<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
 <meta name="theme-color" content="#2563eb">
 <meta name="mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="default">
 <meta name="apple-mobile-web-app-title" content="DIYMatch">
 <meta name="application-name" content="DIYMatch">
 <meta name="description" content="AI-powered DIY assistant connecting you with verified experts and providing instant problem analysis">
 
 <title>DIYMatch - AI-Powered DIY Assistant</title>
 
 <!-- Embedded CSS to avoid external dependencies -->
 <style>
   /* Reset and base styles */
   * {
     margin: 0;
     padding: 0;
     box-sizing: border-box;
     -webkit-tap-highlight-color: transparent;
     -webkit-touch-callout: none;
   }
   
   body {
     font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
     -webkit-font-smoothing: antialiased;
     -moz-osx-font-smoothing: grayscale;
     background-color: #f9fafb;
     color: #111827;
     overflow-x: hidden;
   }

   /* Utility classes (Tailwind-like) */
   .container { max-width: 1200px; margin: 0 auto; padding: 0 1rem; }
   .flex { display: flex; }
   .flex-col { flex-direction: column; }
   .items-center { align-items: center; }
   .justify-center { justify-content: center; }
   .justify-between { justify-content: space-between; }
   .text-center { text-align: center; }
   .min-h-screen { min-height: 100vh; }
   .w-full { width: 100%; }
   .h-full { height: 100%; }
   .max-w-md { max-width: 28rem; }
   .max-w-2xl { max-width: 42rem; }
   .max-w-4xl { max-width: 56rem; }
   .mx-auto { margin-left: auto; margin-right: auto; }
   .mb-2 { margin-bottom: 0.5rem; }
   .mb-4 { margin-bottom: 1rem; }
   .mb-6 { margin-bottom: 1.5rem; }
   .mb-8 { margin-bottom: 2rem; }
   .mb-12 { margin-bottom: 3rem; }
   .mt-4 { margin-top: 1rem; }
   .mt-8 { margin-top: 2rem; }
   .p-4 { padding: 1rem; }
   .p-6 { padding: 1.5rem; }
   .p-8 { padding: 2rem; }
   .px-4 { padding-left: 1rem; padding-right: 1rem; }
   .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
   .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
   .py-4 { padding-top: 1rem; padding-bottom: 1rem; }
   .py-6 { padding-top: 1.5rem; padding-bottom: 1.5rem; }
   .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
   .px-8 { padding-left: 2rem; padding-right: 2rem; }
   .rounded-lg { border-radius: 0.5rem; }
   .rounded-xl { border-radius: 0.75rem; }
   .rounded-2xl { border-radius: 1rem; }
   .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
   .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }

   /* Colors */
   .bg-white { background-color: #ffffff; }
   .bg-gray-50 { background-color: #f9fafb; }
   .bg-gray-100 { background-color: #f3f4f6; }
   .bg-gray-200 { background-color: #e5e7eb; }
   .bg-blue-50 { background-color: #eff6ff; }
   .bg-blue-600 { background-color: #2563eb; }
   .bg-blue-700 { background-color: #1d4ed8; }
   .bg-green-600 { background-color: #059669; }
   .bg-green-700 { background-color: #047857; }
   .bg-red-600 { background-color: #dc2626; }
   .bg-purple-600 { background-color: #9333ea; }
   .text-white { color: #ffffff; }
   .text-gray-600 { color: #4b5563; }
   .text-gray-700 { color: #374151; }
   .text-gray-800 { color: #1f2937; }
   .text-blue-600 { color: #2563eb; }
   .text-red-600 { color: #dc2626; }
   .border { border-width: 1px; }
   .border-gray-300 { border-color: #d1d5db; }

   /* Typography */
   .text-xs { font-size: 0.75rem; }
   .text-sm { font-size: 0.875rem; }
   .text-lg { font-size: 1.125rem; }
   .text-xl { font-size: 1.25rem; }
   .text-2xl { font-size: 1.5rem; }
   .text-3xl { font-size: 1.875rem; }
   .text-4xl { font-size: 2.25rem; }
   .text-5xl { font-size: 3rem; }
   .text-6xl { font-size: 3.75rem; }
   .font-semibold { font-weight: 600; }
   .font-bold { font-weight: 700; }

   /* Grid */
   .grid { display: grid; }
   .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
   .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
   .gap-4 { gap: 1rem; }
   .gap-6 { gap: 1.5rem; }
   .gap-8 { gap: 2rem; }

   /* Spacing */
   .space-y-4 > * + * { margin-top: 1rem; }
   .space-y-6 > * + * { margin-top: 1.5rem; }

   /* Buttons and interactive elements */
   .btn {
     display: inline-flex;
     align-items: center;
     justify-content: center;
     padding: 0.75rem 1.5rem;
     border: none;
     border-radius: 0.5rem;
     font-weight: 600;
     text-decoration: none;
     cursor: pointer;
     transition: all 0.2s;
     touch-action: manipulation;
   }

   .btn:hover {
     transform: translateY(-1px);
     box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
   }

   .btn:active {
     transform: translateY(0);
   }

   .btn-primary {
     background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
     color: white;
   }

   .btn-secondary {
     background-color: #e5e7eb;
     color: #374151;
   }

   .btn-success {
     background: linear-gradient(135deg, #059669 0%, #10b981 100%);
     color: white;
   }

   .btn-danger {
     background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
     color: white;
   }

   /* Form elements */
   .form-input {
     width: 100%;
     padding: 0.75rem 1rem;
     border: 1px solid #d1d5db;
     border-radius: 0.5rem;
     font-size: 16px; /* Prevents zoom on iOS */
     background-color: white;
     transition: border-color 0.2s, box-shadow 0.2s;
   }

   .form-input:focus {
     outline: none;
     border-color: #3b82f6;
     box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
   }

   /* Cards */
   .card {
     background: white;
     border-radius: 1rem;
     padding: 1.5rem;
     box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
     transition: transform 0.2s, box-shadow 0.2s;
   }

   .card:hover {
     transform: translateY(-2px);
     box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
   }

   .feature-card {
     background: white;
     border-radius: 1.5rem;
     padding: 2rem;
     text-align: center;
     transition: all 0.3s ease;
     cursor: pointer;
     box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
   }
   
   .feature-card:hover {
     transform: translateY(-5px);
     box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
   }
   
   .feature-icon {
     width: 80px;
     height: 80px;
     margin: 0 auto 1rem;
     background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
     border-radius: 20px;
     display: flex;
     align-items: center;
     justify-content: center;
     font-size: 2.5rem;
   }

   /* Animations */
   @keyframes fadeIn {
     from { opacity: 0; transform: translateY(10px); }
     to { opacity: 1; transform: translateY(0); }
   }

   @keyframes pulse {
     0%, 100% { opacity: 1; }
     50% { opacity: 0.5; }
   }

   @keyframes spin {
     to { transform: rotate(360deg); }
   }

   .fade-in { animation: fadeIn 0.5s ease-out; }
   .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
   .animate-spin { animation: spin 1s linear infinite; }

   /* Loading spinner */
   .spinner {
     width: 2rem;
     height: 2rem;
     border: 4px solid #e5e7eb;
     border-top-color: #3b82f6;
     border-radius: 50%;
     animation: spin 1s linear infinite;
   }

   /* Splash screen */
   .splash-screen {
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background: linear-gradient(135deg, #2563eb 0%, #8b5cf6 100%);
     display: flex;
     align-items: center;
     justify-content: center;
     z-index: 9999;
     color: white;
   }

   /* Bottom navigation */
   .bottom-nav {
     position: fixed;
     bottom: 0;
     left: 0;
     right: 0;
     background: white;
     border-top: 1px solid #e5e7eb;
     display: flex;
     justify-content: space-around;
     padding: 0.5rem 0;
     z-index: 1000;
     box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
   }

   .bottom-nav-item {
     display: flex;
     flex-direction: column;
     align-items: center;
     padding: 0.5rem 1rem;
     color: #6b7280;
     font-size: 0.75rem;
     transition: all 0.2s;
     cursor: pointer;
     position: relative;
     text-decoration: none;
   }

   .bottom-nav-item.active {
     color: #3b82f6;
   }
   
   .bottom-nav-item.active::before {
     content: '';
     position: absolute;
     top: -1px;
     left: 50%;
     transform: translateX(-50%);
     width: 30px;
     height: 3px;
     background: #3b82f6;
     border-radius: 0 0 3px 3px;
   }

   .bottom-nav-icon {
     font-size: 1.5rem;
     margin-bottom: 0.25rem;
     transition: transform 0.2s;
   }
   
   .bottom-nav-item:active .bottom-nav-icon {
     transform: scale(1.2);
   }

   /* Safe areas for mobile devices */
   .safe-area-top { 
     padding-top: env(safe-area-inset-top);
     padding-top: constant(safe-area-inset-top);
   }
   
   .safe-area-bottom { 
     padding-bottom: env(safe-area-inset-bottom);
     padding-bottom: constant(safe-area-inset-bottom);
   }

   /* Responsive design */
   @media (max-width: 768px) {
     .container { padding: 0 0.5rem; }
     .text-5xl { font-size: 2.5rem; }
     .text-4xl { font-size: 2rem; }
     .feature-card { padding: 1.5rem; }
     .feature-icon { width: 60px; height: 60px; font-size: 2rem; }
     .grid-cols-3 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
   }

   @media (max-width: 640px) {
     .grid-cols-2 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
   }

   /* Utility for hiding elements */
   .hidden { display: none !important; }

   /* Step indicator */
   .steps {
     display: flex;
     justify-content: space-between;
     margin-bottom: 2rem;
     position: relative;
   }

   .step {
     flex: 1;
     text-align: center;
     position: relative;
     z-index: 1;
   }

   .step:not(:last-child)::after {
     content: '';
     position: absolute;
     top: 20px;
     left: 50%;
     width: 100%;
     height: 2px;
     background: #e5e7eb;
     z-index: -1;
   }

   .step.completed:not(:last-child)::after {
     background: #3b82f6;
   }

   .step-circle {
     width: 40px;
     height: 40px;
     border-radius: 50%;
     background: #e5e7eb;
     margin: 0 auto 8px;
     display: flex;
     align-items: center;
     justify-content: center;
     font-weight: 600;
     transition: all 0.3s ease;
     position: relative;
   }

   .step.completed .step-circle {
     background: #3b82f6;
     color: white;
     transform: scale(1.1);
   }

   .step.active .step-circle {
     background: #3b82f6;
     color: white;
     box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
   }
 </style>
</head>
<body>
 <div id="offline-message" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; background: #ef4444; color: white; padding: 10px; text-align: center; z-index: 10000; font-size: 14px;">
   📶 No internet connection. Working in offline mode.
 </div>

 <div id="root">
   <!-- Loading will be replaced by app -->
   <div class="min-h-screen flex items-center justify-content-center">
     <div class="text-center">
       <div class="spinner mx-auto mb-4"></div>
       <p class="text-gray-600">Loading DIYMatch...</p>
     </div>
   </div>
 </div>
 
 <!-- Splash Screen -->
 <div id="splash-screen" class="splash-screen">
   <div class="text-center">
     <div class="text-6xl mb-4 animate-pulse">🔧</div>
     <h1 class="text-3xl font-bold mb-2">DIYMatch</h1>
     <p class="text-lg" style="opacity: 0.8;">AI-Powered DIY Assistant</p>
     <div class="mt-8">
       <div class="spinner mx-auto" style="border-color: rgba(255,255,255,0.3); border-top-color: white;"></div>
     </div>
   </div>
 </div>

 <script>
   'use strict';
   
   // ============================================================================
   // CONFIGURATION
   // ============================================================================
   
   const APP_CONFIG = {
     name: 'DIYMatch',
     version: '3.1.0',
     description: 'AI-Powered DIY Assistant with Expert Network',
     supportEmail: 'support@diymatch.co.uk',
     emergencyHotline: '0800-DIY-HELP',
     aiAnalysisPrice: 4.99,
     maxImageSize: 10 * 1024 * 1024,
     freeAnalysesPerMonth: 1
   };

   // ============================================================================
   // UTILITY FUNCTIONS
   // ============================================================================
   
   let currentUser = null;
   
   const triggerHaptic = (type = 'light') => {
     if ('vibrate' in navigator) {
       const patterns = {
         light: 50,
         medium: 100,
         heavy: 200,
         success: [50, 100, 50],
         error: [100, 50, 100, 50, 100]
       };
       navigator.vibrate(patterns[type] || 50);
     }
   };

   const formatCurrency = (amount) => {
     return new Intl.NumberFormat('en-GB', {
       style: 'currency',
       currency: 'GBP'
     }).format(amount);
   };

   const saveToStorage = (key, data) => {
     try {
       localStorage.setItem(`diymatch_${key}`, JSON.stringify(data));
       return true;
     } catch (error) {
       console.warn('Storage save failed:', error);
       return false;
     }
   };

   const loadFromStorage = (key, defaultValue = null) => {
     try {
       const item = localStorage.getItem(`diymatch_${key}`);
       return item ? JSON.parse(item) : defaultValue;
     } catch (error) {
       console.warn('Storage load failed:', error);
       return defaultValue;
     }
   };

   // ============================================================================
   // SIMPLIFIED ANALYTICS
   // ============================================================================
   
   const analytics = {
     track: (event, data = {}) => {
       console.log('📊 Analytics:', event, data);
       
       // Store locally for later sync
       const events = loadFromStorage('analytics', []);
       events.push({
         event,
         data,
         timestamp: Date.now(),
         url: window.location.href
       });
       saveToStorage('analytics', events.slice(-100)); // Keep last 100 events
     },
     
     trackPageView: (page) => analytics.track('page_view', { page }),
     trackError: (error) => analytics.track('error', { message: error.message || String(error) })
   };

   // ============================================================================
   // NETWORK STATUS
   // ============================================================================
   
   function updateConnectivityStatus() {
     const offlineMessage = document.getElementById('offline-message');
     if (!navigator.onLine) {
       offlineMessage.classList.remove('hidden');
     } else {
       offlineMessage.classList.add('hidden');
     }
   }

   window.addEventListener('online', updateConnectivityStatus);
   window.addEventListener('offline', updateConnectivityStatus);
   updateConnectivityStatus();

   // ============================================================================
   // APP STATE MANAGEMENT
   // ============================================================================
   
   let appState = {
     currentPage: 'welcome',
     user: null,
     loading: false
   };

   const setState = (newState) => {
     appState = { ...appState, ...newState };
     render();
   };

   // ============================================================================
   // PAGES
   // ============================================================================
   
   const WelcomePage = () => {
     return `
       <div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50">
         <div class="safe-area-top">
           <div class="container py-8">
             <!-- Header -->
             <div class="flex items-center justify-between mb-12">
               <div class="flex items-center gap-2">
                 <div class="text-3xl">🔧</div>
                 <h1 class="text-2xl font-bold text-gray-800">DIYMatch</h1>
               </div>
             </div>

             <!-- Hero Section -->
             <div class="text-center mb-16 fade-in">
               <h1 class="text-5xl font-bold mb-6">
                 <span class="text-gray-800">Welcome to </span>
                 <span class="text-blue-600">DIYMatch</span>
               </h1>
               <p class="text-xl text-gray-600 max-w-4xl mx-auto mb-12">
                 AI-powered DIY assistant that instantly analyzes your home problems and connects you with verified local experts
               </p>

               <!-- Action Buttons -->
               <div class="grid gap-4 max-w-4xl mx-auto mb-16">
                 <button onclick="navigateTo('register')" class="btn btn-primary p-6 rounded-2xl text-lg">
                   <span class="flex items-center justify-center gap-3">
                     <span class="text-2xl">🔍</span>
                     <span>Get FREE AI Analysis</span>
                   </span>
                 </button>
                 
                 <button onclick="navigateTo('expert-register')" class="btn btn-success p-6 rounded-2xl text-lg">
                   <span class="flex items-center justify-center gap-3">
                     <span class="text-2xl">👨‍🔧</span>
                     <span>Join as Expert</span>
                   </span>
                 </button>

                 <button onclick="navigateTo('login')" class="btn btn-secondary p-6 rounded-2xl text-lg">
                   <span class="flex items-center justify-center gap-3">
                     <span class="text-2xl">🔑</span>
                     <span>Sign In</span>
                   </span>
                 </button>
               </div>
             </div>

             <!-- Features -->
             <div class="mb-16">
               <h2 class="text-4xl font-bold text-center mb-12 text-gray-800">How DIYMatch Works</h2>
               
               <div class="grid grid-cols-3 gap-8 max-w-6xl mx-auto">
                 <div class="feature-card">
                   <div class="feature-icon">🤖</div>
                   <h3 class="text-2xl font-bold mb-4 text-gray-800">FREE AI Analysis</h3>
                   <p class="text-gray-600">
                     Upload a photo and get completely free problem identification, with detailed analysis and safety warnings.
                   </p>
                 </div>
                 
                 <div class="feature-card">
                   <div class="feature-icon">🎯</div>
                   <h3 class="text-2xl font-bold mb-4 text-gray-800">Expert Connection</h3>
                   <p class="text-gray-600">
                     When DIY isn't enough, instantly connect with verified local professionals who can help.
                   </p>
                 </div>
                 
                 <div class="feature-card">
                   <div class="feature-icon">🛡️</div>
                   <h3 class="text-2xl font-bold mb-4 text-gray-800">Safety First</h3>
                   <p class="text-gray-600">
                     Our AI knows when a job requires professional help and will recommend expert assistance for safety.
                   </p>
                 </div>
               </div>
             </div>

             <!-- Trust Indicators -->
             <div class="text-center">
               <div class="flex justify-center gap-8 mb-4">
                 <div>
                   <div class="text-3xl font-bold text-blue-600">10K+</div>
                   <div class="text-gray-600">Active Users</div>
                 </div>
                 <div>
                   <div class="text-3xl font-bold text-green-600">500+</div>
                   <div class="text-gray-600">Verified Experts</div>
                 </div>
                 <div>
                   <div class="text-3xl font-bold text-purple-600">4.8★</div>
                   <div class="text-gray-600">App Rating</div>
                 </div>
               </div>
             </div>
           </div>
         </div>
       </div>
     `;
   };

   const RegisterPage = () => {
     return `
       <div class="min-h-screen bg-gray-50 flex items-center justify-center p-4">
         <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
           <div class="text-center mb-8">
             <h1 class="text-3xl font-bold text-gray-800 mb-2">Join DIYMatch</h1>
             <p class="text-gray-600">Start solving your DIY problems today</p>
           </div>
           
           <form onsubmit="handleRegister(event)" class="space-y-4">
             <input type="text" name="name" placeholder="Full Name" required class="form-input">
             <input type="email" name="email" placeholder="Email Address" required class="form-input">
             <input type="text" name="postcode" placeholder="Postcode" required class="form-input">
             <input type="tel" name="phone" placeholder="Phone Number" required class="form-input">
             
             <button type="submit" class="btn btn-primary w-full py-3">
               ${appState.loading ? '<div class="spinner mx-auto" style="width: 1.5rem; height: 1.5rem;"></div>' : 'Create Account'}
             </button>
             
             <button type="button" onclick="navigateTo('welcome')" class="btn btn-secondary w-full py-3">
               Back
             </button>
           </form>
         </div>
       </div>
     `;
   };

   const UserDashboard = () => {
     const activeTab = appState.activeTab || 'home';
     
     const renderContent = () => {
       switch (activeTab) {
         case 'analyze':
           return AIAnalysisPage();
         default:
           return `
             <div class="space-y-6 fade-in">
               <!-- Welcome Card -->
               <div class="card" style="background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); color: white;">
                 <h2 class="text-2xl font-bold mb-2">Welcome back, ${appState.user?.name || 'User'}!</h2>
                 <p style="opacity: 0.9;">What can we help you fix today?</p>
               </div>

               <!-- Quick Actions -->
               <div class="grid grid-cols-2 gap-4">
                 <button onclick="setActiveTab('analyze')" class="card text-center hover:shadow-lg" style="background: #3b82f6; color: white;">
                   <div class="text-3xl mb-2">📸</div>
                   <div class="font-semibold">New Analysis</div>
                   <div class="text-xs mt-1" style="opacity: 0.8;">✨ FREE this month!</div>
                 </button>
                 
                 <button class="card text-center hover:shadow-lg" style="background: #059669; color: white;">
                   <div class="text-3xl mb-2">👨‍🔧</div>
                   <div class="font-semibold">Find Experts</div>
                   <div class="text-xs mt-1" style="opacity: 0.8;">Coming soon</div>
                 </button>
                 
                 <button class="card text-center hover:shadow-lg" style="background: #dc2626; color: white;">
                   <div class="text-3xl mb-2">🚨</div>
                   <div class="font-semibold">Emergency</div>
                   <div class="text-xs mt-1" style="opacity: 0.8;">24/7 help</div>
                 </button>
                 
                 <button class="card text-center hover:shadow-lg" style="background: #9333ea; color: white;">
                   <div class="text-3xl mb-2">🛠️</div>
                   <div class="font-semibold">Find Parts</div>
                   <div class="text-xs mt-1" style="opacity: 0.8;">Coming soon</div>
                 </button>
               </div>

               <!-- Tips Card -->
               <div class="card" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
                 <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">
                   <span>💡</span>
                   Pro Tip
                 </h3>
                 <p class="text-gray-700">
                   For best AI analysis results, take photos in good lighting and include the whole problem area.
                 </p>
               </div>
             </div>
           `;
       }
     };

     return `
       <div class="min-h-screen bg-gray-50">
         <!-- Header -->
         <div class="safe-area-top bg-white shadow-sm sticky top-0 z-50">
           <div class="container py-4">
             <div class="flex justify-between items-center">
               <h1 class="text-2xl font-bold flex items-center">
                 <span class="text-3xl mr-2">🔧</span>
                 DIYMatch
               </h1>
               <button onclick="logout()" class="text-gray-600 hover:text-gray-800 px-3 py-1 rounded">
                 Logout
               </button>
             </div>
           </div>
         </div>
         
         <!-- Main Content -->
         <div class="container py-6" style="padding-bottom: 6rem;">
           ${renderContent()}
         </div>
         
         <!-- Bottom Navigation -->
         <div class="bottom-nav safe-area-bottom">
           <button onclick="setActiveTab('home')" class="bottom-nav-item ${activeTab === 'home' ? 'active' : ''}">
             <div class="bottom-nav-icon">🏠</div>
             <span>Home</span>
           </button>
           <button onclick="setActiveTab('analyze')" class="bottom-nav-item ${activeTab === 'analyze' ? 'active' : ''}">
             <div class="bottom-nav-icon">📸</div>
             <span>Analyze</span>
           </button>
           <button class="bottom-nav-item">
             <div class="bottom-nav-icon">👨‍🔧</div>
             <span>Experts</span>
           </button>
           <button class="bottom-nav-item">
             <div class="bottom-nav-icon">📋</div>
             <span>History</span>
           </button>
         </div>
       </div>
     `;
   };

   const AIAnalysisPage = () => {
     const step = appState.analysisStep || 'upload';
     const imageData = appState.imageData;
     const analysis = appState.analysis;

     const renderUploadStep = () => `
       <div class="text-center space-y-6">
         <div class="text-6xl mb-4">📸</div>
         <h2 class="text-2xl font-bold mb-4">Upload Problem Photo</h2>
         <p class="text-gray-600 mb-6">Take a clear photo of your DIY problem for AI analysis</p>
         
         <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 cursor-pointer hover:border-blue-500 transition-colors" onclick="document.getElementById('file-input').click()">
           <div class="text-4xl mb-2">📁</div>
           <p class="font-semibold mb-1">Click to upload photo</p>
           <p class="text-sm text-gray-500">JPG, PNG, WebP up to 10MB</p>
         </div>
         
         <input type="file" id="file-input" accept="image/*" onchange="handleImageUpload(event)" style="display: none;">

         <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
           <h3 class="font-semibold text-blue-800 mb-2">📋 Tips for Best Results:</h3>
           <ul class="text-sm text-blue-700 text-left space-y-1">
             <li>• Ensure good lighting</li>
             <li>• Include the whole problem area</li>
             <li>• Take photo from multiple angles if needed</li>
             <li>• Avoid blurry or dark images</li>
           </ul>
         </div>
       </div>
     `;

     const renderDescribeStep = () => `
       <div class="space-y-6">
         <div class="text-center mb-6">
           <h2 class="text-2xl font-bold mb-4">Describe the Problem</h2>
           <p class="text-gray-600">Tell us more about what's happening for better analysis</p>
         </div>

         <div class="bg-gray-100 rounded-lg p-4 mb-6">
           <div class="text-center">
             <img src="${imageData?.data}" alt="Uploaded problem" class="max-h-48 mx-auto rounded-lg shadow-md">
             <p class="text-sm text-gray-600 mt-2">${imageData?.metadata?.name}</p>
           </div>
         </div>

         <textarea id="description" placeholder="Describe what's wrong, when it started, any sounds, smells, or other details..." rows="4" class="form-input resize-none"></textarea>

         <div class="flex gap-4">
           <button onclick="setAnalysisStep('upload')" class="btn btn-secondary flex-1 py-3">Back</button>
           <button onclick="startAnalysis()" class="btn btn-primary flex-1 py-3">Analyze Problem</button>
         </div>
       </div>
     `;

     const renderAnalyzingStep = () => `
       <div class="text-center space-y-6">
         <div class="text-6xl mb-4 animate-pulse">🤖</div>
         <h2 class="text-2xl font-bold mb-4">AI Analysis in Progress</h2>
         <div class="w-full bg-gray-200 rounded-full h-2 mb-6">
           <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full animate-pulse" style="width: 75%;"></div>
         </div>
         <div class="space-y-2 text-gray-600">
           <p>🔍 Analyzing image patterns...</p>
           <p>🧠 Processing problem description...</p>
           <p>⚖️ Calculating safety risks...</p>
           <p>💡 Generating recommendations...</p>
         </div>
       </div>
     `;

     const renderResultsStep = () => `
       <div class="space-y-6">
         <!-- Header -->
         <div class="text-center mb-6">
           <div class="text-6xl mb-4">✅</div>
           <h2 class="text-2xl font-bold mb-2">Analysis Complete</h2>
           <div class="flex justify-center items-center gap-2">
             <span class="text-sm text-gray-600">Confidence:</span>
             <span class="font-semibold text-blue-600">${analysis?.confidence}</span>
           </div>
         </div>

         <!-- Problem Summary -->
         <div class="card">
           <div class="flex justify-between items-start mb-4">
             <h3 class="text-xl font-bold">${analysis?.problemDetected}</h3>
             <span class="px-3 py-1 rounded-full text-sm font-semibold ${
               analysis?.severity === 'Critical' ? 'bg-red-100 text-red-800' :
               analysis?.severity === 'High' ? 'bg-orange-100 text-orange-800' :
               'bg-yellow-100 text-yellow-800'
             }">${analysis?.severity}</span>
           </div>
           <p class="text-gray-700 mb-4">${analysis?.description}</p>
           
           <div class="grid grid-cols-2 gap-4 mb-4">
             <div>
               <p class="text-sm text-gray-600">DIY Friendly</p>
               <p class="font-semibold">${analysis?.isDIYFriendly ? '✅ Yes' : '❌ No'}</p>
             </div>
             <div>
               <p class="text-sm text-gray-600">Estimated Cost</p>
               <p class="font-semibold">${analysis?.estimatedCost?.range}</p>
             </div>
           </div>
         </div>

         <!-- Safety Warnings -->
         ${analysis?.safetyWarnings?.length > 0 ? `
           <div class="bg-red-50 border border-red-200 rounded-xl p-6">
             <h3 class="text-lg font-bold text-red-800 mb-3 flex items-center gap-2">
               <span>⚠️</span>
               Safety Warnings
             </h3>
             <ul class="space-y-2">
               ${analysis.safetyWarnings.map(warning => `<li class="text-red-700 text-sm">${warning}</li>`).join('')}
             </ul>
           </div>
         ` : ''}

         <!-- Next Steps -->
         <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
           <h3 class="text-lg font-bold text-blue-800 mb-3 flex items-center gap-2">
             <span>📋</span>
             Recommended Next Steps
           </h3>
           <ol class="space-y-2">
             ${analysis?.nextSteps?.map((step, index) => `
               <li class="text-blue-700 text-sm flex items-start gap-2">
                 <span class="font-semibold">${index + 1}.</span>
                 <span>${step}</span>
               </li>
             `).join('') || ''}
           </ol>
         </div>

         <!-- Action Buttons -->
         <div class="flex gap-4">
           <button onclick="resetAnalysis()" class="btn btn-secondary flex-1 py-3">New Analysis</button>
           <button onclick="alert('Expert booking coming soon!')" class="btn btn-success flex-1 py-3">Book Expert</button>
         </div>
       </div>
     `;

     return `
       <div class="max-w-2xl mx-auto">
         <div class="card">
           <!-- Progress Steps -->
           <div class="steps">
             ${['Upload', 'Describe', 'Analyze', 'Results'].map((stepName, index) => {
               const stepKey = ['upload', 'describe', 'analyzing', 'results'][index];
               const isActive = step === stepKey;
               const isCompleted = ['upload', 'describe', 'analyzing', 'results'].indexOf(step) > index;
               
               return `
                 <div class="step ${isActive ? 'active' : ''} ${isCompleted ? 'completed' : ''}">
                   <div class="step-circle">${isCompleted ? '✓' : index + 1}</div>
                   <span class="text-xs mt-1">${stepName}</span>
                 </div>
               `;
             }).join('')}
           </div>

           <!-- Step Content -->
           ${step === 'upload' ? renderUploadStep() : ''}
           ${step === 'describe' ? renderDescribeStep() : ''}
           ${step === 'analyzing' ? renderAnalyzingStep() : ''}
           ${step === 'results' ? renderResultsStep() : ''}
         </div>
       </div>
     `;
   };

   // ============================================================================
   // NAVIGATION AND EVENT HANDLERS
   // ============================================================================
   
   const navigateTo = (page) => {
     triggerHaptic('light');
     analytics.trackPageView(page);
     setState({ currentPage: page, activeTab: null });
   };

   const setActiveTab = (tab) => {
     triggerHaptic('light');
     setState({ activeTab: tab });
   };

   const setAnalysisStep = (step) => {
     setState({ analysisStep: step });
   };

   const logout = () => {
     if (confirm('Are you sure you want to logout?')) {
       triggerHaptic('medium');
       currentUser = null;
       saveToStorage('user', null);
       setState({ currentPage: 'welcome', user: null });
     }
   };

   const handleRegister = async (event) => {
     event.preventDefault();
     setState({ loading: true });
     
     try {
       const formData = new FormData(event.target);
       const userData = {
         id: `user_${Date.now()}`,
         name: formData.get('name'),
         email: formData.get('email'),
         postcode: formData.get('postcode'),
         phone: formData.get('phone'),
         type: 'user',
         createdAt: new Date().toISOString()
       };
       
       // Simulate registration delay
       await new Promise(resolve => setTimeout(resolve, 1000));
       
       currentUser = userData;
       saveToStorage('user', userData);
       analytics.track('user_registered', { userType: 'user' });
       
       setState({ 
         currentPage: 'dashboard',
         user: userData,
         loading: false 
       });
     } catch (error) {
       alert('Registration failed. Please try again.');
       analytics.trackError(error);
       setState({ loading: false });
     }
   };

   const handleImageUpload = (event) => {
     const file = event.target.files[0];
     if (!file) return;

     if (file.size > APP_CONFIG.maxImageSize) {
       alert(`File too large. Maximum size is ${APP_CONFIG.maxImageSize / 1024 / 1024}MB`);
       return;
     }

     const reader = new FileReader();
     reader.onload = (e) => {
       setState({
         imageData: {
           type: 'image',
           data: e.target.result,
           file,
           metadata: {
             name: file.name,
             size: file.size,
             type: file.type
           }
         },
         analysisStep: 'describe'
       });
       triggerHaptic('success');
     };
     reader.readAsDataURL(file);
   };

   const startAnalysis = async () => {
     const description = document.getElementById('description')?.value;
     if (!description?.trim()) {
       alert('Please describe the problem');
       return;
     }

     setState({ analysisStep: 'analyzing' });

     try {
       // Simulate AI analysis
       await new Promise(resolve => setTimeout(resolve, 3000));

       const mockAnalysis = {
         id: `analysis_${Date.now()}`,
         problemDetected: 'Electrical Socket Issue',
         category: 'Electrical',
         confidence: '89%',
         severity: 'High',
         description: 'Potential electrical safety hazard detected. The socket appears to show signs of burning or discoloration, which could indicate overheating or electrical arcing.',
         isDIYFriendly: false,
         estimatedCost: {
           range: '£80-£200',
           professional: '£120-£200'
         },
         safetyWarnings: [
           '⚡ Turn off power at circuit breaker immediately',
           '☠️ DANGER: Risk of electrocution - never work on live circuits',
           '🔥 Do not use socket until professionally inspected',
           '📞 Contact emergency electrician if sparking or burning smell'
         ],
         nextSteps: [
           'Turn off power to the circuit immediately',
           'Do not use the socket',
           'Contact a certified electrician',
           'Take photos for insurance if needed'
         ],
         timestamp: new Date().toISOString()
       };

       // Store analysis
       const analyses = loadFromStorage('analyses', []);
       analyses.unshift(mockAnalysis);
       saveToStorage('analyses', analyses.slice(0, 50)); // Keep last 50

       setState({ 
         analysis: mockAnalysis,
         analysisStep: 'results'
       });
       
       analytics.track('ai_analysis_completed', { 
         problemType: mockAnalysis.problemDetected,
         severity: mockAnalysis.severity 
       });

     } catch (error) {
       console.error('Analysis error:', error);
       alert('Analysis failed. Please try again.');
       analytics.trackError(error);
       setState({ analysisStep: 'describe' });
     }
   };

   const resetAnalysis = () => {
     setState({
       analysisStep: 'upload',
       imageData: null,
       analysis: null
     });
   };

   // ============================================================================
   // MAIN RENDER FUNCTION
   // ============================================================================
   
   const render = () => {
     const rootElement = document.getElementById('root');
     
     let content = '';
     
     switch (appState.currentPage) {
       case 'welcome':
         content = WelcomePage();
         break;
       case 'register':
         content = RegisterPage();
         break;
       case 'dashboard':
         content = UserDashboard();
         break;
       default:
         content = WelcomePage();
     }
     
     rootElement.innerHTML = content;
   };

   // ============================================================================
   // INITIALIZATION
   // ============================================================================
   
   const initializeApp = async () => {
     try {
       console.log('🔧 Initializing DIYMatch...');
       
       // Check for existing user session
       const savedUser = loadFromStorage('user');
       if (savedUser) {
         currentUser = savedUser;
         setState({ 
           currentPage: 'dashboard',
           user: savedUser
         });
       }
       
       analytics.trackPageView('app_launch');
       
       // Hide splash screen
       setTimeout(() => {
         const splash = document.getElementById('splash-screen');
         if (splash) {
           splash.style.opacity = '0';
           splash.style.transition = 'opacity 0.3s';
           setTimeout(() => splash.style.display = 'none', 300);
         }
       }, 2000);
       
       // Initial render
       render();
       
       console.log('✅ DIYMatch initialized successfully');
       
     } catch (error) {
       console.error('❌ App initialization failed:', error);
       analytics.trackError(error);
       
       // Show error message
       document.getElementById('root').innerHTML = `
         <div class="min-h-screen flex items-center justify-center p-4">
           <div class="text-center max-w-md">
             <div class="text-6xl mb-4">😔</div>
             <h1 class="text-2xl font-bold mb-2 text-gray-800">App Loading Failed</h1>
             <p class="text-gray-600 mb-4">Please refresh the page to try again.</p>
             <button onclick="location.reload()" class="btn btn-primary">Refresh Page</button>
           </div>
         </div>
       `;
     }
   };

   // Start the app when DOM is ready
   if (document.readyState === 'loading') {
     document.addEventListener('DOMContentLoaded', initializeApp);
   } else {
     initializeApp();
   }

   console.log('🔧 DIYMatch Self-Contained App Loaded');
   console.log('📱 Version:', APP_CONFIG.version);
 </script>
</body>
</html>
