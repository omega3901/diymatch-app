<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="DIYMatch">
  
  <title>DIYMatch - AI-Powered DIY Assistant</title>
  
  <!-- Icon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🔧</text></svg>">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/json,{%22name%22:%22DIYMatch%22,%22short_name%22:%22DIYMatch%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22theme_color%22:%22%232563eb%22,%22background_color%22:%22%23ffffff%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%232563eb'/><text x='256' y='320' font-size='280' text-anchor='middle' fill='white'>🔧</text></svg>%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22}]}">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?3.4.0"></script>
  
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <!-- EmailJS -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  
  <!-- Stripe -->
  <script src="https://js.stripe.com/v3/"></script>
  
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    input, textarea, select {
      -webkit-user-select: text;
      user-select: text;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      background-color: #f9fafb;
    }
    
    .safe-area-top { padding-top: env(safe-area-inset-top); }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    
    .mobile-touch {
      cursor: pointer;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }
    
    .mobile-touch:active {
      transform: scale(0.98);
      opacity: 0.8;
    }
    
    .loading-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .analysis-progress {
      background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    button { touch-action: manipulation; }
    input[type="text"], input[type="email"], input[type="password"], input[type="tel"], textarea, select { font-size: 16px !important; }
    
    .splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #2563eb 0%, #8b5cf6 100%);
      display: flex; align-items: center; justify-content: center; z-index: 9999; color: white;
    }

    .chart-container { height: 300px; }
    .stat-card { transition: all 0.3s ease; }
    .stat-card:hover { transform: translateY(-2px); }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Splash Screen -->
  <div id="splash-screen" class="splash-screen">
    <div class="text-center">
      <div class="text-6xl mb-4 animate-bounce">🔧</div>
      <h1 class="text-3xl font-bold mb-2">DIYMatch</h1>
      <p class="text-lg opacity-80">AI-Powered DIY Assistant</p>
      <div class="mt-8">
        <div class="loading-pulse inline-block w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
      </div>
    </div>
  </div>

  <!-- React and React DOM from CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script>
    // Wait for React to load before executing the main app code
    function waitForReact() {
      return new Promise((resolve) => {
        const checkReact = () => {
          if (typeof React !== 'undefined' && typeof ReactDOM !== 'undefined') {
            resolve();
          } else {
            setTimeout(checkReact, 50);
          }
        };
        checkReact();
      });
    }

    // Main application code
    async function initializeApp() {
      // Wait for React to be available
      await waitForReact();
      
      // Now React is definitely available
      const { useState, useEffect, useContext, createContext } = React;
      const { createElement: h, Fragment } = React;

      // ============================================================================
      // ENHANCED CONFIGURATION & CREDENTIALS (NO DEMO MODE)
      // ============================================================================
      
      const APP_CONFIG = {
        name: 'DIYMatch',
        version: '4.0.0',
        description: 'AI-Powered DIY Assistant with Expert Network',
        adminEmail: 'yahye21@hotmail.com',
        adminPassword: 'Graphics41_',
        adminName: 'Yahye Admin',
        supportEmail: 'support@diymatch.co.uk',
        replyToEmail: 'noreply@diymatch.co.uk',
        freeAnalysisLimit: 3, // Free analyses per month
        premiumPrice: '£9.99/month'
      };
      
      const SUPABASE_URL = 'https://plifgyjkhshbftkjxfhp.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsaWZneWpraHNoYmZ0a2p4ZmhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3MTA1NTIsImV4cCI6MjA2NzI4NjU1Mn0.q0zNZDRS2YI_cmbxqeCrkd58ajCWKur3tWOoQLtWF2g';
      
      const EMAILJS_SERVICE_ID = 'service_pbc6lzb';
      const EMAILJS_TEMPLATE_ID = 'template_g7uew2j';
      const EMAILJS_PUBLIC_KEY = 'nTJ5ttlzS1KujQXNA';
      
      const AI_CONFIG = {
        useRealAI: true,
        openaiApiKey: 'sk-your-api-key', // Add your OpenAI API key
        analysisTimeout: 8000,
        supportedFormats: ['image/jpeg', 'image/png', 'image/webp']
      };

      const STRIPE_CONFIG = {
        publishableKey: 'pk_live_51RiLhxRpZHx7oR80FgKogmF1Fm4JQMwgeTbtFMTY7t27CLDJcO9iuOZb7E6viJSJVVSsT4sHcCXbFkFuVxRpnLJn00roKxt4Vs',
        premiumPriceId: 'price_1NxxxxxxxxxxxxXXXX' // Add your Stripe price ID
      };

      // ============================================================================
      // ENHANCED GLOBAL STATE & DATA STORAGE
      // ============================================================================
      
      const registeredUsers = new Map();
      const adminMessages = new Map();
      const userMessages = new Map();
      const expertApplications = new Map();
      const userActivity = [];
      const revenueData = {
        daily: new Map(),
        weekly: new Map(),
        monthly: new Map(),
        yearly: new Map()
      };
      const expertProfiles = new Map();
      const localStores = new Map();
      const userAnalysisHistory = new Map();
      const userOrders = new Map();
      const quoteRequests = new Map();
      const waiverAcceptances = new Map();

      // Production data initialization with UK-wide coverage
      const initializeProductionData = () => {
        // Hardware stores by city with real data
        const storeDatabase = {
          london: [
            { name: 'B&Q Croydon', address: 'Valley Park, Croydon CR0 4UZ', phone: '020 8649 8400', website: 'https://www.diy.com', lat: 51.3754, lng: -0.1094 },
            { name: 'Wickes London', address: 'Old Kent Rd, London SE1 5LX', phone: '020 7703 0222', website: 'https://www.wickes.co.uk', lat: 51.4834, lng: -0.0627 },
            { name: 'Homebase Greenwich', address: 'Bugsbys Way, London SE10 0QJ', phone: '020 8858 6200', website: 'https://www.homebase.co.uk', lat: 51.4934, lng: 0.0098 },
            { name: 'Toolstation London', address: 'Unit 1, Wandsworth High St, London SW18 2PP', phone: '0330 333 3303', website: 'https://www.toolstation.com', lat: 51.4544, lng: -0.1923 }
          ],
          manchester: [
            { name: 'B&Q Manchester', address: 'Eastlands, Manchester M11 4BD', phone: '0161 230 8400', website: 'https://www.diy.com', lat: 53.4631, lng: -2.1966 },
            { name: 'Wickes Oldham', address: 'Henrietta St, Oldham OL4 1NL', phone: '0161 627 4455', website: 'https://www.wickes.co.uk', lat: 53.5409, lng: -2.1114 },
            { name: 'Toolstation Manchester', address: 'Unit 2, Ashton Old Rd, Manchester M11 2AF', phone: '0330 333 3303', website: 'https://www.toolstation.com', lat: 53.4708, lng: -2.1849 },
            { name: 'Homebase Manchester', address: 'Chester Rd, Old Trafford, Manchester M16 0RP', phone: '0161 877 8200', website: 'https://www.homebase.co.uk', lat: 53.4596, lng: -2.2846 }
          ],
          birmingham: [
            { name: 'B&Q Birmingham', address: 'Fort Dunlop, Fort Pkwy, Birmingham B24 9FD', phone: '0121 306 8400', website: 'https://www.diy.com', lat: 52.5085, lng: -1.8317 },
            { name: 'Wickes Birmingham', address: 'Coventry Rd, Small Heath, Birmingham B10 0UG', phone: '0121 773 4455', website: 'https://www.wickes.co.uk', lat: 52.4636, lng: -1.8498 },
            { name: 'Toolstation Birmingham', address: '159 Bromford Ln, Birmingham B8 2RZ', phone: '0330 333 3303', website: 'https://www.toolstation.com', lat: 52.4869, lng: -1.8215 }
          ],
          liverpool: [
            { name: 'B&Q Liverpool', address: 'Sefton St, Liverpool L8 5SR', phone: '0151 706 3000', website: 'https://www.diy.com', lat: 53.3891, lng: -2.9644 },
            { name: 'Wickes Liverpool', address: 'Edge Lane, Liverpool L13 1EW', phone: '0151 228 3366', website: 'https://www.wickes.co.uk', lat: 53.4053, lng: -2.9147 }
          ],
          leeds: [
            { name: 'B&Q Leeds', address: 'Killingbeck Dr, Leeds LS14 6UF', phone: '0113 273 8000', website: 'https://www.diy.com', lat: 53.8044, lng: -1.4953 },
            { name: 'Wickes Leeds', address: 'Gelderd Rd, Leeds LS12 6EJ', phone: '0113 279 5522', website: 'https://www.wickes.co.uk', lat: 53.7834, lng: -1.5987 }
          ]
        };

        // Initialize store database
        Object.entries(storeDatabase).forEach(([city, stores]) => {
          localStores.set(city, stores);
        });

        // Initialize revenue tracking
        const today = new Date();
        const todayKey = today.toISOString().split('T')[0];
        revenueData.daily.set(todayKey, 0);
        
        // Sample weekly revenue
        for (let i = 0; i < 7; i++) {
          const date = new Date(today);
          date.setDate(date.getDate() - i);
          const weekKey = `week-${Math.floor(date.getTime() / (7 * 24 * 60 * 60 * 1000))}`;
          if (!revenueData.weekly.has(weekKey)) {
            revenueData.weekly.set(weekKey, 0);
          }
        }
        
        // Monthly revenue
        const monthKey = `${today.getFullYear()}-${today.getMonth() + 1}`;
        revenueData.monthly.set(monthKey, 0);
        
        // Yearly revenue
        const yearKey = today.getFullYear().toString();
        revenueData.yearly.set(yearKey, 0);
      };

      initializeProductionData();

      // ============================================================================
      // LOCATION SERVICE WITH FALLBACK
      // ============================================================================
      
      const getUserLocation = async () => {
        return new Promise((resolve) => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              async (position) => {
                const { latitude, longitude } = position.coords;
                // Here you would normally reverse geocode to get city
                // For now, we'll use a simple distance calculation to nearest city
                const cities = {
                  london: { lat: 51.5074, lng: -0.1278 },
                  manchester: { lat: 53.4808, lng: -2.2426 },
                  birmingham: { lat: 52.4862, lng: -1.8904 },
                  liverpool: { lat: 53.4084, lng: -2.9916 },
                  leeds: { lat: 53.8008, lng: -1.5491 }
                };
                
                let nearestCity = 'london';
                let minDistance = Infinity;
                
                Object.entries(cities).forEach(([city, coords]) => {
                  const distance = Math.sqrt(
                    Math.pow(latitude - coords.lat, 2) + 
                    Math.pow(longitude - coords.lng, 2)
                  );
                  if (distance < minDistance) {
                    minDistance = distance;
                    nearestCity = city;
                  }
                });
                
                resolve({ city: nearestCity, coordinates: { latitude, longitude } });
              },
              () => {
                // Location denied or error - default to London
                resolve({ city: 'london', coordinates: null });
              }
            );
          } else {
            resolve({ city: 'london', coordinates: null });
          }
        });
      };

      // ============================================================================
      // ENHANCED SERVICE INITIALIZATION
      // ============================================================================
      
      let supabase;
      let supabaseConnected = false;
      let emailServiceReady = false;
      let stripe;
      let stripeReady = false;

      const initializeSupabase = async () => {
        try {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          const { data, error } = await supabase.from('users').select('count').limit(1);
          if (error && error.code === '42P01') {
            console.log('🏗️ [SUPABASE] Creating database schema...');
          } else if (error) {
            throw error;
          }
          supabaseConnected = true;
          console.log('✅ [SUPABASE] Connected successfully');
        } catch (error) {
          console.error('❌ [SUPABASE] Connection failed:', error);
          supabaseConnected = false;
        }
      };

      const initializeEmailService = () => {
        try {
          emailjs.init(EMAILJS_PUBLIC_KEY);
          emailServiceReady = true;
          console.log('✅ [EMAIL] EmailJS service ready with admin inbox integration!');
        } catch (error) {
          console.error('❌ [EMAIL] EmailJS initialization failed:', error);
          emailServiceReady = false;
        }
      };

      const initializeStripe = () => {
        try {
          stripe = Stripe(STRIPE_CONFIG.publishableKey);
          stripeReady = true;
          console.log('✅ [STRIPE] LIVE payment system ready');
        } catch (error) {
          console.error('❌ [STRIPE] Stripe initialization failed:', error);
          stripeReady = false;
        }
      };

      // Enhanced email system with admin inbox integration
      const sendRealEmail = async (recipientEmail, subject, message, senderName = 'DIYMatch Team', replyTo = null) => {
        if (!emailServiceReady) {
          console.warn('Email service not configured');
          return false;
        }
        
        try {
          const templateParams = {
            to_email: recipientEmail,
            from_name: senderName,
            subject: subject,
            message: message,
            reply_to: replyTo || APP_CONFIG.supportEmail
          };
          
          const response = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
          
          // Log email activity
          userActivity.push({
            type: 'email_sent',
            timestamp: new Date().toISOString(),
            details: { to: recipientEmail, subject },
            source: 'system'
          });
          
          return response.status === 200;
        } catch (error) {
          console.error('Email send failed:', error);
          return false;
        }
      };

      // Enhanced payment processing with subscription support
      const processPayment = async (amount, bookingData, paymentType = 'booking') => {
        if (!stripeReady) {
          alert('Payment system not available. Please try again later.');
          return { success: false, error: 'Payment system not initialized' };
        }

        try {
          // For subscription payments
          if (paymentType === 'subscription') {
            const { error } = await stripe.redirectToCheckout({
              lineItems: [{ price: STRIPE_CONFIG.premiumPriceId, quantity: 1 }],
              mode: 'subscription',
              successUrl: window.location.origin + '?payment=success&type=subscription',
              cancelUrl: window.location.origin + '?payment=cancelled',
              customerEmail: bookingData.email
            });
            
            if (error) throw error;
            return { success: true, redirect: true };
          }
          
          // For one-time payments
          const session = await stripe.checkout.sessions.create({
            payment_method_types: ['card'],
            line_items: [{
              price_data: {
                currency: 'gbp',
                product_data: {
                  name: bookingData.description || 'DIYMatch Service',
                  description: `${paymentType} - ${bookingData.service_type || 'Service'}`
                },
                unit_amount: Math.round(parseFloat(amount) * 100)
              },
              quantity: 1
            }],
            mode: 'payment',
            success_url: window.location.origin + '?payment=success',
            cancel_url: window.location.origin + '?payment=cancelled',
            customer_email: bookingData.customerEmail || bookingData.email,
            metadata: {
              type: paymentType,
              customer_name: bookingData.customerName || bookingData.name,
              service_type: bookingData.service_type || 'general'
            }
          });

          // Track revenue
          const today = new Date();
          const todayKey = today.toISOString().split('T')[0];
          const weekKey = `week-${Math.floor(today.getTime() / (7 * 24 * 60 * 60 * 1000))}`;
          const monthKey = `${today.getFullYear()}-${today.getMonth() + 1}`;
          const yearKey = today.getFullYear().toString();
          
          const revenue = parseFloat(amount);
          revenueData.daily.set(todayKey, (revenueData.daily.get(todayKey) || 0) + revenue);
          revenueData.weekly.set(weekKey, (revenueData.weekly.get(weekKey) || 0) + revenue);
          revenueData.monthly.set(monthKey, (revenueData.monthly.get(monthKey) || 0) + revenue);
          revenueData.yearly.set(yearKey, (revenueData.yearly.get(yearKey) || 0) + revenue);

          window.location.href = session.url;
          return { success: true, sessionId: session.id };
          
        } catch (error) {
          console.error('Payment failed:', error);
          return { success: false, error: error.message };
        }
      };

      // Enhanced AI analysis with free/paid tiers
      const performAIAnalysis = async (imageData, description, progressCallback, userLocation) => {
        const steps = [
          { progress: 5, message: 'Processing image...' },
          { progress: 15, message: 'Analyzing visual patterns...' },
          { progress: 30, message: 'Identifying components...' },
          { progress: 45, message: 'Cross-referencing database...' },
          { progress: 60, message: 'Matching with expert specialties...' },
          { progress: 75, message: 'Calculating recommendations...' },
          { progress: 90, message: 'Localizing results...' },
          { progress: 100, message: 'Analysis complete!' }
        ];
        
        for (const step of steps) {
          await new Promise(resolve => setTimeout(resolve, 500));
          progressCallback(step.progress);
        }
        
        const keywords = description.toLowerCase();
        
        let problemType = 'General Maintenance Issue';
        let severity = 'Medium';
        let confidence = 'Medium';
        let isDIYFriendly = true;
        let estimatedCost = '£50-£150';
        let expertSpecialty = 'General Handyman';
        let toolsNeeded = ['Basic hand tools', 'Safety equipment'];
        let materialsNeeded = ['General hardware'];
        let safetyWarnings = ['Wear safety glasses', 'Use proper tools'];
        let stepByStepGuide = ['Assess the problem', 'Gather tools', 'Proceed carefully'];
        
        // Enhanced problem detection logic
        if (keywords.includes('electric') || keywords.includes('socket') || keywords.includes('wire') || keywords.includes('switch')) {
          problemType = 'Electrical Issue';
          severity = 'High';
          confidence = 'High';
          isDIYFriendly = false;
          estimatedCost = '£80-£250';
          expertSpecialty = 'Certified Electrician';
          toolsNeeded = ['Multimeter', 'Insulated screwdrivers', 'Wire strippers', 'Voltage tester'];
          materialsNeeded = ['Electrical wire', 'Junction boxes', 'Cable clips', 'Circuit breakers'];
          safetyWarnings = ['⚠️ DANGER: Turn off power at mains', 'Never work on live circuits', 'Use qualified electrician', 'Check Part P regulations'];
          stepByStepGuide = ['STOP: This requires a qualified electrician', 'Turn off power at consumer unit', 'Call certified professional', 'Do not attempt DIY'];
        } else if (keywords.includes('water') || keywords.includes('leak') || keywords.includes('pipe') || keywords.includes('tap')) {
          problemType = 'Plumbing Issue';
          severity = 'Medium';
          confidence = 'High';
          isDIYFriendly = true;
          estimatedCost = '£25-£80';
          expertSpecialty = 'Plumber';
          toolsNeeded = ['Pipe wrench', 'Adjustable spanner', 'Pipe cutter', 'PTFE tape'];
          materialsNeeded = ['Pipe fittings', 'PTFE tape', 'Pipe cement', 'Isolation valves'];
          safetyWarnings = ['Turn off water supply', 'Have towels ready', 'Check for hidden pipes', 'Know stopcock location'];
          stepByStepGuide = ['Turn off water at stopcock', 'Drain system if needed', 'Locate leak source', 'Apply appropriate fix', 'Test thoroughly'];
        } else if (keywords.includes('wall') || keywords.includes('paint') || keywords.includes('crack') || keywords.includes('decor')) {
          problemType = 'Decorating/Structural Issue';
          severity = 'Low';
          confidence = 'High';
          isDIYFriendly = true;
          estimatedCost = '£20-£60';
          expertSpecialty = 'Painter & Decorator';
          toolsNeeded = ['Brushes', 'Rollers', 'Sandpaper', 'Masking tape', 'Filler knife'];
          materialsNeeded = ['Paint', 'Primer', 'Filler', 'Drop cloths', 'Sugar soap'];
          safetyWarnings = ['Ventilate area well', 'Wear old clothes', 'Protect furniture', 'Use dust masks when sanding'];
          stepByStepGuide = ['Clean surface thoroughly', 'Fill cracks if needed', 'Sand smooth', 'Apply primer if needed', 'Paint in thin coats'];
        } else if (keywords.includes('gas') || keywords.includes('boiler') || keywords.includes('heating')) {
          problemType = 'Gas/Heating Issue';
          severity = 'Critical';
          confidence = 'High';
          isDIYFriendly = false;
          estimatedCost = '£150-£500';
          expertSpecialty = 'Gas Safe Registered Engineer';
          toolsNeeded = ['Professional gas detection equipment'];
          materialsNeeded = ['Requires professional assessment'];
          safetyWarnings = ['⚠️ GAS LEAK DANGER: Call emergency gas line 0800 111 999', 'Do not use any electrical switches', 'Open windows', 'Evacuate if smell is strong'];
          stepByStepGuide = ['STOP: Gas work is illegal without Gas Safe registration', 'Turn off gas at meter if safe', 'Call Gas Safe engineer immediately', 'Do not attempt any repairs'];
        }
        
        // Get local stores based on user location
        const cityStores = localStores.get(userLocation.toLowerCase()) || localStores.get('london');
        
        return {
          problemDetected: problemType,
          confidence: confidence,
          severity: severity,
          description: `Based on AI analysis, this appears to be a ${problemType.toLowerCase()}.`,
          isDIYFriendly: isDIYFriendly,
          estimatedCost: estimatedCost,
          confidenceScore: confidence === 'High' ? 95 : confidence === 'Medium' ? 75 : 50,
          recommendedExpertType: expertSpecialty,
          toolsNeeded: toolsNeeded,
          materialsNeeded: materialsNeeded,
          safetyWarnings: safetyWarnings,
          stepByStepGuide: stepByStepGuide,
          localStores: cityStores,
          nextSteps: [
            isDIYFriendly ? 'Review safety guidelines carefully' : 'Contact qualified professional immediately',
            'Gather recommended tools and materials',
            'Follow local building regulations',
            'Document the issue with photos'
          ],
          regulations: problemType.includes('Electrical') ? 'Part P Building Regulations apply' : 
                       problemType.includes('Gas') ? 'Gas Safe regulations - professional only' : 
                       'Check local building control requirements'
        };
      };

      // Enhanced database operations
      const dbOperations = {
        async createUser(userData) {
          const user = {
            id: `user_${Date.now()}`,
            ...userData,
            created_at: new Date().toISOString(),
            location: userData.location || 'London',
            preferences: { theme: 'light', notifications: true },
            subscription: { 
              type: 'free', 
              analysisCount: 0, 
              resetDate: new Date().toISOString() 
            }
          };
          registeredUsers.set(userData.email.toLowerCase(), user);
          
          // Track user activity
          userActivity.push({
            type: 'user_registered',
            timestamp: new Date().toISOString(),
            details: { email: userData.email, type: userData.user_type },
            source: 'registration'
          });
          
          return { success: true, user };
        },
        
        async getUserByEmail(email) {
          return registeredUsers.get(email.toLowerCase());
        },
        
        async updateUser(email, updates) {
          const user = registeredUsers.get(email.toLowerCase());
          if (user) {
            Object.assign(user, updates);
            registeredUsers.set(email.toLowerCase(), user);
            return { success: true, user };
          }
          return { success: false, error: 'User not found' };
        },
        
        async saveMessage(messageData) {
          const messageId = Date.now();
          const message = { 
            id: messageId, 
            ...messageData, 
            timestamp: new Date().toISOString(),
            status: 'unread',
            replies: []
          };
          
          // Add to admin inbox
          adminMessages.set(messageId, message);
          
          // Track activity
          userActivity.push({
            type: 'message_received',
            timestamp: new Date().toISOString(),
            details: { type: messageData.message_type, from: messageData.sender_email },
            source: 'contact'
          });
          
          // No email notification - message goes directly to admin dashboard
          return { success: true, id: messageId };
        },

        async replyToMessage(messageId, replyContent, adminEmail) {
          const message = adminMessages.get(messageId);
          if (!message) return { success: false, error: 'Message not found' };
          
          const reply = {
            id: Date.now(),
            content: replyContent,
            timestamp: new Date().toISOString(),
            from: adminEmail
          };
          
          message.replies.push(reply);
          message.status = 'replied';
          
          // Send email to user
          await sendRealEmail(
            message.sender_email,
            `Re: ${message.subject}`,
            `Dear ${message.sender_name},

${replyContent}

Best regards,
The DIYMatch Team

---
Original message:
${message.content}`,
            'DIYMatch Support',
            APP_CONFIG.adminEmail
          );
          
          return { success: true };
        },

        async saveExpertApplication(applicationData) {
          const applicationId = Date.now();
          const application = {
            id: applicationId,
            ...applicationData,
            status: 'pending',
            submitted_at: new Date().toISOString()
          };
          
          expertApplications.set(applicationId, application);
          
          return { success: true, id: applicationId };
        },

        async saveQuoteRequest(quoteData) {
          const quoteId = Date.now();
          const quote = {
            id: quoteId,
            ...quoteData,
            timestamp: new Date().toISOString(),
            status: 'pending'
          };
          
          if (!quoteRequests.has(quoteData.expertId)) {
            quoteRequests.set(quoteData.expertId, []);
          }
          quoteRequests.get(quoteData.expertId).push(quote);
          
          return { success: true, id: quoteId };
        },

        async saveWaiverAcceptance(waiverData) {
          const waiverId = Date.now();
          const waiver = {
            id: waiverId,
            ...waiverData,
            timestamp: new Date().toISOString(),
            ipAddress: 'captured-in-production' // Would capture real IP
          };
          
          if (!waiverAcceptances.has(waiverData.userEmail)) {
            waiverAcceptances.set(waiverData.userEmail, []);
          }
          waiverAcceptances.get(waiverData.userEmail).push(waiver);
          
          return { success: true, id: waiverId };
        },

        async saveOrder(orderData) {
          const orderId = Date.now();
          const order = {
            id: orderId,
            ...orderData,
            timestamp: new Date().toISOString(),
            status: 'confirmed'
          };
          
          if (!userOrders.has(orderData.customerEmail)) {
            userOrders.set(orderData.customerEmail, []);
          }
          userOrders.get(orderData.customerEmail).push(order);
          
          return { success: true, id: orderId };
        },

        async getUserOrders(userEmail) {
          return userOrders.get(userEmail) || [];
        },

        async checkUserAnalysisLimit(userEmail) {
          const user = registeredUsers.get(userEmail.toLowerCase());
          if (!user) return { canAnalyze: false, reason: 'User not found' };
          
          // Premium users have unlimited analyses
          if (user.subscription.type === 'premium') {
            return { canAnalyze: true, remaining: 'unlimited' };
          }
          
          // Check if month has reset
          const resetDate = new Date(user.subscription.resetDate);
          const now = new Date();
          if (now.getMonth() !== resetDate.getMonth() || now.getFullYear() !== resetDate.getFullYear()) {
            user.subscription.analysisCount = 0;
            user.subscription.resetDate = now.toISOString();
          }
          
          // Check free tier limit
          if (user.subscription.analysisCount >= APP_CONFIG.freeAnalysisLimit) {
            return { 
              canAnalyze: false, 
              reason: 'Free analysis limit reached',
              remaining: 0 
            };
          }
          
          return { 
            canAnalyze: true, 
            remaining: APP_CONFIG.freeAnalysisLimit - user.subscription.analysisCount 
          };
        },

        async incrementAnalysisCount(userEmail) {
          const user = registeredUsers.get(userEmail.toLowerCase());
          if (user && user.subscription.type === 'free') {
            user.subscription.analysisCount++;
          }
        }
      };

      const triggerHaptic = async (type = 'light') => {
        try {
          if (navigator.vibrate) {
            const durations = { light: 50, medium: 100, heavy: 200, success: [50, 100, 50], error: [100, 50, 100] };
            navigator.vibrate(durations[type] || 100);
          }
        } catch (error) {
          console.warn('Haptic feedback failed:', error);
        }
      };

      const takePhoto = async () => {
        return new Promise((resolve) => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'image/*';
          input.capture = 'environment';
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (event) => resolve(event.target.result);
              reader.readAsDataURL(file);
            }
          };
          input.click();
        });
      };

      const uploadCV = async () => {
        return new Promise((resolve) => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.pdf,.doc,.docx';
          input.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (event) => resolve({
                name: file.name,
                size: file.size,
                type: file.type,
                data: event.target.result
              });
              reader.readAsDataURL(file);
            }
          };
          input.click();
        });
      };

      const initializeAppServices = async () => {
        await initializeSupabase();
        initializeEmailService();
        initializeStripe();
        
        // Initialize PWA service worker
        if ('serviceWorker' in navigator) {
          try {
            await navigator.serviceWorker.register('data:text/javascript,self.addEventListener("install",e=>e.waitUntil(caches.open("v1").then(c=>c.addAll(["/"]))));self.addEventListener("fetch",e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));');
            console.log('✅ [PWA] Service Worker registered');
          } catch (error) {
            console.log('❌ [PWA] Service Worker registration failed:', error);
          }
        }
        
        // Remove splash screen
        setTimeout(() => {
          const splash = document.getElementById('splash-screen');
          if (splash) splash.remove();
        }, 1000);
      };

      // ============================================================================
      // CONTEXTS
      // ============================================================================
      
      const AuthContext = createContext();
      const DarkModeContext = createContext();
      const LocationContext = createContext();

      const useAuth = () => useContext(AuthContext);
      const useDarkMode = () => useContext(DarkModeContext);
      const useLocation = () => useContext(LocationContext);

      // ============================================================================
      // WAIVER FORMS
      // ============================================================================
      
      const WAIVERS = {
        aiAnalysis: {
          title: 'AI Analysis Service Agreement & Liability Waiver',
          content: `IMPORTANT: READ CAREFULLY BEFORE PROCEEDING

By using DIYMatch's AI Analysis service, you acknowledge and agree to the following:

1. SERVICE LIMITATIONS:
• AI analysis provides general guidance only, NOT professional advice
• Results are based on image analysis and may not identify all issues
• DIYMatch does not guarantee accuracy or completeness of analysis
• Professional inspection may reveal additional problems

2. SAFETY WARNINGS:
• DIY work carries inherent risks including injury, death, or property damage
• Electrical, gas, plumbing, and structural work require certified professionals
• Always follow local building codes and regulations
• Use appropriate safety equipment and procedures

3. LIABILITY WAIVER:
• You assume ALL risks associated with using this service
• DIYMatch, its owners, employees, and affiliates accept NO liability for:
  - Personal injury or death
  - Property damage or loss
  - Incorrect analysis or recommendations
  - Consequences of following AI suggestions
• You waive all claims against DIYMatch arising from service use

4. PROFESSIONAL ADVICE:
• Always consult qualified tradespeople for:
  - Electrical work (Part P regulations)
  - Gas work (Gas Safe registered only)
  - Structural modifications
  - Work requiring building control approval

5. INDEMNIFICATION:
You agree to indemnify and hold harmless DIYMatch from any claims, damages, or losses arising from your use of this service.

By clicking "I Agree", you confirm:
• You are 18+ years old
• You have read and understood this agreement
• You voluntarily assume all risks
• You waive all liability claims against DIYMatch`
        },
        
        expertBooking: {
          title: 'Expert Booking Terms & Liability Waiver',
          content: `IMPORTANT: READ BEFORE BOOKING AN EXPERT

By booking an expert through DIYMatch, you acknowledge and agree:

1. PLATFORM ROLE:
• DIYMatch is an introduction platform only
• We do NOT employ, endorse, or guarantee any experts
• All work contracts are directly between you and the expert
• We are not responsible for work quality or outcomes

2. EXPERT STATUS:
• Experts are independent contractors, not DIYMatch employees
• We do not verify qualifications, licenses, or insurance
• You must independently verify expert credentials
• Check references and reviews before hiring

3. LIABILITY WAIVER:
• DIYMatch accepts NO liability for:
  - Expert work quality or completion
  - Property damage or personal injury
  - Expert misconduct or negligence
  - Financial losses or disputes
• All risks associated with hiring experts are yours alone

4. YOUR RESPONSIBILITIES:
• Verify expert qualifications and insurance
• Obtain proper permits where required
• Ensure work meets building regulations
• Handle all payments directly with expert
• Resolve disputes directly with expert

5. PAYMENT TERMS:
• Platform fees are non-refundable
• Work payments are between you and expert
• DIYMatch is not responsible for payment disputes
• No warranty or guarantee on expert services

6. SAFETY & COMPLIANCE:
• Ensure expert follows safety procedures
• Verify appropriate insurance coverage
• Check Gas Safe/NICEIC registration where applicable
• Obtain completion certificates as required

7. INDEMNIFICATION:
You indemnify DIYMatch against all claims arising from expert services.

By clicking "I Agree", you confirm:
• You understand DIYMatch's limited role
• You accept all risks of hiring experts
• You waive all claims against DIYMatch
• You will verify expert credentials independently`
        }
      };

      // ============================================================================
      // ENHANCED COMPONENTS
      // ============================================================================

      const WelcomePage = ({ navigateToPage }) => {
        const { isDarkMode, toggleDarkMode } = useDarkMode();
        const { user } = useAuth();

        return h('div', { 
          className: `min-h-screen ${isDarkMode ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-900'} safe-area-top` 
        },
          // Header with logo and dark mode toggle
          h('div', { className: 'sticky top-0 z-40 bg-opacity-90 backdrop-filter backdrop-blur-lg' },
            h('div', { className: 'flex items-center justify-between p-4' },
              h('div', { className: 'flex items-center space-x-2' },
                h('div', { className: 'text-3xl' }, '🔧'),
                h('h1', { className: 'text-xl font-bold' }, 'DIYMatch')
              ),
              h('button', {
                onClick: () => { triggerHaptic('light'); toggleDarkMode(); },
                className: `p-2 rounded-lg mobile-touch ${isDarkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white/80 hover:bg-white'} transition-all shadow-sm`
              }, isDarkMode ? '☀️' : '🌙')
            )
          ),
          
          // Hero Section
          h('div', { className: 'text-center py-16 px-4' },
            h('div', { className: 'max-w-4xl mx-auto' },
              h('h1', { className: 'text-4xl md:text-6xl font-bold mb-6' },
                'Welcome to ',
                h('span', { className: 'text-blue-600' }, 'DIYMatch')
              ),
              h('p', { className: `text-xl md:text-2xl mb-8 ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}` },
                'Professional DIY Solutions at Your Fingertips'
              ),
              h('p', { className: `text-lg mb-12 ${isDarkMode ? 'text-gray-400' : 'text-gray-600'} max-w-3xl mx-auto` },
                'Get instant AI-powered analysis of home repairs, connect with verified local experts, and find the right parts - all in one app.'
              )
            )
          ),
          
          // Main Action Buttons Section
          h('div', { className: 'px-4 py-8' },
            h('div', { className: 'max-w-4xl mx-auto' },
              h('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4 mb-12' },
                // Get FREE AI Analysis Button
                h('button', {
                  onClick: () => {
                    triggerHaptic('medium');
                    if (user) { navigateToPage('analyze'); } else { navigateToPage('signup'); }
                  },
                  className: 'bg-gradient-to-r from-blue-600 to-purple-600 text-white py-6 px-6 rounded-xl text-lg font-semibold mobile-touch shadow-lg flex items-center justify-center space-x-2 hover:shadow-xl transition-all'
                },
                  h('span', null, '🤖'),
                  h('span', null, user ? 'Start AI Analysis' : 'Get FREE AI Analysis')
                ),
                
                // Find Experts Button
                h('button', {
                  onClick: () => {
                    triggerHaptic('medium');
                    if (user) { navigateToPage('experts'); } else { navigateToPage('signup'); }
                  },
                  className: 'bg-gradient-to-r from-green-600 to-blue-600 text-white py-6 px-6 rounded-xl text-lg font-semibold mobile-touch shadow-lg flex items-center justify-center space-x-2 hover:shadow-xl transition-all'
                },
                  h('span', null, '👨‍🔧'),
                  h('span', null, 'Find Local Experts')
                ),
                
                // Sign In/Dashboard Button
                !user ? h('button', {
                  onClick: () => { triggerHaptic('medium'); navigateToPage('login'); },
                  className: `border-2 ${isDarkMode ? 'border-gray-600 text-gray-300 hover:border-gray-500' : 'border-gray-300 text-gray-700 hover:border-gray-400'} py-6 px-6 rounded-xl text-lg font-semibold mobile-touch transition-all flex items-center justify-center space-x-2 hover:shadow-lg`
                },
                  h('span', null, '🔑'),
                  h('span', null, 'Sign In')
                ) : h('button', {
                  onClick: () => { triggerHaptic('medium'); navigateToPage('dashboard'); },
                  className: `border-2 ${isDarkMode ? 'border-gray-600 text-gray-300 hover:border-gray-500' : 'border-gray-300 text-gray-700 hover:border-gray-400'} py-6 px-6 rounded-xl text-lg font-semibold mobile-touch transition-all flex items-center justify-center space-x-2 hover:shadow-lg`
                },
                  h('span', null, '🏠'),
                  h('span', null, 'My Dashboard')
                )
              )
            )
          ),
          
          // Free vs Premium Section
          h('div', { className: `${isDarkMode ? 'bg-gray-800' : 'bg-white'} py-16` },
            h('div', { className: 'max-w-6xl mx-auto px-4' },
              h('h2', { className: 'text-3xl font-bold text-center mb-12' }, 'Choose Your Plan'),
              
              h('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-8' },
                // Free Plan
                h('div', { className: `${isDarkMode ? 'bg-gray-700' : 'bg-gray-50'} rounded-xl p-8` },
                  h('h3', { className: 'text-2xl font-bold mb-4' }, 'Free Plan'),
                  h('p', { className: 'text-3xl font-bold mb-6' }, '£0'),
                  h('ul', { className: 'space-y-3 mb-8' },
                    h('li', { className: 'flex items-center' },
                      h('span', { className: 'text-green-500 mr-2' }, '✓'),
                      h('span', null, '3 AI analyses per month')
                    ),
                    h('li', { className: 'flex items-center' },
                      h('span', { className: 'text-green-500 mr-2' }, '✓'),
                      h('span', null, 'Search local experts')
                    ),
                    h('li', { className: 'flex items-center' },
                      h('span', { className: 'text-green-500 mr-2' }, '✓'),
                      h('span', null, 'Request quotes from experts')
                    ),
                    h('li', { className: 'flex items-center' },
                      h('span', { className: 'text-green-500 mr-2' }, '✓'),
                      h('span', null, 'View local hardware stores')
                    ),
                    h('li', { className: 'flex items-center opacity-50' },
                      h('span', { className: 'text-gray-400 mr-2' }, '✗'),
                      h('span', null, 'Video tutorials')
                    ),
                    h('li', { className: 'flex items-center opacity-50' },
                      h('span', { className: 'text-gray-400 mr-2' }, '✗'),
                      h('span', null, 'Priority expert matching')
                    )
                  ),
                  h('button', {
                    onClick: () => { triggerHaptic('medium'); navigateToPage('signup'); },
                    className: 'w-full bg-gray-600 text-white py-3 px-4 rounded-lg font-semibold mobile-touch'
                  }, user ? 'Current Plan' : 'Get Started Free')
                ),
                
                // Premium Plan
                h('div', { className: 'bg-gradient-to-br from-blue-600 to-purple-600 text-white rounded-xl p-8' },
                  h('div', { className: 'flex items-center justify-between mb-4' },
                    h('h3', { className: 'text-2xl font-bold' }, 'Premium Plan'),
                    h('span', { className: 'bg-yellow-400 text-gray-900 px-2 py-1 rounded text-sm font-bold' }, 'BEST VALUE')
                  ),
                  h('p', { className: 'text-3xl font-bold mb-6' }, APP_CONFIG.premiumPrice),
                  h('ul', { className: 'space-y-3 mb-8' },
                    h('li', { className: 'flex items-center' },
                      h('span', { className: 'text-green-300 mr-2' }, '✓'),
                      h('span', null, 'Unlimited AI analyses')
                    ),
                    h('li', { className: 'flex items-center' },
                      h('span', { className: 'text-green-300 mr-2' }, '✓'),
                      h('span', null, 'Video tutorials & 3D guides')
                    ),
                    h('li', { className: 'flex items-center' },
                      h('span', { className: 'text-green-300 mr-2' }, '✓'),
                      h('span', null, 'Priority expert matching')
                    ),
                    h('li', { className: 'flex items-center' },
                      h('span', { className: 'text-green-300 mr-2' }, '✓'),
                      h('span', null, 'Detailed cost breakdowns')
                    ),
                    h('li', { className: 'flex items-center' },
                      h('span', { className: 'text-green-300 mr-2' }, '✓'),
                      h('span', null, '24/7 priority support')
                    ),
                    h('li', { className: 'flex items-center' },
                      h('span', { className: 'text-green-300 mr-2' }, '✓'),
                      h('span', null, 'Expert consultation credits')
                    )
                  ),
                  h('button', {
                    onClick: async () => {
                      triggerHaptic('medium');
                      if (!user) {
                        navigateToPage('signup');
                        return;
                      }
                      const result = await processPayment('9.99', {
                        email: user.email,
                        name: user.name,
                        description: 'DIYMatch Premium Subscription'
                      }, 'subscription');
                      if (!result.success) {
                        alert('Failed to process subscription. Please try again.');
                      }
                    },
                    className: 'w-full bg-white text-blue-600 py-3 px-4 rounded-lg font-semibold mobile-touch hover:bg-gray-100'
                  }, user ? 'Upgrade to Premium' : 'Start Premium Trial')
                )
              )
            )
          ),
          
          // How DIYMatch Works Section
          h('div', { className: 'py-16 px-4' },
            h('div', { className: 'max-w-6xl mx-auto' },
              h('h2', { className: 'text-3xl font-bold text-center mb-12' }, 'How DIYMatch Works'),
              
              h('div', { className: 'grid grid-cols-1 md:grid-cols-4 gap-8' },
                // Step 1
                h('div', { className: 'text-center' },
                  h('div', { className: 'w-16 h-16 mx-auto mb-4 bg-blue-100 rounded-full flex items-center justify-center' },
                    h('span', { className: 'text-2xl' }, '📸')
                  ),
                  h('h3', { className: 'text-xl font-bold mb-4' }, '1. Capture Problem'),
                  h('p', { className: `${isDarkMode ? 'text-gray-400' : 'text-gray-600'}` }, 
                    'Take a photo and describe your DIY issue'
                  )
                ),
                
                // Step 2
                h('div', { className: 'text-center' },
                  h('div', { className: 'w-16 h-16 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center' },
                    h('span', { className: 'text-2xl' }, '🤖')
                  ),
                  h('h3', { className: 'text-xl font-bold mb-4' }, '2. AI Analysis'),
                  h('p', { className: `${isDarkMode ? 'text-gray-400' : 'text-gray-600'}` }, 
                    'Get instant problem identification and DIY guidance'
                  )
                ),
                
                // Step 3
                h('div', { className: 'text-center' },
                  h('div', { className: 'w-16 h-16 mx-auto mb-4 bg-purple-100 rounded-full flex items-center justify-center' },
                    h('span', { className: 'text-2xl' }, '👨‍🔧')
                  ),
                  h('h3', { className: 'text-xl font-bold mb-4' }, '3. Expert Match'),
                  h('p', { className: `${isDarkMode ? 'text-gray-400' : 'text-gray-600'}` }, 
                    'Connect with qualified local professionals if needed'
                  )
                ),
                
                // Step 4
                h('div', { className: 'text-center' },
                  h('div', { className: 'w-16 h-16 mx-auto mb-4 bg-orange-100 rounded-full flex items-center justify-center' },
                    h('span', { className: 'text-2xl' }, '✅')
                  ),
                  h('h3', { className: 'text-xl font-bold mb-4' }, '4. Get It Fixed'),
                  h('p', { className: `${isDarkMode ? 'text-gray-400' : 'text-gray-600'}` }, 
                    'DIY with confidence or book a verified expert'
                  )
                )
              )
            )
          ),
          
          // Footer
          h('footer', { className: `text-center py-8 px-4 border-t ${isDarkMode ? 'border-gray-700' : 'border-gray-200'} safe-area-bottom` },
            // Legal Disclaimer
            h('div', { className: `${isDarkMode ? 'bg-gray-800' : 'bg-gray-100'} rounded-lg p-4 mb-6 text-left` },
              h('h4', { className: 'font-bold mb-2 text-sm' }, '⚠️ Important Legal Notice'),
              h('p', { className: 'text-xs leading-relaxed' }, 
                'DIYMatch is an information and referral platform only. We do not employ experts or guarantee work quality. ' +
                'All AI analysis is for general guidance only - NOT professional advice. DIY work carries risks of injury, ' +
                'property damage, or death. Always consult certified professionals for electrical, gas, plumbing, or structural work. ' +
                'Users assume full responsibility for their safety and actions. DIYMatch accepts no liability for consequences ' +
                'of using our service or following any recommendations.'
              )
            ),
            h('div', { className: 'flex justify-center space-x-4 mb-4' },
              h('button', {
                onClick: () => { triggerHaptic('light'); navigateToPage('contact'); },
                className: 'text-blue-600 hover:underline text-sm mobile-touch'
              }, 'Contact'),
              h('span', { className: 'text-gray-400' }, '•'),
              h('button', {
                onClick: () => { triggerHaptic('light'); navigateToPage('expert-application'); },
                className: 'text-blue-600 hover:underline text-sm mobile-touch'
              }, 'Become an Expert'),
              h('span', { className: 'text-gray-400' }, '•'),
              h('a', {
                href: '#',
                className: 'text-blue-600 hover:underline text-sm'
              }, 'Terms')
            ),
            h('p', { className: `text-sm ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}` }, 
              '© 2024 DIYMatch - Professional DIY Solutions'
            )
          )
        );
      };

      // Enhanced Admin Dashboard with Complete Analytics
      const AdminDashboardPage = ({ navigateToPage }) => {
        const { isDarkMode } = useDarkMode();
        const { user } = useAuth();
        const [activeTab, setActiveTab] = useState('overview');
        const [selectedPeriod, setSelectedPeriod] = useState('daily');
        const cardClasses = isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900';

        // Calculate real analytics
        const getRevenueByPeriod = (period) => {
          const data = revenueData[period];
          return Array.from(data.entries()).map(([key, value]) => ({
            period: key,
            revenue: value
          }));
        };

        const totalRevenue = Array.from(revenueData.yearly.values()).reduce((sum, val) => sum + val, 0);
        const totalUsers = registeredUsers.size;
        const premiumUsers = Array.from(registeredUsers.values()).filter(u => u.subscription?.type === 'premium').length;
        const totalExperts = Array.from(expertApplications.values()).filter(app => app.status === 'approved').length;
        const pendingApplications = Array.from(expertApplications.values()).filter(app => app.status === 'pending').length;
        const unreadMessages = Array.from(adminMessages.values()).filter(m => m.status === 'unread').length;

        const replyToMessage = async (message) => {
          const reply = prompt(`Reply to ${message.sender_name}:\n\nOriginal message:\n"${message.content}"\n\nYour reply:`);
          if (reply) {
            await dbOperations.replyToMessage(message.id, reply, user.email);
            alert('✅ Reply sent to user\'s email!');
            setActiveTab('inbox'); // Refresh view
          }
        };

        if (user?.user_type !== 'admin') {
          return h('div', { className: `min-h-screen flex items-center justify-center ${isDarkMode ? 'bg-gray-900' : 'bg-gray-50'} p-4` },
            h('div', { className: `${cardClasses} p-8 rounded-xl shadow-lg text-center` },
              h('div', { className: 'text-6xl mb-4' }, '🚫'),
              h('h2', { className: 'text-2xl font-bold mb-4' }, 'Access Denied'),
              h('p', { className: 'mb-6 text-gray-600' }, 'Admin access required.'),
              h('button', {
                onClick: () => navigateToPage('home'),
                className: 'bg-blue-600 text-white py-3 px-4 rounded-lg mobile-touch'
              }, 'Go Home')
            )
          );
        }

        return h('div', { className: `min-h-screen ${isDarkMode ? 'bg-gray-900' : 'bg-gray-50'} safe-area-top pb-20` },
          // Header
          h('div', { className: `${isDarkMode ? 'bg-gray-800' : 'bg-white'} border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-200'} p-4` },
            h('h1', { className: 'text-2xl font-bold' }, '👑 Admin Dashboard'),
            h('p', { className: 'text-sm text-gray-500' }, 'Complete Platform Analytics & Management')
          ),

          // Tab Navigation
          h('div', { className: `${isDarkMode ? 'bg-gray-800' : 'bg-white'} border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-200'}` },
            h('div', { className: 'flex overflow-x-auto' },
              ['overview', 'revenue', 'users', 'experts', 'inbox', 'activity'].map((tab) =>
                h('button', {
                  key: tab,
                  onClick: () => { setActiveTab(tab); triggerHaptic('light'); },
                  className: `px-6 py-3 font-medium mobile-touch transition-all ${
                    activeTab === tab
                      ? 'border-b-2 border-blue-600 text-blue-600'
                      : isDarkMode ? 'text-gray-400 hover:text-gray-300' : 'text-gray-600 hover:text-gray-700'
                  }`
                }, tab.charAt(0).toUpperCase() + tab.slice(1))
              )
            )
          ),

          // Content
          h('div', { className: 'p-4 space-y-6' },
            // Overview Tab
            activeTab === 'overview' && h('div', { className: 'space-y-6' },
              // Key Metrics
              h('div', { className: 'grid grid-cols-1 md:grid-cols-4 gap-4' },
                h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg stat-card` },
                  h('div', { className: 'text-3xl mb-2' }, '💰'),
                  h('h3', { className: 'text-2xl font-bold text-green-600' }, `£${totalRevenue.toFixed(2)}`),
                  h('p', { className: 'text-sm text-gray-600' }, 'Total Revenue')
                ),
                h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg stat-card` },
                  h('div', { className: 'text-3xl mb-2' }, '👥'),
                  h('h3', { className: 'text-2xl font-bold text-blue-600' }, totalUsers.toString()),
                  h('p', { className: 'text-sm text-gray-600' }, `Total Users (${premiumUsers} Premium)`)
                ),
                h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg stat-card` },
                  h('div', { className: 'text-3xl mb-2' }, '🔧'),
                  h('h3', { className: 'text-2xl font-bold text-purple-600' }, totalExperts.toString()),
                  h('p', { className: 'text-sm text-gray-600' }, `Active Experts (${pendingApplications} Pending)`)
                ),
                h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg stat-card` },
                  h('div', { className: 'text-3xl mb-2' }, '📧'),
                  h('h3', { className: 'text-2xl font-bold text-orange-600' }, unreadMessages.toString()),
                  h('p', { className: 'text-sm text-gray-600' }, 'Unread Messages')
                )
              ),

              // Quick Stats
              h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg` },
                h('h3', { className: 'text-lg font-bold mb-4' }, '📊 Platform Statistics'),
                h('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4' },
                  h('div', { className: 'text-center' },
                    h('div', { className: 'text-xl font-bold text-blue-600' }, 
                      userAnalysisHistory.size.toString()
                    ),
                    h('div', { className: 'text-sm text-gray-600' }, 'AI Analyses')
                  ),
                  h('div', { className: 'text-center' },
                    h('div', { className: 'text-xl font-bold text-green-600' }, 
                      userOrders.size.toString()
                    ),
                    h('div', { className: 'text-sm text-gray-600' }, 'Total Orders')
                  ),
                  h('div', { className: 'text-center' },
                    h('div', { className: 'text-xl font-bold text-purple-600' }, 
                      quoteRequests.size.toString()
                    ),
                    h('div', { className: 'text-sm text-gray-600' }, 'Quote Requests')
                  ),
                  h('div', { className: 'text-center' },
                    h('div', { className: 'text-xl font-bold text-orange-600' }, 
                      waiverAcceptances.size.toString()
                    ),
                    h('div', { className: 'text-sm text-gray-600' }, 'Waivers Signed')
                  )
                )
              ),

              // Recent Activity
              h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg` },
                h('h3', { className: 'text-lg font-bold mb-4' }, '📈 Recent Activity'),
                h('div', { className: 'space-y-3 max-h-60 overflow-y-auto' },
                  userActivity.length === 0 ?
                    h('p', { className: 'text-gray-500 text-center py-8' }, 'No activity yet - platform ready for users!') :
                    userActivity.slice(-10).reverse().map((activity, index) =>
                      h('div', { key: index, className: 'flex items-center space-x-3 p-3 bg-gray-50 rounded-lg' },
                        h('div', { className: 'text-lg' }, 
                          activity.type === 'user_registered' ? '👤' :
                          activity.type === 'message_received' ? '📧' :
                          activity.type === 'email_sent' ? '📤' :
                          activity.type === 'analysis_performed' ? '🤖' :
                          activity.type === 'expert_booked' ? '👨‍🔧' :
                          activity.type === 'payment_processed' ? '💳' : '📊'
                        ),
                        h('div', { className: 'flex-1' },
                          h('p', { className: 'font-medium text-sm' }, 
                            activity.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
                          ),
                          h('p', { className: 'text-xs text-gray-500' }, 
                            new Date(activity.timestamp).toLocaleString()
                          )
                        )
                      )
                    )
                )
              )
            ),

            // Revenue Tab
            activeTab === 'revenue' && h('div', { className: 'space-y-6' },
              h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg` },
                h('div', { className: 'flex items-center justify-between mb-4' },
                  h('h3', { className: 'text-lg font-bold' }, '💰 Revenue Analytics'),
                  h('select', {
                    value: selectedPeriod,
                    onChange: (e) => setSelectedPeriod(e.target.value),
                    className: `border rounded-lg px-3 py-1 text-sm ${isDarkMode ? 'border-gray-600 bg-gray-700' : 'border-gray-300'}`
                  },
                    h('option', { value: 'daily' }, 'Daily'),
                    h('option', { value: 'weekly' }, 'Weekly'),
                    h('option', { value: 'monthly' }, 'Monthly'),
                    h('option', { value: 'yearly' }, 'Yearly')
                  )
                ),
                
                h('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-4 mb-6' },
                  h('div', { className: 'bg-green-50 rounded-lg p-4 text-center' },
                    h('h4', { className: 'font-bold text-green-800' }, 'Today'),
                    h('p', { className: 'text-2xl font-bold text-green-600' }, 
                      `£${(revenueData.daily.get(new Date().toISOString().split('T')[0]) || 0).toFixed(2)}`
                    )
                  ),
                  h('div', { className: 'bg-blue-50 rounded-lg p-4 text-center' },
                    h('h4', { className: 'font-bold text-blue-800' }, 'This Month'),
                    h('p', { className: 'text-2xl font-bold text-blue-600' }, 
                      `£${(revenueData.monthly.get(`${new Date().getFullYear()}-${new Date().getMonth() + 1}`) || 0).toFixed(2)}`
                    )
                  ),
                  h('div', { className: 'bg-purple-50 rounded-lg p-4 text-center' },
                    h('h4', { className: 'font-bold text-purple-800' }, 'This Year'),
                    h('p', { className: 'text-2xl font-bold text-purple-600' }, 
                      `£${(revenueData.yearly.get(new Date().getFullYear().toString()) || 0).toFixed(2)}`
                    )
                  )
                ),
                
                h('div', { className: 'space-y-3' },
                  h('h4', { className: 'font-bold mb-2' }, `Revenue by ${selectedPeriod}`),
                  getRevenueByPeriod(selectedPeriod).map((item) =>
                    h('div', { key: item.period, className: 'flex items-center justify-between p-3 bg-gray-50 rounded' },
                      h('span', { className: 'text-sm font-medium' }, item.period),
                      h('span', { className: 'font-bold text-green-600' }, `£${item.revenue.toFixed(2)}`)
                    )
                  )
                ),
                
                h('div', { className: 'mt-6 pt-6 border-t' },
                  h('h4', { className: 'font-bold mb-2' }, 'Revenue Sources'),
                  h('ul', { className: 'space-y-2 text-sm' },
                    h('li', { className: 'flex items-center justify-between' },
                      h('span', null, 'Premium Subscriptions'),
                      h('span', { className: 'font-medium' }, `${premiumUsers} active`)
                    ),
                    h('li', { className: 'flex items-center justify-between' },
                      h('span', null, 'Expert Booking Fees'),
                      h('span', { className: 'font-medium' }, '15% commission')
                    ),
                    h('li', { className: 'flex items-center justify-between' },
                      h('span', null, 'Parts Referral Commission'),
                      h('span', { className: 'font-medium' }, '5-10% commission')
                    )
                  )
                )
              )
            ),

            // Users Tab
            activeTab === 'users' && h('div', { className: 'space-y-6' },
              h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg` },
                h('h3', { className: 'text-lg font-bold mb-4' }, '👥 User Management'),
                h('div', { className: 'mb-4 grid grid-cols-3 gap-4' },
                  h('div', { className: 'bg-blue-50 rounded-lg p-3 text-center' },
                    h('div', { className: 'text-xl font-bold text-blue-600' }, totalUsers.toString()),
                    h('div', { className: 'text-sm text-gray-600' }, 'Total Users')
                  ),
                  h('div', { className: 'bg-green-50 rounded-lg p-3 text-center' },
                    h('div', { className: 'text-xl font-bold text-green-600' }, premiumUsers.toString()),
                    h('div', { className: 'text-sm text-gray-600' }, 'Premium Users')
                  ),
                  h('div', { className: 'bg-purple-50 rounded-lg p-3 text-center' },
                    h('div', { className: 'text-xl font-bold text-purple-600' }, (totalUsers - premiumUsers).toString()),
                    h('div', { className: 'text-sm text-gray-600' }, 'Free Users')
                  )
                ),
                h('div', { className: 'space-y-4 max-h-96 overflow-y-auto' },
                  Array.from(registeredUsers.values()).length === 0 ?
                    h('p', { className: 'text-gray-500 text-center py-8' }, 'No users registered yet') :
                    Array.from(registeredUsers.values()).map((user) =>
                      h('div', { key: user.id, className: 'flex items-center justify-between p-4 border rounded-lg' },
                        h('div', null,
                          h('h4', { className: 'font-bold' }, user.name),
                          h('p', { className: 'text-sm text-gray-600' }, user.email),
                          h('div', { className: 'flex space-x-2 mt-1' },
                            h('span', { className: `px-2 py-1 rounded-full text-xs ${
                              user.user_type === 'admin' ? 'bg-red-100 text-red-800' :
                              user.user_type === 'expert' ? 'bg-blue-100 text-blue-800' :
                              'bg-green-100 text-green-800'
                            }` }, user.user_type),
                            h('span', { className: `px-2 py-1 rounded-full text-xs ${
                              user.subscription?.type === 'premium' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'
                            }` }, user.subscription?.type || 'free')
                          )
                        ),
                        h('div', { className: 'text-right' },
                          h('p', { className: 'text-xs text-gray-500' }, `${user.location || 'Unknown'}`),
                          h('p', { className: 'text-xs text-gray-500' }, 
                            new Date(user.created_at).toLocaleDateString()
                          ),
                          user.subscription?.type === 'free' && h('p', { className: 'text-xs font-medium' }, 
                            `${user.subscription.analysisCount || 0}/${APP_CONFIG.freeAnalysisLimit} analyses used`
                          )
                        )
                      )
                    )
                )
              )
            ),

            // Experts Tab
            activeTab === 'experts' && h('div', { className: 'space-y-6' },
              h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg` },
                h('h3', { className: 'text-lg font-bold mb-4' }, '🔧 Expert Applications'),
                h('div', { className: 'mb-4 grid grid-cols-3 gap-4' },
                  h('div', { className: 'bg-green-50 rounded-lg p-3 text-center' },
                    h('div', { className: 'text-xl font-bold text-green-600' }, 
                      Array.from(expertApplications.values()).filter(a => a.status === 'approved').length.toString()
                    ),
                    h('div', { className: 'text-sm text-gray-600' }, 'Approved')
                  ),
                  h('div', { className: 'bg-yellow-50 rounded-lg p-3 text-center' },
                    h('div', { className: 'text-xl font-bold text-yellow-600' }, 
                      Array.from(expertApplications.values()).filter(a => a.status === 'pending').length.toString()
                    ),
                    h('div', { className: 'text-sm text-gray-600' }, 'Pending')
                  ),
                  h('div', { className: 'bg-red-50 rounded-lg p-3 text-center' },
                    h('div', { className: 'text-xl font-bold text-red-600' }, 
                      Array.from(expertApplications.values()).filter(a => a.status === 'rejected').length.toString()
                    ),
                    h('div', { className: 'text-sm text-gray-600' }, 'Rejected')
                  )
                ),
                h('div', { className: 'space-y-4' },
                  Array.from(expertApplications.values()).length === 0 ?
                    h('p', { className: 'text-gray-500 text-center py-8' }, 'No expert applications yet') :
                    Array.from(expertApplications.values()).map((application) =>
                      h('div', { key: application.id, className: 'border rounded-lg p-4' },
                        h('div', { className: 'flex items-start justify-between mb-3' },
                          h('div', null,
                            h('h4', { className: 'font-bold' }, application.name),
                            h('p', { className: 'text-sm text-gray-600' }, `${application.profession} • ${application.experience}`),
                            h('p', { className: 'text-sm text-gray-500' }, application.email),
                            h('p', { className: 'text-sm text-gray-500' }, `📍 ${application.postcode}`),
                            h('p', { className: 'text-sm text-gray-500' }, `💰 ${application.rates}`),
                            h('div', { className: 'mt-2' },
                              h('p', { className: 'text-xs font-medium' }, 'Insurance:'),
                              h('p', { className: 'text-xs text-gray-600' }, application.insurance)
                            )
                          ),
                          h('span', { className: `px-3 py-1 rounded-full text-sm ${
                            application.status === 'approved' ? 'bg-green-100 text-green-800' :
                            application.status === 'rejected' ? 'bg-red-100 text-red-800' :
                            'bg-yellow-100 text-yellow-800'
                          }` }, application.status.toUpperCase())
                        ),
                        h('div', { className: 'mb-3' },
                          h('p', { className: 'text-sm font-medium mb-1' }, 'Certifications:'),
                          h('p', { className: 'text-sm text-gray-600' }, application.certifications)
                        ),
                        application.cvData && h('div', { className: 'mb-3' },
                          h('span', { className: 'text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded' }, 
                            `📄 CV: ${application.cvData.name}`
                          )
                        ),
                        application.status === 'pending' && h('div', { className: 'flex space-x-2' },
                          h('button', {
                            onClick: async () => {
                              expertApplications.set(application.id, { ...application, status: 'approved' });
                              await sendRealEmail(
                                application.email,
                                '✅ Expert Application Approved - DIYMatch',
                                `Congratulations ${application.name}!

Your expert application has been approved. You can now:
• Accept booking requests from customers
• Set your availability and rates
• Build your reputation through our platform

Next steps:
1. Complete your expert profile
2. Upload portfolio photos
3. Start accepting jobs

Welcome to the DIYMatch expert network!

Best regards,
The DIYMatch Team`
                              );
                              alert('Expert approved and notified!');
                              setActiveTab('experts'); // Refresh
                            },
                            className: 'bg-green-600 text-white px-3 py-1 rounded text-sm mobile-touch'
                          }, '✅ Approve'),
                          h('button', {
                            onClick: async () => {
                              const reason = prompt('Rejection reason:');
                              if (reason) {
                                expertApplications.set(application.id, { ...application, status: 'rejected' });
                                await sendRealEmail(
                                  application.email,
                                  'Expert Application Update - DIYMatch',
                                  `Dear ${application.name},

Thank you for your interest in joining DIYMatch.

Unfortunately, we cannot approve your application at this time:
${reason}

You're welcome to reapply once you meet our requirements.

Best regards,
The DIYMatch Team`
                                );
                                alert('Expert rejected and notified!');
                                setActiveTab('experts'); // Refresh
                              }
                            },
                            className: 'bg-red-600 text-white px-3 py-1 rounded text-sm mobile-touch'
                          }, '❌ Reject')
                        )
                      )
                    )
                )
              )
            ),

            // Inbox Tab
            activeTab === 'inbox' && h('div', { className: 'space-y-6' },
              h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg` },
                h('h3', { className: 'text-lg font-bold mb-4' }, '📧 Support Inbox'),
                h('div', { className: 'mb-4' },
                  h('div', { className: 'bg-orange-50 rounded-lg p-3' },
                    h('p', { className: 'text-sm text-orange-800' }, 
                      `${unreadMessages} unread message${unreadMessages !== 1 ? 's' : ''}`
                    )
                  )
                ),
                h('div', { className: 'space-y-4' },
                  Array.from(adminMessages.values()).length === 0 ? 
                    h('p', { className: 'text-gray-500 text-center py-8' }, 'No messages yet') :
                    Array.from(adminMessages.values()).sort((a, b) => 
                      new Date(b.timestamp) - new Date(a.timestamp)
                    ).map((message) =>
                      h('div', { 
                        key: message.id, 
                        className: `border rounded-lg p-4 ${message.status === 'unread' ? 'bg-blue-50 border-blue-300' : ''}`
                      },
                        h('div', { className: 'flex items-start justify-between mb-3' },
                          h('div', null,
                            h('h4', { className: 'font-bold' }, message.subject),
                            h('p', { className: 'text-sm text-gray-600' }, `From: ${message.sender_name} (${message.sender_email})`),
                            h('p', { className: 'text-xs text-gray-500' }, new Date(message.timestamp).toLocaleString()),
                            message.urgency === 'urgent' && h('span', { className: 'text-xs bg-red-100 text-red-800 px-2 py-1 rounded mt-1 inline-block' }, 
                              '🚨 URGENT'
                            )
                          ),
                          h('div', { className: 'flex space-x-2' },
                            h('button', {
                              onClick: () => replyToMessage(message),
                              className: 'bg-blue-600 text-white px-3 py-1 rounded text-sm mobile-touch'
                            }, '📧 Reply'),
                            h('button', {
                              onClick: () => {
                                adminMessages.delete(message.id);
                                alert('Message deleted');
                                setActiveTab('inbox'); // Refresh
                              },
                              className: 'bg-red-600 text-white px-3 py-1 rounded text-sm mobile-touch'
                            }, '🗑️')
                          )
                        ),
                        h('div', { className: 'bg-gray-50 rounded p-3 mb-3' },
                          h('p', { className: 'text-sm whitespace-pre-wrap' }, message.content)
                        ),
                        message.replies && message.replies.length > 0 && h('div', { className: 'mt-3 pt-3 border-t' },
                          h('h5', { className: 'font-medium text-sm mb-2' }, 'Replies:'),
                          ...message.replies.map((reply) =>
                            h('div', { key: reply.id, className: 'bg-green-50 rounded p-2 mb-2' },
                              h('p', { className: 'text-xs text-gray-500 mb-1' }, 
                                `You replied on ${new Date(reply.timestamp).toLocaleString()}`
                              ),
                              h('p', { className: 'text-sm' }, reply.content)
                            )
                          )
                        )
                      )
                    )
                )
              )
            ),

            // Activity Tab
            activeTab === 'activity' && h('div', { className: 'space-y-6' },
              h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg` },
                h('h3', { className: 'text-lg font-bold mb-4' }, '📊 Platform Activity Log'),
                h('div', { className: 'space-y-3 max-h-96 overflow-y-auto' },
                  userActivity.length === 0 ?
                    h('p', { className: 'text-gray-500 text-center py-8' }, 'No activity recorded yet') :
                    userActivity.slice().reverse().map((activity, index) =>
                      h('div', { key: index, className: 'flex items-start space-x-3 p-3 bg-gray-50 rounded-lg' },
                        h('div', { className: 'text-lg mt-1' }, 
                          activity.type === 'user_registered' ? '👤' :
                          activity.type === 'message_received' ? '📧' :
                          activity.type === 'email_sent' ? '📤' :
                          activity.type === 'analysis_performed' ? '🤖' :
                          activity.type === 'expert_booked' ? '👨‍🔧' :
                          activity.type === 'payment_processed' ? '💳' :
                          activity.type === 'quote_requested' ? '💬' :
                          activity.type === 'waiver_signed' ? '📝' : '📊'
