<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="DIYMatch">
  <meta name="description" content="AI-powered DIY assistant connecting you with verified experts and providing instant problem analysis">
  
  <title>DIYMatch - AI-Powered DIY Assistant</title>
  
  <!-- Icons for various platforms -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üîß</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üîß</text></svg>">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com/3.4.0"></script>
  
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    input, textarea, select {
      -webkit-user-select: text;
      user-select: text;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      background-color: #f9fafb;
    }
    
    .safe-area-top { padding-top: env(safe-area-inset-top); }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    
    .mobile-touch {
      cursor: pointer;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }
    
    .mobile-touch:active {
      transform: scale(0.98);
      opacity: 0.8;
    }
    
    .loading-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .analysis-progress {
      background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    button { touch-action: manipulation; }
    input[type="text"], input[type="email"], input[type="password"], input[type="tel"], textarea, select { font-size: 16px !important; }
    
    .splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #2563eb 0%, #8b5cf6 100%);
      display: flex; align-items: center; justify-content: center; z-index: 9999; color: white;
    }

    .offline-message {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #ef4444;
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 10000;
      font-size: 14px;
    }

    .error-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      padding: 20px;
      text-align: center;
    }

    /* Enhanced UI Elements */
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .gradient-border {
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      padding: 2px;
      border-radius: 12px;
    }

    .float-animation {
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ef4444;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: bold;
    }

    /* Star Rating */
    .star-rating {
      display: flex;
      gap: 4px;
    }

    .star {
      font-size: 20px;
      color: #d1d5db;
      cursor: pointer;
      transition: color 0.2s;
    }

    .star.filled {
      color: #fbbf24;
    }

    .star:hover {
      color: #fbbf24;
    }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
    }

    .progress-step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .progress-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: #e5e7eb;
    }

    .progress-step.completed:not(:last-child)::after {
      background: #3b82f6;
    }

    .progress-step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e5e7eb;
      margin: 0 auto 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 1;
    }

    .progress-step.completed .progress-step-circle {
      background: #3b82f6;
      color: white;
    }

    .progress-step.active .progress-step-circle {
      background: #3b82f6;
      color: white;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
    }

    /* Voice Recording Animation */
    .recording-animation {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #ef4444;
      position: relative;
      animation: recordPulse 1.5s ease-in-out infinite;
    }

    @keyframes recordPulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Chat Bubbles */
    .chat-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      margin-bottom: 8px;
      word-wrap: break-word;
    }

    .chat-bubble.user {
      background: #3b82f6;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .chat-bubble.expert {
      background: #f3f4f6;
      color: #1f2937;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    /* AR View Placeholder */
    .ar-view {
      position: relative;
      width: 100%;
      height: 300px;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }

    .ar-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      text-align: center;
    }

    /* Emergency Button */
    .emergency-button {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      animation: emergencyPulse 2s ease-in-out infinite;
    }

    @keyframes emergencyPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
    }

    /* Skeleton Loading */
    .skeleton {
      background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
      background-size: 200% 100%;
      animation: skeleton 1.2s ease-in-out infinite;
    }

    @keyframes skeleton {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body>
  <div id="offline-message" class="offline-message" style="display: none;">
    No internet connection. Some features may not work.
  </div>

  <div id="error-screen" class="error-screen" style="display: none;">
    <div>
      <div style="font-size: 60px; margin-bottom: 20px;">‚ö†Ô∏è</div>
      <h2 style="font-size: 24px; margin-bottom: 10px; color: #1f2937;">Loading Error</h2>
      <p style="color: #6b7280; margin-bottom: 20px;">Please check your internet connection and try again.</p>
      <button onclick="location.reload()" style="background: #2563eb; color: white; padding: 12px 24px; border-radius: 8px; border: none; font-size: 16px;">
        Retry
      </button>
    </div>
  </div>

  <div id="root"></div>
  
  <!-- Splash Screen -->
  <div id="splash-screen" class="splash-screen">
    <div class="text-center">
      <div class="text-6xl mb-4 animate-bounce">üîß</div>
      <h1 class="text-3xl font-bold mb-2">DIYMatch</h1>
      <p class="text-lg opacity-80">AI-Powered DIY Assistant</p>
      <div class="mt-8">
        <div class="loading-pulse inline-block w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
      </div>
    </div>
  </div>

  <!-- React 18 with Babel Standalone for JSX -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.5/babel.min.js"></script>
  
  <script type="text/babel">
    // ============================================================================
    // CONNECTIVITY & ERROR HANDLING
    // ============================================================================
    
    function checkConnectivity() {
      const offlineMessage = document.getElementById('offline-message');
      if (!navigator.onLine) {
        offlineMessage.style.display = 'block';
      } else {
        offlineMessage.style.display = 'none';
      }
    }

    window.addEventListener('online', checkConnectivity);
    window.addEventListener('offline', checkConnectivity);
    checkConnectivity();

    // Error boundary for React
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true };
      }

      componentDidCatch(error, errorInfo) {
        console.error('Error caught by boundary:', error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-screen flex items-center justify-center p-4">
              <div className="text-center">
                <div className="text-6xl mb-4">üòî</div>
                <h1 className="text-2xl font-bold mb-2">Something went wrong</h1>
                <p className="text-gray-600 mb-4">Please refresh the page to try again</p>
                <button
                  onClick={() => window.location.reload()}
                  className="bg-blue-600 text-white px-6 py-3 rounded-lg"
                >
                  Refresh Page
                </button>
              </div>
            </div>
          );
        }

        return this.props.children;
      }
    }

    // ============================================================================
    // CONFIGURATION
    // ============================================================================
    
    const APP_CONFIG = {
      name: 'DIYMatch',
      version: '2.0.0',
      description: 'AI-Powered DIY Assistant with Expert Network',
      adminEmail: 'yahye21@hotmail.com',
      adminPassword: 'Graphics41_',
      supportEmail: 'support@diymatch.co.uk',
      aiAnalysisPrice: 4.99,
      sameDayMultiplier: 1.5,
      platformCommission: 0.15,
      sameDayCommission: 0.20,
      emergencyHotline: '0800-DIY-HELP',
      maxImageSize: 10 * 1024 * 1024, // 10MB
      maxVideoSize: 100 * 1024 * 1024, // 100MB
      freeAnalysesPerMonth: 1,
      referralBonus: 5.00,
      expertVerificationRequired: true,
      minimumExpertRating: 4.0,
      responseTimeTargets: {
        urgent: '1 hour',
        normal: '4 hours',
        scheduled: '24 hours'
      }
    };

    // ============================================================================
    // ENHANCED GLOBAL STATE
    // ============================================================================
    
    const registeredUsers = new Map();
    const expertProfiles = new Map();
    const quoteRequests = new Map();
    const bookings = new Map();
    const aiAnalysisHistory = new Map();
    const userAnalysisPurchases = new Map();
    const userFreeAnalyses = new Map();
    const userMessages = new Map();
    const messageThreads = new Map();
    const expertReviews = new Map();
    const savedProjects = new Map();
    const emergencyRequests = new Map();
    const userNotifications = new Map();
    const referralCodes = new Map();
    const expertPortfolios = new Map();
    const voiceNotes = new Map();
    const arSessions = new Map();
    
    // Parts stores database
    const partsStores = new Map([
      ['london', [
        {
          id: 'store1',
          name: 'B&Q Wembley',
          address: 'Stadium Retail Park, Wembley, HA9 0EW',
          phone: '020 8902 7200',
          distance: '2.3 miles',
          categories: ['plumbing', 'electrical', 'tools', 'paint', 'building'],
          openHours: 'Mon-Sat: 7am-8pm, Sun: 10am-4pm',
          hasParking: true,
          wheelchairAccess: true,
          inStockItems: 847
        },
        {
          id: 'store2',
          name: 'Screwfix Camden',
          address: '45 Camden High St, NW1 7JH',
          phone: '020 7387 4488',
          distance: '4.1 miles',
          categories: ['tools', 'electrical', 'plumbing', 'safety'],
          openHours: 'Mon-Fri: 6am-8pm, Sat: 7am-6pm, Sun: 9am-4pm',
          hasParking: false,
          wheelchairAccess: true,
          inStockItems: 523
        },
        {
          id: 'store3',
          name: 'Wickes Tottenham',
          address: 'Broad Lane, N15 4QD',
          phone: '020 8808 3366',
          distance: '5.2 miles',
          categories: ['building', 'plumbing', 'paint', 'tools'],
          openHours: 'Mon-Sat: 7am-7pm, Sun: 10am-4pm',
          hasParking: true,
          wheelchairAccess: true,
          inStockItems: 692
        }
      ]]
    ]);

    // Demo expert profiles with enhanced data
    const demoExperts = [
      {
        id: 'expert1',
        name: 'John Smith',
        email: 'john@example.com',
        phone: '07123456789',
        profession: 'Master Plumber',
        postcode: 'NW1',
        location: 'Camden, London',
        bio: 'Professional plumber with 15 years experience. Specialized in emergency repairs, bathroom installations, and eco-friendly solutions. Available 24/7 for emergencies.',
        hourlyRate: 45,
        rating: 4.8,
        reviews: 127,
        completedJobs: 342,
        responseTime: '< 1 hour',
        availability: ['Mon-Fri', 'Weekends', 'Emergency 24/7'],
        certifications: 'City & Guilds Level 3 Plumbing, Water Regulations',
        insurance: 'Public Liability ¬£2M',
        specialties: ['Emergency Repairs', 'Leak Detection', 'Bathroom Installation'],
        verified: true,
        joinedDate: '2022-03-15',
        languages: ['English', 'Polish'],
        transportMode: 'Van',
        toolsProvided: true,
        guaranteeOffered: '12 months',
        badges: ['Top Rated', 'Quick Response', 'Eco Friendly']
      },
      {
        id: 'expert2',
        name: 'Sarah Johnson',
        email: 'sarah@example.com',
        phone: '07987654321',
        profession: 'Certified Electrician',
        postcode: 'E1',
        location: 'Tower Hamlets, London',
        bio: 'NICEIC approved electrician. Expert in domestic installations, testing, smart home systems, and EV charger installations. Committed to safety and innovation.',
        hourlyRate: 55,
        rating: 4.9,
        reviews: 89,
        completedJobs: 256,
        responseTime: '< 2 hours',
        availability: ['Mon-Sat', 'Emergency weekends'],
        certifications: 'NICEIC Approved, 18th Edition, EV Charging Installation',
        insurance: 'Professional Indemnity ¬£5M',
        specialties: ['Smart Home', 'EV Chargers', 'Safety Inspections'],
        verified: true,
        joinedDate: '2021-11-08',
        languages: ['English', 'French'],
        transportMode: 'Van',
        toolsProvided: true,
        guaranteeOffered: '18 months',
        badges: ['5 Star Expert', 'Smart Home Pro', 'Safety First']
      },
      {
        id: 'expert3',
        name: 'Mike Wilson',
        email: 'mike@example.com',
        phone: '07456789123',
        profession: 'Handyman & Carpenter',
        postcode: 'SW1',
        location: 'Westminster, London',
        bio: 'Versatile handyman with carpentry expertise. No job too small! Specializing in furniture assembly, shelving, repairs, and general maintenance.',
        hourlyRate: 35,
        rating: 4.7,
        reviews: 203,
        completedJobs: 567,
        responseTime: '< 3 hours',
        availability: ['Mon-Sat'],
        certifications: 'City & Guilds Carpentry Level 2',
        insurance: 'Public Liability ¬£1M',
        specialties: ['Furniture Assembly', 'Shelving', 'General Repairs'],
        verified: true,
        joinedDate: '2020-06-22',
        languages: ['English'],
        transportMode: 'Van',
        toolsProvided: true,
        guaranteeOffered: '6 months',
        badges: ['Popular Choice', 'Great Value']
      }
    ];

    // Initialize demo experts
    demoExperts.forEach(expert => {
      expertProfiles.set(expert.id, expert);
      expertReviews.set(expert.id, [
        {
          id: `review_${expert.id}_1`,
          userName: 'Alice M.',
          rating: 5,
          date: '2024-01-15',
          comment: 'Excellent work! Very professional and efficient.',
          jobType: 'Emergency Repair'
        },
        {
          id: `review_${expert.id}_2`,
          userName: 'David K.',
          rating: 4,
          date: '2024-01-20',
          comment: 'Good service, arrived on time and fixed the issue quickly.',
          jobType: 'Installation'
        }
      ]);
      expertPortfolios.set(expert.id, [
        {
          id: `portfolio_${expert.id}_1`,
          title: 'Bathroom Renovation',
          description: 'Complete bathroom makeover with modern fixtures',
          images: ['https://via.placeholder.com/300x200?text=Before', 'https://via.placeholder.com/300x200?text=After'],
          date: '2023-12-01'
        }
      ]);
    });

    // ============================================================================
    // ENHANCED UTILITY FUNCTIONS
    // ============================================================================
    
    const triggerHaptic = (type = 'light') => {
      if (navigator.vibrate) {
        const patterns = {
          light: 50,
          medium: 100,
          heavy: 200,
          success: [50, 100, 50],
          error: [100, 50, 100],
          warning: [200, 100, 200]
        };
        navigator.vibrate(patterns[type] || 50);
      }
    };

    const takePhoto = () => {
      return new Promise((resolve) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.capture = 'environment';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            if (file.size > APP_CONFIG.maxImageSize) {
              alert(`Image must be less than ${APP_CONFIG.maxImageSize / 1024 / 1024}MB`);
              return;
            }
            const reader = new FileReader();
            reader.onload = (event) => resolve({ type: 'image', data: event.target.result, file });
            reader.readAsDataURL(file);
          }
        };
        input.click();
      });
    };

    const takeVideo = () => {
      return new Promise((resolve) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'video/*';
        input.capture = 'environment';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file && file.size <= APP_CONFIG.maxVideoSize) {
            const reader = new FileReader();
            reader.onload = (event) => resolve({ type: 'video', data: event.target.result, file });
            reader.readAsDataURL(file);
          } else if (file) {
            alert(`Video must be less than ${APP_CONFIG.maxVideoSize / 1024 / 1024}MB`);
          }
        };
        input.click();
      });
    };

    const recordVoiceNote = () => {
      return new Promise((resolve) => {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('Voice recording not supported on this device');
          resolve(null);
          return;
        }

        // Simulated voice recording for demo
        const duration = prompt('Record voice note (enter duration in seconds):');
        if (duration) {
          resolve({
            type: 'voice',
            duration: parseInt(duration),
            data: 'data:audio/webm;base64,simulatedVoiceData',
            timestamp: new Date().toISOString()
          });
        } else {
          resolve(null);
        }
      });
    };

    const getUserLocation = async () => {
      return new Promise((resolve) => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              resolve({
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                city: 'London' // Would use reverse geocoding API in production
              });
            },
            (error) => {
              console.error('Location error:', error);
              resolve({ city: 'London', error: true });
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
          );
        } else {
          resolve({ city: 'London', error: true });
        }
      });
    };

    const calculateDistance = (lat1, lon1, lat2, lon2) => {
      const R = 6371; // Radius of the earth in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const d = R * c; // Distance in km
      return d;
    };

    // Enhanced payment processing with multiple methods
    const processPayment = async (amount, metadata, method = 'card') => {
      console.log('Processing payment:', { amount, metadata, method });
      
      // Show payment UI
      const paymentConfirmed = confirm(`
        Payment Summary:
        Amount: ¬£${amount.toFixed(2)}
        Method: ${method}
        Description: ${metadata.description || 'DIYMatch Service'}
        
        Proceed with payment?
      `);
      
      if (!paymentConfirmed) {
        return { success: false, error: 'Payment cancelled' };
      }
      
      // Simulate payment processing
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      // Generate payment record
      const paymentRecord = {
        id: `pay_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        amount,
        method,
        metadata,
        timestamp: new Date().toISOString(),
        status: 'completed'
      };
      
      return { success: true, paymentId: paymentRecord.id, record: paymentRecord };
    };

    // Push notification simulation
    const sendPushNotification = async (userId, notification) => {
      if (!userNotifications.has(userId)) {
        userNotifications.set(userId, []);
      }
      
      const notificationData = {
        id: `notif_${Date.now()}`,
        ...notification,
        timestamp: new Date().toISOString(),
        read: false
      };
      
      userNotifications.get(userId).push(notificationData);
      
      // Show browser notification if permitted
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(notification.title, {
          body: notification.body,
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">üîß</text></svg>',
          badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">üîß</text></svg>'
        });
      }
      
      return notificationData;
    };

    // Generate referral code
    const generateReferralCode = (userId) => {
      const code = `DIY${userId.substring(5, 9).toUpperCase()}${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
      referralCodes.set(code, {
        userId,
        uses: 0,
        earnings: 0,
        created: new Date().toISOString()
      });
      return code;
    };

    // Check referral code
    const applyReferralCode = (code, newUserId) => {
      const referral = referralCodes.get(code);
      if (referral && referral.userId !== newUserId) {
        referral.uses++;
        referral.earnings += APP_CONFIG.referralBonus;
        return { valid: true, referrerId: referral.userId, bonus: APP_CONFIG.referralBonus };
      }
      return { valid: false };
    };

    // Free analysis management
    const checkFreeAnalysisAvailable = (userEmail) => {
      const currentMonth = new Date().toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      const userRecord = userFreeAnalyses.get(userEmail);
      
      if (!userRecord || userRecord.month !== currentMonth) {
        return true;
      }
      
      return userRecord.used < APP_CONFIG.freeAnalysesPerMonth;
    };

    const useFreeAnalysis = (userEmail) => {
      const currentMonth = new Date().toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      const userRecord = userFreeAnalyses.get(userEmail) || { month: currentMonth, used: 0 };
      
      if (userRecord.month !== currentMonth) {
        userRecord.month = currentMonth;
        userRecord.used = 0;
      }
      
      userRecord.used++;
      userRecord.lastUsed = new Date().toISOString();
      userFreeAnalyses.set(userEmail, userRecord);
    };

    const getNextFreeAnalysisDate = () => {
      const now = new Date();
      const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      return nextMonth.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    };

    // ============================================================================
    // ENHANCED DATABASE OPERATIONS
    // ============================================================================
    
    const dbOperations = {
      // User operations
      async createUser(userData) {
        const user = {
          id: `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          ...userData,
          createdAt: new Date().toISOString(),
          analysisCount: 0,
          totalSpent: 0,
          referralCode: generateReferralCode(`user_${Date.now()}`),
          settings: {
            notifications: true,
            newsletter: false,
            twoFactor: false,
            language: 'en',
            theme: 'light'
          },
          achievements: [],
          savedExperts: [],
          blockedExperts: []
        };
        registeredUsers.set(userData.email.toLowerCase(), user);
        return { success: true, user };
      },

      async getUserByEmail(email) {
        return registeredUsers.get(email.toLowerCase());
      },

      async updateUser(email, updates) {
        const user = registeredUsers.get(email.toLowerCase());
        if (user) {
          Object.assign(user, updates);
          return { success: true, user };
        }
        return { success: false, error: 'User not found' };
      },

      // Expert operations
      async createExpert(expertData) {
        const expert = {
          id: `expert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          ...expertData,
          createdAt: new Date().toISOString(),
          verified: false,
          rating: 0,
          reviews: 0,
          completedJobs: 0,
          responseRate: 100,
          badges: [],
          portfolio: [],
          earnings: 0,
          accountStatus: 'pending_verification'
        };
        expertProfiles.set(expert.id, expert);
        return { success: true, expert };
      },

      async updateExpert(expertId, updates) {
        const expert = expertProfiles.get(expertId);
        if (expert) {
          Object.assign(expert, updates);
          return { success: true, expert };
        }
        return { success: false, error: 'Expert not found' };
      },

      // Quote operations
      async createQuoteRequest(quoteData) {
        const quote = {
          id: `quote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          ...quoteData,
          status: 'pending',
          createdAt: new Date().toISOString(),
          responses: [],
          selectedExpertId: null
        };
        
        if (!quoteRequests.has(quoteData.userEmail)) {
          quoteRequests.set(quoteData.userEmail, []);
        }
        quoteRequests.get(quoteData.userEmail).push(quote);
        
        // Notify relevant experts
        const relevantExperts = Array.from(expertProfiles.values()).filter(expert => 
          expert.profession.toLowerCase().includes(quoteData.category.toLowerCase())
        );
        
        relevantExperts.forEach(expert => {
          sendPushNotification(expert.id, {
            title: 'New Quote Request',
            body: `${quoteData.urgency === 'urgent' ? 'üö® URGENT: ' : ''}${quoteData.description.substring(0, 50)}...`,
            type: 'quote_request',
            data: quote
          });
        });
        
        return { success: true, quote };
      },

      async respondToQuote(quoteId, expertId, response) {
        // Find the quote across all users
        for (const [userEmail, quotes] of quoteRequests.entries()) {
          const quote = quotes.find(q => q.id === quoteId);
          if (quote) {
            const expertResponse = {
              expertId,
              ...response,
              timestamp: new Date().toISOString()
            };
            quote.responses.push(expertResponse);
            
            // Notify user
            sendPushNotification(userEmail, {
              title: 'New Quote Response',
              body: `You have a new quote from an expert`,
              type: 'quote_response',
              data: expertResponse
            });
            
            return { success: true, response: expertResponse };
          }
        }
        return { success: false, error: 'Quote not found' };
      },

      // Booking operations
      async createBooking(bookingData) {
        const booking = {
          id: `booking_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          ...bookingData,
          status: 'confirmed',
          createdAt: new Date().toISOString(),
          updates: [],
          chatEnabled: true,
          expertArrived: false,
          jobStarted: false,
          jobCompleted: false,
          paymentStatus: 'paid',
          customerSatisfaction: null
        };
        
        if (!bookings.has(bookingData.userEmail)) {
          bookings.set(bookingData.userEmail, []);
        }
        bookings.get(bookingData.userEmail).push(booking);
        
        // Update expert's completed jobs count
        const expert = expertProfiles.get(bookingData.expertId);
        if (expert) {
          expert.completedJobs++;
        }
        
        return { success: true, booking };
      },

      async updateBooking(bookingId, updates) {
        for (const [userEmail, userBookings] of bookings.entries()) {
          const booking = userBookings.find(b => b.id === bookingId);
          if (booking) {
            Object.assign(booking, updates);
            booking.updates.push({
              timestamp: new Date().toISOString(),
              changes: updates
            });
            return { success: true, booking };
          }
        }
        return { success: false, error: 'Booking not found' };
      },

      // AI Analysis operations
      async saveAnalysis(analysisData) {
        const analysis = {
          id: `analysis_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          ...analysisData,
          timestamp: new Date().toISOString(),
          followUpActions: [],
          expertContacted: false,
          issueResolved: false
        };
        
        if (!aiAnalysisHistory.has(analysisData.userEmail)) {
          aiAnalysisHistory.set(analysisData.userEmail, []);
        }
        aiAnalysisHistory.get(analysisData.userEmail).push(analysis);
        
        // Update user's analysis count
        const user = registeredUsers.get(analysisData.userEmail);
        if (user) {
          user.analysisCount++;
        }
        
        return { success: true, analysis };
      },

      // Review operations
      async createReview(reviewData) {
        const review = {
          id: `review_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          ...reviewData,
          timestamp: new Date().toISOString(),
          verified: true,
          helpful: 0,
          reported: false
        };
        
        if (!expertReviews.has(reviewData.expertId)) {
          expertReviews.set(reviewData.expertId, []);
        }
        expertReviews.get(reviewData.expertId).push(review);
        
        // Update expert's rating
        const expert = expertProfiles.get(reviewData.expertId);
        if (expert) {
          const allReviews = expertReviews.get(reviewData.expertId);
          const totalRating = allReviews.reduce((sum, r) => sum + r.rating, 0);
          expert.rating = (totalRating / allReviews.length).toFixed(1);
          expert.reviews = allReviews.length;
        }
        
        return { success: true, review };
      },

      // Project operations
      async saveProject(projectData) {
        const project = {
          id: `project_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          ...projectData,
          createdAt: new Date().toISOString(),
          lastModified: new Date().toISOString(),
          status: 'planning',
          tasks: [],
          expenses: [],
          timeline: [],
          collaborators: []
        };
        
        if (!savedProjects.has(projectData.userEmail)) {
          savedProjects.set(projectData.userEmail, []);
        }
        savedProjects.get(projectData.userEmail).push(project);
        
        return { success: true, project };
      },

      // Emergency request operations
      async createEmergencyRequest(requestData) {
        const emergency = {
          id: `emergency_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
          ...requestData,
          timestamp: new Date().toISOString(),
          status: 'active',
          respondedExperts: [],
          assignedExpertId: null,
          resolution: null
        };
        
        emergencyRequests.set(emergency.id, emergency);
        
        // Alert all available experts in the area
        const availableExperts = Array.from(expertProfiles.values()).filter(expert => {
          const matchesCategory = expert.specialties.some(s => 
            s.toLowerCase().includes(requestData.category.toLowerCase())
          );
          const isAvailable = expert.availability.includes('Emergency 24/7');
          return matchesCategory && isAvailable;
        });
        
        availableExperts.forEach(expert => {
          sendPushNotification(expert.id, {
            title: 'üö® EMERGENCY REQUEST',
            body: requestData.description,
            type: 'emergency',
            priority: 'high',
            data: emergency
          });
        });
        
        return { success: true, emergency, notifiedExperts: availableExperts.length };
      }
    };

    // ============================================================================
    // EMAIL SERVICE WITH TEMPLATES
    // ============================================================================
    
    const emailTemplates = {
      welcome: (user) => ({
        subject: 'Welcome to DIYMatch! üîß',
        body: `
          <h2>Welcome ${user.name}!</h2>
          <p>Thank you for joining DIYMatch, your AI-powered DIY assistant.</p>
          <h3>What you can do now:</h3>
          <ul>
            <li>ü§ñ Get your first AI analysis FREE this month</li>
            <li>üë®‚Äçüîß Connect with verified local experts</li>
            <li>üõ†Ô∏è Find parts at nearby stores</li>
            <li>üí∞ Share your referral code: <strong>${user.referralCode}</strong></li>
          </ul>
          <p>Need help? Reply to this email or call ${APP_CONFIG.emergencyHotline}</p>
        `
      }),
      
      bookingConfirmation: (booking, user, expert) => ({
        subject: `Booking Confirmed - ${expert.name} on ${new Date(booking.date).toLocaleDateString()}`,
        body: `
          <h2>Booking Confirmation</h2>
          <div style="border: 1px solid #ddd; padding: 20px; border-radius: 8px;">
            <h3>üìÖ Appointment Details</h3>
            <p><strong>Expert:</strong> ${expert.name} (${expert.profession})</p>
            <p><strong>Date:</strong> ${new Date(booking.date).toLocaleDateString()}</p>
            <p><strong>Time:</strong> ${booking.time}</p>
            <p><strong>Location:</strong> ${booking.location || user.postcode}</p>
            ${booking.isSameDay ? '<p style="color: #ff6b6b;"><strong>‚ö° Same-day service</strong></p>' : ''}
          </div>
          <div style="margin-top: 20px;">
            <h3>üí∞ Payment Summary</h3>
            <p><strong>Service Cost:</strong> ¬£${booking.basePrice}</p>
            ${booking.isSameDay ? `<p><strong>Same-day Surge:</strong> ¬£${booking.surgeAmount}</p>` : ''}
            <p><strong>Platform Fee:</strong> ¬£${booking.platformFee}</p>
            <p style="font-size: 1.2em;"><strong>Total Paid:</strong> ¬£${booking.totalCost}</p>
          </div>
          <p style="margin-top: 20px;">
            <a href="#" style="background: #3b82f6; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
              Message ${expert.name}
            </a>
          </p>
        `
      }),
      
      analysisComplete: (analysis, user) => ({
        subject: `AI Analysis Complete - ${analysis.problemDetected}`,
        body: `
          <h2>Your AI Analysis Results</h2>
          <div style="background: ${
            analysis.severity === 'Critical' ? '#fee' : 
            analysis.severity === 'High' ? '#ffeaa7' : 
            '#e3f2fd'
          }; padding: 20px; border-radius: 8px;">
            <h3>${analysis.severity === 'Critical' ? 'üö®' : analysis.severity === 'High' ? '‚ö†Ô∏è' : '‚ö°'} ${analysis.problemDetected}</h3>
            <p><strong>Severity:</strong> ${analysis.severity}</p>
            <p><strong>Confidence:</strong> ${analysis.confidence}</p>
            <p>${analysis.description}</p>
          </div>
          <div style="margin-top: 20px;">
            <h3>Recommended Actions:</h3>
            <p><strong>DIY Friendly:</strong> ${analysis.isDIYFriendly ? 'Yes ‚úÖ' : 'No - Expert Required ‚ùå'}</p>
            <p><strong>Estimated Cost:</strong> ${analysis.estimatedCost}</p>
            <p><strong>Expert Type Needed:</strong> ${analysis.recommendedExpertType}</p>
          </div>
          <p style="margin-top: 20px;">
            <a href="#" style="background: #3b82f6; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
              Find Expert Now
            </a>
          </p>
        `
      })
    };

    const sendEmail = async (to, template, data) => {
      const emailContent = typeof template === 'string' 
        ? emailTemplates[template](data)
        : { subject: template.subject, body: template.body };
      
      console.log('Email sent:', { to, ...emailContent });
      
      // In production, integrate with email service
      return true;
    };

    // ============================================================================
    // ENHANCED AI ANALYSIS ENGINE
    // ============================================================================
    
    const performAIAnalysis = async (media, description, progressCallback) => {
      if (!navigator.onLine) {
        throw new Error('Internet connection required for AI analysis');
      }

      const analysisSteps = [
        { progress: 5, delay: 300, message: 'Initializing AI engine...' },
        { progress: 15, delay: 500, message: 'Processing ' + media.type + '...' },
        { progress: 25, delay: 700, message: 'Extracting visual features...' },
        { progress: 35, delay: 600, message: 'Analyzing problem patterns...' },
        { progress: 45, delay: 800, message: 'Checking safety database...' },
        { progress: 55, delay: 700, message: 'Identifying required tools...' },
        { progress: 65, delay: 600, message: 'Calculating repair complexity...' },
        { progress: 75, delay: 700, message: 'Finding compatible parts...' },
        { progress: 85, delay: 600, message: 'Matching expert profiles...' },
        { progress: 95, delay: 500, message: 'Generating recommendations...' },
        { progress: 100, delay: 400, message: 'Finalizing report...' }
      ];

      for (const step of analysisSteps) {
        await new Promise(resolve => setTimeout(resolve, step.delay));
        progressCallback(step.progress, step.message);
      }

      return analyzeWithAI(description.toLowerCase(), media);
    };

    const analyzeWithAI = (keywords, media) => {
      let problemType = 'General Maintenance';
      let severity = 'Medium';
      let confidence = 85;
      let isDIYFriendly = true;
      let estimatedCost = '¬£50-¬£150';
      let recommendedExpert = 'Handyman';
      let riskLevel = 'Low';
      let timeToFix = '1-2 hours';
      
      const problemPatterns = {
        electrical: {
          keywords: ['electric', 'socket', 'wire', 'switch', 'fuse', 'circuit', 'power', 'outlet', 'spark', 'breaker', 'voltage'],
          problem: 'Electrical Issue',
          severity: 'Critical',
          diy: false,
          expert: 'Electrician',
          cost: '¬£100-¬£300',
          risk: 'High',
          time: '2-4 hours',
          urgency: 'Immediate'
        },
        plumbing: {
          keywords: ['leak', 'water', 'pipe', 'tap', 'drain', 'toilet', 'shower', 'sink', 'drip', 'flood', 'pressure'],
          problem: 'Plumbing Issue',
          severity: 'High',
          diy: true,
          expert: 'Plumber',
          cost: '¬£80-¬£200',
          risk: 'Medium',
          time: '1-3 hours',
          urgency: '24 hours'
        },
        structural: {
          keywords: ['wall', 'crack', 'ceiling', 'floor', 'foundation', 'damp', 'mold', 'mould', 'subsidence', 'roof'],
          problem: 'Structural/Damp Issue',
          severity: 'High',
          diy: false,
          expert: 'Building Surveyor',
          cost: '¬£150-¬£500',
          risk: 'High',
          time: '4-8 hours',
          urgency: '48 hours'
        },
        heating: {
          keywords: ['boiler', 'radiator', 'heating', 'cold', 'thermostat', 'gas', 'central heating', 'hot water'],
          problem: 'Heating/Gas Issue',
          severity: 'Critical',
          diy: false,
          expert: 'Gas Safe Engineer',
          cost: '¬£150-¬£400',
          risk: 'Critical',
          time: '2-5 hours',
          urgency: 'Immediate'
        },
        appliance: {
          keywords: ['washing machine', 'dishwasher', 'fridge', 'freezer', 'oven', 'microwave', 'dryer'],
          problem: 'Appliance Malfunction',
          severity: 'Medium',
          diy: true,
          expert: 'Appliance Technician',
          cost: '¬£60-¬£180',
          risk: 'Low',
          time: '1-2 hours',
          urgency: '72 hours'
        },
        pest: {
          keywords: ['mouse', 'rat', 'insect', 'wasp', 'bee', 'ant', 'cockroach', 'pest', 'infestation'],
          problem: 'Pest Control Issue',
          severity: 'Medium',
          diy: true,
          expert: 'Pest Control Specialist',
          cost: '¬£80-¬£250',
          risk: 'Medium',
          time: '2-4 hours',
          urgency: '48 hours'
        }
      };

      // Enhanced pattern matching with context analysis
      let bestMatch = null;
      let maxScore = 0;
      
      for (const [type, config] of Object.entries(problemPatterns)) {
        let score = 0;
        config.keywords.forEach(keyword => {
          if (keywords.includes(keyword)) {
            score += 1;
            // Boost score for exact matches
            if (keywords.split(' ').includes(keyword)) {
              score += 0.5;
            }
          }
        });
        
        if (score > maxScore) {
          maxScore = score;
          bestMatch = config;
        }
      }
      
      if (bestMatch && maxScore >= 2) {
        problemType = bestMatch.problem;
        severity = bestMatch.severity;
        isDIYFriendly = bestMatch.diy;
        recommendedExpert = bestMatch.expert;
        estimatedCost = bestMatch.cost;
        riskLevel = bestMatch.risk;
        timeToFix = bestMatch.time;
        confidence = Math.min(95, 70 + (maxScore * 5));
      }

      // Check for emergency keywords
      const emergencyKeywords = ['urgent', 'emergency', 'flooding', 'fire', 'smoke', 'gas smell', 'sparking', 'dangerous'];
      const isEmergency = emergencyKeywords.some(word => keywords.includes(word));
      
      if (isEmergency) {
        severity = 'Critical';
        isDIYFriendly = false;
        riskLevel = 'Critical';
      }

      // Generate comprehensive analysis results
      const analysis = {
        problemDetected: problemType,
        confidence: confidence + '%',
        severity,
        description: `AI analysis indicates this is a ${problemType.toLowerCase()} with ${confidence}% confidence.`,
        isDIYFriendly,
        estimatedCost,
        timeToFix,
        recommendedExpertType: recommendedExpert,
        safetyWarnings: generateSafetyWarnings(severity, problemType),
        recommendedParts: generatePartsRecommendations(problemType),
        stepByStepGuide: isDIYFriendly ? generateDetailedSteps(problemType) : ['Professional expertise required - do not attempt DIY'],
        riskLevel,
        mediaType: media.type,
        regulations: getRegulations(problemType),
        availableExperts: checkUrgentExpertAvailability(recommendedExpert),
        aiInsights: generateAIInsights(problemType, severity, keywords),
        preventiveTips: generatePreventiveTips(problemType),
        similarIssues: findSimilarIssues(problemType),
        costBreakdown: generateCostBreakdown(problemType, estimatedCost),
        toolsRequired: generateToolsList(problemType, isDIYFriendly),
        videoTutorials: getVideoTutorials(problemType),
        warrantyInfo: getWarrantyInfo(problemType),
        environmentalImpact: assessEnvironmentalImpact(problemType)
      };

      return analysis;
    };

    const generateSafetyWarnings = (severity, problemType) => {
      const baseWarnings = {
        'Critical': [
          'üö® IMMEDIATE ACTION REQUIRED',
          '‚ö†Ô∏è Turn off main utilities if applicable',
          'üìû Consider calling emergency services',
          'üö´ Do not attempt repairs yourself',
          'üë• Keep all occupants away from danger'
        ],
        'High': [
          '‚ö†Ô∏è Significant safety hazard present',
          'üß§ Professional PPE required',
          'üìñ Follow safety protocols strictly',
          'üë®‚Äçüîß Professional expertise recommended',
          '‚è∞ Address within 24-48 hours'
        ],
        'Medium': [
          '‚ö° Exercise appropriate caution',
          'ü•Ω Use safety equipment',
          'üìã Follow instructions carefully',
          'üîç Monitor for deterioration'
        ],
        'Low': [
          '‚úÖ Generally safe for DIY',
          'üß§ Basic safety gear recommended',
          'üìñ Read instructions thoroughly'
        ]
      };
      
      // Add problem-specific warnings
      const specificWarnings = {
        'Electrical Issue': ['‚ö° Risk of electrocution', 'üî• Fire hazard', 'Turn off circuit breaker'],
        'Gas Issue': ['üí® Ventilate area immediately', 'üö≠ No open flames', 'Call Gas Emergency Service: 0800 111 999'],
        'Structural Issue': ['üè† Risk of collapse', '‚ö†Ô∏è Evacuate if severe', 'Document for insurance']
      };
      
      const warnings = [...(baseWarnings[severity] || baseWarnings['Medium'])];
      
      Object.keys(specificWarnings).forEach(key => {
        if (problemType.includes(key.split(' ')[0])) {
          warnings.push(...specificWarnings[key]);
        }
      });
      
      return warnings;
    };

    const generatePartsRecommendations = (problemType) => {
      const partsDatabase = {
        'Plumbing Issue': [
          { name: 'Pipe Repair Kit', price: '¬£12.99', priority: 'Essential', category: 'plumbing' },
          { name: 'PTFE Tape', price: '¬£2.49', priority: 'Essential', category: 'plumbing' },
          { name: 'Adjustable Wrench Set', price: '¬£15.99', priority: 'Essential', category: 'tools' },
          { name: 'Plumber\'s Putty', price: '¬£4.99', priority: 'Recommended', category: 'plumbing' },
          { name: 'Pipe Cutter', price: '¬£19.99', priority: 'Optional', category: 'tools' },
          { name: 'Leak Detection Dye', price: '¬£7.99', priority: 'Optional', category: 'plumbing' }
        ],
        'Electrical Issue': [
          { name: 'Voltage Tester', price: '¬£19.99', priority: 'Essential', category: 'electrical' },
          { name: 'Wire Nuts Assortment', price: '¬£8.99', priority: 'Essential', category: 'electrical' },
          { name: 'Electrical Tape', price: '¬£3.49', priority: 'Essential', category: 'electrical' },
          { name: 'Circuit Breaker Finder', price: '¬£34.99', priority: 'Recommended', category: 'electrical' },
          { name: 'Insulated Screwdriver Set', price: '¬£24.99', priority: 'Essential', category: 'tools' },
          { name: 'Wire Stripper', price: '¬£12.99', priority: 'Recommended', category: 'tools' }
        ],
        'Structural/Damp Issue': [
          { name: 'Damp Seal Paint 5L', price: '¬£24.99', priority: 'Essential', category: 'paint' },
          { name: 'Crack Repair Compound', price: '¬£8.99', priority: 'Essential', category: 'building' },
          { name: 'Digital Moisture Meter', price: '¬£29.99', priority: 'Recommended', category: 'tools' },
          { name: 'Anti-Mold Treatment', price: '¬£12.99', priority: 'Essential', category: 'building' },
          { name: 'Dehumidifier', price: '¬£149.99', priority: 'Recommended', category: 'electrical' },
          { name: 'Waterproof Membrane', price: '¬£34.99', priority: 'Optional', category: 'building' }
        ],
        'Heating/Gas Issue': [
          { name: 'Carbon Monoxide Detector', price: '¬£19.99', priority: 'Essential', category: 'safety' },
          { name: 'Radiator Bleed Key', price: '¬£2.99', priority: 'Essential', category: 'plumbing' },
          { name: 'Pipe Insulation', price: '¬£9.99', priority: 'Recommended', category: 'building' },
          { name: 'Thermostat (Smart)', price: '¬£179.99', priority: 'Optional', category: 'electrical' },
          { name: 'Radiator Valve Set', price: '¬£24.99', priority: 'Recommended', category: 'plumbing' }
        ],
        'General Maintenance': [
          { name: 'Multi-Tool Set', price: '¬£24.99', priority: 'Essential', category: 'tools' },
          { name: 'WD-40', price: '¬£5.99', priority: 'Essential', category: 'tools' },
          { name: 'Duct Tape', price: '¬£4.49', priority: 'Essential', category: 'tools' },
          { name: 'Screwdriver Set', price: '¬£12.99', priority: 'Essential', category: 'tools' },
          { name: 'Digital Multimeter', price: '¬£19.99', priority: 'Recommended', category: 'electrical' },
          { name: 'Tool Box', price: '¬£29.99', priority: 'Recommended', category: 'tools' }
        ]
      };
      
      return partsDatabase[problemType] || partsDatabase['General Maintenance'];
    };

    const generateDetailedSteps = (problemType) => {
      const stepGuides = {
        'Plumbing Issue': [
          '1. üö∞ Turn off water supply at stopcock (usually under kitchen sink)',
          '2. üì∏ Take photos for reference before starting',
          '3. ü™£ Place buckets and towels under work area',
          '4. üîç Identify exact source - check joints, seals, and connections',
          '5. üßπ Clean and dry the affected area thoroughly',
          '6. üîß If joint leak: Tighten connection (turn clockwise)',
          '7. üî® If still leaking: Disassemble and replace washers/seals',
          '8. üßµ Apply PTFE tape to threads (wrap clockwise)',
          '9. üîÑ Reassemble components carefully',
          '10. üíß Turn water back on slowly',
          '11. ‚úÖ Check for leaks - wait 30 minutes',
          '12. üìù Document repair for future reference'
        ],
        'General Maintenance': [
          '1. üìã Document the issue with photos/videos',
          '2. üîç Research specific repair procedures',
          '3. üõ†Ô∏è Gather all necessary tools and parts',
          '4. ü¶∫ Put on appropriate safety equipment',
          '5. üìñ Read instructions/watch tutorials',
          '6. üîß Perform repair step by step',
          '7. ‚úÖ Test thoroughly',
          '8. üßπ Clean up work area',
          '9. üìù Keep repair documentation'
        ],
        'Appliance Malfunction': [
          '1. üîå Unplug appliance from power source',
          '2. üìñ Check user manual for troubleshooting',
          '3. üîç Inspect for obvious issues (blockages, damage)',
          '4. üßπ Clean filters and accessible parts',
          '5. üîß Check and tighten connections',
          '6. üîÑ Reset appliance if applicable',
          '7. üîå Reconnect and test',
          '8. üìû Contact manufacturer if under warranty'
        ]
      };
      
      return stepGuides[problemType] || stepGuides['General Maintenance'];
    };

    const getRegulations = (problemType) => {
      const regulations = {
        'Electrical Issue': {
          regulation: 'Part P Building Regulations',
          details: 'Notifiable work includes new circuits, work in bathrooms, and outdoor installations',
          requirement: 'Must use certified electrician for notifiable work',
          penalty: 'Up to ¬£5,000 fine for non-compliance'
        },
        'Heating/Gas Issue': {
          regulation: 'Gas Safe Regulations',
          details: 'All gas work must be carried out by Gas Safe registered engineers',
          requirement: 'Legal requirement - check engineer\'s Gas Safe ID',
          penalty: 'Unlimited fine and/or imprisonment for illegal gas work'
        },
        'Structural/Damp Issue': {
          regulation: 'Building Regulations',
          details: 'Structural alterations may require building control approval',
          requirement: 'Check with local authority before major work',
          penalty: 'Enforcement notice and required remedial work'
        },
        'Plumbing Issue': {
          regulation: 'Water Supply Regulations (WRAS)',
          details: 'Some work requires approval to prevent contamination',
          requirement: 'Use WRAS approved fittings',
          penalty: 'Fine and required correction of work'
        }
      };
      
      const reg = regulations[problemType];
      return reg ? `${reg.regulation}: ${reg.details}. ${reg.requirement}` : 'No specific regulations, but follow manufacturer guidelines and best practices';
    };

    const checkUrgentExpertAvailability = (expertType) => {
      const experts = Array.from(expertProfiles.values());
      const now = new Date();
      const currentHour = now.getHours();
      const isBusinessHours = currentHour >= 8 && currentHour < 20;
      const isWeekend = now.getDay() === 0 || now.getDay() === 6;
      
      const availableExperts = experts.filter(expert => {
        const matchesType = expert.profession.toLowerCase().includes(expertType.toLowerCase()) ||
                          expert.specialties.some(s => s.toLowerCase().includes(expertType.toLowerCase()));
        const respondsQuickly = expert.responseTime && (
          expert.responseTime.includes('< 1 hour') || 
          expert.responseTime.includes('< 2 hours')
        );
        const availableNow = expert.availability.includes('Emergency 24/7') ||
                           (isBusinessHours && !isWeekend && expert.availability.includes('Mon-Fri')) ||
                           (isWeekend && expert.availability.includes('Weekends'));
        
        return matchesType && respondsQuickly && availableNow;
      });

      // Sort by rating and response time
      availableExperts.sort((a, b) => {
        const aScore = parseFloat(a.rating) + (a.responseTime.includes('< 1 hour') ? 0.5 : 0);
        const bScore = parseFloat(b.rating) + (b.responseTime.includes('< 1 hour') ? 0.5 : 0);
        return bScore - aScore;
      });

      return {
        count: availableExperts.length,
        experts: availableExperts.slice(0, 5),
        nextAvailable: availableExperts.length === 0 
          ? (isBusinessHours ? 'Tomorrow 8am' : 'Today 8am')
          : 'Now',
        averageResponseTime: availableExperts.length > 0
          ? availableExperts[0].responseTime
          : '4-6 hours'
      };
    };

    const generateAIInsights = (problemType, severity, keywords) => {
      const weatherImpact = keywords.includes('rain') || keywords.includes('storm') || keywords.includes('wind');
      const ageRelated = keywords.includes('old') || keywords.includes('worn') || keywords.includes('years');
      
      return {
        rootCause: `Based on the analysis, the likely root cause is ${
          problemType.includes('Electrical') ? 'electrical component failure, wiring degradation, or overload issues' :
          problemType.includes('Plumbing') ? 'seal degradation, pipe corrosion, or pressure issues' :
          problemType.includes('Structural') ? 'moisture ingress, settlement, or material fatigue' :
          problemType.includes('Heating') ? 'component wear, lack of maintenance, or system age' :
          'general wear and tear or lack of maintenance'
        }${weatherImpact ? ' possibly exacerbated by recent weather conditions' : ''}${ageRelated ? ' due to age-related deterioration' : ''}.`,
        
        riskAssessment: `This issue has a ${severity.toLowerCase()} risk level. ${
          severity === 'Critical' ? 'Immediate action required to prevent danger or extensive damage.' :
          severity === 'High' ? 'Should be addressed within 24-48 hours to prevent escalation.' :
          severity === 'Medium' ? 'Schedule repair within a week to prevent deterioration.' :
          'Can be scheduled at your convenience, but don\'t delay too long.'
        }`,
        
        costFactors: `Main cost drivers include: ${
          problemType.includes('Electrical') ? 'safety compliance, specialized parts, and certification requirements' :
          problemType.includes('Plumbing') ? 'water damage prevention, parts availability, and access difficulty' :
          problemType.includes('Structural') ? 'extent of damage, materials needed, and potential hidden issues' :
          'parts replacement, labor time, and any required permits'
        }.`,
        
        preventionValue: `Addressing this now could prevent: ${
          severity === 'Critical' ? 'serious injury, major property damage, or emergency callout fees' :
          severity === 'High' ? 'water damage, electrical fires, or costly emergency repairs' :
          'further deterioration, higher repair costs, or system failure'
        }. Estimated prevention savings: ¬£${Math.floor(Math.random() * 500 + 200)}-¬£${Math.floor(Math.random() * 1000 + 500)}.`,
        
        seasonalConsiderations: `${
          new Date().getMonth() >= 9 || new Date().getMonth() <= 2 
            ? 'Winter conditions may worsen this issue. Address before severe weather.' 
            : new Date().getMonth() >= 3 && new Date().getMonth() <= 5
            ? 'Spring is ideal for repairs. Good weather window for external work.'
            : 'Summer heat may affect repair materials. Work during cooler hours.'
        }`
      };
    };

    const generatePreventiveTips = (problemType) => {
      const tips = {
        'Electrical Issue': [
          '‚ö° Test RCD/circuit breakers monthly by pressing test button',
          'üîå Check outlets for warmth or discoloration quarterly',
          'üìÖ Schedule professional inspection every 5 years (rental properties: every 5 years required)',
          'üîã Replace smoke alarm batteries every 6 months',
          'üí° Upgrade to LED bulbs to reduce electrical load',
          'üìä Monitor energy usage for unusual spikes'
        ],
        'Plumbing Issue': [
          'üîç Inspect under sinks monthly for moisture or drips',
          'üöø Clean shower heads and aerators every 3 months',
          'üìè Check water pressure quarterly (ideal: 40-60 PSI)',
          'üßπ Clear drain traps and use enzyme cleaners monthly',
          '‚ùÑÔ∏è Insulate pipes in cold areas before winter',
          'üö∞ Service water heater annually'
        ],
        'Structural/Damp Issue': [
          'üè† Clear gutters and downspouts twice yearly',
          'üëÄ Inspect roof after storms for damage',
          'üí® Ensure adequate ventilation in all rooms',
          'üìä Monitor indoor humidity (ideal: 30-50%)',
          'üîç Check for cracks after extreme weather',
          'üå± Keep plants/soil away from foundations'
        ],
        'Heating/Gas Issue': [
          'üî• Service boiler annually (legally required for rentals)',
          'üå°Ô∏è Bleed radiators at start of heating season',
          'üö® Test carbon monoxide detectors monthly',
          'üìÖ Replace boiler filters as recommended',
          'üîß Check boiler pressure monthly (ideal: 1-1.5 bar)',
          'üìä Monitor gas usage for unusual increases'
        ],
        'General Maintenance': [
          'üìù Keep a home maintenance log',
          'üóìÔ∏è Create seasonal maintenance schedule',
          'üîß Build basic tool kit and supplies',
          'üìö Learn location of utility shutoffs',
          'üì∏ Document property condition annually',
          'üí∞ Budget 1% of home value for annual maintenance'
        ]
      };
      
      return tips[problemType] || tips['General Maintenance'];
    };

    const findSimilarIssues = (problemType) => {
      // Simulate finding similar resolved issues
      return [
        {
          title: `Similar ${problemType} - Resolved in 2 hours`,
          description: 'User had comparable issue, fixed with expert help',
          cost: '¬£120',
          rating: 4.8,
          timeAgo: '3 days ago'
        },
        {
          title: `DIY ${problemType} Success Story`,
          description: 'Homeowner fixed similar problem themselves',
          cost: '¬£45 (parts only)',
          rating: 5.0,
          timeAgo: '1 week ago'
        }
      ];
    };

    const generateCostBreakdown = (problemType, estimatedRange) => {
      const [min, max] = estimatedRange.match(/\d+/g).map(Number);
      const labor = Math.round((min + max) / 2 * 0.7);
      const parts = Math.round((min + max) / 2 * 0.3);
      
      return {
        labor: `¬£${labor}`,
        parts: `¬£${parts}`,
        callOutFee: '¬£0-50',
        vat: '20% (if applicable)',
        total: estimatedRange,
        savingsIfDIY: `¬£${labor}`,
        financingAvailable: max > 500
      };
    };

    const generateToolsList = (problemType, isDIY) => {
      if (!isDIY) {
        return ['Professional equipment required - not suitable for DIY'];
      }
      
      const tools = {
        'Plumbing Issue': [
          { name: 'Adjustable Wrench', essential: true, price: '¬£15' },
          { name: 'Pipe Cutter', essential: false, price: '¬£20' },
          { name: 'Plumber\'s Tape', essential: true, price: '¬£3' },
          { name: 'Bucket', essential: true, price: '¬£5' },
          { name: 'Towels', essential: true, price: '¬£10' }
        ],
        'General Maintenance': [
          { name: 'Screwdriver Set', essential: true, price: '¬£13' },
          { name: 'Hammer', essential: true, price: '¬£10' },
          { name: 'Measuring Tape', essential: true, price: '¬£5' },
          { name: 'Level', essential: false, price: '¬£15' },
          { name: 'Safety Glasses', essential: true, price: '¬£5' }
        ]
      };
      
      return tools[problemType] || tools['General Maintenance'];
    };

    const getVideoTutorials = (problemType) => {
      return [
        {
          title: `How to Fix ${problemType} - Beginner's Guide`,
          duration: '12:34',
          thumbnail: 'https://via.placeholder.com/320x180?text=Video+Tutorial',
          views: '45K',
          source: 'DIYMatch Academy'
        },
        {
          title: `Common ${problemType} Mistakes to Avoid`,
          duration: '8:45',
          thumbnail: 'https://via.placeholder.com/320x180?text=Tips+Video',
          views: '23K',
          source: 'Pro Tips Channel'
        }
      ];
    };

    const getWarrantyInfo = (problemType) => {
      return {
        manufacturerWarranty: 'Check device serial number and purchase date',
        homeWarranty: 'May be covered under home warranty if applicable',
        insuranceClaim: problemType.includes('Structural') || problemType.includes('Flood') 
          ? 'Potentially covered - check policy' 
          : 'Unlikely to be covered',
        expertGuarantee: 'Most professionals offer 6-12 month guarantee on work'
      };
    };

    const assessEnvironmentalImpact = (problemType) => {
      const impacts = {
        'Plumbing Issue': {
          waterWaste: 'Leaks can waste 3,000+ gallons/year',
          ecoFriendly: 'Fix promptly to conserve water',
          greenOptions: 'Consider low-flow fixtures when replacing'
        },
        'Electrical Issue': {
          energyWaste: 'Faulty wiring can increase energy consumption 10-20%',
          ecoFriendly: 'Repair improves efficiency',
          greenOptions: 'Upgrade to smart switches and LED bulbs'
        },
        'Heating/Gas Issue': {
          carbonFootprint: 'Inefficient heating increases CO2 emissions',
          ecoFriendly: 'Regular maintenance improves efficiency 15-30%',
          greenOptions: 'Consider heat pump or smart thermostat'
        }
      };
      
      return impacts[problemType] || {
        general: 'Timely repairs prevent waste and improve efficiency',
        ecoFriendly: 'Choose sustainable materials when possible',
        greenOptions: 'Ask experts about eco-friendly alternatives'
      };
    };

    // Calculate AI-powered price estimation
    const calculateAIPrice = (description, isSameDay, expertHourlyRate = 45) => {
      const keywords = description.toLowerCase();
      
      let estimatedHours = 2;
      let complexity = 1.0;
      let partsMultiplier = 1.0;
      
      // Complexity analysis
      if (keywords.includes('emergency') || keywords.includes('urgent')) {
        complexity *= 1.3;
      }
      if (keywords.includes('extensive') || keywords.includes('major') || keywords.includes('multiple')) {
        estimatedHours = 4;
        complexity *= 1.2;
        partsMultiplier = 1.5;
      }
      if (keywords.includes('simple') || keywords.includes('quick') || keywords.includes('minor')) {
        estimatedHours = 1;
        complexity *= 0.9;
        partsMultiplier = 0.8;
      }
      if (keywords.includes('replace') || keywords.includes('new')) {
        partsMultiplier *= 1.3;
      }
      
      // Access difficulty
      if (keywords.includes('ceiling') || keywords.includes('roof') || keywords.includes('attic')) {
        complexity *= 1.15;
      }
      if (keywords.includes('floor') || keywords.includes('underground') || keywords.includes('basement')) {
        complexity *= 1.2;
      }
      
      const laborCost = expertHourlyRate * estimatedHours * complexity;
      const partsCost = 50 * partsMultiplier; // Base parts estimate
      const basePrice = laborCost + partsCost;
      
      // Apply same-day surge
      const finalPrice = isSameDay ? basePrice * APP_CONFIG.sameDayMultiplier : basePrice;
      
      // Platform fee
      const platformFee = finalPrice * (isSameDay ? APP_CONFIG.sameDayCommission : APP_CONFIG.platformCommission);
      
      return {
        estimated: `¬£${finalPrice.toFixed(2)}`,
        breakdown: {
          labor: `¬£${laborCost.toFixed(2)}`,
          parts: `¬£${partsCost.toFixed(2)}`,
          surge: isSameDay ? `¬£${(basePrice * 0.5).toFixed(2)}` : '¬£0',
          platformFee: `¬£${platformFee.toFixed(2)}`
        },
        hours: estimatedHours,
        confidence: complexity > 1.2 ? 'Low-Medium' : 'Medium-High',
        factors: {
          complexity: complexity.toFixed(2),
          urgency: isSameDay ? 'High' : 'Normal',
          partsNeeded: partsMultiplier > 1 ? 'Above average' : 'Standard'
        }
      };
    };

    // ============================================================================
    // CONTEXTS
    // ============================================================================
    
    const AuthContext = React.createContext();
    const ThemeContext = React.createContext();
    const NotificationContext = React.createContext();

    // ============================================================================
    // CUSTOM HOOKS
    // ============================================================================
    
    const useLocalStorage = (key, initialValue) => {
      // Note: This is for demo purposes. In production, use secure storage
      const [storedValue, setStoredValue] = React.useState(() => {
        try {
          const item = window.localStorage.getItem(key);
          return item ? JSON.parse(item) : initialValue;
        } catch (error) {
          console.error('LocalStorage error:', error);
          return initialValue;
        }
      });

      const setValue = (value) => {
        try {
          setStoredValue(value);
          window.localStorage.setItem(key, JSON.stringify(value));
        } catch (error) {
          console.error('LocalStorage error:', error);
        }
      };

      return [storedValue, setValue];
    };

    const useNotifications = () => {
      const [notifications, setNotifications] = React.useState([]);
      
      const addNotification = (notification) => {
        const newNotif = {
          id: Date.now(),
          ...notification,
          timestamp: new Date().toISOString()
        };
        setNotifications(prev => [newNotif, ...prev]);
        
        // Auto-remove after 5 seconds for non-persistent notifications
        if (!notification.persistent) {
          setTimeout(() => {
            removeNotification(newNotif.id);
          }, 5000);
        }
      };
      
      const removeNotification = (id) => {
        setNotifications(prev => prev.filter(n => n.id !== id));
      };
      
      const clearAll = () => {
        setNotifications([]);
      };
      
      return {
        notifications,
        addNotification,
        removeNotification,
        clearAll
      };
    };

    // ============================================================================
    // SHARED COMPONENTS
    // ============================================================================
    
    const LoadingSpinner = ({ size = 'medium', color = 'blue' }) => {
      const sizeClasses = {
        small: 'w-4 h-4',
        medium: 'w-8 h-8',
        large: 'w-12 h-12'
      };
      
      return (
        <div className={`${sizeClasses[size]} border-4 border-${color}-600 border-t-transparent rounded-full animate-spin`} />
      );
    };

    const EmptyState = ({ icon, title, description, action }) => {
      return (
        <div className="text-center py-12">
          <div className="text-6xl mb-4">{icon}</div>
          <h3 className="text-xl font-semibold mb-2">{title}</h3>
          <p className="text-gray-600 mb-4">{description}</p>
          {action}
        </div>
      );
    };

    const ProgressSteps = ({ steps, currentStep }) => {
      return (
        <div className="progress-steps mb-6">
          {steps.map((step, index) => (
            <div 
              key={index}
              className={`progress-step ${
                index < currentStep ? 'completed' : 
                index === currentStep ? 'active' : ''
              }`}
            >
              <div className="progress-step-circle">
                {index < currentStep ? '‚úì' : index + 1}
              </div>
              <div className="text-xs mt-1">{step}</div>
            </div>
          ))}
        </div>
      );
    };

    const StarRating = ({ rating, onRate, readonly = false }) => {
      const [hover, setHover] = React.useState(0);
      
      return (
        <div className="star-rating">
          {[1, 2, 3, 4, 5].map((star) => (
            <span
              key={star}
              className={`star ${star <= (hover || rating) ? 'filled' : ''}`}
              onClick={() => !readonly && onRate && onRate(star)}
              onMouseEnter={() => !readonly && setHover(star)}
              onMouseLeave={() => !readonly && setHover(0)}
              style={{ cursor: readonly ? 'default' : 'pointer' }}
            >
              ‚òÖ
            </span>
          ))}
        </div>
      );
    };

    const NotificationBadge = ({ count }) => {
      if (!count) return null;
      
      return (
        <span className="notification-badge">
          {count > 99 ? '99+' : count}
        </span>
      );
    };

    const Modal = ({ isOpen, onClose, title, children, size = 'medium' }) => {
      if (!isOpen) return null;
      
      const sizeClasses = {
        small: 'max-w-sm',
        medium: 'max-w-md',
        large: 'max-w-2xl',
        fullscreen: 'max-w-full h-full'
      };
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className={`bg-white rounded-xl w-full ${sizeClasses[size]} max-h-[90vh] overflow-hidden`}>
            <div className="p-4 border-b flex items-center justify-between">
              <h2 className="text-xl font-bold">{title}</h2>
              <button
                onClick={onClose}
                className="text-gray-500 text-2xl mobile-touch"
              >
                √ó
              </button>
            </div>
            <div className="p-4 overflow-y-auto" style={{ maxHeight: 'calc(90vh - 120px)' }}>
              {children}
            </div>
          </div>
        </div>
      );
    };

    const ChatBubble = ({ message, isUser, timestamp }) => {
      return (
        <div className={`flex ${isUser ? 'justify-end' : 'justify-start'} mb-4`}>
          <div className={`chat-bubble ${isUser ? 'user' : 'expert'}`}>
            <p>{message}</p>
            <p className={`text-xs mt-1 ${isUser ? 'text-blue-100' : 'text-gray-500'}`}>
              {new Date(timestamp).toLocaleTimeString()}
            </p>
          </div>
        </div>
      );
    };

    const SkeletonLoader = ({ type = 'card', count = 1 }) => {
      const renderSkeleton = () => {
        switch (type) {
          case 'card':
            return (
              <div className="bg-white rounded-xl p-4 shadow-sm">
                <div className="skeleton h-6 w-3/4 mb-3 rounded" />
                <div className="skeleton h-4 w-full mb-2 rounded" />
                <div className="skeleton h-4 w-5/6 mb-3 rounded" />
                <div className="flex justify-between">
                  <div className="skeleton h-8 w-24 rounded" />
                  <div className="skeleton h-8 w-20 rounded" />
                </div>
              </div>
            );
          case 'list':
            return (
              <div className="bg-white p-3 border-b">
                <div className="flex items-center">
                  <div className="skeleton w-12 h-12 rounded-full mr-3" />
                  <div className="flex-1">
                    <div className="skeleton h-4 w-32 mb-2 rounded" />
                    <div className="skeleton h-3 w-48 rounded" />
                  </div>
                </div>
              </div>
            );
          default:
            return <div className="skeleton h-12 w-full rounded" />;
        }
      };
      
      return (
        <>
          {Array.from({ length: count }).map((_, index) => (
            <div key={index}>{renderSkeleton()}</div>
          ))}
        </>
      );
    };

    // ============================================================================
    // PAGE COMPONENTS
    // ============================================================================
    
    // Enhanced Welcome Page with animations
    const WelcomePage = ({ navigateTo }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const { user } = React.useContext(AuthContext);
      const [showFeatures, setShowFeatures] = React.useState(false);

      React.useEffect(() => {
        setTimeout(() => setShowFeatures(true), 300);
      }, []);

      return (
        <div className="safe-area-top min-h-screen">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} shadow-sm`}>
            <div className="flex items-center justify-between p-4">
              <div className="flex items-center space-x-2">
                <div className="text-3xl float-animation">üîß</div>
                <h1 className="text-xl font-bold">DIYMatch</h1>
              </div>
              <button
                onClick={() => React.useContext(ThemeContext).toggleTheme()}
                className="p-2 rounded-lg mobile-touch"
              >
                {isDarkMode ? '‚òÄÔ∏è' : 'üåô'}
              </button>
            </div>
          </div>

          <div className="px-4 py-8">
            <div className="text-center mb-8">
              <h2 className="text-3xl font-bold mb-4">Professional DIY Solutions</h2>
              <p className="text-gray-600">AI-powered analysis & expert connections</p>
              <div className="mt-4 flex justify-center space-x-4 text-sm">
                <span className="flex items-center"><span className="text-green-500 mr-1">‚úì</span> Instant Analysis</span>
                <span className="flex items-center"><span className="text-green-500 mr-1">‚úì</span> Verified Experts</span>
                <span className="flex items-center"><span className="text-green-500 mr-1">‚úì</span> Fair Pricing</span>
              </div>
            </div>

            <div className="space-y-4 max-w-md mx-auto">
              {/* Emergency Button */}
              <button
                onClick={() => navigateTo('emergency')}
                className="w-full emergency-button text-white py-4 rounded-xl font-semibold mobile-touch flex items-center justify-center space-x-2"
              >
                <span>üö®</span>
                <span>EMERGENCY HELP</span>
              </button>

              <button
                onClick={() => navigateTo(user ? 'analysis' : 'signup')}
                className="w-full bg-blue-600 text-white py-4 rounded-xl font-semibold mobile-touch flex items-center justify-center space-x-2 relative"
              >
                <span>ü§ñ</span>
                <span>AI Analysis - ¬£4.99 Per Issue</span>
                <span className="absolute top-0 right-0 transform translate-x-2 -translate-y-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full">
                  1 FREE/month
                </span>
              </button>

              <button
                onClick={() => navigateTo(user ? 'experts' : 'signup')}
                className="w-full bg-green-600 text-white py-4 rounded-xl font-semibold mobile-touch flex items-center justify-center space-x-2"
              >
                <span>üë®‚Äçüîß</span>
                <span>Find Local Experts</span>
              </button>

              <button
                onClick={() => navigateTo(user ? 'parts' : 'signup')}
                className="w-full bg-purple-600 text-white py-4 rounded-xl font-semibold mobile-touch flex items-center justify-center space-x-2"
              >
                <span>üõ†Ô∏è</span>
                <span>Find Parts & Tools</span>
              </button>

              <button
                onClick={() => navigateTo(user ? 'ar-measure' : 'signup')}
                className="w-full bg-orange-600 text-white py-4 rounded-xl font-semibold mobile-touch flex items-center justify-center space-x-2"
              >
                <span>üìê</span>
                <span>AR Measure Tool</span>
                <span className="text-xs bg-red-500 text-white px-2 py-1 rounded ml-2">NEW</span>
              </button>

              <div className="flex space-x-3">
                {!user ? (
                  <>
                    <button
                      onClick={() => navigateTo('login')}
                      className="flex-1 border-2 border-gray-300 py-4 rounded-xl font-semibold mobile-touch"
                    >
                      Sign In
                    </button>
                    <button
                      onClick={() => navigateTo('signup')}
                      className="flex-1 bg-gray-800 text-white py-4 rounded-xl font-semibold mobile-touch"
                    >
                      Sign Up
                    </button>
                  </>
                ) : (
                  <button
                    onClick={() => navigateTo('dashboard')}
                    className="w-full border-2 border-gray-300 py-4 rounded-xl font-semibold mobile-touch"
                  >
                    My Dashboard
                  </button>
                )}
              </div>
            </div>
          </div>

          {showFeatures && (
            <div className="px-4 py-8 slide-in">
              <h3 className="text-lg font-semibold mb-4 text-center">Why Choose DIYMatch?</h3>
              <div className="grid grid-cols-2 gap-4">
                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded-xl shadow-sm`}>
                  <div className="text-2xl mb-2">üì∏</div>
                  <h3 className="font-semibold">AI Analysis</h3>
                  <p className="text-sm text-gray-600">Instant problem identification</p>
                </div>
                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded-xl shadow-sm`}>
                  <div className="text-2xl mb-2">‚úÖ</div>
                  <h3 className="font-semibold">Verified Experts</h3>
                  <p className="text-sm text-gray-600">Background checked pros</p>
                </div>
                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded-xl shadow-sm`}>
                  <div className="text-2xl mb-2">üí∞</div>
                  <h3 className="font-semibold">Fair Pricing</h3>
                  <p className="text-sm text-gray-600">Transparent quotes</p>
                </div>
                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded-xl shadow-sm`}>
                  <div className="text-2xl mb-2">üéÅ</div>
                  <h3 className="font-semibold">Monthly Free</h3>
                  <p className="text-sm text-gray-600">1 FREE analysis/month</p>
                </div>
              </div>

              {/* Trust Indicators */}
              <div className="mt-8 text-center">
                <p className="text-sm text-gray-600 mb-2">Trusted by homeowners</p>
                <div className="flex justify-center space-x-6">
                  <div>
                    <p className="text-2xl font-bold">10K+</p>
                    <p className="text-xs text-gray-600">Active Users</p>
                  </div>
                  <div>
                    <p className="text-2xl font-bold">4.8‚òÖ</p>
                    <p className="text-xs text-gray-600">App Rating</p>
                  </div>
                  <div>
                    <p className="text-2xl font-bold">24/7</p>
                    <p className="text-xs text-gray-600">Support</p>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Enhanced Login Page
    const LoginPage = ({ navigateTo }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const { login } = React.useContext(AuthContext);
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [showPassword, setShowPassword] = React.useState(false);
      const [rememberMe, setRememberMe] = React.useState(false);
      const [isLoading, setIsLoading] = React.useState(false);

      const handleLogin = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        
        // Simulate API call
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        if (email === APP_CONFIG.adminEmail && password === APP_CONFIG.adminPassword) {
          login({ email, name: 'Admin', role: 'admin' });
          navigateTo('admin-dashboard');
        } else {
          const user = await dbOperations.getUserByEmail(email);
          if (user && user.password === password) {
            login(user);
            navigateTo('dashboard');
          } else {
            alert('Invalid credentials. Try demo@example.com / demo123');
          }
        }
        
        setIsLoading(false);
      };

      const handleDemoLogin = () => {
        setEmail('demo@example.com');
        setPassword('demo123');
      };

      return (
        <div className="min-h-screen flex items-center justify-center px-4">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6 w-full max-w-md`}>
            <div className="text-center mb-6">
              <div className="text-4xl mb-2 float-animation">üîß</div>
              <h2 className="text-2xl font-bold">Welcome Back</h2>
              <p className="text-gray-600 mt-2">Sign in to continue</p>
            </div>

            <form onSubmit={handleLogin} className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-2">Email</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="your@email.com"
                  className="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  required
                  disabled={isLoading}
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-2">Password</label>
                <div className="relative">
                  <input
                    type={showPassword ? 'text' : 'password'}
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    className="w-full p-3 border rounded-lg pr-10 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    required
                    disabled={isLoading}
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-3 top-3 text-gray-500"
                  >
                    {showPassword ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è'}
                  </button>
                </div>
              </div>

              <div className="flex items-center justify-between">
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={rememberMe}
                    onChange={(e) => setRememberMe(e.target.checked)}
                    className="mr-2"
                  />
                  <span className="text-sm">Remember me</span>
                </label>
                <button
                  type="button"
                  onClick={() => navigateTo('forgot-password')}
                  className="text-sm text-blue-600 hover:underline"
                >
                  Forgot password?
                </button>
              </div>

              <button
                type="submit"
                disabled={isLoading}
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold mobile-touch flex items-center justify-center"
              >
                {isLoading ? (
                  <>
                    <LoadingSpinner size="small" color="white" />
                    <span className="ml-2">Signing in...</span>
                  </>
                ) : (
                  'Sign In'
                )}
              </button>

              <div className="relative my-6">
                <div className="absolute inset-0 flex items-center">
                  <div className="w-full border-t border-gray-300"></div>
                </div>
                <div className="relative flex justify-center text-sm">
                  <span className={`px-2 ${isDarkMode ? 'bg-gray-800' : 'bg-white'} text-gray-500`}>
                    Or continue with
                  </span>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <button
                  type="button"
                  onClick={handleDemoLogin}
                  className="border border-gray-300 py-2 rounded-lg mobile-touch flex items-center justify-center"
                >
                  <span className="mr-2">üé≠</span>
                  Demo
                </button>
                <button
                  type="button"
                  className="border border-gray-300 py-2 rounded-lg mobile-touch flex items-center justify-center"
                  onClick={() => alert('Social login coming soon!')}
                >
                  <span className="mr-2">üçé</span>
                  Apple
                </button>
              </div>

              <div className="text-center mt-6">
                <p className="text-sm text-gray-600">
                  Don't have an account?{' '}
                  <button
                    type="button"
                    onClick={() => navigateTo('signup')}
                    className="text-blue-600 font-semibold hover:underline"
                  >
                    Sign up free
                  </button>
                </p>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // Enhanced Signup Page
    const SignupPage = ({ navigateTo }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const { login } = React.useContext(AuthContext);
      const [step, setStep] = React.useState(1);
      const [formData, setFormData] = React.useState({
        userType: 'customer',
        name: '',
        email: '',
        password: '',
        phone: '',
        postcode: '',
        referralCode: '',
        acceptedTerms: false,
        marketingConsent: false
      });
      const [showTerms, setShowTerms] = React.useState(false);
      const [isLoading, setIsLoading] = React.useState(false);

      const validateStep = () => {
        switch (step) {
          case 1:
            return formData.userType;
          case 2:
            return formData.name && formData.email && formData.password.length >= 8;
          case 3:
            return formData.phone && formData.postcode;
          case 4:
            return formData.acceptedTerms;
          default:
            return false;
        }
      };

      const handleNext = () => {
        if (validateStep()) {
          if (step < 4) {
            setStep(step + 1);
          } else {
            handleSignup();
          }
        } else {
          alert('Please complete all required fields');
        }
      };

      const handleSignup = async () => {
        setIsLoading(true);
        
        try {
          // Check referral code if provided
          let referralBonus = 0;
          if (formData.referralCode) {
            const referralResult = applyReferralCode(formData.referralCode, formData.email);
            if (referralResult.valid) {
              referralBonus = referralResult.bonus;
              alert(`Referral code applied! You'll receive ¬£${referralBonus} credit after your first booking.`);
            }
          }
          
          const result = await dbOperations.createUser({
            ...formData,
            acceptedTermsAt: new Date().toISOString(),
            referralBonus
          });

          if (result.success) {
            // Send welcome email
            await sendEmail(formData.email, 'welcome', result.user);
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
              Notification.requestPermission();
            }
            
            login(result.user);
            navigateTo('onboarding');
          }
        } catch (error) {
          alert('Signup failed. Please try again.');
        }
        
        setIsLoading(false);
      };

      const steps = ['Account Type', 'Basic Info', 'Contact', 'Terms'];

      return (
        <div className="min-h-screen flex items-center justify-center px-4 py-8">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6 w-full max-w-md`}>
            <div className="text-center mb-6">
              <div className="text-4xl mb-2">üîß</div>
              <h2 className="text-2xl font-bold">Create Account</h2>
              <p className="text-gray-600 mt-2">Join DIYMatch today</p>
            </div>

            <ProgressSteps steps={steps} currentStep={step - 1} />

            <form onSubmit={(e) => { e.preventDefault(); handleNext(); }} className="space-y-4">
              {step === 1 && (
                <div>
                  <h3 className="font-semibold mb-4">Choose your account type</h3>
                  <div className="grid grid-cols-2 gap-3">
                    <button
                      type="button"
                      onClick={() => setFormData({...formData, userType: 'customer'})}
                      className={`p-4 rounded-lg border-2 mobile-touch ${
                        formData.userType === 'customer' 
                          ? 'border-blue-600 bg-blue-50' 
                          : 'border-gray-300'
                      }`}
                    >
                      <div className="text-3xl mb-2">üè†</div>
                      <div className="font-medium">Homeowner</div>
                      <p className="text-xs text-gray-600 mt-1">
                        Get help with DIY projects
                      </p>
                    </button>
                    <button
                      type="button"
                      onClick={() => setFormData({...formData, userType: 'expert'})}
                      className={`p-4 rounded-lg border-2 mobile-touch ${
                        formData.userType === 'expert' 
                          ? 'border-blue-600 bg-blue-50' 
                          : 'border-gray-300'
                      }`}
                    >
                      <div className="text-3xl mb-2">üë®‚Äçüîß</div>
                      <div className="font-medium">Professional</div>
                      <p className="text-xs text-gray-600 mt-1">
                        Offer your services
                      </p>
                    </button>
                  </div>
                  {formData.userType === 'expert' && (
                    <div className="mt-4 p-3 bg-yellow-50 rounded-lg">
                      <p className="text-sm text-yellow-800">
                        <strong>Expert Account:</strong> Requires verification. 
                        You'll need to provide certifications and insurance details.
                      </p>
                    </div>
                  )}
                </div>
              )}

              {step === 2 && (
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Full Name</label>
                    <input
                      type="text"
                      value={formData.name}
                      onChange={(e) => setFormData({...formData, name: e.target.value})}
                      placeholder="John Smith"
                      className="w-full p-3 border rounded-lg"
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">Email</label>
                    <input
                      type="email"
                      value={formData.email}
                      onChange={(e) => setFormData({...formData, email: e.target.value})}
                      placeholder="your@email.com"
                      className="w-full p-3 border rounded-lg"
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">
                      Password
                      <span className="text-xs text-gray-500 ml-2">(min 8 characters)</span>
                    </label>
                    <input
                      type="password"
                      value={formData.password}
                      onChange={(e) => setFormData({...formData, password: e.target.value})}
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      className="w-full p-3 border rounded-lg"
                      required
                      minLength={8}
                    />
                    {formData.password && formData.password.length < 8 && (
                      <p className="text-xs text-red-500 mt-1">
                        Password must be at least 8 characters
                      </p>
                    )}
                  </div>
                </div>
              )}

              {step === 3 && (
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-2">Phone Number</label>
                    <input
                      type="tel"
                      value={formData.phone}
                      onChange={(e) => setFormData({...formData, phone: e.target.value})}
                      placeholder="07123456789"
                      className="w-full p-3 border rounded-lg"
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">Postcode</label>
                    <input
                      type="text"
                      value={formData.postcode}
                      onChange={(e) => setFormData({...formData, postcode: e.target.value.toUpperCase()})}
                      placeholder="SW1A 1AA"
                      className="w-full p-3 border rounded-lg"
                      required
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-2">
                      Referral Code 
                      <span className="text-xs text-gray-500 ml-2">(optional)</span>
                    </label>
                    <input
                      type="text"
                      value={formData.referralCode}
                      onChange={(e) => setFormData({...formData, referralCode: e.target.value.toUpperCase()})}
                      placeholder="DIYX1234"
                      className="w-full p-3 border rounded-lg"
                    />
                    <p className="text-xs text-green-600 mt-1">
                      Get ¬£{APP_CONFIG.referralBonus} credit with valid referral code!
                    </p>
                  </div>
                </div>
              )}

              {step === 4 && (
                <div className="space-y-4">
                  <div className="border rounded-lg p-4">
                    <label className="flex items-start space-x-3">
                      <input
                        type="checkbox"
                        checked={formData.acceptedTerms}
                        onChange={(e) => setFormData({...formData, acceptedTerms: e.target.checked})}
                        className="mt-1"
                      />
                      <div className="text-sm">
                        <p>
                          I accept the{' '}
                          <button
                            type="button"
                            onClick={() => setShowTerms(true)}
                            className="text-blue-600 underline"
                          >
                            Terms & Conditions
                          </button>
                          {' '}and{' '}
                          <button
                            type="button"
                            onClick={() => setShowTerms(true)}
                            className="text-blue-600 underline"
                          >
                            Privacy Policy
                          </button>
                        </p>
                      </div>
                    </label>
                  </div>

                  <div className="border rounded-lg p-4">
                    <label className="flex items-start space-x-3">
                      <input
                        type="checkbox"
                        checked={formData.marketingConsent}
                        onChange={(e) => setFormData({...formData, marketingConsent: e.target.checked})}
                        className="mt-1"
                      />
                      <div className="text-sm">
                        <p>
                          I'd like to receive helpful DIY tips, exclusive offers, and updates 
                          from DIYMatch (you can unsubscribe anytime)
                        </p>
                      </div>
                    </label>
                  </div>

                  {formData.userType === 'customer' && (
                    <div className="bg-green-50 rounded-lg p-4">
                      <h4 className="font-semibold text-green-800 mb-2">üéÅ Welcome Bonus!</h4>
                      <ul className="text-sm text-green-700 space-y-1">
                        <li>‚Ä¢ 1 FREE AI analysis every month</li>
                        <li>‚Ä¢ ¬£5 off your first expert booking</li>
                        <li>‚Ä¢ Access to exclusive DIY guides</li>
                      </ul>
                    </div>
                  )}
                </div>
              )}

              <div className="flex space-x-3 mt-6">
                {step > 1 && (
                  <button
                    type="button"
                    onClick={() => setStep(step - 1)}
                    className="flex-1 border border-gray-300 py-3 rounded-lg mobile-touch"
                  >
                    Back
                  </button>
                )}
                
                <button
                  type="submit"
                  disabled={isLoading || !validateStep()}
                  className={`flex-1 py-3 rounded-lg font-semibold mobile-touch flex items-center justify-center ${
                    validateStep() 
                      ? 'bg-blue-600 text-white' 
                      : 'bg-gray-300 text-gray-500'
                  }`}
                >
                  {isLoading ? (
                    <>
                      <LoadingSpinner size="small" color="white" />
                      <span className="ml-2">Creating...</span>
                    </>
                  ) : (
                    step === 4 ? 'Create Account' : 'Next'
                  )}
                </button>
              </div>

              {step === 1 && (
                <div className="text-center mt-6">
                  <p className="text-sm text-gray-600">
                    Already have an account?{' '}
                    <button
                      type="button"
                      onClick={() => navigateTo('login')}
                      className="text-blue-600 font-semibold hover:underline"
                    >
                      Sign in
                    </button>
                  </p>
                </div>
              )}
            </form>
          </div>

          {showTerms && (
            <TermsModal
              onClose={() => setShowTerms(false)}
              isDarkMode={isDarkMode}
            />
          )}
        </div>
      );
    };

    // Enhanced Terms & Conditions Modal
    const TermsModal = ({ onClose, isDarkMode }) => {
      const [activeTab, setActiveTab] = React.useState('terms');
      
      return (
        <Modal isOpen={true} onClose={onClose} title="Legal Information" size="large">
          <div className="mb-4">
            <div className="flex space-x-2 border-b">
              <button
                onClick={() => setActiveTab('terms')}
                className={`px-4 py-2 font-medium ${
                  activeTab === 'terms' 
                    ? 'border-b-2 border-blue-600 text-blue-600' 
                    : 'text-gray-600'
                }`}
              >
                Terms & Conditions
              </button>
              <button
                onClick={() => setActiveTab('privacy')}
                className={`px-4 py-2 font-medium ${
                  activeTab === 'privacy' 
                    ? 'border-b-2 border-blue-600 text-blue-600' 
                    : 'text-gray-600'
                }`}
              >
                Privacy Policy
              </button>
              <button
                onClick={() => setActiveTab('cookies')}
                className={`px-4 py-2 font-medium ${
                  activeTab === 'cookies' 
                    ? 'border-b-2 border-blue-600 text-blue-600' 
                    : 'text-gray-600'
                }`}
              >
                Cookie Policy
              </button>
            </div>
          </div>
          
          <div className="prose prose-sm max-w-none">
            {activeTab === 'terms' && (
              <>
                <h3 className="font-bold mb-3">DIYMatch Terms of Service</h3>
                <p className="mb-3">Last updated: {new Date().toLocaleDateString()}</p>
                
                <h4 className="font-bold mt-4 mb-2">1. Acceptance of Terms</h4>
                <p className="mb-3">
                  By accessing or using DIYMatch, you agree to be bound by these Terms. 
                  If you disagree with any part, you may not use our services.
                </p>
                
                <h4 className="font-bold mt-4 mb-2">2. Service Description</h4>
                <p className="mb-3">
                  DIYMatch provides AI-powered DIY analysis and connects users with independent tradespeople. 
                  We are a platform only and do not employ or endorse any experts.
                </p>
                
                <h4 className="font-bold mt-4 mb-2">3. User Responsibilities</h4>
                <ul className="list-disc pl-5 mb-3">
                  <li>Provide accurate information</li>
                  <li>Maintain account security</li>
                  <li>Verify expert credentials independently</li>
                  <li>Comply with all applicable laws</li>
                  <li>Accept all risks of DIY work</li>
                </ul>
                
                <h4 className="font-bold mt-4 mb-2">4. AI Analysis Service</h4>
                <p className="mb-3">
                  AI analysis is for guidance only, not professional advice. ¬£4.99 per issue with 
                  {APP_CONFIG.freeAnalysesPerMonth} free analysis per month. Results may not be accurate or complete.
                </p>
                
                <h4 className="font-bold mt-4 mb-2">5. Expert Services</h4>
                <p className="mb-3">
                  All experts are independent contractors. DIYMatch is not responsible for their work quality, 
                  conduct, or any damages. Users must verify qualifications and insurance.
                </p>
                
                <h4 className="font-bold mt-4 mb-2">6. Fees & Payments</h4>
                <ul className="list-disc pl-5 mb-3">
                  <li>AI Analysis: ¬£{APP_CONFIG.aiAnalysisPrice} per issue ({APP_CONFIG.freeAnalysesPerMonth} free per month)</li>
                  <li>Platform fee: {APP_CONFIG.platformCommission * 100}% of booking ({APP_CONFIG.sameDayCommission * 100}% for same-day)</li>
                  <li>Same-day surge: +{(APP_CONFIG.sameDayMultiplier - 1) * 100}% to customer</li>
                  <li>All payments are non-refundable unless service not provided</li>
                </ul>
                
                <h4 className="font-bold mt-4 mb-2">7. Liability Limitation</h4>
                <p className="mb-3">
                  DIYMatch shall not be liable for any damages arising from use of our services, 
                  including but not limited to property damage, personal injury, or financial losses.
                </p>
                
                <h4 className="font-bold mt-4 mb-2">8. Dispute Resolution</h4>
                <p className="mb-3">
                  Any disputes between users and experts must be resolved directly between the parties. 
                  DIYMatch may provide mediation assistance but is not obligated to do so.
                </p>
              </>
            )}
            
            {activeTab === 'privacy' && (
              <>
                <h3 className="font-bold mb-3">Privacy Policy</h3>
                <p className="mb-3">Last updated: {new Date().toLocaleDateString()}</p>
                
                <h4 className="font-bold mt-4 mb-2">Information We Collect</h4>
                <ul className="list-disc pl-5 mb-3">
                  <li>Personal information (name, email, phone, address)</li>
                  <li>Property images and videos for analysis</li>
                  <li>Location data for finding local experts</li>
                  <li>Payment information (processed securely via Stripe)</li>
                  <li>Communication between users and experts</li>
                </ul>
                
                <h4 className="font-bold mt-4 mb-2">How We Use Your Information</h4>
                <ul className="list-disc pl-5 mb-3">
                  <li>Provide AI analysis services</li>
                  <li>Connect you with suitable experts</li>
                  <li>Process payments and bookings</li>
                  <li>Send service updates and notifications</li>
                  <li>Improve our services through analytics</li>
                </ul>
                
                <h4 className="font-bold mt-4 mb-2">Data Security</h4>
                <p className="mb-3">
                  We use industry-standard encryption and security measures to protect your data. 
                  However, no method of transmission over the internet is 100% secure.
                </p>
                
                <h4 className="font-bold mt-4 mb-2">Your Rights</h4>
                <ul className="list-disc pl-5 mb-3">
                  <li>Access your personal data</li>
                  <li>Correct inaccurate data</li>
                  <li>Request deletion of your data</li>
                  <li>Opt-out of marketing communications</li>
                  <li>Export your data in a portable format</li>
                </ul>
              </>
            )}
            
            {activeTab === 'cookies' && (
              <>
                <h3 className="font-bold mb-3">Cookie Policy</h3>
                <p className="mb-3">Last updated: {new Date().toLocaleDateString()}</p>
                
                <h4 className="font-bold mt-4 mb-2">What Are Cookies?</h4>
                <p className="mb-3">
                  Cookies are small text files stored on your device when you visit our website. 
                  They help us provide a better user experience.
                </p>
                
                <h4 className="font-bold mt-4 mb-2">Types of Cookies We Use</h4>
                <ul className="list-disc pl-5 mb-3">
                  <li><strong>Essential Cookies:</strong> Required for the website to function</li>
                  <li><strong>Analytics Cookies:</strong> Help us understand how you use our site</li>
                  <li><strong>Preference Cookies:</strong> Remember your settings and preferences</li>
                  <li><strong>Marketing Cookies:</strong> Used to deliver relevant advertisements</li>
                </ul>
                
                <h4 className="font-bold mt-4 mb-2">Managing Cookies</h4>
                <p className="mb-3">
                  You can control cookies through your browser settings. However, disabling certain 
                  cookies may impact the functionality of our website.
                </p>
              </>
            )}
          </div>
          
          <div className="mt-6 flex justify-end">
            <button
              onClick={onClose}
              className="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold mobile-touch"
            >
              Close
            </button>
          </div>
        </Modal>
      );
    };

    // Onboarding Flow for New Users
    const OnboardingPage = ({ navigateTo }) => {
      const { user } = React.useContext(AuthContext);
      const [currentSlide, setCurrentSlide] = React.useState(0);
      
      const slides = [
        {
          icon: 'ü§ñ',
          title: 'AI-Powered Analysis',
          description: 'Take a photo or video of any DIY issue and get instant AI analysis',
          features: ['Problem identification', 'Safety assessment', 'Cost estimation']
        },
        {
          icon: 'üë®‚Äçüîß',
          title: 'Verified Experts',
          description: 'Connect with background-checked professionals in your area',
          features: ['Read reviews', 'Compare quotes', 'Book instantly']
        },
        {
          icon: 'üí∞',
          title: 'Fair & Transparent Pricing',
          description: 'No hidden fees. Pay per issue for AI analysis or book experts directly',
          features: ['¬£4.99 per AI analysis', '1 FREE analysis/month', 'Secure payments']
        },
        {
          icon: 'üéÅ',
          title: 'Your Referral Code',
          description: `Share your code: ${user?.referralCode || 'DIYX1234'}`,
          features: [`Earn ¬£${APP_CONFIG.referralBonus} per referral`, 'Unlimited earnings', 'Track your rewards']
        }
      ];
      
      return (
        <div className="min-h-screen flex flex-col">
          <div className="flex-1 flex items-center justify-center p-4">
            <div className="w-full max-w-md">
              <div className="text-center mb-8">
                <div className="text-6xl mb-4 float-animation">
                  {slides[currentSlide].icon}
                </div>
                <h2 className="text-2xl font-bold mb-2">{slides[currentSlide].title}</h2>
                <p className="text-gray-600 mb-6">{slides[currentSlide].description}</p>
                
                <div className="space-y-2">
                  {slides[currentSlide].features.map((feature, idx) => (
                    <div key={idx} className="flex items-center justify-center space-x-2">
                      <span className="text-green-500">‚úì</span>
                      <span className="text-sm">{feature}</span>
                    </div>
                  ))}
                </div>
              </div>
              
              <div className="flex justify-center space-x-2 mb-8">
                {slides.map((_, idx) => (
                  <div
                    key={idx}
                    className={`h-2 rounded-full transition-all ${
                      idx === currentSlide ? 'w-8 bg-blue-600' : 'w-2 bg-gray-300'
                    }`}
                  />
                ))}
              </div>
              
              <div className="flex space-x-3">
                {currentSlide > 0 && (
                  <button
                    onClick={() => setCurrentSlide(currentSlide - 1)}
                    className="flex-1 border border-gray-300 py-3 rounded-lg mobile-touch"
                  >
                    Back
                  </button>
                )}
                
                <button
                  onClick={() => {
                    if (currentSlide < slides.length - 1) {
                      setCurrentSlide(currentSlide + 1);
                    } else {
                      navigateTo('dashboard');
                    }
                  }}
                  className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold mobile-touch"
                >
                  {currentSlide === slides.length - 1 ? 'Get Started' : 'Next'}
                </button>
              </div>
              
              {currentSlide === slides.length - 1 && (
                <button
                  onClick={() => navigateTo('dashboard')}
                  className="w-full mt-3 text-gray-600 py-2"
                >
                  Skip for now
                </button>
              )}
            </div>
          </div>
        </div>
      );
    };

    // Enhanced Dashboard Page
    const DashboardPage = ({ navigateTo }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const { user, logout } = React.useContext(AuthContext);
      const { notifications } = React.useContext(NotificationContext);
      const [activeTab, setActiveTab] = React.useState('home');
      const [showNotifications, setShowNotifications] = React.useState(false);

      if (!user) {
        navigateTo('welcome');
        return null;
      }

      const userBookings = bookings.get(user.email) || [];
      const userAnalyses = aiAnalysisHistory.get(user.email) || [];
      const userProjects = savedProjects.get(user.email) || [];
      const userNotifs = userNotifications.get(user.email) || [];
      const unreadCount = userNotifs.filter(n => !n.read).length;

      // Quick stats
      const stats = {
        analysesThisMonth: userAnalyses.filter(a => {
          const analysisDate = new Date(a.timestamp);
          const now = new Date();
          return analysisDate.getMonth() === now.getMonth() && 
                 analysisDate.getFullYear() === now.getFullYear();
        }).length,
        activeBookings: userBookings.filter(b => b.status !== 'completed').length,
        totalSaved: userAnalyses.reduce((sum, a) => {
          const match = a.estimatedCost.match(/¬£(\d+)/);
          return sum + (match ? parseInt(match[1]) * 0.7 : 0); // Assuming 70% savings on DIY
        }, 0),
        referralEarnings: referralCodes.get(user.referralCode)?.earnings || 0
      };

      return (
        <div className="min-h-screen safe-area-top">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} shadow-sm`}>
            <div className="p-4">
              <div className="flex items-center justify-between mb-4">
                <div>
                  <h1 className="text-xl font-bold">Welcome, {user.name}</h1>
                  <p className="text-sm text-gray-600">
                    {new Date().toLocaleDateString('en-GB', { 
                      weekday: 'long', 
                      day: 'numeric', 
                      month: 'long' 
                    })}
                  </p>
                </div>
                <div className="flex items-center space-x-3">
                  <button
                    onClick={() => setShowNotifications(true)}
                    className="relative p-2 mobile-touch"
                  >
                    <span className="text-2xl">üîî</span>
                    <NotificationBadge count={unreadCount} />
                  </button>
                  <button
                    onClick={() => {
                      if (confirm('Are you sure you want to logout?')) {
                        logout();
                        navigateTo('welcome');
                      }
                    }}
                    className="text-red-600 mobile-touch"
                  >
                    Logout
                  </button>
                </div>
              </div>

              <div className="flex space-x-2 overflow-x-auto pb-2">
                {['home', 'activity', 'projects', 'rewards'].map(tab => (
                  <button
                    key={tab}
                    onClick={() => setActiveTab(tab)}
                    className={`px-4 py-2 rounded-lg whitespace-nowrap mobile-touch ${
                      activeTab === tab ? 'bg-blue-600 text-white' : 'bg-gray-200'
                    }`}
                  >
                    {tab.charAt(0).toUpperCase() + tab.slice(1)}
                  </button>
                ))}
              </div>
            </div>
          </div>

          <div className="p-4">
            {activeTab === 'home' && (
              <div className="space-y-4">
                {/* Quick Stats */}
                <div className="grid grid-cols-2 gap-3">
                  <div className="bg-blue-50 rounded-xl p-4">
                    <div className="text-blue-600 text-2xl font-bold">
                      {stats.analysesThisMonth}/{APP_CONFIG.freeAnalysesPerMonth}
                    </div>
                    <p className="text-sm text-blue-800">Free analyses used</p>
                  </div>
                  <div className="bg-green-50 rounded-xl p-4">
                    <div className="text-green-600 text-2xl font-bold">
                      ¬£{stats.totalSaved}
                    </div>
                    <p className="text-sm text-green-800">Estimated savings</p>
                  </div>
                  <div className="bg-purple-50 rounded-xl p-4">
                    <div className="text-purple-600 text-2xl font-bold">
                      {stats.activeBookings}
                    </div>
                    <p className="text-sm text-purple-800">Active bookings</p>
                  </div>
                  <div className="bg-orange-50 rounded-xl p-4">
                    <div className="text-orange-600 text-2xl font-bold">
                      ¬£{stats.referralEarnings}
                    </div>
                    <p className="text-sm text-orange-800">Referral earnings</p>
                  </div>
                </div>

                {/* Quick Actions */}
                <div className="grid grid-cols-2 gap-4">
                  <button
                    onClick={() => navigateTo('analysis')}
                    className="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 rounded-xl mobile-touch relative overflow-hidden"
                  >
                    <div className="absolute top-0 right-0 w-20 h-20 bg-white opacity-10 rounded-full -mr-10 -mt-10" />
                    <div className="text-3xl mb-2">ü§ñ</div>
                    <div className="font-semibold">AI Analysis</div>
                    <div className="text-sm opacity-90">Quick diagnosis</div>
                    {checkFreeAnalysisAvailable(user.email) && (
                      <div className="absolute top-2 right-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full">
                        FREE
                      </div>
                    )}
                  </button>

                  <button
                    onClick={() => navigateTo('experts')}
                    className="bg-gradient-to-r from-green-600 to-green-700 text-white p-6 rounded-xl mobile-touch relative overflow-hidden"
                  >
                    <div className="absolute top-0 right-0 w-20 h-20 bg-white opacity-10 rounded-full -mr-10 -mt-10" />
                    <div className="text-3xl mb-2">üë®‚Äçüîß</div>
                    <div className="font-semibold">Find Expert</div>
                    <div className="text-sm opacity-90">Get help now</div>
                  </button>

                  <button
                    onClick={() => navigateTo('parts')}
                    className="bg-gradient-to-r from-purple-600 to-purple-700 text-white p-6 rounded-xl mobile-touch relative overflow-hidden"
                  >
                    <div className="absolute top-0 right-0 w-20 h-20 bg-white opacity-10 rounded-full -mr-10 -mt-10" />
                    <div className="text-3xl mb-2">üõ†Ô∏è</div>
                    <div className="font-semibold">Parts Finder</div>
                    <div className="text-sm opacity-90">Local stores</div>
                  </button>

                  <button
                    onClick={() => navigateTo('emergency')}
                    className="bg-gradient-to-r from-red-600 to-red-700 text-white p-6 rounded-xl mobile-touch relative overflow-hidden"
                  >
                    <div className="absolute top-0 right-0 w-20 h-20 bg-white opacity-10 rounded-full -mr-10 -mt-10" />
                    <div className="text-3xl mb-2">üö®</div>
                    <div className="font-semibold">Emergency</div>
                    <div className="text-sm opacity-90">Urgent help</div>
                  </button>
                </div>

                {/* Recent Activity */}
                {(userAnalyses.length > 0 || userBookings.length > 0) && (
                  <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}>
                    <h3 className="font-semibold mb-3">Recent Activity</h3>
                    <div className="space-y-3">
                      {userAnalyses.slice(0, 2).map(analysis => (
                        <div key={analysis.id} className="flex items-center space-x-3">
                          <div className="text-2xl">
                            {analysis.severity === 'Critical' ? 'üö®' : 'üîç'}
                          </div>
                          <div className="flex-1">
                            <p className="font-medium text-sm">{analysis.problemDetected}</p>
                            <p className="text-xs text-gray-600">
                              {new Date(analysis.timestamp).toLocaleDateString()}
                            </p>
                          </div>
                          <button
                            onClick={() => {
                              window.selectedAnalysis = analysis;
                              navigateTo('analysis-detail');
                            }}
                            className="text-blue-600 text-sm"
                          >
                            View
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Tips Card */}
                <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl p-4">
                  <h4 className="font-semibold mb-2">üí° DIY Tip of the Day</h4>
                  <p className="text-sm opacity-90">
                    Always turn off electricity at the breaker before working on any electrical fixtures. 
                    Safety first!
                  </p>
                </div>
              </div>
            )}

            {activeTab === 'activity' && (
              <div className="space-y-4">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-semibold">Your Activity</h3>
                  <select className="border rounded-lg px-3 py-1 text-sm">
                    <option>All Time</option>
                    <option>This Month</option>
                    <option>This Week</option>
                  </select>
                </div>

                {userAnalyses.length === 0 && userBookings.length === 0 ? (
                  <EmptyState
                    icon="üìä"
                    title="No activity yet"
                    description="Start with an AI analysis or book an expert"
                    action={
                      <button
                        onClick={() => navigateTo('analysis')}
                        className="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg mobile-touch"
                      >
                        Start Analysis
                      </button>
                    }
                  />
                ) : (
                  <div className="space-y-3">
                    {/* Mix analyses and bookings by date */}
                    {[...userAnalyses, ...userBookings]
                      .sort((a, b) => new Date(b.timestamp || b.createdAt) - new Date(a.timestamp || a.createdAt))
                      .map(item => (
                        <div 
                          key={item.id} 
                          className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-4 shadow-sm`}
                        >
                          {item.problemDetected ? (
                            // Analysis item
                            <div className="flex items-start justify-between">
                              <div className="flex items-start space-x-3">
                                <div className="text-2xl">
                                  {item.severity === 'Critical' ? 'üö®' :
                                   item.severity === 'High' ? '‚ö†Ô∏è' :
                                   item.severity === 'Medium' ? '‚ö°' : '‚úÖ'}
                                </div>
                                <div>
                                  <h4 className="font-semibold">{item.problemDetected}</h4>
                                  <p className="text-sm text-gray-600 mt-1">
                                    AI Analysis ‚Ä¢ {new Date(item.timestamp).toLocaleDateString()}
                                  </p>
                                  <p className="text-sm mt-1">
                                    Estimated cost: {item.estimatedCost}
                                  </p>
                                </div>
                              </div>
                              <button
                                onClick={() => {
                                  window.selectedAnalysis = item;
                                  navigateTo('analysis-detail');
                                }}
                                className="text-blue-600 text-sm mobile-touch"
                              >
                                View
                              </button>
                            </div>
                          ) : (
                            // Booking item
                            <div className="flex items-start justify-between">
                              <div className="flex items-start space-x-3">
                                <div className="text-2xl">üìÖ</div>
                                <div>
                                  <h4 className="font-semibold">{item.expertName}</h4>
                                  <p className="text-sm text-gray-600 mt-1">
                                    Booking ‚Ä¢ {new Date(item.date).toLocaleDateString()}
                                  </p>
                                  <p className="text-sm mt-1">
                                    Status: <span className={`font-medium ${
                                      item.status === 'completed' ? 'text-green-600' : 'text-blue-600'
                                    }`}>{item.status}</span>
                                  </p>
                                </div>
                              </div>
                              <button
                                onClick={() => {
                                  window.selectedBooking = item;
                                  navigateTo('booking-detail');
                                }}
                                className="text-blue-600 text-sm mobile-touch"
                              >
                                View
                              </button>
                            </div>
                          )}
                        </div>
                      ))}
                  </div>
                )}
              </div>
            )}

            {activeTab === 'projects' && (
              <div className="space-y-4">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-semibold">My Projects</h3>
                  <button
                    onClick={() => navigateTo('create-project')}
                    className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm mobile-touch"
                  >
                    + New Project
                  </button>
                </div>

                {userProjects.length === 0 ? (
                  <EmptyState
                    icon="üìÅ"
                    title="No projects yet"
                    description="Create a project to track your DIY work"
                    action={
                      <button
                        onClick={() => navigateTo('create-project')}
                        className="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg mobile-touch"
                      >
                        Create Project
                      </button>
                    }
                  />
                ) : (
                  <div className="grid grid-cols-2 gap-3">
                    {userProjects.map(project => (
                      <div 
                        key={project.id}
                        onClick={() => {
                          window.selectedProject = project;
                          navigateTo('project-detail');
                        }}
                        className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-lg p-4 shadow-sm mobile-touch`}
                      >
                        <div className="text-2xl mb-2">{project.icon || 'üî®'}</div>
                        <h4 className="font-semibold text-sm">{project.name}</h4>
                        <p className="text-xs text-gray-600 mt-1">
                          {project.tasks?.filter(t => t.completed).length || 0}/{project.tasks?.length || 0} tasks
                        </p>
                        <div className="mt-2">
                          <div className="bg-gray-200 rounded-full h-2">
                            <div 
                              className="bg-blue-600 h-2 rounded-full"
                              style={{ 
                                width: `${project.tasks?.length ? 
                                  (project.tasks.filter(t => t.completed).length / project.tasks.length * 100) : 0}%` 
                              }}
                            />
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            )}

            {activeTab === 'rewards' && (
              <div className="space-y-4">
                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-6 shadow-sm text-center`}>
                  <div className="text-4xl mb-2">üéÅ</div>
                  <h3 className="text-xl font-bold mb-2">Your Referral Code</h3>
                  <div className="bg-blue-50 text-blue-800 text-2xl font-mono font-bold py-3 px-4 rounded-lg mb-4">
                    {user.referralCode}
                  </div>
                  <p className="text-sm text-gray-600 mb-4">
                    Share this code with friends. You both get ¬£{APP_CONFIG.referralBonus} credit!
                  </p>
                  <button
                    onClick={() => {
                      navigator.clipboard.writeText(user.referralCode);
                      alert('Referral code copied!');
                    }}
                    className="bg-blue-600 text-white px-6 py-2 rounded-lg mobile-touch"
                  >
                    Copy Code
                  </button>
                </div>

                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}>
                  <h4 className="font-semibold mb-3">Referral Stats</h4>
                  <div className="space-y-2">
                    <div className="flex justify-between">
                      <span>Total Referrals:</span>
                      <span className="font-medium">{referralCodes.get(user.referralCode)?.uses || 0}</span>
                    </div>
                    <div className="flex justify-between">
                      <span>Total Earned:</span>
                      <span className="font-medium text-green-600">
                        ¬£{referralCodes.get(user.referralCode)?.earnings || 0}
                      </span>
                    </div>
                    <div className="flex justify-between">
                      <span>Pending Credits:</span>
                      <span className="font-medium">¬£0</span>
                    </div>
                  </div>
                </div>

                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}>
                  <h4 className="font-semibold mb-3">Achievements</h4>
                  <div className="grid grid-cols-3 gap-3">
                    {[
                      { icon: 'üåü', name: 'First Analysis', earned: userAnalyses.length > 0 },
                      { icon: 'üë•', name: 'First Referral', earned: (referralCodes.get(user.referralCode)?.uses || 0) > 0 },
                      { icon: 'üèÜ', name: 'Super User', earned: userAnalyses.length >= 10 }
                    ].map((achievement, idx) => (
                      <div 
                        key={idx}
                        className={`text-center p-3 rounded-lg ${
                          achievement.earned ? 'bg-yellow-50' : 'bg-gray-100 opacity-50'
                        }`}
                      >
                        <div className="text-2xl mb-1">{achievement.icon}</div>
                        <p className="text-xs">{achievement.name}</p>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            )}
          </div>

          {/* Bottom Navigation */}
          <div className={`fixed bottom-0 left-0 right-0 ${isDarkMode ? 'bg-gray-800' : 'bg-white'} border-t safe-area-bottom`}>
            <div className="flex justify-around py-2">
              <button
                onClick={() => navigateTo('dashboard')}
                className="p-3 mobile-touch"
              >
                <div className="text-center">
                  <div className="text-2xl">üè†</div>
                  <div className="text-xs">Home</div>
                </div>
              </button>
              <button
                onClick={() => navigateTo('analysis')}
                className="p-3 mobile-touch relative"
              >
                <div className="text-center">
                  <div className="text-2xl">üì∏</div>
                  <div className="text-xs">Analyze</div>
                </div>
                {checkFreeAnalysisAvailable(user.email) && (
                  <span className="absolute top-0 right-0 bg-green-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                    1
                  </span>
                )}
              </button>
              <button
                onClick={() => navigateTo('experts')}
                className="p-3 mobile-touch"
              >
                <div className="text-center">
                  <div className="text-2xl">üë®‚Äçüîß</div>
                  <div className="text-xs">Experts</div>
                </div>
              </button>
              <button
                onClick={() => navigateTo('bookings')}
                className="p-3 mobile-touch relative"
              >
                <div className="text-center">
                  <div className="text-2xl">üìÖ</div>
                  <div className="text-xs">Bookings</div>
                </div>
                <NotificationBadge count={stats.activeBookings} />
              </button>
              <button
                onClick={() => navigateTo('profile')}
                className="p-3 mobile-touch"
              >
                <div className="text-center">
                  <div className="text-2xl">üë§</div>
                  <div className="text-xs">Profile</div>
                </div>
              </button>
            </div>
          </div>

          {/* Notifications Modal */}
          {showNotifications && (
            <NotificationsModal
              notifications={userNotifs}
              onClose={() => setShowNotifications(false)}
              onMarkRead={(id) => {
                const notif = userNotifs.find(n => n.id === id);
                if (notif) notif.read = true;
              }}
            />
          )}
        </div>
      );
    };

    // Notifications Modal
    const NotificationsModal = ({ notifications, onClose, onMarkRead }) => {
      const [filter, setFilter] = React.useState('all');
      
      const filteredNotifications = notifications.filter(n => {
        if (filter === 'all') return true;
        if (filter === 'unread') return !n.read;
        return n.type === filter;
      });
      
      return (
        <Modal isOpen={true} onClose={onClose} title="Notifications" size="medium">
          <div className="mb-4">
            <div className="flex space-x-2 overflow-x-auto">
              {['all', 'unread', 'bookings', 'quotes', 'system'].map(f => (
                <button
                  key={f}
                  onClick={() => setFilter(f)}
                  className={`px-3 py-1 rounded-lg text-sm whitespace-nowrap ${
                    filter === f ? 'bg-blue-600 text-white' : 'bg-gray-200'
                  }`}
                >
                  {f.charAt(0).toUpperCase() + f.slice(1)}
                </button>
              ))}
            </div>
          </div>
          
          {filteredNotifications.length === 0 ? (
            <EmptyState
              icon="üîî"
              title="No notifications"
              description={filter === 'unread' ? 'All caught up!' : 'No notifications yet'}
            />
          ) : (
            <div className="space-y-3">
              {filteredNotifications.map(notif => (
                <div 
                  key={notif.id}
                  onClick={() => onMarkRead(notif.id)}
                  className={`p-3 rounded-lg border ${
                    notif.read ? 'bg-gray-50 border-gray-200' : 'bg-blue-50 border-blue-200'
                  } mobile-touch`}
                >
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <h4 className="font-medium text-sm">{notif.title}</h4>
                      <p className="text-sm text-gray-600 mt-1">{notif.body}</p>
                      <p className="text-xs text-gray-500 mt-2">
                        {new Date(notif.timestamp).toLocaleString()}
                      </p>
                    </div>
                    {!notif.read && (
                      <div className="w-2 h-2 bg-blue-600 rounded-full ml-3 mt-2" />
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </Modal>
      );
    };

    // Complete AI Analysis Page with all features
    const AIAnalysisPage = ({ navigateTo }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const { user } = React.useContext(AuthContext);
      const { addNotification } = React.useContext(NotificationContext);
      const [step, setStep] = React.useState('waiver');
      const [media, setMedia] = React.useState(null);
      const [additionalMedia, setAdditionalMedia] = React.useState([]);
      const [description, setDescription] = React.useState('');
      const [voiceNote, setVoiceNote] = React.useState(null);
      const [progress, setProgress] = React.useState(0);
      const [progressMessage, setProgressMessage] = React.useState('');
      const [analysisResult, setAnalysisResult] = React.useState(null);
      const [acceptedWaiver, setAcceptedWaiver] = React.useState(false);
      const [showPartsModal, setShowPartsModal] = React.useState(false);
      const [selectedParts, setSelectedParts] = React.useState([]);
      const [showAISuggestions, setShowAISuggestions] = React.useState(false);
      const [urgencyLevel, setUrgencyLevel] = React.useState('normal');
      const [location, setLocation] = React.useState(null);
      const [showARView, setShowARView] = React.useState(false);

      React.useEffect(() => {
        if (!user) {
          alert('Please sign in to use AI Analysis');
          navigateTo('login');
        }
      }, [user]);

      React.useEffect(() => {
        // Get user location for better expert matching
        getUserLocation().then(loc => setLocation(loc));
      }, []);

      const handleWaiverAccept = () => {
        if (!acceptedWaiver) {
          alert('Please accept the waiver to continue');
          return;
        }
        setStep('capture');
      };

      const handleMediaCapture = async (type) => {
        try {
          let mediaData;
          if (type === 'video') {
            mediaData = await takeVideo();
          } else if (type === 'voice') {
            mediaData = await recordVoiceNote();
            setVoiceNote(mediaData);
            return;
          } else {
            mediaData = await takePhoto();
          }
          
          if (mediaData) {
            if (!media) {
              setMedia(mediaData);
              setStep('describe');
            } else {
              setAdditionalMedia([...additionalMedia, mediaData]);
            }
            triggerHaptic('success');
          }
        } catch (error) {
          console.error('Media capture error:', error);
          alert('Failed to capture media. Please try again.');
        }
      };

      const checkAnalysisPayment = () => {
        // Generate unique issue ID
        const issueId = btoa(
          description + 
          (media?.data || '').substring(0, 100) + 
          Date.now()
        ).substring(0, 20);
        
        const purchases = userAnalysisPurchases.get(user.email) || [];
        
        if (purchases.includes(issueId)) {
          return { paid: true, issueId };
        }
        return { paid: false, issueId };
      };

      const handleAnalyze = () => {
        if (!navigator.onLine) {
          alert('Internet connection required for AI analysis');
          return;
        }

        // Validate inputs
        if (!media) {
          alert('Please capture a photo or video first');
          return;
        }

        if (!description || description.length < 10) {
          alert('Please provide a detailed description (at least 10 characters)');
          return;
        }

        // Set urgency level
        const urgentKeywords = ['urgent', 'emergency', 'flooding', 'gas', 'smoke', 'fire', 'dangerous', 'sparking'];
        const descLower = description.toLowerCase();
        if (urgentKeywords.some(keyword => descLower.includes(keyword))) {
          setUrgencyLevel('urgent');
        }

        const hasFreeAnalysis = checkFreeAnalysisAvailable(user.email);
        const { paid } = checkAnalysisPayment();
        
        if (hasFreeAnalysis || paid) {
          if (hasFreeAnalysis && !paid) {
            useFreeAnalysis(user.email);
            addNotification({
              title: 'Free Analysis Used',
              body: 'Using your monthly free AI analysis!',
              type: 'system'
            });
          }
          startAnalysis();
        } else {
          setStep('payment');
        }
      };

      const handlePayment = async () => {
        const { issueId } = checkAnalysisPayment();
        
        const result = await processPayment(APP_CONFIG.aiAnalysisPrice, {
          description: 'DIYMatch AI Analysis - Per Issue',
          userEmail: user.email,
          issueId: issueId
        });

        if (result.success) {
          const purchases = userAnalysisPurchases.get(user.email) || [];
          purchases.push(issueId);
          userAnalysisPurchases.set(user.email, purchases);
          
          // Update user's total spent
          const userRecord = registeredUsers.get(user.email.toLowerCase());
          if (userRecord) {
            userRecord.totalSpent = (userRecord.totalSpent || 0) + APP_CONFIG.aiAnalysisPrice;
          }
          
          startAnalysis();
        } else {
          alert('Payment failed. Please try again.');
        }
      };

      const startAnalysis = async () => {
        setStep('analyzing');
        
        try {
          const result = await performAIAnalysis(media, description, (progress, message) => {
            setProgress(progress);
            setProgressMessage(message);
          });
          
          result.urgencyLevel = urgencyLevel;
          result.location = location;
          result.additionalMedia = additionalMedia;
          result.voiceNote = voiceNote;
          
          // Save analysis
          await dbOperations.saveAnalysis({
            ...result,
            userEmail: user.email,
            media: media.type,
            description
          });

          // Send email with results
          await sendEmail(user.email, 'analysisComplete', { analysis: result, user });

          setAnalysisResult(result);
          setStep('results');
          triggerHaptic('success');
          
          // Add notification
          addNotification({
            title: 'Analysis Complete',
            body: `${result.problemDetected} - ${result.severity} severity`,
            type: 'analysis'
          });
        } catch (error) {
          console.error('Analysis error:', error);
          alert('Analysis failed: ' + error.message);
          setStep('describe');
        }
      };

      // AI Suggestion Helper
      const getAISuggestions = () => [
        'Is this an urgent/emergency situation?',
        'Is there active water/gas/electrical hazard?',
        'When did you first notice this issue?',
        'Has this problem occurred before?',
        'Are there any unusual sounds, smells, or visual signs?',
        'What have you tried to fix it already?',
        'Is the issue getting worse over time?',
        'Are other areas/rooms affected?'
      ];

      const handleExpertBooking = (expert) => {
        window.selectedExpert = expert;
        window.analysisContext = analysisResult;
        navigateTo('expert-detail');
      };

      const handleSaveAnalysis = () => {
        // Already saved during analysis
        addNotification({
          title: 'Analysis Saved',
          body: 'You can view this analysis in your activity history',
          type: 'system'
        });
      };

      const handleShareAnalysis = () => {
        if (navigator.share) {
          navigator.share({
            title: 'DIYMatch Analysis Results',
            text: `${analysisResult.problemDetected} - Get the DIYMatch app for AI-powered DIY help!`,
            url: window.location.href
          });
        } else {
          // Fallback
          const shareText = `Check out my DIYMatch analysis: ${analysisResult.problemDetected}. Estimated cost: ${analysisResult.estimatedCost}`;
          navigator.clipboard.writeText(shareText);
          alert('Analysis summary copied to clipboard!');
        }
      };

      if (!user) return null;

      return (
        <div className="min-h-screen safe-area-top pb-20">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} shadow-sm`}>
            <div className="flex items-center p-4">
              <button
                onClick={() => {
                  if (step !== 'waiver' && step !== 'results') {
                    if (confirm('Exit analysis? Your progress will be lost.')) {
                      navigateTo('dashboard');
                    }
                  } else {
                    navigateTo('dashboard');
                  }
                }}
                className="mr-4 mobile-touch"
              >
                ‚Üê
              </button>
              <h1 className="text-xl font-bold">ü§ñ AI Analysis</h1>
              <div className="ml-auto">
                {user && checkFreeAnalysisAvailable(user.email) ? (
                  <span className="text-sm bg-green-100 text-green-800 px-2 py-1 rounded font-medium">
                    1 FREE available
                  </span>
                ) : (
                  <span className="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">
                    ¬£{APP_CONFIG.aiAnalysisPrice}/issue
                  </span>
                )}
              </div>
            </div>
          </div>

          <div className="p-4">
            {step === 'waiver' && (
              <div className="max-w-md mx-auto">
                <div className="text-center mb-6">
                  <div className="text-6xl mb-4">üìã</div>
                  <h2 className="text-2xl font-bold mb-2">Important Agreement</h2>
                  <p className="text-gray-600">Please read and accept before proceeding</p>
                </div>

                <div className="border rounded-lg p-4 mb-4">
                  <h4 className="font-semibold mb-2">Terms & Liability Waiver</h4>
                  <div className="text-sm text-gray-600 space-y-2">
                    <p>‚Ä¢ AI analysis is for guidance only, not professional advice</p>
                    <p className="font-medium text-green-600">‚Ä¢ First analysis each month is FREE!</p>
                    <p>‚Ä¢ Additional analyses: ¬£{APP_CONFIG.aiAnalysisPrice} per issue</p>
                    <p>‚Ä¢ Results may not be 100% accurate</p>
                    <p>‚Ä¢ Always consult professionals for serious issues</p>
                    <p>‚Ä¢ You accept full responsibility for any DIY work</p>
                    <p>‚Ä¢ DIYMatch is not liable for any damages or injuries</p>
                    <p>‚Ä¢ Internet connection required for analysis</p>
                    <p>‚Ä¢ Your data is processed securely and privately</p>
                  </div>
                  
                  <div className="mt-4 p-3 bg-yellow-50 rounded-lg">
                    <p className="text-sm text-yellow-800">
                      <strong>‚ö†Ô∏è Warning:</strong> For gas, electrical, or structural issues, 
                      we strongly recommend professional help.
                    </p>
                  </div>
                  
                  <label className="flex items-start space-x-3 mt-4">
                    <input
                      type="checkbox"
                      checked={acceptedWaiver}
                      onChange={(e) => setAcceptedWaiver(e.target.checked)}
                      className="mt-1"
                    />
                    <span className="text-sm font-medium">
                      I have read, understood, and accept these terms
                    </span>
                  </label>
                </div>

                <button
                  onClick={handleWaiverAccept}
                  disabled={!acceptedWaiver}
                  className={`w-full py-3 rounded-lg font-semibold mobile-touch ${
                    acceptedWaiver ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-500'
                  }`}
                >
                  Continue to Camera
                </button>
              </div>
            )}

            {step === 'capture' && (
              <div className="text-center max-w-md mx-auto">
                <div className="mb-8">
                  <div className="text-6xl mb-4">üì∏</div>
                  <h2 className="text-2xl font-bold mb-2">Capture Your Problem</h2>
                  <p className="text-gray-600">Take clear photos/videos from multiple angles</p>
                </div>

                <div className="space-y-3">
                  <button
                    onClick={() => handleMediaCapture('photo')}
                    className="w-full bg-blue-600 text-white px-6 py-4 rounded-xl font-semibold mobile-touch flex items-center justify-center space-x-2"
                  >
                    <span>üì∑</span>
                    <span>Take Photo</span>
                  </button>
                  
                  <button
                    onClick={() => handleMediaCapture('video')}
                    className="w-full bg-purple-600 text-white px-6 py-4 rounded-xl font-semibold mobile-touch flex items-center justify-center space-x-2"
                  >
                    <span>üé•</span>
                    <span>Record Video</span>
                    <span className="text-xs bg-purple-500 px-2 py-1 rounded ml-2">Recommended</span>
                  </button>
                  
                  <button
                    onClick={() => setShowARView(true)}
                    className="w-full bg-orange-600 text-white px-6 py-4 rounded-xl font-semibold mobile-touch flex items-center justify-center space-x-2"
                  >
                    <span>üìê</span>
                    <span>AR Measure</span>
                    <span className="text-xs bg-red-500 px-2 py-1 rounded ml-2">BETA</span>
                  </button>
                  
                  <button
                    onClick={() => handleMediaCapture('voice')}
                    className="w-full bg-green-600 text-white px-6 py-4 rounded-xl font-semibold mobile-touch flex items-center justify-center space-x-2"
                  >
                    <span>üé§</span>
                    <span>Record Voice Note</span>
                  </button>
                  
                  <p className="text-xs text-gray-500 mt-4">
                    Tips: Good lighting, show the full problem area, capture any labels/model numbers
                  </p>
                </div>
              </div>
            )}

            {step === 'describe' && (
              <div className="max-w-md mx-auto">
                <div className="mb-4">
                  {/* Main media preview */}
                  {media.type === 'image' ? (
                    <img 
                      src={media.data} 
                      className="w-full rounded-xl mb-4"
                      style={{ maxHeight: '300px', objectFit: 'cover' }}
                    />
                  ) : (
                    <video 
                      src={media.data} 
                      controls
                      className="w-full rounded-xl mb-4"
                      style={{ maxHeight: '300px' }}
                    />
                  )}
                  
                  {/* Additional media thumbnails */}
                  {additionalMedia.length > 0 && (
                    <div className="flex space-x-2 mb-4 overflow-x-auto">
                      {additionalMedia.map((item, idx) => (
                        <div key={idx} className="relative flex-shrink-0">
                          {item.type === 'image' ? (
                            <img 
                              src={item.data} 
                              className="w-20 h-20 object-cover rounded-lg"
                            />
                          ) : (
                            <video 
                              src={item.data}
                              className="w-20 h-20 object-cover rounded-lg"
                            />
                          )}
                          <button
                            onClick={() => setAdditionalMedia(additionalMedia.filter((_, i) => i !== idx))}
                            className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-xs"
                          >
                            √ó
                          </button>
                        </div>
                      ))}
                      <button
                        onClick={() => handleMediaCapture('photo')}
                        className="w-20 h-20 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center"
                      >
                        <span className="text-2xl">+</span>
                      </button>
                    </div>
                  )}
                  
                  {voiceNote && (
                    <div className="bg-green-50 rounded-lg p-3 mb-4 flex items-center justify-between">
                      <div className="flex items-center space-x-2">
                        <span>üé§</span>
                        <span className="text-sm">Voice note recorded ({voiceNote.duration}s)</span>
                      </div>
                      <button
                        onClick={() => setVoiceNote(null)}
                        className="text-red-600 text-sm"
                      >
                        Remove
                      </button>
                    </div>
                  )}
                  
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-lg font-semibold">Describe the problem</h3>
                    <button
                      onClick={() => setShowAISuggestions(!showAISuggestions)}
                      className="text-blue-600 text-sm mobile-touch"
                    >
                      üí° AI Help
                    </button>
                  </div>
                  
                  {showAISuggestions && (
                    <div className="bg-blue-50 rounded-lg p-3 mb-3">
                      <p className="text-sm font-medium mb-2">Answer these to improve accuracy:</p>
                      <ul className="text-sm space-y-1">
                        {getAISuggestions().map((suggestion, idx) => (
                          <li key={idx}>‚Ä¢ {suggestion}</li>
                        ))}
                      </ul>
                    </div>
                  )}
                  
                  <textarea
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    placeholder="What issue are you experiencing? Be as detailed as possible. Include when it started, any sounds/smells, what you've tried..."
                    className="w-full p-3 border rounded-lg"
                    rows={6}
                  />
                  
                  <div className="flex items-center justify-between mt-1">
                    <p className="text-xs text-gray-500">
                      {description.length}/500 characters
                    </p>
                    {description.includes('urgent') || description.includes('emergency') ? (
                      <p className="text-xs text-red-600 font-medium">
                        ‚ö° Urgent issue detected
                      </p>
                    ) : null}
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <button
                    onClick={() => {
                      setStep('capture');
                      setAdditionalMedia([]);
                      setVoiceNote(null);
                    }}
                    className="border border-gray-300 py-3 rounded-lg mobile-touch"
                  >
                    ‚Üê Back
                  </button>

                  <button
                    onClick={handleAnalyze}
                    disabled={!description || description.length < 10}
                    className={`py-3 rounded-lg font-semibold mobile-touch ${
                      description && description.length >= 10 
                        ? 'bg-blue-600 text-white' 
                        : 'bg-gray-300 text-gray-500'
                    }`}
                  >
                    {checkFreeAnalysisAvailable(user.email) ? 'Analyze FREE' : `Analyze ¬£${APP_CONFIG.aiAnalysisPrice}`}
                  </button>
                </div>
                
                {additionalMedia.length === 0 && (
                  <button
                    onClick={() => handleMediaCapture('photo')}
                    className="w-full mt-3 text-blue-600 py-2"
                  >
                    + Add more photos/videos
                  </button>
                )}
              </div>
            )}

            {step === 'payment' && (
              <div className="max-w-md mx-auto">
                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-6 shadow-sm mb-4`}>
                  <h2 className="text-2xl font-bold mb-4">Payment Required</h2>
                  
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                    <p className="text-sm text-yellow-800">
                      <span className="font-medium">üí° You've used your FREE monthly analysis.</span><br/>
                      Next free analysis available: {getNextFreeAnalysisDate()}
                    </p>
                  </div>
                  
                  <div className="text-center mb-6">
                    <p className="text-4xl font-bold text-green-600">¬£{APP_CONFIG.aiAnalysisPrice}</p>
                    <p className="text-gray-600">One-time payment for this issue</p>
                  </div>

                  <div className="bg-blue-50 rounded-lg p-4 mb-6">
                    <h4 className="font-medium mb-2">This analysis includes:</h4>
                    <ul className="space-y-2 text-sm">
                      <li className="flex items-center">
                        <span className="text-green-500 mr-2">‚úì</span>
                        <span>AI problem identification & severity assessment</span>
                      </li>
                      <li className="flex items-center">
                        <span className="text-green-500 mr-2">‚úì</span>
                        <span>Safety warnings & regulatory guidance</span>
                      </li>
                      <li className="flex items-center">
                        <span className="text-green-500 mr-2">‚úì</span>
                        <span>Parts list with local store availability</span>
                      </li>
                      <li className="flex items-center">
                        <span className="text-green-500 mr-2">‚úì</span>
                        <span>Matched expert profiles & instant quotes</span>
                      </li>
                      <li className="flex items-center">
                        <span className="text-green-500 mr-2">‚úì</span>
                        <span>Step-by-step DIY guide (if safe)</span>
                      </li>
                      <li className="flex items-center">
                        <span className="text-green-500 mr-2">‚úì</span>
                        <span>Cost breakdown & time estimates</span>
                      </li>
                      <li className="flex items-center">
                        <span className="text-green-500 mr-2">‚úì</span>
                        <span>Prevention tips & warranty info</span>
                      </li>
                    </ul>
                  </div>
                  
                  <div className="space-y-3">
                    <button
                      onClick={handlePayment}
                      className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold mobile-touch flex items-center justify-center space-x-2"
                    >
                      <span>üí≥</span>
                      <span>Pay ¬£{APP_CONFIG.aiAnalysisPrice} & Analyze</span>
                    </button>
                    
                    <div className="text-center text-sm text-gray-600">
                      <p>Secure payment via Stripe</p>
                      <p className="mt-1">Cancel anytime ‚Ä¢ No subscription</p>
                    </div>
                  </div>
                </div>
                
                <button
                  onClick={() => setStep('describe')}
                  className="w-full text-gray-600 py-2"
                >
                  ‚Üê Back to description
                </button>
              </div>
            )}

            {step === 'analyzing' && (
              <div className="text-center max-w-md mx-auto">
                <div className="mb-8">
                  <div className="text-6xl mb-4 animate-pulse">ü§ñ</div>
                  <h2 className="text-2xl font-bold mb-2">AI Analysis in Progress</h2>
                  <p className="text-gray-600">{progressMessage || 'Processing...'}</p>
                </div>

                <div className="mb-8">
                  <div className="bg-gray-200 rounded-full h-4 mb-2">
                    <div 
                      className="analysis-progress h-full rounded-full transition-all duration-500"
                      style={{ width: `${progress}%` }}
                    />
                  </div>
                  <p className="text-sm text-gray-600">{progress}% complete</p>
                </div>
                
                <div className="space-y-2 text-sm text-gray-600">
                  <p>üîç Analyzing {media.type} content</p>
                  <p>üß† Processing with advanced AI</p>
                  <p>üìä Comparing with thousands of similar cases</p>
                </div>
              </div>
            )}

            {step === 'results' && analysisResult && (
              <div className="space-y-4 max-w-2xl mx-auto">
                {/* Urgent Expert Availability */}
                {analysisResult.urgencyLevel === 'urgent' && analysisResult.availableExperts && (
                  <div className="bg-red-50 border-2 border-red-300 rounded-xl p-4 text-center">
                    <h3 className="font-bold text-red-800 text-lg mb-2">
                      üö® URGENT ISSUE DETECTED
                    </h3>
                    {analysisResult.availableExperts.count > 0 ? (
                      <div>
                        <p className="text-red-700 font-medium">
                          {analysisResult.availableExperts.count} experts available NOW
                        </p>
                        <p className="text-sm text-red-600 mt-1">
                          Average response time: {analysisResult.availableExperts.averageResponseTime}
                        </p>
                        <div className="mt-3 space-y-2">
                          {analysisResult.availableExperts.experts.slice(0, 3).map(expert => (
                            <button
                              key={expert.id}
                              onClick={() => handleExpertBooking(expert)}
                              className="w-full bg-red-600 text-white px-4 py-3 rounded-lg font-bold mobile-touch flex items-center justify-between"
                            >
                              <div className="text-left">
                                <p className="font-semibold">{expert.name}</p>
                                <p className="text-sm opacity-90">
                                  {expert.profession} ‚Ä¢ {expert.rating}‚òÖ
                                </p>
                              </div>
                              <div className="text-right">
                                <p className="font-bold">¬£{expert.hourlyRate}/hr</p>
                                <p className="text-xs opacity-90">{expert.responseTime}</p>
                              </div>
                            </button>
                          ))}
                        </div>
                      </div>
                    ) : (
                      <div>
                        <p className="text-red-700">
                          No experts available right now
                        </p>
                        <p className="text-sm text-red-600">
                          Next available: {analysisResult.availableExperts.nextAvailable}
                        </p>
                        <button
                          onClick={() => navigateTo('emergency')}
                          className="mt-3 bg-red-600 text-white px-6 py-3 rounded-lg font-bold mobile-touch"
                        >
                          Call Emergency Services
                        </button>
                      </div>
                    )}
                  </div>
                )}

                {/* Problem Summary Card */}
                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-6 shadow-sm`}>
                  <div className="flex items-start space-x-4">
                    <div className={`text-4xl ${
                      analysisResult.severity === 'Critical' ? 'text-red-500 animate-pulse' :
                      analysisResult.severity === 'High' ? 'text-orange-500' :
                      analysisResult.severity === 'Medium' ? 'text-yellow-500' :
                      'text-blue-500'
                    }`}>
                      {analysisResult.severity === 'Critical' ? 'üö®' :
                       analysisResult.severity === 'High' ? '‚ö†Ô∏è' :
                       analysisResult.severity === 'Medium' ? '‚ö°' : '‚úÖ'}
                    </div>
                    <div className="flex-1">
                      <h2 className="text-2xl font-bold mb-2">{analysisResult.problemDetected}</h2>
                      <p className="text-gray-600 mb-3">{analysisResult.description}</p>
                      
                      <div className="grid grid-cols-2 gap-3 mb-4">
                        <div className="bg-gray-50 rounded-lg p-3">
                          <p className="text-xs text-gray-600">Time to Fix</p>
                          <p className="font-semibold">{analysisResult.timeToFix}</p>
                        </div>
                        <div className="bg-gray-50 rounded-lg p-3">
                          <p className="text-xs text-gray-600">Risk Level</p>
                          <p className="font-semibold">{analysisResult.riskLevel}</p>
                        </div>
                      </div>
                      
                      <div className="flex flex-wrap gap-2">
                        <span className={`px-3 py-1 rounded-full text-sm ${
                          analysisResult.isDIYFriendly 
                            ? 'bg-green-100 text-green-800' 
                            : 'bg-red-100 text-red-800'
                        }`}>
                          {analysisResult.isDIYFriendly ? 'üîß DIY Possible' : 'üë®‚Äçüîß Expert Required'}
                        </span>
                        <span className="px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">
                          üí∞ {analysisResult.estimatedCost}
                        </span>
                        <span className="px-3 py-1 rounded-full text-sm bg-purple-100 text-purple-800">
                          üë∑ {analysisResult.recommendedExpertType}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* AI Insights */}
                {analysisResult.aiInsights && (
                  <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}>
                    <h3 className="font-bold mb-3 flex items-center">
                      <span className="mr-2">ü§ñ</span> AI Insights
                    </h3>
                    <div className="space-y-3 text-sm">
                      <div>
                        <p className="font-medium text-gray-700">Root Cause Analysis:</p>
                        <p className="text-gray-600">{analysisResult.aiInsights.rootCause}</p>
                      </div>
                      <div>
                        <p className="font-medium text-gray-700">Risk Assessment:</p>
                        <p className="text-gray-600">{analysisResult.aiInsights.riskAssessment}</p>
                      </div>
                      <div>
                        <p className="font-medium text-gray-700">Cost Factors:</p>
                        <p className="text-gray-600">{analysisResult.aiInsights.costFactors}</p>
                      </div>
                      <div>
                        <p className="font-medium text-gray-700">Prevention Value:</p>
                        <p className="text-gray-600">{analysisResult.aiInsights.preventionValue}</p>
                      </div>
                      <div>
                        <p className="font-medium text-gray-700">Seasonal Considerations:</p>
                        <p className="text-gray-600">{analysisResult.aiInsights.seasonalConsiderations}</p>
                      </div>
                    </div>
                  </div>
                )}

                {/* Quick Decision Helper */}
                <div className="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl p-4">
                  <h3 className="font-bold text-lg mb-2">
                    {analysisResult.isDIYFriendly ? 'ü§î Should You DIY?' : '‚ö†Ô∏è Professional Help Needed'}
                  </h3>
                  {analysisResult.isDIYFriendly ? (
                    <div className="space-y-2 text-sm">
                      <p>‚úÖ This issue can be safely handled as DIY</p>
                      <p>‚è±Ô∏è Estimated time: {analysisResult.timeToFix}</p>
                      <p>üí∞ Potential savings: {analysisResult.costBreakdown?.savingsIfDIY || '¬£50-100'}</p>
                      <p className="font-medium mt-2">
                        However, if you're not confident, it's always safer to hire an expert!
                      </p>
                    </div>
                  ) : (
                    <div className="space-y-2 text-sm">
                      <p>üö´ This requires professional expertise</p>
                      <p>‚ö° Safety/legal regulations apply</p>
                      <p>üìú Certification may be required</p>
                      <p className="font-medium mt-2">
                        Don't risk it - get expert help below!
                      </p>
                    </div>
                  )}
                </div>

                {/* Safety Warnings */}
                {analysisResult.safetyWarnings?.length > 0 && (
                  <div className="bg-red-50 border border-red-200 rounded-xl p-4">
                    <h3 className="font-bold text-red-800 mb-3 flex items-center">
                      <span className="mr-2">‚ö†Ô∏è</span> Safety Warnings
                    </h3>
                    <ul className="space-y-2">
                      {analysisResult.safetyWarnings.map((warning, index) => (
                        <li key={index} className="text-sm text-red-700 flex items-start">
                          <span className="mr-2">‚Ä¢</span>
                          <span>{warning}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}

                {/* Cost Breakdown */}
                {analysisResult.costBreakdown && (
                  <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}>
                    <h3 className="font-bold mb-3">üí∞ Cost Breakdown</h3>
                    <div className="space-y-2 text-sm">
                      <div className="flex justify-between">
                        <span>Labor:</span>
                        <span className="font-medium">{analysisResult.costBreakdown.labor}</span>
                      </div>
                      <div className="flex justify-between">
                        <span>Parts & Materials:</span>
                        <span className="font-medium">{analysisResult.costBreakdown.parts}</span>
                      </div>
                      <div className="flex justify-between">
                        <span>Call-out Fee:</span>
                        <span className="font-medium">{analysisResult.costBreakdown.callOutFee}</span>
                      </div>
                      <div className="border-t pt-2 mt-2">
                        <div className="flex justify-between font-semibold">
                          <span>Total Estimate:</span>
                          <span className="text-lg">{analysisResult.costBreakdown.total}</span>
                        </div>
                      </div>
                      {analysisResult.costBreakdown.savingsIfDIY && (
                        <div className="bg-green-50 rounded-lg p-2 mt-2">
                          <p className="text-green-700 text-center">
                            DIY Savings: {analysisResult.costBreakdown.savingsIfDIY}
                          </p>
                        </div>
                      )}
                    </div>
                  </div>
                )}

                {/* Parts & Tools */}
                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-6 shadow-sm`}>
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="font-bold text-lg">üõ†Ô∏è Parts & Tools Needed</h3>
                    <button
                      onClick={() => setShowPartsModal(true)}
                      className="text-blue-600 font-medium mobile-touch"
                    >
                      üìç Find Stores
                    </button>
                  </div>
                  
                  <div className="space-y-3 mb-4">
                    {analysisResult.recommendedParts?.map((part, idx) => (
                      <div 
                        key={idx} 
                        className="border rounded-lg p-3 flex items-center justify-between"
                      >
                        <div className="flex items-center space-x-3">
                          <input
                            type="checkbox"
                            checked={selectedParts.includes(part.name)}
                            onChange={(e) => {
                              if (e.target.checked) {
                                setSelectedParts([...selectedParts, part.name]);
                              } else {
                                setSelectedParts(selectedParts.filter(p => p !== part.name));
                              }
                            }}
                            className="w-5 h-5"
                          />
                          <div>
                            <h4 className="font-medium">{part.name}</h4>
                            <p className="text-sm text-gray-600">
                              {part.priority} ‚Ä¢ {part.category}
                            </p>
                          </div>
                        </div>
                        <p className="text-lg font-bold text-green-600">{part.price}</p>
                      </div>
                    ))}
                  </div>
                  
                  {selectedParts.length > 0 && (
                    <div className="bg-blue-50 rounded-lg p-3">
                      <p className="text-sm text-blue-800">
                        {selectedParts.length} items selected ‚Ä¢ 
                        Estimated total: ¬£{
                          analysisResult.recommendedParts
                            .filter(p => selectedParts.includes(p.name))
                            .reduce((sum, p) => sum + parseFloat(p.price.replace('¬£', '')), 0)
                            .toFixed(2)
                        }
                      </p>
                    </div>
                  )}
                </div>

                {/* Step by Step Guide (if DIY friendly) */}
                {analysisResult.isDIYFriendly && analysisResult.stepByStepGuide && (
                  <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-6 shadow-sm`}>
                    <h3 className="font-bold mb-4 flex items-center">
                      <span className="mr-2">üìã</span> DIY Step-by-Step Guide
                    </h3>
                    <ol className="space-y-3">
                      {analysisResult.stepByStepGuide.map((step, idx) => (
                        <li key={idx} className="flex items-start">
                          <span className="bg-blue-100 text-blue-800 rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0 mr-3 text-sm font-medium">
                            {idx + 1}
                          </span>
                          <span className="text-sm">{step.replace(/^\d+\.\s*/, '')}</span>
                        </li>
                      ))}
                    </ol>
                    
                    {analysisResult.videoTutorials && analysisResult.videoTutorials.length > 0 && (
                      <div className="mt-4 pt-4 border-t">
                        <h4 className="font-medium mb-2">üìπ Video Tutorials</h4>
                        <div className="space-y-2">
                          {analysisResult.videoTutorials.map((video, idx) => (
                            <div key={idx} className="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                              <div className="flex items-center space-x-3">
                                <div className="w-16 h-10 bg-gray-200 rounded flex items-center justify-center">
                                  ‚ñ∂Ô∏è
                                </div>
                                <div>
                                  <p className="text-sm font-medium">{video.title}</p>
                                  <p className="text-xs text-gray-600">{video.duration} ‚Ä¢ {video.views} views</p>
                                </div>
                              </div>
                              <button className="text-blue-600 text-sm">
                                Watch
                              </button>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Expert Recommendations */}
                {analysisResult.availableExperts && analysisResult.availableExperts.experts.length > 0 && (
                  <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-6 shadow-sm`}>
                    <h3 className="font-bold mb-4">üë®‚Äçüîß Recommended Experts</h3>
                    <div className="space-y-3">
                      {analysisResult.availableExperts.experts.map((expert) => (
                        <div
                          key={expert.id}
                          onClick={() => handleExpertBooking(expert)}
                          className="border rounded-lg p-4 mobile-touch hover:border-blue-500 transition-colors"
                        >
                          <div className="flex items-start justify-between mb-2">
                            <div>
                              <h4 className="font-semibold">{expert.name}</h4>
                              <p className="text-sm text-gray-600">{expert.profession}</p>
                              <div className="flex items-center mt-1">
                                <StarRating rating={parseFloat(expert.rating)} readonly />
                                <span className="text-sm text-gray-600 ml-2">
                                  ({expert.reviews} reviews)
                                </span>
                              </div>
                            </div>
                            <div className="text-right">
                              <p className="text-xl font-bold text-green-600">¬£{expert.hourlyRate}/hr</p>
                              <p className="text-sm text-gray-600">{expert.responseTime}</p>
                            </div>
                          </div>
                          
                          {expert.badges && expert.badges.length > 0 && (
                            <div className="flex flex-wrap gap-1 mt-2">
                              {expert.badges.map((badge, idx) => (
                                <span key={idx} className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                  {badge}
                                </span>
                              ))}
                            </div>
                          )}
                          
                          <button className="w-full mt-3 bg-blue-600 text-white py-2 rounded-lg text-sm font-medium">
                            Get Quote ‚Üí
                          </button>
                        </div>
                      ))}
                    </div>
                    
                    <button
                      onClick={() => navigateTo('experts')}
                      className="w-full mt-4 border border-blue-600 text-blue-600 py-3 rounded-lg font-medium mobile-touch"
                    >
                      View All Experts
                    </button>
                  </div>
                )}

                {/* Regulations & Compliance */}
                {analysisResult.regulations && (
                  <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}>
                    <h4 className="font-bold mb-2 flex items-center">
                      <span className="mr-2">üìú</span> Regulations & Compliance
                    </h4>
                    <p className="text-sm text-gray-600">{analysisResult.regulations}</p>
                  </div>
                )}

                {/* Environmental Impact */}
                {analysisResult.environmentalImpact && (
                  <div className="bg-green-50 rounded-xl p-4">
                    <h4 className="font-bold mb-2 flex items-center text-green-800">
                      <span className="mr-2">üå±</span> Environmental Impact
                    </h4>
                    <div className="space-y-2 text-sm text-green-700">
                      {Object.entries(analysisResult.environmentalImpact).map(([key, value]) => (
                        <p key={key}>
                          <span className="font-medium">{key.charAt(0).toUpperCase() + key.slice(1)}:</span> {value}
                        </p>
                      ))}
                    </div>
                  </div>
                )}

                {/* Preventive Tips */}
                {analysisResult.preventiveTips?.length > 0 && (
                  <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}>
                    <h4 className="font-bold mb-3 flex items-center">
                      <span className="mr-2">üí°</span> Prevention Tips
                    </h4>
                    <ul className="space-y-2">
                      {analysisResult.preventiveTips.map((tip, idx) => (
                        <li key={idx} className="text-sm text-gray-600 flex items-start">
                          <span className="text-green-500 mr-2">‚úì</span>
                          <span>{tip}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}

                {/* Warranty Information */}
                {analysisResult.warrantyInfo && (
                  <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}>
                    <h4 className="font-bold mb-3">üõ°Ô∏è Warranty & Insurance</h4>
                    <div className="space-y-2 text-sm">
                      {Object.entries(analysisResult.warrantyInfo).map(([key, value]) => (
                        <div key={key} className="flex items-start">
                          <span className="font-medium mr-2">
                            {key.replace(/([A-Z])/g, ' $1').trim()}:
                          </span>
                          <span className="text-gray-600">{value}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Similar Issues */}
                {analysisResult.similarIssues && analysisResult.similarIssues.length > 0 && (
                  <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}>
                    <h4 className="font-bold mb-3">üîç Similar Issues</h4>
                    <div className="space-y-2">
                      {analysisResult.similarIssues.map((issue, idx) => (
                        <div key={idx} className="border rounded-lg p-3">
                          <div className="flex items-start justify-between">
                            <div>
                              <p className="font-medium text-sm">{issue.title}</p>
                              <p className="text-xs text-gray-600">{issue.description}</p>
                            </div>
                            <div className="text-right">
                              <p className="text-sm font-medium">{issue.cost}</p>
                              <p className="text-xs text-gray-600">{issue.rating}‚òÖ</p>
                            </div>
                          </div>
                          <p className="text-xs text-gray-500 mt-1">{issue.timeAgo}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Action Buttons */}
                <div className="grid grid-cols-2 gap-3 pb-8">
                  <button
                    onClick={() => {
                      if (confirm('Start a new analysis? Current results will be saved.')) {
                        handleSaveAnalysis();
                        setStep('waiver');
                        setMedia(null);
                        setAdditionalMedia([]);
                        setDescription('');
                        setAnalysisResult(null);
                        setSelectedParts([]);
                        setAcceptedWaiver(false);
                        setVoiceNote(null);
                      }
                    }}
                    className="border border-gray-300 py-3 rounded-lg mobile-touch flex items-center justify-center space-x-2"
                  >
                    <span>üîÑ</span>
                    <span>New Analysis</span>
                  </button>

                  <button
                    onClick={() => navigateTo('experts')}
                    className="bg-blue-600 text-white py-3 rounded-lg font-semibold mobile-touch flex items-center justify-center space-x-2"
                  >
                    <span>üë®‚Äçüîß</span>
                    <span>Find Expert</span>
                  </button>

                  <button
                    onClick={handleSaveAnalysis}
                    className="border border-gray-300 py-3 rounded-lg mobile-touch flex items-center justify-center space-x-2"
                  >
                    <span>üíæ</span>
                    <span>Save</span>
                  </button>

                  <button
                    onClick={handleShareAnalysis}
                    className="border border-gray-300 py-3 rounded-lg mobile-touch flex items-center justify-center space-x-2"
                  >
                    <span>üì§</span>
                    <span>Share</span>
                  </button>
                </div>
              </div>
            )}
          </div>

          {/* Parts Store Modal */}
          {showPartsModal && (
            <PartsStoreModal
              parts={selectedParts}
              userLocation={location}
              onClose={() => setShowPartsModal(false)}
              isDarkMode={isDarkMode}
            />
          )}

          {/* AR View Modal */}
          {showARView && (
            <ARMeasureModal
              onClose={() => setShowARView(false)}
              onCapture={(measurement) => {
                setDescription(description + `\n\nMeasurements: ${measurement}`);
                setShowARView(false);
              }}
            />
          )}
        </div>
      );
    };

    // Parts Store Modal Component
    const PartsStoreModal = ({ parts, userLocation, onClose, isDarkMode }) => {
      const [selectedStore, setSelectedStore] = React.useState(null);
      const [showDirections, setShowDirections] = React.useState(false);
      
      // Get stores for user's city (simplified for demo)
      const cityStores = partsStores.get('london') || [];
      
      // Calculate real distances if we have user location
      const storesWithDistance = cityStores.map(store => ({
        ...store,
        realDistance: userLocation?.latitude ? 
          calculateDistance(
            userLocation.latitude,
            userLocation.longitude,
            51.5074, // Store lat (example)
            -0.1278  // Store lon (example)
          ).toFixed(1) + ' km' : store.distance
      }));
      
      return (
        <Modal isOpen={true} onClose={onClose} title="üè™ Find Parts Locally" size="medium">
          {parts.length > 0 && (
            <div className="bg-blue-50 rounded-lg p-3 mb-4">
              <p className="text-sm font-medium text-blue-800">
                Shopping for {parts.length} items
              </p>
            </div>
          )}
          
          <div className="space-y-3">
            {storesWithDistance.map((store, idx) => (
              <div 
                key={store.id}
                className={`border rounded-lg p-4 mobile-touch ${
                  selectedStore === idx ? 'border-blue-600 bg-blue-50' : ''
                }`}
                onClick={() => setSelectedStore(idx)}
              >
                <div className="flex items-start justify-between mb-2">
                  <div>
                    <h3 className="font-semibold">{store.name}</h3>
                    <p className="text-sm text-gray-600">{store.address}</p>
                  </div>
                  <span className="text-sm font-medium text-blue-600">
                    {store.realDistance}
                  </span>
                </div>
                
                <div className="flex items-center justify-between mb-3">
                  <div className="flex flex-wrap gap-1">
                    {store.categories.slice(0, 3).map(cat => (
                      <span 
                        key={cat}
                        className="text-xs bg-gray-100 px-2 py-1 rounded"
                      >
                        {cat}
                      </span>
                    ))}
                    {store.categories.length > 3 && (
                      <span className="text-xs text-gray-500">
                        +{store.categories.length - 3} more
                      </span>
                    )}
                  </div>
                  <div className="flex items-center space-x-1 text-xs text-gray-600">
                    {store.hasParking && <span>üÖøÔ∏è</span>}
                    {store.wheelchairAccess && <span>‚ôø</span>}
                  </div>
                </div>
                
                <div className="text-sm text-gray-600 mb-3">
                  <p>üìû {store.phone}</p>
                  <p>üïê {store.openHours}</p>
                  <p>üì¶ {store.inStockItems} items in stock</p>
                </div>
                
                <div className="flex space-x-2">
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      window.open(`tel:${store.phone}`);
                    }}
                    className="flex-1 bg-green-600 text-white py-2 rounded-lg text-sm mobile-touch"
                  >
                    üìû Call Store
                  </button>
                  <button
                    onClick={(e) => {
                      e.stopPropagation();
                      window.open(`https://maps.google.com/?q=${encodeURIComponent(store.address)}`);
                    }}
                    className="flex-1 bg-blue-600 text-white py-2 rounded-lg text-sm mobile-touch"
                  >
                    üó∫Ô∏è Directions
                  </button>
                </div>
              </div>
            ))}
          </div>

          {parts.length > 0 && (
            <div className="mt-6 bg-yellow-50 rounded-lg p-4">
              <h4 className="font-medium mb-2">üìù Your Shopping List:</h4>
              <ul className="text-sm space-y-1">
                {parts.map((part, idx) => (
                  <li key={idx} className="flex items-center">
                    <span className="text-green-500 mr-2">‚úì</span>
                    <span>{part}</span>
                  </li>
                ))}
              </ul>
              <p className="text-xs text-gray-600 mt-3">
                üí° Tip: Call ahead to check availability and reserve items
              </p>
            </div>
          )}
          
          <div className="mt-6 flex space-x-3">
            <button
              onClick={() => {
                if (parts.length > 0) {
                  const list = parts.join('\n');
                  navigator.clipboard.writeText(list);
                  alert('Shopping list copied!');
                }
              }}
              className="flex-1 border border-gray-300 py-3 rounded-lg mobile-touch"
            >
              üìã Copy List
            </button>
            <button
              onClick={onClose}
              className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold mobile-touch"
            >
              Done
            </button>
          </div>
        </Modal>
      );
    };

    // AR Measure Modal (Simulated)
    const ARMeasureModal = ({ onClose, onCapture }) => {
      const [measuring, setMeasuring] = React.useState(false);
      const [measurement, setMeasurement] = React.useState('');
      
      return (
        <Modal isOpen={true} onClose={onClose} title="üìê AR Measure" size="fullscreen">
          <div className="ar-view">
            <div className="ar-overlay">
              <div className="text-white text-center">
                <div className="text-4xl mb-4">üìê</div>
                <h3 className="text-xl font-bold mb-2">AR Measurement Tool</h3>
                <p className="mb-4">Coming Soon!</p>
                <p className="text-sm opacity-80">
                  This feature will allow you to measure dimensions using your camera
                </p>
                
                <div className="mt-8 space-y-3">
                  <input
                    type="text"
                    placeholder="Enter measurements manually (e.g., 2.5m x 1.8m)"
                    value={measurement}
                    onChange={(e) => setMeasurement(e.target.value)}
                    className="px-4 py-2 rounded-lg text-gray-900 w-64"
                  />
                  
                  <div>
                    <button
                      onClick={() => {
                        if (measurement) {
                          onCapture(measurement);
                        }
                      }}
                      className="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold"
                    >
                      Add Measurements
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </Modal>
      );
    };

    // Enhanced Experts Page
    const ExpertsPage = ({ navigateTo }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const { user } = React.useContext(AuthContext);
      const [filter, setFilter] = React.useState('all');
      const [sortBy, setSortBy] = React.useState('rating');
      const [showFilters, setShowFilters] = React.useState(false);
      const [priceRange, setPriceRange] = React.useState([0, 200]);
      const [selectedFeatures, setSelectedFeatures] = React.useState([]);
      const [searchQuery, setSearchQuery] = React.useState('');
      const [isLoading, setIsLoading] = React.useState(false);

      const features = [
        '24/7 Emergency',
        'Same Day Service',
        'Eco Friendly',
        'Warranty Offered',
        'Free Quotes',
        'Insurance Work'
      ];

      const filteredExperts = React.useMemo(() => {
        let experts = Array.from(expertProfiles.values());
        
        // Filter by profession
        if (filter !== 'all') {
          experts = experts.filter(expert => 
            expert.profession.toLowerCase().includes(filter.toLowerCase()) ||
            expert.specialties?.some(s => s.toLowerCase().includes(filter.toLowerCase()))
          );
        }
        
        // Filter by search query
        if (searchQuery) {
          experts = experts.filter(expert =>
            expert.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
            expert.bio.toLowerCase().includes(searchQuery.toLowerCase()) ||
            expert.specialties?.some(s => s.toLowerCase().includes(searchQuery.toLowerCase()))
          );
        }
        
        // Filter by price range
        experts = experts.filter(expert => 
          expert.hourlyRate >= priceRange[0] && expert.hourlyRate <= priceRange[1]
        );
        
        // Filter by features
        if (selectedFeatures.length > 0) {
          experts = experts.filter(expert => {
            return selectedFeatures.every(feature => {
              if (feature === '24/7 Emergency') return expert.availability.includes('Emergency 24/7');
              if (feature === 'Same Day Service') return expert.responseTime.includes('< 1 hour');
              if (feature === 'Eco Friendly') return expert.badges?.includes('Eco Friendly');
              if (feature === 'Warranty Offered') return expert.guaranteeOffered;
              if (feature === 'Free Quotes') return true; // All offer free quotes in demo
              if (feature === 'Insurance Work') return expert.insurance;
              return false;
            });
          });
        }
        
        // Sort
        experts.sort((a, b) => {
          switch (sortBy) {
            case 'rating':
              return parseFloat(b.rating) - parseFloat(a.rating);
            case 'price_low':
              return a.hourlyRate - b.hourlyRate;
            case 'price_high':
              return b.hourlyRate - a.hourlyRate;
            case 'reviews':
              return b.reviews - a.reviews;
            case 'nearest':
              // In production, would sort by actual distance
              return a.location.localeCompare(b.location);
            default:
              return 0;
          }
        });
        
        return experts;
      }, [filter, sortBy, priceRange, selectedFeatures, searchQuery]);

      const categories = [
        { id: 'all', name: 'All Experts', icon: 'üë•' },
        { id: 'plumber', name: 'Plumber', icon: 'üö∞' },
        { id: 'electrician', name: 'Electrician', icon: '‚ö°' },
        { id: 'handyman', name: 'Handyman', icon: 'üî®' },
        { id: 'gas', name: 'Gas Engineer', icon: 'üî•' },
        { id: 'carpenter', name: 'Carpenter', icon: 'ü™ö' },
        { id: 'painter', name: 'Painter', icon: 'üé®' },
        { id: 'cleaner', name: 'Cleaner', icon: 'üßπ' }
      ];

      return (
        <div className="min-h-screen safe-area-top pb-20">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} shadow-sm`}>
            <div className="p-4">
              <div className="flex items-center mb-4">
                <button
                  onClick={() => navigateTo('dashboard')}
                  className="mr-4 mobile-touch"
                >
                  ‚Üê
                </button>
                <h1 className="text-xl font-bold">Find Experts</h1>
                <button
                  onClick={() => setShowFilters(!showFilters)}
                  className="ml-auto text-blue-600 mobile-touch relative"
                >
                  <span className="text-xl">‚öôÔ∏è</span>
                  {selectedFeatures.length > 0 && (
                    <span className="absolute -top-1 -right-1 bg-blue-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                      {selectedFeatures.length}
                    </span>
                  )}
                </button>
              </div>

              <div className="relative mb-4">
                <input
                  type="text"
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  placeholder="Search experts, services..."
                  className="w-full p-3 pl-10 border rounded-lg"
                />
                <span className="absolute left-3 top-3.5 text-gray-400">üîç</span>
              </div>

              <div className="flex space-x-2 overflow-x-auto pb-2">
                {categories.map(category => (
                  <button
                    key={category.id}
                    onClick={() => setFilter(category.id)}
                    className={`px-4 py-2 rounded-lg whitespace-nowrap mobile-touch flex items-center space-x-2 ${
                      filter === category.id ? 'bg-blue-600 text-white' : 'bg-gray-200'
                    }`}
                  >
                    <span>{category.icon}</span>
                    <span>{category.name}</span>
                  </button>
                ))}
              </div>
            </div>
          </div>

          {/* Filters Panel */}
          {showFilters && (
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} border-b p-4 space-y-4`}>
              <div>
                <label className="block text-sm font-medium mb-2">Sort By</label>
                <select
                  value={sortBy}
                  onChange={(e) => setSortBy(e.target.value)}
                  className="w-full p-2 border rounded-lg"
                >
                  <option value="rating">Highest Rated</option>
                  <option value="reviews">Most Reviews</option>
                  <option value="price_low">Price: Low to High</option>
                  <option value="price_high">Price: High to Low</option>
                  <option value="nearest">Nearest to You</option>
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium mb-2">
                  Hourly Rate: ¬£{priceRange[0]} - ¬£{priceRange[1]}
                </label>
                <input
                  type="range"
                  min="0"
                  max="200"
                  value={priceRange[1]}
                  onChange={(e) => setPriceRange([priceRange[0], parseInt(e.target.value)])}
                  className="w-full"
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-2">Features</label>
                <div className="grid grid-cols-2 gap-2">
                  {features.map(feature => (
                    <label key={feature} className="flex items-center space-x-2">
                      <input
                        type="checkbox"
                        checked={selectedFeatures.includes(feature)}
                        onChange={(e) => {
                          if (e.target.checked) {
                            setSelectedFeatures([...selectedFeatures, feature]);
                          } else {
                            setSelectedFeatures(selectedFeatures.filter(f => f !== feature));
                          }
                        }}
                      />
                      <span className="text-sm">{feature}</span>
                    </label>
                  ))}
                </div>
              </div>

              <button
                onClick={() => {
                  setSelectedFeatures([]);
                  setPriceRange([0, 200]);
                  setSortBy('rating');
                }}
                className="text-blue-600 text-sm"
              >
                Clear Filters
              </button>
            </div>
          )}

          <div className="p-4">
            {/* Results Summary */}
            <div className="mb-4 text-sm text-gray-600">
              Found {filteredExperts.length} experts
              {filter !== 'all' && ` in ${filter}`}
              {searchQuery && ` matching "${searchQuery}"`}
            </div>

            {/* Expert Cards */}
            {isLoading ? (
              <div className="space-y-4">
                <SkeletonLoader type="card" count={3} />
              </div>
            ) : filteredExperts.length === 0 ? (
              <EmptyState
                icon="üë®‚Äçüîß"
                title="No experts found"
                description="Try adjusting your filters or search query"
                action={
                  <button
                    onClick={() => {
                      setFilter('all');
                      setSearchQuery('');
                      setSelectedFeatures([]);
                    }}
                    className="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg mobile-touch"
                  >
                    Clear Filters
                  </button>
                }
              />
            ) : (
              <div className="space-y-4">
                {filteredExperts.map(expert => (
                  <div
                    key={expert.id}
                    onClick={() => {
                      window.selectedExpert = expert;
                      navigateTo('expert-detail');
                    }}
                    className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm mobile-touch`}
                  >
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex-1">
                        <div className="flex items-center space-x-2 mb-1">
                          <h3 className="font-semibold text-lg">{expert.name}</h3>
                          {expert.verified && (
                            <span className="text-blue-600" title="Verified Expert">‚úì</span>
                          )}
                        </div>
                        <p className="text-gray-600">{expert.profession}</p>
                        <div className="flex items-center mt-1">
                          <StarRating rating={parseFloat(expert.rating)} readonly />
                          <span className="ml-2 text-sm text-gray-600">
                            {expert.rating} ({expert.reviews} reviews)
                          </span>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="text-2xl font-bold text-green-600">¬£{expert.hourlyRate}</p>
                        <p className="text-sm text-gray-600">per hour</p>
                      </div>
                    </div>
                    
                    <p className="text-sm text-gray-600 mb-3 line-clamp-2">
                      {expert.bio}
                    </p>
                    
                    {expert.badges && expert.badges.length > 0 && (
                      <div className="flex flex-wrap gap-1 mb-3">
                        {expert.badges.slice(0, 3).map((badge, idx) => (
                          <span 
                            key={idx} 
                            className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded"
                          >
                            {badge}
                          </span>
                        ))}
                        {expert.badges.length > 3 && (
                          <span className="text-xs text-gray-500">
                            +{expert.badges.length - 3} more
                          </span>
                        )}
                      </div>
                    )}
                    
                    <div className="flex items-center justify-between text-sm">
                      <div className="flex items-center space-x-4 text-gray-600">
                        <span>üìç {expert.location}</span>
                        <span>‚è±Ô∏è {expert.responseTime}</span>
                      </div>
                      <button 
                        className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium"
                        onClick={(e) => {
                          e.stopPropagation();
                          window.selectedExpert = expert;
                          navigateTo('expert-detail');
                        }}
                      >
                        View Profile
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Load More */}
            {filteredExperts.length > 10 && (
              <button
                className="w-full mt-6 border border-gray-300 py-3 rounded-lg mobile-touch"
              >
                Load More Experts
              </button>
            )}
          </div>
        </div>
      );
    };

    // Complete App Component
    const App = () => {
      const [currentPage, setCurrentPage] = React.useState('welcome');
      const [user, setUser] = React.useState(null);
      const [isDarkMode, setIsDarkMode] = React.useState(false);
      const notificationUtils = useNotifications();

      React.useEffect(() => {
        // Hide splash screen after app loads
        setTimeout(() => {
          const splash = document.getElementById('splash-screen');
          if (splash) splash.style.display = 'none';
        }, 1500);

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/sw.js').catch(err => {
            console.log('Service worker registration failed:', err);
          });
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
        }
      }, []);

      const navigateTo = (page) => {
        setCurrentPage(page);
        window.scrollTo(0, 0);
        
        // Track navigation (analytics would go here)
        console.log('Navigation:', page);
      };

      const login = (userData) => {
        setUser(userData);
        
        // Create demo notifications
        notificationUtils.addNotification({
          title: 'Welcome back!',
          body: 'Check out our new features',
          type: 'system'
        });
      };

      const logout = () => {
        setUser(null);
        navigateTo('welcome');
      };

      const toggleTheme = () => {
        setIsDarkMode(!isDarkMode);
        document.body.style.backgroundColor = !isDarkMode ? '#1f2937' : '#f9fafb';
      };

      const authContextValue = { user, login, logout };
      const themeContextValue = { isDarkMode, toggleTheme };
      const notificationContextValue = notificationUtils;

      // Render loading state
      if (!React) {
        return <div className="splash-screen">Loading...</div>;
      }

      return (
        <ErrorBoundary>
          <AuthContext.Provider value={authContextValue}>
            <ThemeContext.Provider value={themeContextValue}>
              <NotificationContext.Provider value={notificationContextValue}>
                <div className={isDarkMode ? 'bg-gray-900 text-white min-h-screen' : 'bg-gray-50 text-gray-900 min-h-screen'}>
                  {/* Page Router */}
                  {currentPage === 'welcome' && <WelcomePage navigateTo={navigateTo} />}
                  {currentPage === 'login' && <LoginPage navigateTo={navigateTo} />}
                  {currentPage === 'signup' && <SignupPage navigateTo={navigateTo} />}
                  {currentPage === 'onboarding' && <OnboardingPage navigateTo={navigateTo} />}
                  {currentPage === 'dashboard' && <DashboardPage navigateTo={navigateTo} />}
                  {currentPage === 'analysis' && <AIAnalysisPage navigateTo={navigateTo} />}
                  {currentPage === 'experts' && <ExpertsPage navigateTo={navigateTo} />}
                  
                  {/* Additional pages would be implemented here */}
                  {/* expert-detail, parts, bookings, profile, emergency, etc. */}
                  
                  {/* Global notification container */}
                  <div className="fixed top-4 right-4 z-50 space-y-2">
                    {notificationContextValue.notifications.map(notif => (
                      <div
                        key={notif.id}
                        className="bg-white text-gray-900 rounded-lg shadow-lg p-4 max-w-sm slide-in"
                      >
                        <div className="flex items-start justify-between">
                          <div>
                            <h4 className="font-medium">{notif.title}</h4>
                            <p className="text-sm text-gray-600">{notif.body}</p>
                          </div>
                          <button
                            onClick={() => notificationContextValue.removeNotification(notif.id)}
                            className="text-gray-400 ml-3"
                          >
                            √ó
                          </button>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </NotificationContext.Provider>
            </ThemeContext.Provider>
          </AuthContext.Provider>
        </ErrorBoundary>
      );
    };

    // Initialize demo user for testing
    dbOperations.createUser({
      name: 'Demo User',
      email: 'demo@example.com',
      password: 'demo123',
      phone: '07123456789',
      postcode: 'SW1A 1AA',
      userType: 'customer'
    });

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
