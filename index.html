<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="DIYMatch">
  <meta name="description" content="AI-powered DIY assistant connecting you with verified experts and providing instant problem analysis">
  
  <title>DIYMatch - AI-Powered DIY Assistant</title>
  
  <!-- Icons for various platforms -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🔧</text></svg>">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🔧</text></svg>">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.json">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com/3.4.0"></script>
  
  <!-- Sentry Error Monitoring -->
  <script src="https://browser.sentry-cdn.com/7.0.0/bundle.min.js" crossorigin="anonymous"></script>
  
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    input, textarea, select {
      -webkit-user-select: text;
      user-select: text;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      background-color: #ffffff;
    }
    
    .safe-area-top { padding-top: env(safe-area-inset-top); }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    
    .mobile-touch {
      cursor: pointer;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }
    
    .mobile-touch:active {
      transform: scale(0.98);
      opacity: 0.8;
    }
    
    .loading-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .analysis-progress {
      background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    button { touch-action: manipulation; }
    input[type="text"], input[type="email"], input[type="password"], input[type="tel"], textarea, select { font-size: 16px !important; }
    
    .splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #2563eb 0%, #8b5cf6 100%);
      display: flex; align-items: center; justify-content: center; z-index: 9999; color: white;
    }

    .offline-message {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #ef4444;
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 10000;
      font-size: 14px;
    }

    .error-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      padding: 20px;
      text-align: center;
    }

    /* Enhanced UI Elements */
    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .gradient-border {
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      padding: 2px;
      border-radius: 12px;
    }

    .float-animation {
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .slide-in {
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ef4444;
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: bold;
    }

    /* Star Rating */
    .star-rating {
      display: flex;
      gap: 4px;
    }

    .star {
      font-size: 20px;
      color: #d1d5db;
      cursor: pointer;
      transition: color 0.2s;
    }

    .star.filled {
      color: #fbbf24;
    }

    .star:hover {
      color: #fbbf24;
    }

    /* Progress Steps */
    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
    }

    .progress-step {
      flex: 1;
      text-align: center;
      position: relative;
    }

    .progress-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: #e5e7eb;
    }

    .progress-step.completed:not(:last-child)::after {
      background: #3b82f6;
    }

    .progress-step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e5e7eb;
      margin: 0 auto 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      z-index: 1;
    }

    .progress-step.completed .progress-step-circle {
      background: #3b82f6;
      color: white;
    }

    .progress-step.active .progress-step-circle {
      background: #3b82f6;
      color: white;
      box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
    }

    /* Voice Recording Animation */
    .recording-animation {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #ef4444;
      position: relative;
      animation: recordPulse 1.5s ease-in-out infinite;
    }

    @keyframes recordPulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Chat Bubbles */
    .chat-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      margin-bottom: 8px;
      word-wrap: break-word;
    }

    .chat-bubble.user {
      background: #3b82f6;
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }

    .chat-bubble.expert {
      background: #f3f4f6;
      color: #1f2937;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }

    /* AR View Placeholder */
    .ar-view {
      position: relative;
      width: 100%;
      height: 300px;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }

    .ar-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      text-align: center;
    }

    /* Emergency Button */
    .emergency-button {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      animation: emergencyPulse 2s ease-in-out infinite;
    }

    @keyframes emergencyPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
    }

    /* Skeleton Loading */
    .skeleton {
      background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
      background-size: 200% 100%;
      animation: skeleton 1.2s ease-in-out infinite;
    }

    @keyframes skeleton {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Welcome Page Specific Styles */
    .welcome-container {
      min-height: 100vh;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .welcome-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
      padding: 3rem;
      max-width: 1200px;
      width: 100%;
    }

    .welcome-title {
      font-size: 2.5rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 1rem;
    }

    .welcome-subtitle {
      font-size: 1.1rem;
      color: #6b7280;
      text-align: center;
      margin-bottom: 2rem;
      line-height: 1.6;
    }

    .welcome-buttons {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-bottom: 3rem;
    }

    .welcome-button {
      padding: 1rem 2rem;
      border-radius: 50px;
      font-weight: 600;
      font-size: 1.1rem;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .welcome-button-primary {
      background: #5865f2;
      color: white;
    }

    .welcome-button-primary:hover {
      background: #4752c4;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(88, 101, 242, 0.3);
    }

    .welcome-button-secondary {
      background: #27ae60;
      color: white;
    }

    .welcome-button-secondary:hover {
      background: #219a52;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
    }

    .welcome-button-text {
      color: #5865f2;
      background: transparent;
    }

    .welcome-button-text:hover {
      text-decoration: underline;
    }

    .how-it-works {
      background: #f8f9fa;
      border-radius: 16px;
      padding: 2.5rem;
      margin-bottom: 2rem;
    }

    .how-it-works-title {
      font-size: 1.8rem;
      font-weight: bold;
      text-align: center;
      margin-bottom: 2rem;
    }

    .how-it-works-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
    }

    .how-it-works-item {
      text-align: center;
    }

    .how-it-works-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .how-it-works-subtitle {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .how-it-works-description {
      color: #6b7280;
      line-height: 1.5;
    }

    .get-in-touch {
      background: #fef3c7;
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
    }

    .get-in-touch-title {
      font-size: 1.5rem;
      font-weight: bold;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .get-in-touch-description {
      color: #6b7280;
      margin-bottom: 1.5rem;
    }

    .contact-button {
      background: #3b82f6;
      color: white;
      padding: 0.75rem 2rem;
      border-radius: 50px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .contact-button:hover {
      background: #2563eb;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
    }

    /* Bottom Navigation Bar */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-around;
      padding: 0.5rem 0;
      z-index: 1000;
    }

    .bottom-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.5rem 1rem;
      color: #6b7280;
      font-size: 0.75rem;
      transition: color 0.2s;
    }

    .bottom-nav-item.active {
      color: #3b82f6;
    }

    .bottom-nav-item:hover {
      color: #3b82f6;
    }

    .bottom-nav-icon {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
    }

    /* File Upload Styles */
    .file-upload-zone {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f9fafb;
    }

    .file-upload-zone:hover {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .file-upload-zone.drag-over {
      border-color: #3b82f6;
      background: #dbeafe;
    }

    /* Admin Dashboard Styles */
    .admin-stat-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .admin-stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #1f2937;
    }

    .admin-stat-label {
      font-size: 0.875rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }

    /* Support Chat Widget */
    .support-widget {
      position: fixed;
      bottom: 80px;
      right: 20px;
      z-index: 999;
    }

    .support-button {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #3b82f6;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .support-button:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .support-chat {
      position: absolute;
      bottom: 70px;
      right: 0;
      width: 350px;
      max-width: calc(100vw - 40px);
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      display: none;
    }

    .support-chat.open {
      display: block;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .welcome-card {
        padding: 2rem 1.5rem;
      }

      .welcome-title {
        font-size: 2rem;
      }

      .welcome-buttons {
        flex-direction: column;
        width: 100%;
      }

      .welcome-button {
        width: 100%;
        justify-content: center;
      }

      .how-it-works-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }

      .support-chat {
        width: calc(100vw - 40px);
        right: 20px;
      }
    }
  </style>
</head>
<body>
  <div id="offline-message" class="offline-message" style="display: none;">
    No internet connection. Some features may not work.
  </div>

  <div id="error-screen" class="error-screen" style="display: none;">
    <div>
      <div style="font-size: 60px; margin-bottom: 20px;">⚠️</div>
      <h2 style="font-size: 24px; margin-bottom: 10px; color: #1f2937;">Loading Error</h2>
      <p style="color: #6b7280; margin-bottom: 20px;">Please check your internet connection and try again.</p>
      <button onclick="location.reload()" style="background: #2563eb; color: white; padding: 12px 24px; border-radius: 8px; border: none; font-size: 16px;">
        Retry
      </button>
    </div>
  </div>

  <div id="root"></div>
  
  <!-- Splash Screen -->
  <div id="splash-screen" class="splash-screen">
    <div class="text-center">
      <div class="text-6xl mb-4 animate-bounce">🔧</div>
      <h1 class="text-3xl font-bold mb-2">DIYMatch</h1>
      <p class="text-lg opacity-80">AI-Powered DIY Assistant</p>
      <div class="mt-8">
        <div class="loading-pulse inline-block w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
      </div>
    </div>
  </div>

  <!-- React 18 with Babel Standalone for JSX -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.5/babel.min.js"></script>
  
  <!-- Stripe Payment Integration -->
  <script src="https://js.stripe.com/v3/"></script>
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-XXXXXXXXXX');
  </script>
  
  <script type="text/babel">
    // ============================================================================
    // CONFIGURATION & INITIALIZATION
    // ============================================================================
    
    // Initialize Sentry Error Monitoring
    if (typeof Sentry !== 'undefined') {
      Sentry.init({
        dsn: "YOUR_SENTRY_DSN_HERE",
        integrations: [new Sentry.BrowserTracing()],
        tracesSampleRate: 1.0,
        environment: "production"
      });
    }

    // Initialize Stripe
    const stripe = typeof Stripe !== 'undefined' ? Stripe('YOUR_STRIPE_PUBLISHABLE_KEY') : null;

    // ============================================================================
    // CONNECTIVITY & ERROR HANDLING
    // ============================================================================
    
    function checkConnectivity() {
      const offlineMessage = document.getElementById('offline-message');
      if (!navigator.onLine) {
        offlineMessage.style.display = 'block';
      } else {
        offlineMessage.style.display = 'none';
      }
    }

    window.addEventListener('online', checkConnectivity);
    window.addEventListener('offline', checkConnectivity);
    checkConnectivity();

    // Error boundary for React
    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true };
      }

      componentDidCatch(error, errorInfo) {
        console.error('Error caught by boundary:', error, errorInfo);
        if (typeof Sentry !== 'undefined') {
          Sentry.captureException(error);
        }
      }

      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-screen flex items-center justify-center p-4">
              <div className="text-center">
                <div className="text-6xl mb-4">😔</div>
                <h1 className="text-2xl font-bold mb-2">Something went wrong</h1>
                <p className="text-gray-600 mb-4">Please refresh the page to try again</p>
                <button
                  onClick={() => window.location.reload()}
                  className="bg-blue-600 text-white px-6 py-3 rounded-lg"
                >
                  Refresh Page
                </button>
              </div>
            </div>
          );
        }

        return this.props.children;
      }
    }

    // ============================================================================
    // APP CONFIGURATION
    // ============================================================================
    
    const APP_CONFIG = {
      name: 'DIYMatch',
      version: '2.0.0',
      description: 'AI-Powered DIY Assistant with Expert Network',
      adminEmail: 'yahye21@hotmail.com',
      adminPassword: 'Graphics41_',
      supportEmail: 'support@diymatch.co.uk',
      aiAnalysisPrice: 4.99,
      sameDayMultiplier: 1.5,
      platformCommission: 0.15,
      sameDayCommission: 0.20,
      emergencyHotline: '0800-DIY-HELP',
      maxImageSize: 10 * 1024 * 1024, // 10MB
      maxVideoSize: 100 * 1024 * 1024, // 100MB
      maxFileSize: 50 * 1024 * 1024, // 50MB for documents
      freeAnalysesPerMonth: 1,
      referralBonus: 5.00,
      expertVerificationRequired: true,
      minimumExpertRating: 4.0,
      responseTimeTargets: {
        urgent: '1 hour',
        normal: '4 hours',
        scheduled: '24 hours'
      },
      stripePublishableKey: 'YOUR_STRIPE_PUBLISHABLE_KEY',
      sentryDsn: 'YOUR_SENTRY_DSN',
      googleAnalyticsId: 'G-XXXXXXXXXX',
      emailServiceEndpoint: 'https://api.emailservice.com/send',
      aiAnalysisEndpoint: 'https://api.openai.com/v1/chat/completions',
      databaseEndpoint: 'https://api.yourdatabase.com',
      backupSchedule: '0 2 * * *', // 2 AM daily
      supportChatEnabled: true
    };

    // ============================================================================
    // DATABASE ABSTRACTION LAYER
    // ============================================================================
    
    class DatabaseService {
      constructor() {
        this.endpoint = APP_CONFIG.databaseEndpoint;
        this.cache = new Map();
        this.syncQueue = [];
        this.isOnline = navigator.onLine;
      }

      async query(collection, operation, data) {
        try {
          if (!this.isOnline) {
            // Queue for later sync
            this.syncQueue.push({ collection, operation, data, timestamp: Date.now() });
            return this.handleOfflineOperation(collection, operation, data);
          }

          const response = await fetch(`${this.endpoint}/${collection}/${operation}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${this.getAuthToken()}`
            },
            body: JSON.stringify(data)
          });

          if (!response.ok) {
            throw new Error(`Database error: ${response.statusText}`);
          }

          const result = await response.json();
          this.updateCache(collection, result);
          return result;
        } catch (error) {
          console.error('Database query error:', error);
          if (typeof Sentry !== 'undefined') {
            Sentry.captureException(error);
          }
          return this.handleOfflineOperation(collection, operation, data);
        }
      }

      handleOfflineOperation(collection, operation, data) {
        // Use local storage as fallback
        const localData = JSON.parse(localStorage.getItem(`diymatch_${collection}`) || '{}');
        
        switch (operation) {
          case 'create':
            const id = `local_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            localData[id] = { ...data, id, _local: true };
            break;
          case 'update':
            if (localData[data.id]) {
              localData[data.id] = { ...localData[data.id], ...data };
            }
            break;
          case 'delete':
            delete localData[data.id];
            break;
          case 'find':
            return Object.values(localData).filter(item => 
              Object.entries(data).every(([key, value]) => item[key] === value)
            );
        }
        
        localStorage.setItem(`diymatch_${collection}`, JSON.stringify(localData));
        return { success: true, data: localData[data.id] || localData };
      }

      async sync() {
        if (!this.isOnline || this.syncQueue.length === 0) return;
        
        const queue = [...this.syncQueue];
        this.syncQueue = [];
        
        for (const item of queue) {
          try {
            await this.query(item.collection, item.operation, item.data);
          } catch (error) {
            this.syncQueue.push(item); // Re-queue failed items
          }
        }
      }

      getAuthToken() {
        return localStorage.getItem('diymatch_auth_token') || '';
      }

      updateCache(collection, data) {
        this.cache.set(collection, data);
      }
    }

    const db = new DatabaseService();

    // Sync when coming online
    window.addEventListener('online', () => {
      db.isOnline = true;
      db.sync();
    });

    window.addEventListener('offline', () => {
      db.isOnline = false;
    });

    // ============================================================================
    // ENHANCED GLOBAL STATE
    // ============================================================================
    
    const registeredUsers = new Map();
    const expertProfiles = new Map();
    const quoteRequests = new Map();
    const bookings = new Map();
    const aiAnalysisHistory = new Map();
    const userAnalysisPurchases = new Map();
    const userFreeAnalyses = new Map();
    const userMessages = new Map();
    const messageThreads = new Map();
    const expertReviews = new Map();
    const savedProjects = new Map();
    const emergencyRequests = new Map();
    const userNotifications = new Map();
    const referralCodes = new Map();
    const expertPortfolios = new Map();
    const voiceNotes = new Map();
    const arSessions = new Map();
    const expertDocuments = new Map(); // New: Store expert CVs and certifications
    const supportTickets = new Map(); // New: Customer support tickets
    const systemBackups = new Map(); // New: System backup logs
    
    // Parts stores database
    const partsStores = new Map([
      ['london', [
        {
          id: 'store1',
          name: 'B&Q Wembley',
          address: 'Stadium Retail Park, Wembley, HA9 0EW',
          phone: '020 8902 7200',
          distance: '2.3 miles',
          categories: ['plumbing', 'electrical', 'tools', 'paint', 'building'],
          openHours: 'Mon-Sat: 7am-8pm, Sun: 10am-4pm',
          hasParking: true,
          wheelchairAccess: true,
          inStockItems: 847
        },
        {
          id: 'store2',
          name: 'Screwfix Camden',
          address: '45 Camden High St, NW1 7JH',
          phone: '020 7387 4488',
          distance: '4.1 miles',
          categories: ['tools', 'electrical', 'plumbing', 'safety'],
          openHours: 'Mon-Fri: 6am-8pm, Sat: 7am-6pm, Sun: 9am-4pm',
          hasParking: false,
          wheelchairAccess: true,
          inStockItems: 523
        },
        {
          id: 'store3',
          name: 'Wickes Tottenham',
          address: 'Broad Lane, N15 4QD',
          phone: '020 8808 3366',
          distance: '5.2 miles',
          categories: ['building', 'plumbing', 'paint', 'tools'],
          openHours: 'Mon-Sat: 7am-7pm, Sun: 10am-4pm',
          hasParking: true,
          wheelchairAccess: true,
          inStockItems: 692
        }
      ]]
    ]);

    // Demo expert profiles with enhanced data
    const demoExperts = [
      {
        id: 'expert1',
        name: 'John Smith',
        email: 'john@example.com',
        phone: '07123456789',
        profession: 'Master Plumber',
        postcode: 'NW1',
        location: 'Camden, London',
        bio: 'Professional plumber with 15 years experience. Specialized in emergency repairs, bathroom installations, and eco-friendly solutions. Available 24/7 for emergencies.',
        hourlyRate: 45,
        rating: 4.8,
        reviews: 127,
        completedJobs: 342,
        responseTime: '< 1 hour',
        availability: ['Mon-Fri', 'Weekends', 'Emergency 24/7'],
        certifications: 'City & Guilds Level 3 Plumbing, Water Regulations',
        insurance: 'Public Liability £2M',
        specialties: ['Emergency Repairs', 'Leak Detection', 'Bathroom Installation'],
        verified: true,
        joinedDate: '2022-03-15',
        languages: ['English', 'Polish'],
        transportMode: 'Van',
        toolsProvided: true,
        guaranteeOffered: '12 months',
        badges: ['Top Rated', 'Quick Response', 'Eco Friendly'],
        documents: ['cv_john_smith.pdf', 'cert_plumbing_level3.pdf', 'insurance_2024.pdf']
      },
      {
        id: 'expert2',
        name: 'Sarah Johnson',
        email: 'sarah@example.com',
        phone: '07987654321',
        profession: 'Certified Electrician',
        postcode: 'E1',
        location: 'Tower Hamlets, London',
        bio: 'NICEIC approved electrician. Expert in domestic installations, testing, smart home systems, and EV charger installations. Committed to safety and innovation.',
        hourlyRate: 55,
        rating: 4.9,
        reviews: 89,
        completedJobs: 256,
        responseTime: '< 2 hours',
        availability: ['Mon-Sat', 'Emergency weekends'],
        certifications: 'NICEIC Approved, 18th Edition, EV Charging Installation',
        insurance: 'Professional Indemnity £5M',
        specialties: ['Smart Home', 'EV Chargers', 'Safety Inspections'],
        verified: true,
        joinedDate: '2021-11-08',
        languages: ['English', 'French'],
        transportMode: 'Van',
        toolsProvided: true,
        guaranteeOffered: '18 months',
        badges: ['5 Star Expert', 'Smart Home Pro', 'Safety First'],
        documents: ['cv_sarah_johnson.pdf', 'niceic_cert.pdf', 'ev_training.pdf']
      },
      {
        id: 'expert3',
        name: 'Mike Wilson',
        email: 'mike@example.com',
        phone: '07456789123',
        profession: 'Handyman & Carpenter',
        postcode: 'SW1',
        location: 'Westminster, London',
        bio: 'Versatile handyman with carpentry expertise. No job too small! Specializing in furniture assembly, shelving, repairs, and general maintenance.',
        hourlyRate: 35,
        rating: 4.7,
        reviews: 203,
        completedJobs: 567,
        responseTime: '< 3 hours',
        availability: ['Mon-Sat'],
        certifications: 'City & Guilds Carpentry Level 2',
        insurance: 'Public Liability £1M',
        specialties: ['Furniture Assembly', 'Shelving', 'General Repairs'],
        verified: true,
        joinedDate: '2020-06-22',
        languages: ['English'],
        transportMode: 'Van',
        toolsProvided: true,
        guaranteeOffered: '6 months',
        badges: ['Popular Choice', 'Great Value'],
        documents: ['cv_mike_wilson.pdf', 'carpentry_cert.pdf']
      }
    ];

    // Initialize demo experts with documents
    demoExperts.forEach(expert => {
      expertProfiles.set(expert.id, expert);
      expertDocuments.set(expert.id, {
        cv: null,
        certifications: [],
        insurance: null,
        uploadedAt: new Date().toISOString()
      });
      expertReviews.set(expert.id, [
        {
          id: `review_${expert.id}_1`,
          userName: 'Alice M.',
          rating: 5,
          date: '2024-01-15',
          comment: 'Excellent work! Very professional and efficient.',
          jobType: 'Emergency Repair'
        },
        {
          id: `review_${expert.id}_2`,
          userName: 'David K.',
          rating: 4,
          date: '2024-01-20',
          comment: 'Good service, arrived on time and fixed the issue quickly.',
          jobType: 'Installation'
        }
      ]);
      expertPortfolios.set(expert.id, [
        {
          id: `portfolio_${expert.id}_1`,
          title: 'Bathroom Renovation',
          description: 'Complete bathroom makeover with modern fixtures',
          images: ['https://via.placeholder.com/300x200?text=Before', 'https://via.placeholder.com/300x200?text=After'],
          date: '2023-12-01'
        }
      ]);
    });

    // ============================================================================
    // PAYMENT SERVICE
    // ============================================================================
    
    class PaymentService {
      constructor() {
        this.stripe = stripe;
      }

      async createPaymentIntent(amount, metadata) {
        try {
          // In production, this would call your backend
          const response = await fetch('/api/create-payment-intent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: amount * 100, metadata })
          });

          if (!response.ok) {
            throw new Error('Payment intent creation failed');
          }

          const { clientSecret } = await response.json();
          return clientSecret;
        } catch (error) {
          console.error('Payment error:', error);
          // Fallback to demo mode
          return 'demo_payment_intent_' + Date.now();
        }
      }

      async processPayment(amount, metadata, paymentMethod = 'card') {
        try {
          if (!this.stripe) {
            // Demo mode
            console.log('Demo payment:', { amount, metadata, paymentMethod });
            return {
              success: true,
              paymentId: `demo_pay_${Date.now()}`,
              amount,
              metadata
            };
          }

          const clientSecret = await this.createPaymentIntent(amount, metadata);
          
          // In production, you'd collect card details and confirm payment
          const result = await this.stripe.confirmCardPayment(clientSecret, {
            payment_method: paymentMethod
          });

          if (result.error) {
            throw new Error(result.error.message);
          }

          return {
            success: true,
            paymentId: result.paymentIntent.id,
            amount,
            metadata
          };
        } catch (error) {
          console.error('Payment processing error:', error);
          if (typeof Sentry !== 'undefined') {
            Sentry.captureException(error);
          }
          throw error;
        }
      }

      async refund(paymentId, amount, reason) {
        try {
          const response = await fetch('/api/refund', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paymentId, amount: amount * 100, reason })
          });

          if (!response.ok) {
            throw new Error('Refund failed');
          }

          return await response.json();
        } catch (error) {
          console.error('Refund error:', error);
          throw error;
        }
      }
    }

    const paymentService = new PaymentService();

    // ============================================================================
    // AI ANALYSIS SERVICE
    // ============================================================================
    
    class AIAnalysisService {
      constructor() {
        this.endpoint = APP_CONFIG.aiAnalysisEndpoint;
        this.apiKey = 'YOUR_OPENAI_API_KEY';
      }

      async analyzeImage(imageData, description) {
        try {
          // Convert image to base64 if needed
          const base64Image = imageData.startsWith('data:') 
            ? imageData.split(',')[1] 
            : imageData;

          const response = await fetch(this.endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${this.apiKey}`
            },
            body: JSON.stringify({
              model: 'gpt-4-vision-preview',
              messages: [
                {
                  role: 'system',
                  content: 'You are a professional DIY and home repair expert. Analyze the image and description to identify the problem, assess severity, recommend solutions, and estimate costs.'
                },
                {
                  role: 'user',
                  content: [
                    {
                      type: 'text',
                      text: description
                    },
                    {
                      type: 'image_url',
                      image_url: {
                        url: `data:image/jpeg;base64,${base64Image}`
                      }
                    }
                  ]
                }
              ],
              max_tokens: 1000
            })
          });

          if (!response.ok) {
            throw new Error('AI analysis failed');
          }

          const result = await response.json();
          return this.parseAIResponse(result.choices[0].message.content);
        } catch (error) {
          console.error('AI analysis error:', error);
          // Fallback to pattern-based analysis
          return this.fallbackAnalysis(description);
        }
      }

      parseAIResponse(content) {
        // Parse structured response from AI
        try {
          const sections = content.split('\n\n');
          return {
            problemDetected: this.extractSection(sections, 'Problem:'),
            severity: this.extractSection(sections, 'Severity:'),
            description: this.extractSection(sections, 'Description:'),
            isDIYFriendly: this.extractSection(sections, 'DIY Friendly:').toLowerCase() === 'yes',
            estimatedCost: this.extractSection(sections, 'Estimated Cost:'),
            recommendedExpertType: this.extractSection(sections, 'Expert Type:'),
            safetyWarnings: this.extractList(sections, 'Safety Warnings:'),
            recommendedParts: this.extractPartsList(sections, 'Parts Needed:'),
            stepByStepGuide: this.extractList(sections, 'Steps:'),
            confidence: this.extractSection(sections, 'Confidence:') || '85%'
          };
        } catch (error) {
          return this.fallbackAnalysis(content);
        }
      }

      extractSection(sections, label) {
        const section = sections.find(s => s.startsWith(label));
        return section ? section.replace(label, '').trim() : '';
      }

      extractList(sections, label) {
        const section = sections.find(s => s.startsWith(label));
        if (!section) return [];
        return section
          .replace(label, '')
          .trim()
          .split('\n')
          .filter(line => line.trim())
          .map(line => line.replace(/^[-•*]\s*/, ''));
      }

      extractPartsList(sections, label) {
        const list = this.extractList(sections, label);
        return list.map(item => {
          const [name, price] = item.split(' - ');
          return {
            name: name || item,
            price: price || '£10-20',
            priority: 'Essential',
            category: 'general'
          };
        });
      }

      fallbackAnalysis(description) {
        // Existing pattern-based analysis as fallback
        return analyzeWithAI(description.toLowerCase(), { type: 'image', data: '' });
      }
    }

    const aiService = new AIAnalysisService();

    // ============================================================================
    // EMAIL SERVICE
    // ============================================================================
    
    class EmailService {
      constructor() {
        this.endpoint = APP_CONFIG.emailServiceEndpoint;
        this.templates = {
          welcome: (user) => ({
            subject: 'Welcome to DIYMatch! 🔧',
            html: `
              <h2>Welcome ${user.name}!</h2>
              <p>Thank you for joining DIYMatch, your AI-powered DIY assistant.</p>
              <h3>What you can do now:</h3>
              <ul>
                <li>🤖 Get your first AI analysis FREE this month</li>
                <li>👨‍🔧 Connect with verified local experts</li>
                <li>🛠️ Find parts at nearby stores</li>
                <li>💰 Share your referral code: <strong>${user.referralCode}</strong></li>
              </ul>
              <p>Need help? Reply to this email or call ${APP_CONFIG.emergencyHotline}</p>
            `,
            text: `Welcome ${user.name}! Thank you for joining DIYMatch.`
          }),
          
          bookingConfirmation: (booking, user, expert) => ({
            subject: `Booking Confirmed - ${expert.name} on ${new Date(booking.date).toLocaleDateString()}`,
            html: `
              <h2>Booking Confirmation</h2>
              <div style="border: 1px solid #ddd; padding: 20px; border-radius: 8px;">
                <h3>📅 Appointment Details</h3>
                <p><strong>Expert:</strong> ${expert.name} (${expert.profession})</p>
                <p><strong>Date:</strong> ${new Date(booking.date).toLocaleDateString()}</p>
                <p><strong>Time:</strong> ${booking.time}</p>
                <p><strong>Location:</strong> ${booking.location || user.postcode}</p>
              </div>
            `,
            text: `Booking confirmed with ${expert.name} on ${new Date(booking.date).toLocaleDateString()}`
          })
        };
      }

      async send(to, template, data) {
        try {
          const emailContent = typeof template === 'string' 
            ? this.templates[template](data)
            : template;

          const response = await fetch(this.endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${this.getApiKey()}`
            },
            body: JSON.stringify({
              to,
              from: APP_CONFIG.supportEmail,
              subject: emailContent.subject,
              html: emailContent.html,
              text: emailContent.text
            })
          });

          if (!response.ok) {
            throw new Error('Email send failed');
          }

          return { success: true };
        } catch (error) {
          console.error('Email service error:', error);
          // Log for manual follow-up
          console.log('Failed email:', { to, ...emailContent });
          return { success: false, error: error.message };
        }
      }

      getApiKey() {
        return 'YOUR_EMAIL_API_KEY';
      }
    }

    const emailService = new EmailService();

    // ============================================================================
    // BACKUP SERVICE
    // ============================================================================
    
    class BackupService {
      constructor() {
        this.schedule = APP_CONFIG.backupSchedule;
        this.lastBackup = null;
      }

      async createBackup() {
        try {
          const timestamp = new Date().toISOString();
          const data = {
            timestamp,
            users: Array.from(registeredUsers.entries()),
            experts: Array.from(expertProfiles.entries()),
            bookings: Array.from(bookings.entries()),
            analyses: Array.from(aiAnalysisHistory.entries()),
            reviews: Array.from(expertReviews.entries())
          };

          // In production, upload to cloud storage
          const backup = {
            id: `backup_${timestamp}`,
            timestamp,
            size: JSON.stringify(data).length,
            status: 'completed',
            location: 's3://diymatch-backups/' + timestamp
          };

          systemBackups.set(backup.id, backup);
          this.lastBackup = timestamp;

          // Keep only last 30 backups
          const backupList = Array.from(systemBackups.entries())
            .sort((a, b) => new Date(b[1].timestamp) - new Date(a[1].timestamp));
          
          if (backupList.length > 30) {
            backupList.slice(30).forEach(([id]) => systemBackups.delete(id));
          }

          return backup;
        } catch (error) {
          console.error('Backup failed:', error);
          if (typeof Sentry !== 'undefined') {
            Sentry.captureException(error);
          }
          throw error;
        }
      }

      async restoreBackup(backupId) {
        try {
          const backup = systemBackups.get(backupId);
          if (!backup) {
            throw new Error('Backup not found');
          }

          // In production, download from cloud storage and restore
          console.log('Restoring backup:', backup);
          
          return { success: true, backup };
        } catch (error) {
          console.error('Restore failed:', error);
          throw error;
        }
      }

      scheduleAutoBackup() {
        // In production, use a proper scheduler
        setInterval(() => {
          const now = new Date();
          if (now.getHours() === 2 && now.getMinutes() === 0) {
            this.createBackup();
          }
        }, 60000); // Check every minute
      }
    }

    const backupService = new BackupService();
    backupService.scheduleAutoBackup();

    // ============================================================================
    // ANALYTICS SERVICE
    // ============================================================================
    
    class AnalyticsService {
      constructor() {
        this.enabled = typeof gtag !== 'undefined';
      }

      track(eventName, parameters = {}) {
        if (!this.enabled) {
          console.log('Analytics event:', eventName, parameters);
          return;
        }

        try {
          gtag('event', eventName, {
            ...parameters,
            timestamp: new Date().toISOString()
          });
        } catch (error) {
          console.error('Analytics error:', error);
        }
      }

      trackPageView(pageName) {
        this.track('page_view', { page_name: pageName });
      }

      trackUserAction(action, category, label, value) {
        this.track(action, {
          event_category: category,
          event_label: label,
          value: value
        });
      }

      trackError(error, fatal = false) {
        this.track('exception', {
          description: error.message || error,
          fatal: fatal
        });
      }

      trackConversion(type, value) {
        this.track('conversion', {
          conversion_type: type,
          value: value,
          currency: 'GBP'
        });
      }
    }

    const analytics = new AnalyticsService();

    // ============================================================================
    // CUSTOMER SUPPORT SERVICE
    // ============================================================================
    
    class CustomerSupportService {
      constructor() {
        this.enabled = APP_CONFIG.supportChatEnabled;
      }

      async createTicket(userId, subject, message, priority = 'normal') {
        try {
          const ticket = {
            id: `ticket_${Date.now()}`,
            userId,
            subject,
            message,
            priority,
            status: 'open',
            createdAt: new Date().toISOString(),
            responses: []
          };

          supportTickets.set(ticket.id, ticket);
          
          // Notify support team
          await emailService.send(APP_CONFIG.supportEmail, {
            subject: `New Support Ticket: ${subject}`,
            html: `<p>Priority: ${priority}</p><p>Message: ${message}</p>`,
            text: `Priority: ${priority}\nMessage: ${message}`
          });

          return ticket;
        } catch (error) {
          console.error('Support ticket creation failed:', error);
          throw error;
        }
      }

      async respondToTicket(ticketId, message, isStaff = false) {
        const ticket = supportTickets.get(ticketId);
        if (!ticket) throw new Error('Ticket not found');

        const response = {
          id: `response_${Date.now()}`,
          message,
          isStaff,
          timestamp: new Date().toISOString()
        };

        ticket.responses.push(response);
        ticket.lastUpdated = response.timestamp;

        return ticket;
      }

      getTicketsForUser(userId) {
        return Array.from(supportTickets.values())
          .filter(ticket => ticket.userId === userId)
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      }

      getAllTickets() {
        return Array.from(supportTickets.values())
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
      }
    }

    const supportService = new CustomerSupportService();

    // ============================================================================
    // ENHANCED UTILITY FUNCTIONS
    // ============================================================================
    
    const triggerHaptic = (type = 'light') => {
      if (navigator.vibrate) {
        const patterns = {
          light: 50,
          medium: 100,
          heavy: 200,
          success: [50, 100, 50],
          error: [100, 50, 100],
          warning: [200, 100, 200]
        };
        navigator.vibrate(patterns[type] || 50);
      }
    };

    const takePhoto = () => {
      return new Promise((resolve) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.capture = 'environment';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            if (file.size > APP_CONFIG.maxImageSize) {
              alert(`Image must be less than ${APP_CONFIG.maxImageSize / 1024 / 1024}MB`);
              return;
            }
            const reader = new FileReader();
            reader.onload = (event) => resolve({ type: 'image', data: event.target.result, file });
            reader.readAsDataURL(file);
          }
        };
        input.click();
      });
    };

    const takeVideo = () => {
      return new Promise((resolve) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'video/*';
        input.capture = 'environment';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file && file.size <= APP_CONFIG.maxVideoSize) {
            const reader = new FileReader();
            reader.onload = (event) => resolve({ type: 'video', data: event.target.result, file });
            reader.readAsDataURL(file);
          } else if (file) {
            alert(`Video must be less than ${APP_CONFIG.maxVideoSize / 1024 / 1024}MB`);
          }
        };
        input.click();
      });
    };

    const uploadFile = (accept = '*') => {
      return new Promise((resolve) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = accept;
        input.multiple = true;
        input.onchange = (e) => {
          const files = Array.from(e.target.files);
          const validFiles = files.filter(file => file.size <= APP_CONFIG.maxFileSize);
          
          if (validFiles.length < files.length) {
            alert(`Some files were too large (max ${APP_CONFIG.maxFileSize / 1024 / 1024}MB)`);
          }
          
          Promise.all(validFiles.map(file => {
            return new Promise((res) => {
              const reader = new FileReader();
              reader.onload = (event) => res({
                name: file.name,
                type: file.type,
                size: file.size,
                data: event.target.result,
                file
              });
              reader.readAsDataURL(file);
            });
          })).then(resolve);
        };
        input.click();
      });
    };

    const recordVoiceNote = () => {
      return new Promise((resolve) => {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert('Voice recording not supported on this device');
          resolve(null);
          return;
        }

        // Simulated voice recording for demo
        const duration = prompt('Record voice note (enter duration in seconds):');
        if (duration) {
          resolve({
            type: 'voice',
            duration: parseInt(duration),
            data: 'data:audio/webm;base64,simulatedVoiceData',
            timestamp: new Date().toISOString()
          });
        } else {
          resolve(null);
        }
      });
    };

    const getUserLocation = async () => {
      return new Promise((resolve) => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              resolve({
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                city: 'London' // Would use reverse geocoding API in production
              });
            },
            (error) => {
              console.error('Location error:', error);
              analytics.trackError('Location access denied');
              resolve({ city: 'London', error: true });
            },
            { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
          );
        } else {
          resolve({ city: 'London', error: true });
        }
      });
    };

    const calculateDistance = (lat1, lon1, lat2, lon2) => {
      const R = 6371; // Radius of the earth in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      const d = R * c; // Distance in km
      return d;
    };

    // Enhanced payment processing
    const processPayment = async (amount, metadata, method = 'card') => {
      try {
        analytics.track('payment_initiated', { amount, method });
        
        const result = await paymentService.processPayment(amount, metadata, method);
        
        if (result.success) {
          analytics.trackConversion('payment', amount);
        }
        
        return result;
      } catch (error) {
        analytics.trackError(error);
        throw error;
      }
    };

    // Push notification simulation
    const sendPushNotification = async (userId, notification) => {
      if (!userNotifications.has(userId)) {
        userNotifications.set(userId, []);
      }
      
      const notificationData = {
        id: `notif_${Date.now()}`,
        ...notification,
        timestamp: new Date().toISOString(),
        read: false
      };
      
      userNotifications.get(userId).push(notificationData);
      
      // Show browser notification if permitted
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(notification.title, {
          body: notification.body,
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">🔧</text></svg>',
          badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">🔧</text></svg>'
        });
      }
      
      return notificationData;
    };

    // Generate referral code
    const generateReferralCode = (userId) => {
      const code = `DIY${userId.substring(5, 9).toUpperCase()}${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
      referralCodes.set(code, {
        userId,
        uses: 0,
        earnings: 0,
        created: new Date().toISOString()
      });
      return code;
    };

    // Check referral code
    const applyReferralCode = (code, newUserId) => {
      const referral = referralCodes.get(code);
      if (referral && referral.userId !== newUserId) {
        referral.uses++;
        referral.earnings += APP_CONFIG.referralBonus;
        analytics.track('referral_applied', { code, referrer: referral.userId });
        return { valid: true, referrerId: referral.userId, bonus: APP_CONFIG.referralBonus };
      }
      return { valid: false };
    };

    // Free analysis management
    const checkFreeAnalysisAvailable = (userEmail) => {
      const currentMonth = new Date().toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      const userRecord = userFreeAnalyses.get(userEmail);
      
      if (!userRecord || userRecord.month !== currentMonth) {
        return true;
      }
      
      return userRecord.used < APP_CONFIG.freeAnalysesPerMonth;
    };

    const useFreeAnalysis = (userEmail) => {
      const currentMonth = new Date().toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      const userRecord = userFreeAnalyses.get(userEmail) || { month: currentMonth, used: 0 };
      
      if (userRecord.month !== currentMonth) {
        userRecord.month = currentMonth;
        userRecord.used = 0;
      }
      
      userRecord.used++;
      userRecord.lastUsed = new Date().toISOString();
      userFreeAnalyses.set(userEmail, userRecord);
      
      analytics.track('free_analysis_used', { userEmail, month: currentMonth });
    };

    const getNextFreeAnalysisDate = () => {
      const now = new Date();
      const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      return nextMonth.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
    };

    // ============================================================================
    // ENHANCED DATABASE OPERATIONS
    // ============================================================================
    
    const dbOperations = {
      // User operations
      async createUser(userData) {
        try {
          const user = {
            id: `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            ...userData,
            createdAt: new Date().toISOString(),
            analysisCount: 0,
            totalSpent: 0,
            referralCode: generateReferralCode(`user_${Date.now()}`),
            settings: {
              notifications: true,
              newsletter: false,
              twoFactor: false,
              language: 'en',
              theme: 'light'
            },
            achievements: [],
            savedExperts: [],
            blockedExperts: []
          };
          
          registeredUsers.set(userData.email.toLowerCase(), user);
          await db.query('users', 'create', user);
          
          analytics.track('user_created', { userType: userData.userType });
          return { success: true, user };
        } catch (error) {
          console.error('Create user error:', error);
          throw error;
        }
      },

      async getUserByEmail(email) {
        const user = registeredUsers.get(email.toLowerCase());
        if (user) return user;
        
        try {
          const results = await db.query('users', 'find', { email: email.toLowerCase() });
          if (results && results.length > 0) {
            registeredUsers.set(email.toLowerCase(), results[0]);
            return results[0];
          }
        } catch (error) {
          console.error('Get user error:', error);
        }
        return null;
      },

      async updateUser(email, updates) {
        const user = registeredUsers.get(email.toLowerCase());
        if (user) {
          Object.assign(user, updates);
          await db.query('users', 'update', { id: user.id, ...updates });
          return { success: true, user };
        }
        return { success: false, error: 'User not found' };
      },

      // Expert operations
      async createExpert(expertData) {
        try {
          const expert = {
            id: `expert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            ...expertData,
            createdAt: new Date().toISOString(),
            verified: false,
            rating: 0,
            reviews: 0,
            completedJobs: 0,
            responseRate: 100,
            badges: [],
            portfolio: [],
            earnings: 0,
            accountStatus: 'pending_verification',
            documents: []
          };
          
          expertProfiles.set(expert.id, expert);
          await db.query('experts', 'create', expert);
          
          analytics.track('expert_created', { profession: expertData.profession });
          return { success: true, expert };
        } catch (error) {
          console.error('Create expert error:', error);
          throw error;
        }
      },

      async updateExpert(expertId, updates) {
        const expert = expertProfiles.get(expertId);
        if (expert) {
          Object.assign(expert, updates);
          await db.query('experts', 'update', { id: expertId, ...updates });
          return { success: true, expert };
        }
        return { success: false, error: 'Expert not found' };
      },

      async uploadExpertDocuments(expertId, documents) {
        try {
          const docRecord = {
            expertId,
            cv: documents.cv || null,
            certifications: documents.certifications || [],
            insurance: documents.insurance || null,
            uploadedAt: new Date().toISOString()
          };
          
          expertDocuments.set(expertId, docRecord);
          await db.query('expert_documents', 'create', docRecord);
          
          // Update expert verification status
          const expert = expertProfiles.get(expertId);
          if (expert && docRecord.cv && docRecord.certifications.length > 0) {
            expert.accountStatus = 'pending_review';
            await this.updateExpert(expertId, { accountStatus: 'pending_review' });
          }
          
          return { success: true, documents: docRecord };
        } catch (error) {
          console.error('Upload documents error:', error);
          throw error;
        }
      },

      // Quote operations
      async createQuoteRequest(quoteData) {
        try {
          const quote = {
            id: `quote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            ...quoteData,
            status: 'pending',
            createdAt: new Date().toISOString(),
            responses: [],
            selectedExpertId: null
          };
          
          if (!quoteRequests.has(quoteData.userEmail)) {
            quoteRequests.set(quoteData.userEmail, []);
          }
          quoteRequests.get(quoteData.userEmail).push(quote);
          
          await db.query('quotes', 'create', quote);
          
          // Notify relevant experts
          const relevantExperts = Array.from(expertProfiles.values()).filter(expert => 
            expert.profession.toLowerCase().includes(quoteData.category.toLowerCase()) &&
            expert.accountStatus === 'verified'
          );
          
          relevantExperts.forEach(expert => {
            sendPushNotification(expert.id, {
              title: 'New Quote Request',
              body: `${quoteData.urgency === 'urgent' ? '🚨 URGENT: ' : ''}${quoteData.description.substring(0, 50)}...`,
              type: 'quote_request',
              data: quote
            });
          });
          
          analytics.track('quote_requested', { category: quoteData.category, urgency: quoteData.urgency });
          return { success: true, quote };
        } catch (error) {
          console.error('Create quote error:', error);
          throw error;
        }
      },

      async respondToQuote(quoteId, expertId, response) {
        // Find the quote across all users
        for (const [userEmail, quotes] of quoteRequests.entries()) {
          const quote = quotes.find(q => q.id === quoteId);
          if (quote) {
            const expertResponse = {
              expertId,
              ...response,
              timestamp: new Date().toISOString()
            };
            quote.responses.push(expertResponse);
            
            await db.query('quotes', 'update', { id: quoteId, responses: quote.responses });
            
            // Notify user
            sendPushNotification(userEmail, {
              title: 'New Quote Response',
              body: `You have a new quote from an expert`,
              type: 'quote_response',
              data: expertResponse
            });
            
            analytics.track('quote_responded', { quoteId, expertId });
            return { success: true, response: expertResponse };
          }
        }
        return { success: false, error: 'Quote not found' };
      },

      // Booking operations
      async createBooking(bookingData) {
        try {
          const booking = {
            id: `booking_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            ...bookingData,
            status: 'confirmed',
            createdAt: new Date().toISOString(),
            updates: [],
            chatEnabled: true,
            expertArrived: false,
            jobStarted: false,
            jobCompleted: false,
            paymentStatus: 'paid',
            customerSatisfaction: null
          };
          
          if (!bookings.has(bookingData.userEmail)) {
            bookings.set(bookingData.userEmail, []);
          }
          bookings.get(bookingData.userEmail).push(booking);
          
          await db.query('bookings', 'create', booking);
          
          // Update expert's completed jobs count
          const expert = expertProfiles.get(bookingData.expertId);
          if (expert) {
            expert.completedJobs++;
            await this.updateExpert(bookingData.expertId, { completedJobs: expert.completedJobs });
          }
          
          analytics.trackConversion('booking', bookingData.totalCost);
          return { success: true, booking };
        } catch (error) {
          console.error('Create booking error:', error);
          throw error;
        }
      },

      async updateBooking(bookingId, updates) {
        for (const [userEmail, userBookings] of bookings.entries()) {
          const booking = userBookings.find(b => b.id === bookingId);
          if (booking) {
            Object.assign(booking, updates);
            booking.updates.push({
              timestamp: new Date().toISOString(),
              changes: updates
            });
            
            await db.query('bookings', 'update', { id: bookingId, ...updates });
            return { success: true, booking };
          }
        }
        return { success: false, error: 'Booking not found' };
      },

      // AI Analysis operations
      async saveAnalysis(analysisData) {
        try {
          const analysis = {
            id: `analysis_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            ...analysisData,
            timestamp: new Date().toISOString(),
            followUpActions: [],
            expertContacted: false,
            issueResolved: false
          };
          
          if (!aiAnalysisHistory.has(analysisData.userEmail)) {
            aiAnalysisHistory.set(analysisData.userEmail, []);
          }
          aiAnalysisHistory.get(analysisData.userEmail).push(analysis);
          
          await db.query('analyses', 'create', analysis);
          
          // Update user's analysis count
          const user = registeredUsers.get(analysisData.userEmail);
          if (user) {
            user.analysisCount++;
            await this.updateUser(analysisData.userEmail, { analysisCount: user.analysisCount });
          }
          
          analytics.track('analysis_completed', { 
            problemType: analysisData.problemDetected, 
            severity: analysisData.severity 
          });
          
          return { success: true, analysis };
        } catch (error) {
          console.error('Save analysis error:', error);
          throw error;
        }
      },

      // Review operations
      async createReview(reviewData) {
        try {
          const review = {
            id: `review_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            ...reviewData,
            timestamp: new Date().toISOString(),
            verified: true,
            helpful: 0,
            reported: false
          };
          
          if (!expertReviews.has(reviewData.expertId)) {
            expertReviews.set(reviewData.expertId, []);
          }
          expertReviews.get(reviewData.expertId).push(review);
          
          await db.query('reviews', 'create', review);
          
          // Update expert's rating
          const expert = expertProfiles.get(reviewData.expertId);
          if (expert) {
            const allReviews = expertReviews.get(reviewData.expertId);
            const totalRating = allReviews.reduce((sum, r) => sum + r.rating, 0);
            expert.rating = (totalRating / allReviews.length).toFixed(1);
            expert.reviews = allReviews.length;
            await this.updateExpert(reviewData.expertId, { 
              rating: expert.rating, 
              reviews: expert.reviews 
            });
          }
          
          analytics.track('review_created', { expertId: reviewData.expertId, rating: reviewData.rating });
          return { success: true, review };
        } catch (error) {
          console.error('Create review error:', error);
          throw error;
        }
      },

      // Project operations
      async saveProject(projectData) {
        try {
          const project = {
            id: `project_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            ...projectData,
            createdAt: new Date().toISOString(),
            lastModified: new Date().toISOString(),
            status: 'planning',
            tasks: [],
            expenses: [],
            timeline: [],
            collaborators: []
          };
          
          if (!savedProjects.has(projectData.userEmail)) {
            savedProjects.set(projectData.userEmail, []);
          }
          savedProjects.get(projectData.userEmail).push(project);
          
          await db.query('projects', 'create', project);
          
          analytics.track('project_created', { projectType: projectData.type });
          return { success: true, project };
        } catch (error) {
          console.error('Save project error:', error);
          throw error;
        }
      },

      // Emergency request operations
      async createEmergencyRequest(requestData) {
        try {
          const emergency = {
            id: `emergency_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            ...requestData,
            timestamp: new Date().toISOString(),
            status: 'active',
            respondedExperts: [],
            assignedExpertId: null,
            resolution: null
          };
          
          emergencyRequests.set(emergency.id, emergency);
          await db.query('emergencies', 'create', emergency);
          
          // Alert all available experts in the area
          const availableExperts = Array.from(expertProfiles.values()).filter(expert => {
            const matchesCategory = expert.specialties.some(s => 
              s.toLowerCase().includes(requestData.category.toLowerCase())
            );
            const isAvailable = expert.availability.includes('Emergency 24/7');
            const isVerified = expert.accountStatus === 'verified';
            return matchesCategory && isAvailable && isVerified;
          });
          
          availableExperts.forEach(expert => {
            sendPushNotification(expert.id, {
              title: '🚨 EMERGENCY REQUEST',
              body: requestData.description,
              type: 'emergency',
              priority: 'high',
              data: emergency
            });
          });
          
          analytics.track('emergency_created', { 
            category: requestData.category, 
            notifiedExperts: availableExperts.length 
          });
          
          return { success: true, emergency, notifiedExperts: availableExperts.length };
        } catch (error) {
          console.error('Create emergency error:', error);
          throw error;
        }
      }
    };

    // ============================================================================
    // EMAIL SERVICE WITH TEMPLATES
    // ============================================================================
    
    const sendEmail = async (to, template, data) => {
      return emailService.send(to, template, data);
    };

    const sendBookingConfirmation = async (booking, user, expert) => {
      return emailService.send(user.email, 'bookingConfirmation', { booking, user, expert });
    };

    // ============================================================================
    // ENHANCED AI ANALYSIS ENGINE
    // ============================================================================
    
    const performAIAnalysis = async (media, description, progressCallback) => {
      if (!navigator.onLine) {
        throw new Error('Internet connection required for AI analysis');
      }

      const analysisSteps = [
        { progress: 5, delay: 300, message: 'Initializing AI engine...' },
        { progress: 15, delay: 500, message: 'Processing ' + media.type + '...' },
        { progress: 25, delay: 700, message: 'Extracting visual features...' },
        { progress: 35, delay: 600, message: 'Analyzing problem patterns...' },
        { progress: 45, delay: 800, message: 'Checking safety database...' },
        { progress: 55, delay: 700, message: 'Identifying required tools...' },
        { progress: 65, delay: 600, message: 'Calculating repair complexity...' },
        { progress: 75, delay: 700, message: 'Finding compatible parts...' },
        { progress: 85, delay: 600, message: 'Matching expert profiles...' },
        { progress: 95, delay: 500, message: 'Generating recommendations...' },
        { progress: 100, delay: 400, message: 'Finalizing report...' }
      ];

      // Simulate progress for demo - in production, use real AI service
      for (const step of analysisSteps) {
        await new Promise(resolve => setTimeout(resolve, step.delay));
        progressCallback(step.progress, step.message);
      }

      try {
        // Try real AI analysis first
        const result = await aiService.analyzeImage(media.data, description);
        return { ...result, mediaType: media.type };
      } catch (error) {
        // Fallback to pattern-based analysis
        console.log('Using fallback analysis');
        return analyzeWithAI(description.toLowerCase(), media);
      }
    };

    const analyzeWithAI = (keywords, media) => {
      let problemType = 'General Maintenance';
      let severity = 'Medium';
      let confidence = 85;
      let isDIYFriendly = true;
      let estimatedCost = '£50-£150';
      let recommendedExpert = 'Handyman';
      let riskLevel = 'Low';
      let timeToFix = '1-2 hours';
      
      const problemPatterns = {
        electrical: {
          keywords: ['electric', 'socket', 'wire', 'switch', 'fuse', 'circuit', 'power', 'outlet', 'spark', 'breaker', 'voltage'],
          problem: 'Electrical Issue',
          severity: 'Critical',
          diy: false,
          expert: 'Electrician',
          cost: '£100-£300',
          risk: 'High',
          time: '2-4 hours',
          urgency: 'Immediate'
        },
        plumbing: {
          keywords: ['leak', 'water', 'pipe', 'tap', 'drain', 'toilet', 'shower', 'sink', 'drip', 'flood', 'pressure'],
          problem: 'Plumbing Issue',
          severity: 'High',
          diy: true,
          expert: 'Plumber',
          cost: '£80-£200',
          risk: 'Medium',
          time: '1-3 hours',
          urgency: '24 hours'
        },
        structural: {
          keywords: ['wall', 'crack', 'ceiling', 'floor', 'foundation', 'damp', 'mold', 'mould', 'subsidence', 'roof'],
          problem: 'Structural/Damp Issue',
          severity: 'High',
          diy: false,
          expert: 'Building Surveyor',
          cost: '£150-£500',
          risk: 'High',
          time: '4-8 hours',
          urgency: '48 hours'
        },
        heating: {
          keywords: ['boiler', 'radiator', 'heating', 'cold', 'thermostat', 'gas', 'central heating', 'hot water'],
          problem: 'Heating/Gas Issue',
          severity: 'Critical',
          diy: false,
          expert: 'Gas Safe Engineer',
          cost: '£150-£400',
          risk: 'Critical',
          time: '2-5 hours',
          urgency: 'Immediate'
        },
        appliance: {
          keywords: ['washing machine', 'dishwasher', 'fridge', 'freezer', 'oven', 'microwave', 'dryer'],
          problem: 'Appliance Malfunction',
          severity: 'Medium',
          diy: true,
          expert: 'Appliance Technician',
          cost: '£60-£180',
          risk: 'Low',
          time: '1-2 hours',
          urgency: '72 hours'
        },
        pest: {
          keywords: ['mouse', 'rat', 'insect', 'wasp', 'bee', 'ant', 'cockroach', 'pest', 'infestation'],
          problem: 'Pest Control Issue',
          severity: 'Medium',
          diy: true,
          expert: 'Pest Control Specialist',
          cost: '£80-£250',
          risk: 'Medium',
          time: '2-4 hours',
          urgency: '48 hours'
        }
      };

      // Enhanced pattern matching with context analysis
      let bestMatch = null;
      let maxScore = 0;
      
      for (const [type, config] of Object.entries(problemPatterns)) {
        let score = 0;
        config.keywords.forEach(keyword => {
          if (keywords.includes(keyword)) {
            score += 1;
            // Boost score for exact matches
            if (keywords.split(' ').includes(keyword)) {
              score += 0.5;
            }
          }
        });
        
        if (score > maxScore) {
          maxScore = score;
          bestMatch = config;
        }
      }
      
      if (bestMatch && maxScore >= 2) {
        problemType = bestMatch.problem;
        severity = bestMatch.severity;
        isDIYFriendly = bestMatch.diy;
        recommendedExpert = bestMatch.expert;
        estimatedCost = bestMatch.cost;
        riskLevel = bestMatch.risk;
        timeToFix = bestMatch.time;
        confidence = Math.min(95, 70 + (maxScore * 5));
      }

      // Check for emergency keywords
      const emergencyKeywords = ['urgent', 'emergency', 'flooding', 'fire', 'smoke', 'gas smell', 'sparking', 'dangerous'];
      const isEmergency = emergencyKeywords.some(word => keywords.includes(word));
      
      if (isEmergency) {
        severity = 'Critical';
        isDIYFriendly = false;
        riskLevel = 'Critical';
      }

      // Generate comprehensive analysis results
      const analysis = {
        problemDetected: problemType,
        confidence: confidence + '%',
        severity,
        description: `AI analysis indicates this is a ${problemType.toLowerCase()} with ${confidence}% confidence.`,
        isDIYFriendly,
        estimatedCost,
        timeToFix,
        recommendedExpertType: recommendedExpert,
        safetyWarnings: generateSafetyWarnings(severity, problemType),
        recommendedParts: generatePartsRecommendations(problemType),
        stepByStepGuide: isDIYFriendly ? generateDetailedSteps(problemType) : ['Professional expertise required - do not attempt DIY'],
        riskLevel,
        mediaType: media.type,
        regulations: getRegulations(problemType),
        availableExperts: checkUrgentExpertAvailability(recommendedExpert),
        aiInsights: generateAIInsights(problemType, severity, keywords),
        preventiveTips: generatePreventiveTips(problemType),
        similarIssues: findSimilarIssues(problemType),
        costBreakdown: generateCostBreakdown(problemType, estimatedCost),
        toolsRequired: generateToolsList(problemType, isDIYFriendly),
        videoTutorials: getVideoTutorials(problemType),
        warrantyInfo: getWarrantyInfo(problemType),
        environmentalImpact: assessEnvironmentalImpact(problemType)
      };

      return analysis;
    };

    const generateSafetyWarnings = (severity, problemType) => {
      const baseWarnings = {
        'Critical': [
          '🚨 IMMEDIATE ACTION REQUIRED',
          '⚠️ Turn off main utilities if applicable',
          '📞 Consider calling emergency services',
          '🚫 Do not attempt repairs yourself',
          '👥 Keep all occupants away from danger'
        ],
        'High': [
          '⚠️ Significant safety hazard present',
          '🧤 Professional PPE required',
          '📖 Follow safety protocols strictly',
          '👨‍🔧 Professional expertise recommended',
          '⏰ Address within 24-48 hours'
        ],
        'Medium': [
          '⚡ Exercise appropriate caution',
          '🥽 Use safety equipment',
          '📋 Follow instructions carefully',
          '🔍 Monitor for deterioration'
        ],
        'Low': [
          '✅ Generally safe for DIY',
          '🧤 Basic safety gear recommended',
          '📖 Read instructions thoroughly'
        ]
      };
      
      // Add problem-specific warnings
      const specificWarnings = {
        'Electrical Issue': ['⚡ Risk of electrocution', '🔥 Fire hazard', 'Turn off circuit breaker'],
        'Gas Issue': ['💨 Ventilate area immediately', '🚭 No open flames', 'Call Gas Emergency Service: 0800 111 999'],
        'Structural Issue': ['🏠 Risk of collapse', '⚠️ Evacuate if severe', 'Document for insurance']
      };
      
      const warnings = [...(baseWarnings[severity] || baseWarnings['Medium'])];
      
      Object.keys(specificWarnings).forEach(key => {
        if (problemType.includes(key.split(' ')[0])) {
          warnings.push(...specificWarnings[key]);
        }
      });
      
      return warnings;
    };

    const generatePartsRecommendations = (problemType) => {
      const partsDatabase = {
        'Plumbing Issue': [
          { name: 'Pipe Repair Kit', price: '£12.99', priority: 'Essential', category: 'plumbing' },
          { name: 'PTFE Tape', price: '£2.49', priority: 'Essential', category: 'plumbing' },
          { name: 'Adjustable Wrench Set', price: '£15.99', priority: 'Essential', category: 'tools' },
          { name: 'Plumber\'s Putty', price: '£4.99', priority: 'Recommended', category: 'plumbing' },
          { name: 'Pipe Cutter', price: '£19.99', priority: 'Optional', category: 'tools' },
          { name: 'Leak Detection Dye', price: '£7.99', priority: 'Optional', category: 'plumbing' }
        ],
        'Electrical Issue': [
          { name: 'Voltage Tester', price: '£19.99', priority: 'Essential', category: 'electrical' },
          { name: 'Wire Nuts Assortment', price: '£8.99', priority: 'Essential', category: 'electrical' },
          { name: 'Electrical Tape', price: '£3.49', priority: 'Essential', category: 'electrical' },
          { name: 'Circuit Breaker Finder', price: '£34.99', priority: 'Recommended', category: 'electrical' },
          { name: 'Insulated Screwdriver Set', price: '£24.99', priority: 'Essential', category: 'tools' },
          { name: 'Wire Stripper', price: '£12.99', priority: 'Recommended', category: 'tools' }
        ],
        'Structural/Damp Issue': [
          { name: 'Damp Seal Paint 5L', price: '£24.99', priority: 'Essential', category: 'paint' },
          { name: 'Crack Repair Compound', price: '£8.99', priority: 'Essential', category: 'building' },
          { name: 'Digital Moisture Meter', price: '£29.99', priority: 'Recommended', category: 'tools' },
          { name: 'Anti-Mold Treatment', price: '£12.99', priority: 'Essential', category: 'building' },
          { name: 'Dehumidifier', price: '£149.99', priority: 'Recommended', category: 'electrical' },
          { name: 'Waterproof Membrane', price: '£34.99', priority: 'Optional', category: 'building' }
        ],
        'Heating/Gas Issue': [
          { name: 'Carbon Monoxide Detector', price: '£19.99', priority: 'Essential', category: 'safety' },
          { name: 'Radiator Bleed Key', price: '£2.99', priority: 'Essential', category: 'plumbing' },
          { name: 'Pipe Insulation', price: '£9.99', priority: 'Recommended', category: 'building' },
          { name: 'Thermostat (Smart)', price: '£179.99', priority: 'Optional', category: 'electrical' },
          { name: 'Radiator Valve Set', price: '£24.99', priority: 'Recommended', category: 'plumbing' }
        ],
        'General Maintenance': [
          { name: 'Multi-Tool Set', price: '£24.99', priority: 'Essential', category: 'tools' },
          { name: 'WD-40', price: '£5.99', priority: 'Essential', category: 'tools' },
          { name: 'Duct Tape', price: '£4.49', priority: 'Essential', category: 'tools' },
          { name: 'Screwdriver Set', price: '£12.99', priority: 'Essential', category: 'tools' },
          { name: 'Digital Multimeter', price: '£19.99', priority: 'Recommended', category: 'electrical' },
          { name: 'Tool Box', price: '£29.99', priority: 'Recommended', category: 'tools' }
        ]
      };
      
      return partsDatabase[problemType] || partsDatabase['General Maintenance'];
    };

    const generateDetailedSteps = (problemType) => {
      const stepGuides = {
        'Plumbing Issue': [
          '1. 🚰 Turn off water supply at stopcock (usually under kitchen sink)',
          '2. 📸 Take photos for reference before starting',
          '3. 🪣 Place buckets and towels under work area',
          '4. 🔍 Identify exact source - check joints, seals, and connections',
          '5. 🧹 Clean and dry the affected area thoroughly',
          '6. 🔧 If joint leak: Tighten connection (turn clockwise)',
          '7. 🔨 If still leaking: Disassemble and replace washers/seals',
          '8. 🧵 Apply PTFE tape to threads (wrap clockwise)',
          '9. 🔄 Reassemble components carefully',
          '10. 💧 Turn water back on slowly',
          '11. ✅ Check for leaks - wait 30 minutes',
          '12. 📝 Document repair for future reference'
        ],
        'General Maintenance': [
          '1. 📋 Document the issue with photos/videos',
          '2. 🔍 Research specific repair procedures',
          '3. 🛠️ Gather all necessary tools and parts',
          '4. 🦺 Put on appropriate safety equipment',
          '5. 📖 Read instructions/watch tutorials',
          '6. 🔧 Perform repair step by step',
          '7. ✅ Test thoroughly',
          '8. 🧹 Clean up work area',
          '9. 📝 Keep repair documentation'
        ],
        'Appliance Malfunction': [
          '1. 🔌 Unplug appliance from power source',
          '2. 📖 Check user manual for troubleshooting',
          '3. 🔍 Inspect for obvious issues (blockages, damage)',
          '4. 🧹 Clean filters and accessible parts',
          '5. 🔧 Check and tighten connections',
          '6. 🔄 Reset appliance if applicable',
          '7. 🔌 Reconnect and test',
          '8. 📞 Contact manufacturer if under warranty'
        ]
      };
      
      return stepGuides[problemType] || stepGuides['General Maintenance'];
    };

    const getRegulations = (problemType) => {
      const regulations = {
        'Electrical Issue': {
          regulation: 'Part P Building Regulations',
          details: 'Notifiable work includes new circuits, work in bathrooms, and outdoor installations',
          requirement: 'Must use certified electrician for notifiable work',
          penalty: 'Up to £5,000 fine for non-compliance'
        },
        'Heating/Gas Issue': {
          regulation: 'Gas Safe Regulations',
          details: 'All gas work must be carried out by Gas Safe registered engineers',
          requirement: 'Legal requirement - check engineer\'s Gas Safe ID',
          penalty: 'Unlimited fine and/or imprisonment for illegal gas work'
        },
        'Structural/Damp Issue': {
          regulation: 'Building Regulations',
          details: 'Structural alterations may require building control approval',
          requirement: 'Check with local authority before major work',
          penalty: 'Enforcement notice and required remedial work'
        },
        'Plumbing Issue': {
          regulation: 'Water Supply Regulations (WRAS)',
          details: 'Some work requires approval to prevent contamination',
          requirement: 'Use WRAS approved fittings',
          penalty: 'Fine and required correction of work'
        }
      };
      
      const reg = regulations[problemType];
      return reg ? `${reg.regulation}: ${reg.details}. ${reg.requirement}` : 'No specific regulations, but follow manufacturer guidelines and best practices';
    };

    const checkUrgentExpertAvailability = (expertType) => {
      const experts = Array.from(expertProfiles.values());
      const now = new Date();
      const currentHour = now.getHours();
      const isBusinessHours = currentHour >= 8 && currentHour < 20;
      const isWeekend = now.getDay() === 0 || now.getDay() === 6;
      
      const availableExperts = experts.filter(expert => {
        const matchesType = expert.profession.toLowerCase().includes(expertType.toLowerCase()) ||
                          expert.specialties.some(s => s.toLowerCase().includes(expertType.toLowerCase()));
        const respondsQuickly = expert.responseTime && (
          expert.responseTime.includes('< 1 hour') || 
          expert.responseTime.includes('< 2 hours')
        );
        const availableNow = expert.availability.includes('Emergency 24/7') ||
                           (isBusinessHours && !isWeekend && expert.availability.includes('Mon-Fri')) ||
                           (isWeekend && expert.availability.includes('Weekends'));
        const isVerified = expert.verified && expert.accountStatus === 'verified';
        
        return matchesType && respondsQuickly && availableNow && isVerified;
      });

      // Sort by rating and response time
      availableExperts.sort((a, b) => {
        const aScore = parseFloat(a.rating) + (a.responseTime.includes('< 1 hour') ? 0.5 : 0);
        const bScore = parseFloat(b.rating) + (b.responseTime.includes('< 1 hour') ? 0.5 : 0);
        return bScore - aScore;
      });

      return {
        count: availableExperts.length,
        experts: availableExperts.slice(0, 5),
        nextAvailable: availableExperts.length === 0 
          ? (isBusinessHours ? 'Tomorrow 8am' : 'Today 8am')
          : 'Now',
        averageResponseTime: availableExperts.length > 0
          ? availableExperts[0].responseTime
          : '4-6 hours'
      };
    };

    const generateAIInsights = (problemType, severity, keywords) => {
      const weatherImpact = keywords.includes('rain') || keywords.includes('storm') || keywords.includes('wind');
      const ageRelated = keywords.includes('old') || keywords.includes('worn') || keywords.includes('years');
      
      return {
        rootCause: `Based on the analysis, the likely root cause is ${
          problemType.includes('Electrical') ? 'electrical component failure, wiring degradation, or overload issues' :
          problemType.includes('Plumbing') ? 'seal degradation, pipe corrosion, or pressure issues' :
          problemType.includes('Structural') ? 'moisture ingress, settlement, or material fatigue' :
          problemType.includes('Heating') ? 'component wear, lack of maintenance, or system age' :
          'general wear and tear or lack of maintenance'
        }${weatherImpact ? ' possibly exacerbated by recent weather conditions' : ''}${ageRelated ? ' due to age-related deterioration' : ''}.`,
        
        riskAssessment: `This issue has a ${severity.toLowerCase()} risk level. ${
          severity === 'Critical' ? 'Immediate action required to prevent danger or extensive damage.' :
          severity === 'High' ? 'Should be addressed within 24-48 hours to prevent escalation.' :
          severity === 'Medium' ? 'Schedule repair within a week to prevent deterioration.' :
          'Can be scheduled at your convenience, but don\'t delay too long.'
        }`,
        
        costFactors: `Main cost drivers include: ${
          problemType.includes('Electrical') ? 'safety compliance, specialized parts, and certification requirements' :
          problemType.includes('Plumbing') ? 'water damage prevention, parts availability, and access difficulty' :
          problemType.includes('Structural') ? 'extent of damage, materials needed, and potential hidden issues' :
          'parts replacement, labor time, and any required permits'
        }.`,
        
        preventionValue: `Addressing this now could prevent: ${
          severity === 'Critical' ? 'serious injury, major property damage, or emergency callout fees' :
          severity === 'High' ? 'water damage, electrical fires, or costly emergency repairs' :
          'further deterioration, higher repair costs, or system failure'
        }. Estimated prevention savings: £${Math.floor(Math.random() * 500 + 200)}-£${Math.floor(Math.random() * 1000 + 500)}.`,
        
        seasonalConsiderations: `${
          new Date().getMonth() >= 9 || new Date().getMonth() <= 2 
            ? 'Winter conditions may worsen this issue. Address before severe weather.' 
            : new Date().getMonth() >= 3 && new Date().getMonth() <= 5
            ? 'Spring is ideal for repairs. Good weather window for external work.'
            : 'Summer heat may affect repair materials. Work during cooler hours.'
        }`
      };
    };

    const generatePreventiveTips = (problemType) => {
      const tips = {
        'Electrical Issue': [
          '⚡ Test RCD/circuit breakers monthly by pressing test button',
          '🔌 Check outlets for warmth or discoloration quarterly',
          '📅 Schedule professional inspection every 5 years (rental properties: every 5 years required)',
          '🔋 Replace smoke alarm batteries every 6 months',
          '💡 Upgrade to LED bulbs to reduce electrical load',
          '📊 Monitor energy usage for unusual spikes'
        ],
        'Plumbing Issue': [
          '🔍 Inspect under sinks monthly for moisture or drips',
          '🚿 Clean shower heads and aerators every 3 months',
          '📏 Check water pressure quarterly (ideal: 40-60 PSI)',
          '🧹 Clear drain traps and use enzyme cleaners monthly',
          '❄️ Insulate pipes in cold areas before winter',
          '🚰 Service water heater annually'
        ],
        'Structural/Damp Issue': [
          '🏠 Clear gutters and downspouts twice yearly',
          '👀 Inspect roof after storms for damage',
          '💨 Ensure adequate ventilation in all rooms',
          '📊 Monitor indoor humidity (ideal: 30-50%)',
          '🔍 Check for cracks after extreme weather',
          '🌱 Keep plants/soil away from foundations'
        ],
        'Heating/Gas Issue': [
          '🔥 Service boiler annually (legally required for rentals)',
          '🌡️ Bleed radiators at start of heating season',
          '🚨 Test carbon monoxide detectors monthly',
          '📅 Replace boiler filters as recommended',
          '🔧 Check boiler pressure monthly (ideal: 1-1.5 bar)',
          '📊 Monitor gas usage for unusual increases'
        ],
        'General Maintenance': [
          '📝 Keep a home maintenance log',
          '🗓️ Create seasonal maintenance schedule',
          '🔧 Build basic tool kit and supplies',
          '📚 Learn location of utility shutoffs',
          '📸 Document property condition annually',
          '💰 Budget 1% of home value for annual maintenance'
        ]
      };
      
      return tips[problemType] || tips['General Maintenance'];
    };

    const findSimilarIssues = (problemType) => {
      // Simulate finding similar resolved issues
      return [
        {
          title: `Similar ${problemType} - Resolved in 2 hours`,
          description: 'User had comparable issue, fixed with expert help',
          cost: '£120',
          rating: 4.8,
          timeAgo: '3 days ago'
        },
        {
          title: `DIY ${problemType} Success Story`,
          description: 'Homeowner fixed similar problem themselves',
          cost: '£45 (parts only)',
          rating: 5.0,
          timeAgo: '1 week ago'
        }
      ];
    };

    const generateCostBreakdown = (problemType, estimatedRange) => {
      const [min, max] = estimatedRange.match(/\d+/g).map(Number);
      const labor = Math.round((min + max) / 2 * 0.7);
      const parts = Math.round((min + max) / 2 * 0.3);
      
      return {
        labor: `£${labor}`,
        parts: `£${parts}`,
        callOutFee: '£0-50',
        vat: '20% (if applicable)',
        total: estimatedRange,
        savingsIfDIY: `£${labor}`,
        financingAvailable: max > 500
      };
    };

    const generateToolsList = (problemType, isDIY) => {
      if (!isDIY) {
        return ['Professional equipment required - not suitable for DIY'];
      }
      
      const tools = {
        'Plumbing Issue': [
          { name: 'Adjustable Wrench', essential: true, price: '£15' },
          { name: 'Pipe Cutter', essential: false, price: '£20' },
          { name: 'Plumber\'s Tape', essential: true, price: '£3' },
          { name: 'Bucket', essential: true, price: '£5' },
          { name: 'Towels', essential: true, price: '£10' }
        ],
        'General Maintenance': [
          { name: 'Screwdriver Set', essential: true, price: '£13' },
          { name: 'Hammer', essential: true, price: '£10' },
          { name: 'Measuring Tape', essential: true, price: '£5' },
          { name: 'Level', essential: false, price: '£15' },
          { name: 'Safety Glasses', essential: true, price: '£5' }
        ]
      };
      
      return tools[problemType] || tools['General Maintenance'];
    };

    const getVideoTutorials = (problemType) => {
      return [
        {
          title: `How to Fix ${problemType} - Beginner's Guide`,
          duration: '12:34',
          thumbnail: 'https://via.placeholder.com/320x180?text=Video+Tutorial',
          views: '45K',
          source: 'DIYMatch Academy'
        },
        {
          title: `Common ${problemType} Mistakes to Avoid`,
          duration: '8:45',
          thumbnail: 'https://via.placeholder.com/320x180?text=Tips+Video',
          views: '23K',
          source: 'Pro Tips Channel'
        }
      ];
    };

    const getWarrantyInfo = (problemType) => {
      return {
        manufacturerWarranty: 'Check device serial number and purchase date',
        homeWarranty: 'May be covered under home warranty if applicable',
        insuranceClaim: problemType.includes('Structural') || problemType.includes('Flood') 
          ? 'Potentially covered - check policy' 
          : 'Unlikely to be covered',
        expertGuarantee: 'Most professionals offer 6-12 month guarantee on work'
      };
    };

    const assessEnvironmentalImpact = (problemType) => {
      const impacts = {
        'Plumbing Issue': {
          waterWaste: 'Leaks can waste 3,000+ gallons/year',
          ecoFriendly: 'Fix promptly to conserve water',
          greenOptions: 'Consider low-flow fixtures when replacing'
        },
        'Electrical Issue': {
          energyWaste: 'Faulty wiring can increase energy consumption 10-20%',
          ecoFriendly: 'Repair improves efficiency',
          greenOptions: 'Upgrade to smart switches and LED bulbs'
        },
        'Heating/Gas Issue': {
          carbonFootprint: 'Inefficient heating increases CO2 emissions',
          ecoFriendly: 'Regular maintenance improves efficiency 15-30%',
          greenOptions: 'Consider heat pump or smart thermostat'
        }
      };
      
      return impacts[problemType] || {
        general: 'Timely repairs prevent waste and improve efficiency',
        ecoFriendly: 'Choose sustainable materials when possible',
        greenOptions: 'Ask experts about eco-friendly alternatives'
      };
    };

    // Calculate AI-powered price estimation
    const calculateAIPrice = (description, isSameDay, expertHourlyRate = 45) => {
      const keywords = description.toLowerCase();
      
      let estimatedHours = 2;
      let complexity = 1.0;
      let partsMultiplier = 1.0;
      
      // Complexity analysis
      if (keywords.includes('emergency') || keywords.includes('urgent')) {
        complexity *= 1.3;
      }
      if (keywords.includes('extensive') || keywords.includes('major') || keywords.includes('multiple')) {
        estimatedHours = 4;
        complexity *= 1.2;
        partsMultiplier = 1.5;
      }
      if (keywords.includes('simple') || keywords.includes('quick') || keywords.includes('minor')) {
        estimatedHours = 1;
        complexity *= 0.9;
        partsMultiplier = 0.8;
      }
      if (keywords.includes('replace') || keywords.includes('new')) {
        partsMultiplier *= 1.3;
      }
      
      // Access difficulty
      if (keywords.includes('ceiling') || keywords.includes('roof') || keywords.includes('attic')) {
        complexity *= 1.15;
      }
      if (keywords.includes('floor') || keywords.includes('underground') || keywords.includes('basement')) {
        complexity *= 1.2;
      }
      
      const laborCost = expertHourlyRate * estimatedHours * complexity;
      const partsCost = 50 * partsMultiplier; // Base parts estimate
      const basePrice = laborCost + partsCost;
      
      // Apply same-day surge
      const finalPrice = isSameDay ? basePrice * APP_CONFIG.sameDayMultiplier : basePrice;
      
      // Platform fee
      const platformFee = finalPrice * (isSameDay ? APP_CONFIG.sameDayCommission : APP_CONFIG.platformCommission);
      
      return {
        estimated: `£${finalPrice.toFixed(2)}`,
        breakdown: {
          labor: `£${laborCost.toFixed(2)}`,
          parts: `£${partsCost.toFixed(2)}`,
          surge: isSameDay ? `£${(basePrice * 0.5).toFixed(2)}` : '£0',
          platformFee: `£${platformFee.toFixed(2)}`
        },
        hours: estimatedHours,
        confidence: complexity > 1.2 ? 'Low-Medium' : 'Medium-High',
        factors: {
          complexity: complexity.toFixed(2),
          urgency: isSameDay ? 'High' : 'Normal',
          partsNeeded: partsMultiplier > 1 ? 'Above average' : 'Standard'
        }
      };
    };

    // ============================================================================
    // CONTEXTS
    // ============================================================================
    
    const AuthContext = React.createContext();
    const ThemeContext = React.createContext();
    const NotificationContext = React.createContext();

    // ============================================================================
    // CUSTOM HOOKS
    // ============================================================================
    
    const useLocalStorage = (key, initialValue) => {
      // Note: This is for demo purposes. In production, use secure storage
      const [storedValue, setStoredValue] = React.useState(() => {
        try {
          const item = window.localStorage.getItem(key);
          return item ? JSON.parse(item) : initialValue;
        } catch (error) {
          console.error('LocalStorage error:', error);
          return initialValue;
        }
      });

      const setValue = (value) => {
        try {
          setStoredValue(value);
          window.localStorage.setItem(key, JSON.stringify(value));
        } catch (error) {
          console.error('LocalStorage error:', error);
        }
      };

      return [storedValue, setValue];
    };

    const useNotifications = () => {
      const [notifications, setNotifications] = React.useState([]);
      
      const addNotification = (notification) => {
        const newNotif = {
          id: Date.now(),
          ...notification,
          timestamp: new Date().toISOString()
        };
        setNotifications(prev => [newNotif, ...prev]);
        
        // Auto-remove after 5 seconds for non-persistent notifications
        if (!notification.persistent) {
          setTimeout(() => {
            removeNotification(newNotif.id);
          }, 5000);
        }
      };
      
      const removeNotification = (id) => {
        setNotifications(prev => prev.filter(n => n.id !== id));
      };
      
      const clearAll = () => {
        setNotifications([]);
      };
      
      return {
        notifications,
        addNotification,
        removeNotification,
        clearAll
      };
    };

    // ============================================================================
    // SHARED COMPONENTS
    // ============================================================================
    
    const LoadingSpinner = ({ size = 'medium', color = 'blue' }) => {
      const sizeClasses = {
        small: 'w-4 h-4',
        medium: 'w-8 h-8',
        large: 'w-12 h-12'
      };
      
      return (
        <div className={`${sizeClasses[size]} border-4 border-${color}-600 border-t-transparent rounded-full animate-spin`} />
      );
    };

    const EmptyState = ({ icon, title, description, action }) => {
      return (
        <div className="text-center py-12">
          <div className="text-6xl mb-4">{icon}</div>
          <h3 className="text-xl font-semibold mb-2">{title}</h3>
          <p className="text-gray-600 mb-4">{description}</p>
          {action}
        </div>
      );
    };

    const ProgressSteps = ({ steps, currentStep }) => {
      return (
        <div className="progress-steps mb-6">
          {steps.map((step, index) => (
            <div 
              key={index}
              className={`progress-step ${
                index < currentStep ? 'completed' : 
                index === currentStep ? 'active' : ''
              }`}
            >
              <div className="progress-step-circle">
                {index < currentStep ? '✓' : index + 1}
              </div>
              <div className="text-xs mt-1">{step}</div>
            </div>
          ))}
        </div>
      );
    };

    const StarRating = ({ rating, onRate, readonly = false }) => {
      const [hover, setHover] = React.useState(0);
      
      return (
        <div className="star-rating">
          {[1, 2, 3, 4, 5].map((star) => (
            <span
              key={star}
              className={`star ${star <= (hover || rating) ? 'filled' : ''}`}
              onClick={() => !readonly && onRate && onRate(star)}
              onMouseEnter={() => !readonly && setHover(star)}
              onMouseLeave={() => !readonly && setHover(0)}
              style={{ cursor: readonly ? 'default' : 'pointer' }}
            >
              ★
            </span>
          ))}
        </div>
      );
    };

    const NotificationBadge = ({ count }) => {
      if (count === 0) return null;
      
      return (
        <span className="notification-badge">
          {count > 9 ? '9+' : count}
        </span>
      );
    };

    const Modal = ({ isOpen, onClose, title, children }) => {
      if (!isOpen) return null;
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div className="flex justify-between items-center p-4 border-b">
              <h2 className="text-xl font-semibold">{title}</h2>
              <button
                onClick={onClose}
                className="text-gray-500 hover:text-gray-700 text-2xl"
              >
                ×
              </button>
            </div>
            <div className="p-4">
              {children}
            </div>
          </div>
        </div>
      );
    };

    const FileUploadZone = ({ onUpload, accept, multiple = false }) => {
      const [isDragging, setIsDragging] = React.useState(false);
      
      const handleDrop = (e) => {
        e.preventDefault();
        setIsDragging(false);
        
        const files = Array.from(e.dataTransfer.files);
        if (!multiple && files.length > 1) {
          alert('Only one file allowed');
          return;
        }
        
        onUpload(files);
      };
      
      const handleDragOver = (e) => {
        e.preventDefault();
        setIsDragging(true);
      };
      
      const handleDragLeave = () => {
        setIsDragging(false);
      };
      
      const handleClick = () => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = accept;
        input.multiple = multiple;
        input.onchange = (e) => {
          const files = Array.from(e.target.files);
          onUpload(files);
        };
        input.click();
      };
      
      return (
        <div
          className={`file-upload-zone ${isDragging ? 'drag-over' : ''}`}
          onDrop={handleDrop}
          onDragOver={handleDragOver}
          onDragLeave={handleDragLeave}
          onClick={handleClick}
        >
          <div className="text-4xl mb-2">📁</div>
          <p className="font-semibold mb-1">Drop files here or click to upload</p>
          <p className="text-sm text-gray-500">
            {accept ? `Accepted formats: ${accept}` : 'All files accepted'}
          </p>
        </div>
      );
    };

    // ============================================================================
    // MAIN APPLICATION COMPONENTS
    // ============================================================================
    
    const WelcomePage = ({ onGetStarted, onLoginExpert }) => {
      analytics.trackPageView('welcome');
      
      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50">
          <div className="safe-area-top">
            <div className="container mx-auto px-4 py-8">
              <div className="text-center mb-12">
                <div className="text-6xl mb-4 float-animation">🔧</div>
                <h1 className="text-5xl font-bold mb-4">DIYMatch</h1>
                <p className="text-xl text-gray-600">AI-Powered DIY Assistant & Expert Network</p>
              </div>

              <div className="bg-white rounded-2xl shadow-xl p-8 max-w-4xl mx-auto mb-8">
                <h2 className="text-3xl font-bold text-center mb-8">Fix It Right, Every Time</h2>
                
                <div className="grid md:grid-cols-3 gap-8 mb-8">
                  <div className="text-center">
                    <div className="text-5xl mb-4">📸</div>
                    <h3 className="text-xl font-semibold mb-2">AI Analysis</h3>
                    <p className="text-gray-600">Snap a photo and get instant expert analysis</p>
                  </div>
                  <div className="text-center">
                    <div className="text-5xl mb-4">👨‍🔧</div>
                    <h3 className="text-xl font-semibold mb-2">Expert Network</h3>
                    <p className="text-gray-600">Connect with verified local professionals</p>
                  </div>
                  <div className="text-center">
                    <div className="text-5xl mb-4">🛠️</div>
                    <h3 className="text-xl font-semibold mb-2">DIY Guidance</h3>
                    <p className="text-gray-600">Step-by-step instructions and safety tips</p>
                  </div>
                </div>

                <div className="flex flex-col sm:flex-row gap-4 justify-center">
                  <button
                    onClick={onGetStarted}
                    className="mobile-touch bg-blue-600 text-white px-8 py-4 rounded-full text-lg font-semibold hover:bg-blue-700 transition-all transform hover:scale-105"
                  >
                    🚀 Get Started
                  </button>
                  <button
                    onClick={onLoginExpert}
                    className="mobile-touch bg-green-600 text-white px-8 py-4 rounded-full text-lg font-semibold hover:bg-green-700 transition-all transform hover:scale-105"
                  >
                    👨‍🔧 Expert Login
                  </button>
                </div>
              </div>

              <div className="bg-yellow-50 rounded-2xl p-6 max-w-4xl mx-auto">
                <h3 className="text-xl font-semibold mb-4 flex items-center justify-center">
                  <span className="text-2xl mr-2">🆓</span>
                  First AI Analysis FREE Every Month!
                </h3>
                <p className="text-center text-gray-700">
                  New users get their first problem analysis completely free. 
                  Additional analyses only £{APP_CONFIG.aiAnalysisPrice}.
                </p>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const UserDashboard = ({ user, onLogout }) => {
      const [activeTab, setActiveTab] = React.useState('home');
      const [analysisHistory, setAnalysisHistory] = React.useState([]);
      const [notifications, setNotifications] = React.useState([]);
      const [savedExperts, setSavedExperts] = React.useState([]);
      const { addNotification } = useNotifications();
      
      React.useEffect(() => {
        // Load user data
        const userAnalyses = aiAnalysisHistory.get(user.email) || [];
        setAnalysisHistory(userAnalyses);
        
        const userNotifs = userNotifications.get(user.email) || [];
        setNotifications(userNotifs);
        
        setSavedExperts(user.savedExperts || []);
        
        analytics.trackPageView('user_dashboard');
      }, [user]);
      
      const handleNewAnalysis = async () => {
        const freeAvailable = checkFreeAnalysisAvailable(user.email);
        
        if (!freeAvailable && !confirm(`This will cost £${APP_CONFIG.aiAnalysisPrice}. Continue?`)) {
          return;
        }
        
        setActiveTab('analyze');
      };
      
      const renderHomeTab = () => (
        <div className="space-y-6">
          <div className="bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl p-6 text-white">
            <h2 className="text-2xl font-bold mb-2">Welcome back, {user.name}!</h2>
            <p className="mb-4">Your referral code: <span className="font-mono bg-white/20 px-2 py-1 rounded">{user.referralCode}</span></p>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <div className="text-3xl font-bold">{user.analysisCount || 0}</div>
                <div className="text-sm opacity-80">Analyses Done</div>
              </div>
              <div>
                <div className="text-3xl font-bold">£{user.totalSpent || 0}</div>
                <div className="text-sm opacity-80">Total Saved</div>
              </div>
            </div>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button
              onClick={handleNewAnalysis}
              className="mobile-touch bg-blue-600 text-white p-6 rounded-xl hover:bg-blue-700 transition-all"
            >
              <div className="text-3xl mb-2">📸</div>
              <div className="font-semibold">New Analysis</div>
              <div className="text-sm opacity-80">
                {checkFreeAnalysisAvailable(user.email) ? 'FREE this month!' : `£${APP_CONFIG.aiAnalysisPrice}`}
              </div>
            </button>
            
            <button
              onClick={() => setActiveTab('experts')}
              className="mobile-touch bg-green-600 text-white p-6 rounded-xl hover:bg-green-700 transition-all"
            >
              <div className="text-3xl mb-2">👨‍🔧</div>
              <div className="font-semibold">Find Experts</div>
              <div className="text-sm opacity-80">Verified professionals</div>
            </button>
            
            <button
              onClick={() => setActiveTab('emergency')}
              className="mobile-touch emergency-button text-white p-6 rounded-xl hover:opacity-90 transition-all"
            >
              <div className="text-3xl mb-2">🚨</div>
              <div className="font-semibold">Emergency Help</div>
              <div className="text-sm opacity-80">24/7 urgent assistance</div>
            </button>
            
            <button
              onClick={() => setActiveTab('parts')}
              className="mobile-touch bg-purple-600 text-white p-6 rounded-xl hover:bg-purple-700 transition-all"
            >
              <div className="text-3xl mb-2">🛠️</div>
              <div className="font-semibold">Find Parts</div>
              <div className="text-sm opacity-80">Nearby stores</div>
            </button>
          </div>
          
          {analysisHistory.length > 0 && (
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h3 className="text-xl font-semibold mb-4">Recent Analyses</h3>
              <div className="space-y-3">
                {analysisHistory.slice(0, 3).map((analysis, index) => (
                  <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                      <div className="font-medium">{analysis.problemDetected}</div>
                      <div className="text-sm text-gray-600">{new Date(analysis.timestamp).toLocaleDateString()}</div>
                    </div>
                    <div className={`px-3 py-1 rounded-full text-sm ${
                      analysis.severity === 'Critical' ? 'bg-red-100 text-red-800' :
                      analysis.severity === 'High' ? 'bg-orange-100 text-orange-800' :
                      analysis.severity === 'Medium' ? 'bg-yellow-100 text-yellow-800' :
                      'bg-green-100 text-green-800'
                    }`}>
                      {analysis.severity}
                    </div>
                  </div>
                ))}
              </div>
              <button
                onClick={() => setActiveTab('history')}
                className="mt-4 text-blue-600 hover:text-blue-800 font-medium"
              >
                View All History →
              </button>
            </div>
          )}
        </div>
      );
      
      const renderAnalyzeTab = () => <AIAnalysisPage user={user} />;
      
      const renderExpertsTab = () => <ExpertSearchPage user={user} />;
      
      const renderEmergencyTab = () => <EmergencyHelpPage user={user} />;
      
      const renderPartsTab = () => <PartsFinderPage user={user} />;
      
      const renderHistoryTab = () => (
        <div className="space-y-4">
          <h2 className="text-2xl font-bold mb-4">Analysis History</h2>
          {analysisHistory.length === 0 ? (
            <EmptyState
              icon="📋"
              title="No analyses yet"
              description="Start by taking a photo of your DIY problem"
              action={
                <button
                  onClick={() => setActiveTab('analyze')}
                  className="bg-blue-600 text-white px-6 py-2 rounded-lg"
                >
                  Start Analysis
                </button>
              }
            />
          ) : (
            analysisHistory.map((analysis, index) => (
              <div key={index} className="bg-white rounded-lg shadow-md p-6">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <h3 className="text-lg font-semibold">{analysis.problemDetected}</h3>
                    <p className="text-gray-600">{new Date(analysis.timestamp).toLocaleString()}</p>
                  </div>
                  <div className={`px-3 py-1 rounded-full text-sm ${
                    analysis.severity === 'Critical' ? 'bg-red-100 text-red-800' :
                    analysis.severity === 'High' ? 'bg-orange-100 text-orange-800' :
                    analysis.severity === 'Medium' ? 'bg-yellow-100 text-yellow-800' :
                    'bg-green-100 text-green-800'
                  }`}>
                    {analysis.severity}
                  </div>
                </div>
                <p className="text-gray-700 mb-3">{analysis.description}</p>
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <div>
                    <span className="font-medium">Estimated Cost:</span> {analysis.estimatedCost}
                  </div>
                  <div>
                    <span className="font-medium">DIY Friendly:</span> {analysis.isDIYFriendly ? 'Yes' : 'No'}
                  </div>
                </div>
                <button
                  onClick={() => {
                    // View full analysis
                    alert('Full analysis view coming soon!');
                  }}
                  className="mt-4 text-blue-600 hover:text-blue-800 font-medium"
                >
                  View Full Analysis →
                </button>
              </div>
            ))
          )}
        </div>
      );
      
      const renderProfileTab = () => <UserProfilePage user={user} />;
      
      return (
        <div className="min-h-screen bg-gray-50">
          <div className="safe-area-top bg-white shadow-sm">
            <div className="container mx-auto px-4 py-4">
              <div className="flex justify-between items-center">
                <h1 className="text-2xl font-bold flex items-center">
                  <span className="text-3xl mr-2">🔧</span> DIYMatch
                </h1>
                <div className="flex items-center gap-4">
                  <div className="relative">
                    <button className="text-2xl">🔔</button>
                    <NotificationBadge count={notifications.filter(n => !n.read).length} />
                  </div>
                  <button
                    onClick={onLogout}
                    className="text-gray-600 hover:text-gray-800"
                  >
                    Logout
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div className="container mx-auto px-4 py-6 pb-20">
            {activeTab === 'home' && renderHomeTab()}
            {activeTab === 'analyze' && renderAnalyzeTab()}
            {activeTab === 'experts' && renderExpertsTab()}
            {activeTab === 'emergency' && renderEmergencyTab()}
            {activeTab === 'parts' && renderPartsTab()}
            {activeTab === 'history' && renderHistoryTab()}
            {activeTab === 'profile' && renderProfileTab()}
          </div>
          
          <div className="bottom-nav safe-area-bottom">
            <button
              onClick={() => setActiveTab('home')}
              className={`bottom-nav-item ${activeTab === 'home' ? 'active' : ''}`}
            >
              <div className="bottom-nav-icon">🏠</div>
              <span>Home</span>
            </button>
            <button
              onClick={() => setActiveTab('analyze')}
              className={`bottom-nav-item ${activeTab === 'analyze' ? 'active' : ''}`}
            >
              <div className="bottom-nav-icon">📸</div>
              <span>Analyze</span>
            </button>
            <button
              onClick={() => setActiveTab('experts')}
              className={`bottom-nav-item ${activeTab === 'experts' ? 'active' : ''}`}
            >
              <div className="bottom-nav-icon">👨‍🔧</div>
              <span>Experts</span>
            </button>
            <button
              onClick={() => setActiveTab('history')}
              className={`bottom-nav-item ${activeTab === 'history' ? 'active' : ''}`}
            >
              <div className="bottom-nav-icon">📋</div>
              <span>History</span>
            </button>
            <button
              onClick={() => setActiveTab('profile')}
              className={`bottom-nav-item ${activeTab === 'profile' ? 'active' : ''}`}
            >
              <div className="bottom-nav-icon">👤</div>
              <span>Profile</span>
            </button>
          </div>
        </div>
      );
    };

    const AIAnalysisPage = ({ user }) => {
      const [step, setStep] = React.useState(1);
      const [media, setMedia] = React.useState(null);
      const [description, setDescription] = React.useState('');
      const [analyzing, setAnalyzing] = React.useState(false);
      const [progress, setProgress] = React.useState(0);
      const [progressMessage, setProgressMessage] = React.useState('');
      const [analysis, setAnalysis] = React.useState(null);
      const [selectedExpert, setSelectedExpert] = React.useState(null);
      
      const handleMediaCapture = async (type) => {
        try {
          let capturedMedia;
          if (type === 'photo') {
            capturedMedia = await takePhoto();
          } else if (type === 'video') {
            capturedMedia = await takeVideo();
          } else if (type === 'voice') {
            capturedMedia = await recordVoiceNote();
          }
          
          if (capturedMedia) {
            setMedia(capturedMedia);
            setStep(2);
            triggerHaptic('success');
          }
        } catch (error) {
          console.error('Media capture error:', error);
          alert('Failed to capture media. Please try again.');
        }
      };
      
      const handleAnalysis = async () => {
        if (!media || !description.trim()) {
          alert('Please provide both media and description');
          return;
        }
        
        setAnalyzing(true);
        setStep(3);
        
        try {
          const analysisResult = await performAIAnalysis(
            media,
            description,
            (prog, msg) => {
              setProgress(prog);
              setProgressMessage(msg);
            }
          );
          
          // Check if free analysis is available
          const isFree = checkFreeAnalysisAvailable(user.email);
          
          if (!isFree) {
            // Process payment
            const paymentResult = await processPayment(
              APP_CONFIG.aiAnalysisPrice,
              { type: 'ai_analysis', userId: user.id }
            );
            
            if (!paymentResult.success) {
              throw new Error('Payment failed');
            }
            
            userAnalysisPurchases.set(user.email, [
              ...(userAnalysisPurchases.get(user.email) || []),
              { timestamp: new Date().toISOString(), amount: APP_CONFIG.aiAnalysisPrice }
            ]);
          } else {
            useFreeAnalysis(user.email);
          }
          
          // Save analysis
          const savedAnalysis = {
            ...analysisResult,
            userEmail: user.email,
            media: media,
            description: description
          };
          
          await dbOperations.saveAnalysis(savedAnalysis);
          
          setAnalysis(analysisResult);
          setStep(4);
          triggerHaptic('success');
        } catch (error) {
          console.error('Analysis error:', error);
          alert('Analysis failed. Please try again.');
          setStep(2);
        } finally {
          setAnalyzing(false);
        }
      };
      
      const renderStep1 = () => (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold text-center">Capture Your Problem</h2>
          <p className="text-center text-gray-600">Choose how you'd like to show us the issue</p>
          
          <div className="grid grid-cols-1 gap-4">
            <button
              onClick={() => handleMediaCapture('photo')}
              className="mobile-touch bg-blue-600 text-white p-6 rounded-xl hover:bg-blue-700 transition-all flex items-center justify-between"
            >
              <div className="flex items-center">
                <div className="text-3xl mr-4">📸</div>
                <div className="text-left">
                  <div className="font-semibold">Take Photo</div>
                  <div className="text-sm opacity-80">Best for most issues</div>
                </div>
              </div>
              <div className="text-2xl">→</div>
            </button>
            
            <button
              onClick={() => handleMediaCapture('video')}
              className="mobile-touch bg-purple-600 text-white p-6 rounded-xl hover:bg-purple-700 transition-all flex items-center justify-between"
            >
              <div className="flex items-center">
                <div className="text-3xl mr-4">🎥</div>
                <div className="text-left">
                  <div className="font-semibold">Record Video</div>
                  <div className="text-sm opacity-80">For complex or intermittent issues</div>
                </div>
              </div>
              <div className="text-2xl">→</div>
            </button>
            
            <button
              onClick={() => handleMediaCapture('voice')}
              className="mobile-touch bg-green-600 text-white p-6 rounded-xl hover:bg-green-700 transition-all flex items-center justify-between"
            >
              <div className="flex items-center">
                <div className="text-3xl mr-4">🎤</div>
                <div className="text-left">
                  <div className="font-semibold">Voice Note</div>
                  <div className="text-sm opacity-80">Describe the problem verbally</div>
                </div>
              </div>
              <div className="text-2xl">→</div>
            </button>
          </div>
          
          <div className="text-center">
            <button
              onClick={() => setStep(0)}
              className="text-gray-600 hover:text-gray-800"
            >
              ← Back
            </button>
          </div>
        </div>
      );
      
      const renderStep2 = () => (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold text-center">Describe the Problem</h2>
          
          {media && (
            <div className="bg-gray-100 rounded-lg p-4">
              {media.type === 'image' && (
                <img src={media.data} alt="Problem" className="w-full rounded-lg" />
              )}
              {media.type === 'video' && (
                <video src={media.data} controls className="w-full rounded-lg" />
              )}
              {media.type === 'voice' && (
                <div className="text-center py-8">
                  <div className="text-4xl mb-2">🎤</div>
                  <p>Voice note recorded ({media.duration}s)</p>
                </div>
              )}
            </div>
          )}
          
          <div>
            <label className="block text-sm font-medium mb-2">
              Tell us more about the problem:
            </label>
            <textarea
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              className="w-full p-3 border rounded-lg resize-none"
              rows="4"
              placeholder="E.g., Leaking pipe under kitchen sink, started yesterday after heavy rain..."
            />
          </div>
          
          <div className="bg-yellow-50 p-4 rounded-lg">
            <p className="text-sm">
              <strong>Tip:</strong> Include details like when it started, any unusual sounds/smells, 
              and what you've already tried.
            </p>
          </div>
          
          <div className="flex gap-4">
            <button
              onClick={() => setStep(1)}
              className="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold"
            >
              ← Back
            </button>
            <button
              onClick={handleAnalysis}
              disabled={!description.trim()}
              className={`flex-1 py-3 rounded-lg font-semibold ${
                description.trim()
                  ? 'bg-blue-600 text-white hover:bg-blue-700'
                  : 'bg-gray-300 text-gray-500 cursor-not-allowed'
              }`}
            >
              Analyze →
            </button>
          </div>
        </div>
      );
      
      const renderStep3 = () => (
        <div className="space-y-6 text-center">
          <h2 className="text-2xl font-bold">AI Analysis in Progress</h2>
          
          <div className="relative w-32 h-32 mx-auto">
            <div className="absolute inset-0 bg-blue-200 rounded-full animate-ping"></div>
            <div className="relative bg-blue-600 rounded-full w-32 h-32 flex items-center justify-center text-white text-5xl">
              🤖
            </div>
          </div>
          
          <div className="space-y-2">
            <div className="text-lg font-medium">{progressMessage}</div>
            <div className="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
              <div 
                className="analysis-progress h-full transition-all duration-300"
                style={{ width: `${progress}%` }}
              />
            </div>
            <div className="text-sm text-gray-600">{progress}% Complete</div>
          </div>
          
          <p className="text-gray-600">
            Our AI is analyzing your problem using advanced pattern recognition...
          </p>
        </div>
      );
      
      const renderStep4 = () => (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold text-center">Analysis Complete!</h2>
          
          {analysis && (
            <div className="bg-white rounded-lg shadow-lg p-6 space-y-4">
              <div className="flex justify-between items-start">
                <div>
                  <h3 className="text-xl font-semibold">{analysis.problemDetected}</h3>
                  <p className="text-gray-600">Confidence: {analysis.confidence}</p>
                </div>
                <div className={`px-3 py-1 rounded-full text-sm ${
                  analysis.severity === 'Critical' ? 'bg-red-100 text-red-800' :
                  analysis.severity === 'High' ? 'bg-orange-100 text-orange-800' :
                  analysis.severity === 'Medium' ? 'bg-yellow-100 text-yellow-800' :
                  'bg-green-100 text-green-800'
                }`}>
                  {analysis.severity} Severity
                </div>
              </div>
              
              <p className="text-gray-700">{analysis.description}</p>
              
              <div className="grid grid-cols-2 gap-4">
                <div className="bg-gray-50 p-3 rounded-lg">
                  <div className="text-sm text-gray-600">Estimated Cost</div>
                  <div className="font-semibold">{analysis.estimatedCost}</div>
                </div>
                <div className="bg-gray-50 p-3 rounded-lg">
                  <div className="text-sm text-gray-600">Time to Fix</div>
                  <div className="font-semibold">{analysis.timeToFix}</div>
                </div>
              </div>
              
              {analysis.safetyWarnings && analysis.safetyWarnings.length > 0 && (
                <div className="bg-red-50 p-4 rounded-lg">
                  <h4 className="font-semibold text-red-800 mb-2">⚠️ Safety Warnings</h4>
                  <ul className="space-y-1">
                    {analysis.safetyWarnings.map((warning, index) => (
                      <li key={index} className="text-sm text-red-700">{warning}</li>
                    ))}
                  </ul>
                </div>
              )}
              
              {analysis.isDIYFriendly ? (
                <div className="bg-green-50 p-4 rounded-lg">
                  <h4 className="font-semibold text-green-800 mb-2">✅ DIY Friendly!</h4>
                  <p className="text-sm text-green-700">
                    This issue can be safely handled as a DIY project with proper precautions.
                  </p>
                </div>
              ) : (
                <div className="bg-orange-50 p-4 rounded-lg">
                  <h4 className="font-semibold text-orange-800 mb-2">👨‍🔧 Professional Required</h4>
                  <p className="text-sm text-orange-700">
                    This issue requires professional expertise. We recommend hiring a {analysis.recommendedExpertType}.
                  </p>
                </div>
              )}
              
              <div className="flex flex-col gap-3">
                {analysis.isDIYFriendly && (
                  <button
                    onClick={() => {
                      // Show DIY guide
                      alert('DIY Guide coming soon!');
                    }}
                    className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700"
                  >
                    View DIY Guide →
                  </button>
                )}
                
                <button
                  onClick={() => {
                    // Find experts
                    alert('Expert search coming soon!');
                  }}
                  className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700"
                >
                  Find {analysis.recommendedExpertType} →
                </button>
                
                <button
                  onClick={() => {
                    // Find parts
                    alert('Parts finder coming soon!');
                  }}
                  className="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700"
                >
                  Find Parts & Tools →
                </button>
              </div>
            </div>
          )}
          
          <button
            onClick={() => {
              setStep(1);
              setMedia(null);
              setDescription('');
              setAnalysis(null);
            }}
            className="w-full bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold"
          >
            Start New Analysis
          </button>
        </div>
      );
      
      return (
        <div className="max-w-2xl mx-auto">
          <ProgressSteps
            steps={['Capture', 'Describe', 'Analyze', 'Results']}
            currentStep={step - 1}
          />
          
          {step === 1 && renderStep1()}
          {step === 2 && renderStep2()}
          {step === 3 && renderStep3()}
          {step === 4 && renderStep4()}
        </div>
      );
    };

    const ExpertSearchPage = ({ user }) => {
      const [searchTerm, setSearchTerm] = React.useState('');
      const [selectedCategory, setSelectedCategory] = React.useState('all');
      const [sortBy, setSortBy] = React.useState('rating');
      const [experts, setExperts] = React.useState([]);
      
      React.useEffect(() => {
        // Load and filter experts
        let filteredExperts = Array.from(expertProfiles.values());
        
        if (selectedCategory !== 'all') {
          filteredExperts = filteredExperts.filter(expert =>
            expert.profession.toLowerCase().includes(selectedCategory.toLowerCase()) ||
            expert.specialties.some(s => s.toLowerCase().includes(selectedCategory.toLowerCase()))
          );
        }
        
        if (searchTerm) {
          filteredExperts = filteredExperts.filter(expert =>
            expert.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            expert.profession.toLowerCase().includes(searchTerm.toLowerCase()) ||
            expert.bio.toLowerCase().includes(searchTerm.toLowerCase())
          );
        }
        
        // Sort experts
        filteredExperts.sort((a, b) => {
          switch (sortBy) {
            case 'rating':
              return parseFloat(b.rating) - parseFloat(a.rating);
            case 'price':
              return a.hourlyRate - b.hourlyRate;
            case 'distance':
              return parseFloat(a.distance || '999') - parseFloat(b.distance || '999');
            case 'reviews':
              return b.reviews - a.reviews;
            default:
              return 0;
          }
        });
        
        setExperts(filteredExperts);
      }, [searchTerm, selectedCategory, sortBy]);
      
      return (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold">Find Expert Help</h2>
          
          <div className="bg-white rounded-lg shadow-md p-4 space-y-4">
            <input
              type="text"
              placeholder="Search experts..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full p-3 border rounded-lg"
            />
            
            <div className="flex gap-2 overflow-x-auto pb-2">
              {['all', 'plumber', 'electrician', 'handyman', 'carpenter', 'painter'].map(cat => (
                <button
                  key={cat}
                  onClick={() => setSelectedCategory(cat)}
                  className={`px-4 py-2 rounded-full whitespace-nowrap ${
                    selectedCategory === cat
                      ? 'bg-blue-600 text-white'
                      : 'bg-gray-200 text-gray-700'
                  }`}
                >
                  {cat.charAt(0).toUpperCase() + cat.slice(1)}
                </button>
              ))}
            </div>
            
            <div className="flex justify-between items-center">
              <span className="text-sm text-gray-600">{experts.length} experts found</span>
              <select
                value={sortBy}
                onChange={(e) => setSortBy(e.target.value)}
                className="px-3 py-1 border rounded-lg text-sm"
              >
                <option value="rating">Highest Rated</option>
                <option value="price">Lowest Price</option>
                <option value="distance">Nearest</option>
                <option value="reviews">Most Reviews</option>
              </select>
            </div>
          </div>
          
          <div className="space-y-4">
            {experts.map(expert => (
              <ExpertCard key={expert.id} expert={expert} user={user} />
            ))}
          </div>
          
          {experts.length === 0 && (
            <EmptyState
              icon="🔍"
              title="No experts found"
              description="Try adjusting your search or filters"
            />
          )}
        </div>
      );
    };

    const ExpertCard = ({ expert, user }) => {
      const [showContact, setShowContact] = React.useState(false);
      
      const handleContactExpert = () => {
        triggerHaptic('light');
        setShowContact(true);
      };
      
      return (
        <div className="bg-white rounded-lg shadow-md p-6">
          <div className="flex justify-between items-start mb-4">
            <div className="flex-1">
              <div className="flex items-center gap-2 mb-1">
                <h3 className="text-lg font-semibold">{expert.name}</h3>
                {expert.verified && <span className="text-blue-600">✓</span>}
                {expert.badges.map((badge, i) => (
                  <span key={i} className="text-xs bg-gray-100 px-2 py-1 rounded">
                    {badge}
                  </span>
                ))}
              </div>
              <p className="text-gray-600">{expert.profession}</p>
              <p className="text-sm text-gray-500">{expert.location}</p>
            </div>
            <div className="text-right">
              <div className="flex items-center gap-1 mb-1">
                <StarRating rating={parseFloat(expert.rating)} readonly />
                <span className="font-semibold">{expert.rating}</span>
              </div>
              <p className="text-sm text-gray-600">({expert.reviews} reviews)</p>
            </div>
          </div>
          
          <p className="text-gray-700 mb-4 line-clamp-2">{expert.bio}</p>
          
          <div className="grid grid-cols-2 gap-4 mb-4 text-sm">
            <div>
              <span className="text-gray-600">Hourly Rate:</span>
              <span className="font-semibold ml-1">£{expert.hourlyRate}</span>
            </div>
            <div>
              <span className="text-gray-600">Response:</span>
              <span className="font-semibold ml-1">{expert.responseTime}</span>
            </div>
            <div>
              <span className="text-gray-600">Jobs Done:</span>
              <span className="font-semibold ml-1">{expert.completedJobs}</span>
            </div>
            <div>
              <span className="text-gray-600">Available:</span>
              <span className="font-semibold ml-1">
                {expert.availability.includes('Emergency 24/7') ? '24/7' : 'Standard'}
              </span>
            </div>
          </div>
          
          <div className="flex gap-2">
            <button
              onClick={handleContactExpert}
              className="flex-1 bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700"
            >
              Contact Expert
            </button>
            <button
              onClick={() => {
                // View profile
                alert('Expert profile view coming soon!');
              }}
              className="flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg font-semibold hover:bg-gray-300"
            >
              View Profile
            </button>
          </div>
          
          <Modal
            isOpen={showContact}
            onClose={() => setShowContact(false)}
            title={`Contact ${expert.name}`}
          >
            <div className="space-y-4">
              <div className="bg-blue-50 p-4 rounded-lg">
                <p className="text-sm">
                  <strong>Phone:</strong> {expert.phone}<br />
                  <strong>Email:</strong> {expert.email}
                </p>
              </div>
              <button
                onClick={() => {
                  window.location.href = `tel:${expert.phone}`;
                }}
                className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold"
              >
                📞 Call Now
              </button>
              <button
                onClick={() => {
                  // Send message
                  alert('Messaging coming soon!');
                }}
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold"
              >
                💬 Send Message
              </button>
              <button
                onClick={() => {
                  // Request quote
                  alert('Quote request coming soon!');
                }}
                className="w-full bg-purple-600 text-white py-3 rounded-lg font-semibold"
              >
                📝 Request Quote
              </button>
            </div>
          </Modal>
        </div>
      );
    };

    const EmergencyHelpPage = ({ user }) => {
      const [emergencyType, setEmergencyType] = React.useState('');
      const [description, setDescription] = React.useState('');
      const [requesting, setRequesting] = React.useState(false);
      
      const emergencyTypes = [
        { id: 'flooding', icon: '🌊', label: 'Flooding/Water', color: 'blue' },
        { id: 'electrical', icon: '⚡', label: 'Electrical', color: 'yellow' },
        { id: 'gas', icon: '🔥', label: 'Gas/Heating', color: 'orange' },
        { id: 'structural', icon: '🏚️', label: 'Structural', color: 'red' },
        { id: 'security', icon: '🔒', label: 'Security', color: 'purple' },
        { id: 'other', icon: '⚠️', label: 'Other', color: 'gray' }
      ];
      
      const handleEmergencyRequest = async () => {
        if (!emergencyType || !description.trim()) {
          alert('Please select emergency type and describe the issue');
          return;
        }
        
        setRequesting(true);
        triggerHaptic('heavy');
        
        try {
          const location = await getUserLocation();
          
          const emergencyRequest = await dbOperations.createEmergencyRequest({
            userEmail: user.email,
            category: emergencyType,
            description: description,
            location: location,
            urgency: 'immediate'
          });
          
          alert(`Emergency request sent! ${emergencyRequest.notifiedExperts} experts have been notified.`);
          
          // Reset form
          setEmergencyType('');
          setDescription('');
        } catch (error) {
          console.error('Emergency request error:', error);
          alert('Failed to send emergency request. Please call emergency services.');
        } finally {
          setRequesting(false);
        }
      };
      
      return (
        <div className="space-y-6">
          <div className="bg-red-600 text-white rounded-lg p-6 text-center">
            <h2 className="text-2xl font-bold mb-2">🚨 Emergency Help</h2>
            <p>For life-threatening emergencies, call 999 immediately</p>
            <a
              href="tel:999"
              className="inline-block mt-4 bg-white text-red-600 px-6 py-3 rounded-lg font-semibold"
            >
              📞 Call 999
            </a>
          </div>
          
          <div className="bg-white rounded-lg shadow-md p-6">
            <h3 className="text-xl font-semibold mb-4">DIY Emergency Support</h3>
            <p className="text-gray-600 mb-6">
              Select your emergency type and we'll connect you with available experts immediately
            </p>
            
            <div className="grid grid-cols-2 gap-3 mb-6">
              {emergencyTypes.map(type => (
                <button
                  key={type.id}
                  onClick={() => setEmergencyType(type.id)}
                  className={`p-4 rounded-lg border-2 transition-all ${
                    emergencyType === type.id
                      ? 'border-red-600 bg-red-50'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                >
                  <div className="text-3xl mb-1">{type.icon}</div>
                  <div className="text-sm font-medium">{type.label}</div>
                </button>
              ))}
            </div>
            
            <textarea
              value={description}
              onChange={(e) => setDescription(e.target.value)}
              placeholder="Describe your emergency... Include any immediate dangers"
              className="w-full p-3 border rounded-lg resize-none mb-4"
              rows="4"
            />
            
            <button
              onClick={handleEmergencyRequest}
              disabled={requesting || !emergencyType || !description.trim()}
              className={`w-full py-3 rounded-lg font-semibold ${
                requesting || !emergencyType || !description.trim()
                  ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  : 'bg-red-600 text-white hover:bg-red-700'
              }`}
            >
              {requesting ? 'Sending Emergency Request...' : 'Send Emergency Request'}
            </button>
          </div>
          
          <div className="bg-yellow-50 rounded-lg p-4">
            <h4 className="font-semibold mb-2">Emergency Contacts</h4>
            <ul className="space-y-2 text-sm">
              <li>🔥 Gas Emergency: <a href="tel:0800111999" className="text-blue-600">0800 111 999</a></li>
              <li>💡 Power Cut: <a href="tel:105" className="text-blue-600">105</a></li>
              <li>💧 Water Emergency: Check your supplier</li>
              <li>🏠 Building Emergency: Contact your council</li>
            </ul>
          </div>
        </div>
      );
    };

    const PartsFinderPage = ({ user }) => {
      const [searchTerm, setSearchTerm] = React.useState('');
      const [selectedCategory, setSelectedCategory] = React.useState('all');
      const [stores, setStores] = React.useState([]);
      const [recommendedParts, setRecommendedParts] = React.useState([]);
      
      React.useEffect(() => {
        // Load stores for user's location
        const userStores = partsStores.get('london') || [];
        setStores(userStores);
        
        // Get recommended parts from recent analyses
        const userAnalyses = aiAnalysisHistory.get(user.email) || [];
        if (userAnalyses.length > 0) {
          const latestAnalysis = userAnalyses[userAnalyses.length - 1];
          setRecommendedParts(latestAnalysis.recommendedParts || []);
        }
      }, [user]);
      
      return (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold">Find Parts & Tools</h2>
          
          {recommendedParts.length > 0 && (
            <div className="bg-blue-50 rounded-lg p-4">
              <h3 className="font-semibold mb-3">🎯 Recommended for your recent issue:</h3>
              <div className="grid grid-cols-2 gap-3">
                {recommendedParts.slice(0, 4).map((part, index) => (
                  <div key={index} className="bg-white p-3 rounded-lg">
                    <div className="font-medium text-sm">{part.name}</div>
                    <div className="text-blue-600 font-semibold">{part.price}</div>
                    <div className="text-xs text-gray-600">{part.priority}</div>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          <div className="bg-white rounded-lg shadow-md p-4">
            <input
              type="text"
              placeholder="Search for parts..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full p-3 border rounded-lg mb-4"
            />
            
            <div className="flex gap-2 overflow-x-auto pb-2">
              {['all', 'plumbing', 'electrical', 'tools', 'paint', 'building'].map(cat => (
                <button
                  key={cat}
                  onClick={() => setSelectedCategory(cat)}
                  className={`px-4 py-2 rounded-full whitespace-nowrap ${
                    selectedCategory === cat
                      ? 'bg-purple-600 text-white'
                      : 'bg-gray-200 text-gray-700'
                  }`}
                >
                  {cat.charAt(0).toUpperCase() + cat.slice(1)}
                </button>
              ))}
            </div>
          </div>
          
          <div className="space-y-4">
            <h3 className="text-lg font-semibold">Nearby Stores</h3>
            {stores.map(store => (
              <div key={store.id} className="bg-white rounded-lg shadow-md p-4">
                <div className="flex justify-between items-start mb-2">
                  <div>
                    <h4 className="font-semibold">{store.name}</h4>
                    <p className="text-sm text-gray-600">{store.address}</p>
                    <p className="text-sm text-blue-600">{store.distance}</p>
                  </div>
                  <div className="text-right">
                    <p className="text-sm font-medium">{store.openHours.split(',')[0]}</p>
                    <p className="text-xs text-gray-600">{store.inStockItems} items</p>
                  </div>
                </div>
                
                <div className="flex gap-2 text-xs mb-3">
                  {store.categories.slice(0, 3).map((cat, i) => (
                    <span key={i} className="bg-gray-100 px-2 py-1 rounded">
                      {cat}
                    </span>
                  ))}
                  {store.hasParking && <span className="bg-green-100 text-green-800 px-2 py-1 rounded">🚗 Parking</span>}
                </div>
                
                <div className="flex gap-2">
                  <button
                    onClick={() => window.location.href = `tel:${store.phone}`}
                    className="flex-1 bg-green-600 text-white py-2 rounded-lg text-sm font-semibold"
                  >
                    📞 Call
                  </button>
                  <button
                    onClick={() => {
                      // Open maps
                      window.open(`https://maps.google.com/?q=${encodeURIComponent(store.address)}`);
                    }}
                    className="flex-1 bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold"
                  >
                    📍 Directions
                  </button>
                  <button
                    onClick={() => {
                      // Check stock
                      alert('Stock check coming soon!');
                    }}
                    className="flex-1 bg-purple-600 text-white py-2 rounded-lg text-sm font-semibold"
                  >
                    📦 Stock
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    };

    const UserProfilePage = ({ user }) => {
      const [editMode, setEditMode] = React.useState(false);
      const [formData, setFormData] = React.useState({
        name: user.name,
        email: user.email,
        phone: user.phone || '',
        postcode: user.postcode || ''
      });
      
      const handleSave = async () => {
        await dbOperations.updateUser(user.email, formData);
        setEditMode(false);
        alert('Profile updated!');
      };
      
      return (
        <div className="space-y-6">
          <h2 className="text-2xl font-bold">My Profile</h2>
          
          <div className="bg-white rounded-lg shadow-md p-6">
            <div className="flex justify-between items-center mb-6">
              <h3 className="text-lg font-semibold">Personal Information</h3>
              <button
                onClick={() => setEditMode(!editMode)}
                className="text-blue-600 hover:text-blue-800"
              >
                {editMode ? 'Cancel' : 'Edit'}
              </button>
            </div>
            
            <div className="space-y-4">
              <div>
                <label className="block text-sm text-gray-600 mb-1">Name</label>
                {editMode ? (
                  <input
                    type="text"
                    value={formData.name}
                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                    className="w-full p-2 border rounded-lg"
                  />
                ) : (
                  <p className="font-medium">{user.name}</p>
                )}
              </div>
              
              <div>
                <label className="block text-sm text-gray-600 mb-1">Email</label>
                <p className="font-medium">{user.email}</p>
              </div>
              
              <div>
                <label className="block text-sm text-gray-600 mb-1">Phone</label>
                {editMode ? (
                  <input
                    type="tel"
                    value={formData.phone}
                    onChange={(e) => setFormData({...formData, phone: e.target.value})}
                    className="w-full p-2 border rounded-lg"
                  />
                ) : (
                  <p className="font-medium">{user.phone || 'Not set'}</p>
                )}
              </div>
              
              <div>
                <label className="block text-sm text-gray-600 mb-1">Postcode</label>
                {editMode ? (
                  <input
                    type="text"
                    value={formData.postcode}
                    onChange={(e) => setFormData({...formData, postcode: e.target.value})}
                    className="w-full p-2 border rounded-lg"
                  />
                ) : (
                  <p className="font-medium">{user.postcode || 'Not set'}</p>
                )}
              </div>
              
              {editMode && (
                <button
                  onClick={handleSave}
                  className="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold"
                >
                  Save Changes
                </button>
              )}
            </div>
          </div>
          
          <div className="bg-white rounded-lg shadow-md p-6">
            <h3 className="text-lg font-semibold mb-4">Referral Program</h3>
            <div className="bg-blue-50 p-4 rounded-lg mb-4">
              <p className="text-sm text-gray-700 mb-2">Your referral code:</p>
              <div className="flex items-center gap-2">
                <code className="bg-white px-3 py-2 rounded font-mono text-lg">{user.referralCode}</code>
                <button
                  onClick={() => {
                    navigator.clipboard.writeText(user.referralCode);
                    alert('Referral code copied!');
                  }}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm"
                >
                  Copy
                </button>
              </div>
            </div>
            <p className="text-sm text-gray-600">
              Share your code and earn £{APP_CONFIG.referralBonus} for each friend who signs up!
            </p>
          </div>
          
          <div className="bg-white rounded-lg shadow-md p-6">
            <h3 className="text-lg font-semibold mb-4">Settings</h3>
            <div className="space-y-3">
              <label className="flex items-center justify-between">
                <span>Email notifications</span>
                <input type="checkbox" defaultChecked className="toggle" />
              </label>
              <label className="flex items-center justify-between">
                <span>Push notifications</span>
                <input type="checkbox" defaultChecked className="toggle" />
              </label>
              <label className="flex items-center justify-between">
                <span>SMS alerts</span>
                <input type="checkbox" className="toggle" />
              </label>
            </div>
          </div>
          
          <button
            onClick={() => {
              if (confirm('Are you sure you want to delete your account?')) {
                alert('Account deletion coming soon');
              }
            }}
            className="w-full bg-red-600 text-white py-3 rounded-lg font-semibold"
          >
            Delete Account
          </button>
        </div>
      );
    };

    const ExpertDashboard = ({ expert, onLogout }) => {
      const [activeTab, setActiveTab] = React.useState('dashboard');
      const [stats, setStats] = React.useState({
        todayJobs: 0,
        weekEarnings: 0,
        monthlyJobs: 0,
        avgRating: expert.rating
      });
      
      React.useEffect(() => {
        analytics.trackPageView('expert_dashboard');
      }, []);
      
      const renderDashboard = () => (
        <div className="space-y-6">
          <div className="bg-gradient-to-r from-green-500 to-blue-600 rounded-xl p-6 text-white">
            <h2 className="text-2xl font-bold mb-2">Welcome back, {expert.name}!</h2>
            <p className="mb-4">You have 3 new quote requests</p>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <div className="text-3xl font-bold">£{stats.weekEarnings}</div>
                <div className="text-sm opacity-80">This Week</div>
              </div>
              <div>
                <div className="text-3xl font-bold">{expert.rating} ⭐</div>
                <div className="text-sm opacity-80">Rating ({expert.reviews} reviews)</div>
              </div>
            </div>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="admin-stat-card">
              <div className="admin-stat-value">{stats.todayJobs}</div>
              <div className="admin-stat-label">Today's Jobs</div>
            </div>
            <div className="admin-stat-card">
              <div className="admin-stat-value">{expert.completedJobs}</div>
              <div className="admin-stat-label">Total Completed</div>
            </div>
            <div className="admin-stat-card">
              <div className="admin-stat-value">{expert.responseTime}</div>
              <div className="admin-stat-label">Avg Response</div>
            </div>
          </div>
          
          <div className="bg-white rounded-lg shadow-md p-6">
            <h3 className="text-lg font-semibold mb-4">Quick Actions</h3>
            <div className="grid grid-cols-2 gap-3">
              <button
                onClick={() => setActiveTab('quotes')}
                className="bg-blue-600 text-white p-4 rounded-lg hover:bg-blue-700"
              >
                <div className="text-2xl mb-1">📝</div>
                <div>View Quotes</div>
              </button>
              <button
                onClick={() => setActiveTab('schedule')}
                className="bg-green-600 text-white p-4 rounded-lg hover:bg-green-700"
              >
                <div className="text-2xl mb-1">📅</div>
                <div>Schedule</div>
              </button>
              <button
                onClick={() => setActiveTab('earnings')}
                className="bg-purple-600 text-white p-4 rounded-lg hover:bg-purple-700"
              >
                <div className="text-2xl mb-1">💰</div>
                <div>Earnings</div>
              </button>
              <button
                onClick={() => setActiveTab('profile')}
                className="bg-gray-600 text-white p-4 rounded-lg hover:bg-gray-700"
              >
                <div className="text-2xl mb-1">👤</div>
                <div>Profile</div>
              </button>
            </div>
          </div>
        </div>
      );
      
      return (
        <div className="min-h-screen bg-gray-50">
          <div className="safe-area-top bg-white shadow-sm">
            <div className="container mx-auto px-4 py-4">
              <div className="flex justify-between items-center">
                <h1 className="text-2xl font-bold flex items-center">
                  <span className="text-3xl mr-2">👨‍🔧</span> Expert Portal
                </h1>
                <button
                  onClick={onLogout}
                  className="text-gray-600 hover:text-gray-800"
                >
                  Logout
                </button>
              </div>
            </div>
          </div>
          
          <div className="container mx-auto px-4 py-6 pb-20">
            {activeTab === 'dashboard' && renderDashboard()}
            {/* Add other tab renders here */}
          </div>
          
          <div className="bottom-nav safe-area-bottom">
            <button
              onClick={() => setActiveTab('dashboard')}
              className={`bottom-nav-item ${activeTab === 'dashboard' ? 'active' : ''}`}
            >
              <div className="bottom-nav-icon">📊</div>
              <span>Dashboard</span>
            </button>
            <button
              onClick={() => setActiveTab('quotes')}
              className={`bottom-nav-item ${activeTab === 'quotes' ? 'active' : ''}`}
            >
              <div className="bottom-nav-icon">📝</div>
              <span>Quotes</span>
            </button>
            <button
              onClick={() => setActiveTab('jobs')}
              className={`bottom-nav-item ${activeTab === 'jobs' ? 'active' : ''}`}
            >
              <div className="bottom-nav-icon">🔧</div>
              <span>Jobs</span>
            </button>
            <button
              onClick={() => setActiveTab('earnings')}
              className={`bottom-nav-item ${activeTab === 'earnings' ? 'active' : ''}`}
            >
              <div className="bottom-nav-icon">💰</div>
              <span>Earnings</span>
            </button>
            <button
              onClick={() => setActiveTab('profile')}
              className={`bottom-nav-item ${activeTab === 'profile' ? 'active' : ''}`}
            >
              <div className="bottom-nav-icon">👤</div>
              <span>Profile</span>
            </button>
          </div>
        </div>
      );
    };

    const AdminDashboard = ({ onLogout }) => {
      const [activeTab, setActiveTab] = React.useState('overview');
      const [stats, setStats] = React.useState({
        totalUsers: registeredUsers.size,
        totalExperts: expertProfiles.size,
        totalBookings: Array.from(bookings.values()).flat().length,
        totalRevenue: 0,
        activeEmergencies: emergencyRequests.size,
        pendingVerifications: 0
      });
      
      React.useEffect(() => {
        analytics.trackPageView('admin_dashboard');
        // Calculate stats
        const pendingExperts = Array.from(expertProfiles.values()).filter(
          e => e.accountStatus === 'pending_verification'
        ).length;
        setStats(prev => ({ ...prev, pendingVerifications: pendingExperts }));
      }, []);
      
      return (
        <div className="min-h-screen bg-gray-100">
          <div className="bg-white shadow-sm">
            <div className="container mx-auto px-4 py-4">
              <div className="flex justify-between items-center">
                <h1 className="text-2xl font-bold">Admin Dashboard</h1>
                <button onClick={onLogout} className="text-gray-600">Logout</button>
              </div>
            </div>
          </div>
          
          <div className="container mx-auto px-4 py-6">
            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
              <div className="admin-stat-card">
                <div className="admin-stat-value">{stats.totalUsers}</div>
                <div className="admin-stat-label">Total Users</div>
              </div>
              <div className="admin-stat-card">
                <div className="admin-stat-value">{stats.totalExperts}</div>
                <div className="admin-stat-label">Total Experts</div>
              </div>
              <div className="admin-stat-card">
                <div className="admin-stat-value">{stats.totalBookings}</div>
                <div className="admin-stat-label">Total Bookings</div>
              </div>
              <div className="admin-stat-card">
                <div className="admin-stat-value">£{stats.totalRevenue}</div>
                <div className="admin-stat-label">Revenue</div>
              </div>
              <div className="admin-stat-card">
                <div className="admin-stat-value">{stats.activeEmergencies}</div>
                <div className="admin-stat-label">Emergencies</div>
              </div>
              <div className="admin-stat-card">
                <div className="admin-stat-value">{stats.pendingVerifications}</div>
                <div className="admin-stat-label">Pending</div>
              </div>
            </div>
            
            <div className="bg-white rounded-lg shadow-md p-6">
              <h2 className="text-xl font-semibold mb-4">System Status</h2>
              <div className="space-y-2">
                <div className="flex justify-between">
                  <span>Database Status</span>
                  <span className="text-green-600">● Online</span>
                </div>
                <div className="flex justify-between">
                  <span>Payment Gateway</span>
                  <span className="text-green-600">● Active</span>
                </div>
                <div className="flex justify-between">
                  <span>AI Service</span>
                  <span className="text-green-600">● Operational</span>
                </div>
                <div className="flex justify-between">
                  <span>Last Backup</span>
                  <span>{backupService.lastBackup || 'Never'}</span>
                </div>
              </div>
              
              <div className="mt-4 flex gap-2">
                <button
                  onClick={() => backupService.createBackup()}
                  className="bg-blue-600 text-white px-4 py-2 rounded-lg"
                >
                  Run Backup
                </button>
                <button
                  onClick={() => alert('System check complete')}
                  className="bg-green-600 text-white px-4 py-2 rounded-lg"
                >
                  System Check
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // ============================================================================
    // AUTHENTICATION COMPONENTS
    // ============================================================================
    
    const LoginPage = ({ onLogin, onSignup, onBack, userType = 'user' }) => {
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');
      const [loading, setLoading] = React.useState(false);
      
      const handleLogin = async (e) => {
        e.preventDefault();
        setLoading(true);
        
        try {
          // Check admin credentials
          if (userType === 'admin' && email === APP_CONFIG.adminEmail && password === APP_CONFIG.adminPassword) {
            analytics.track('admin_login', { email });
            onLogin({ type: 'admin', email });
            return;
          }
          
          // Check user credentials
          const user = registeredUsers.get(email.toLowerCase());
          if (user && user.password === password) {
            analytics.track('user_login', { userType, email });
            onLogin({ ...user, type: userType });
            return;
          }
          
          // Check expert credentials
          if (userType === 'expert') {
            const expert = Array.from(expertProfiles.values()).find(e => e.email === email);
            if (expert && expert.password === password) {
              analytics.track('expert_login', { email });
              onLogin({ ...expert, type: 'expert' });
              return;
            }
          }
          
          alert('Invalid email or password');
        } catch (error) {
          console.error('Login error:', error);
          alert('Login failed. Please try again.');
        } finally {
          setLoading(false);
        }
      };
      
      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div className="text-center mb-8">
              <div className="text-5xl mb-4">
                {userType === 'expert' ? '👨‍🔧' : userType === 'admin' ? '⚙️' : '🔧'}
              </div>
              <h2 className="text-3xl font-bold mb-2">
                {userType === 'expert' ? 'Expert Login' : userType === 'admin' ? 'Admin Login' : 'Welcome Back'}
              </h2>
              <p className="text-gray-600">Sign in to your account</p>
            </div>
            
            <form onSubmit={handleLogin} className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-2">Email</label>
                <input
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full p-3 border rounded-lg"
                  placeholder="your@email.com"
                  required
                />
              </div>
              
              <div>
                <label className="block text-sm font-medium mb-2">Password</label>
                <input
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full p-3 border rounded-lg"
                  placeholder="••••••••"
                  required
                />
              </div>
              
              <button
                type="submit"
                disabled={loading}
                className={`w-full py-3 rounded-lg font-semibold transition-all ${
                  loading
                    ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                    : 'bg-blue-600 text-white hover:bg-blue-700'
                }`}
              >
                {loading ? 'Signing in...' : 'Sign In'}
              </button>
            </form>
            
            {userType === 'user' && (
              <>
                <div className="mt-6 text-center">
                  <p className="text-gray-600">
                    Don't have an account?{' '}
                    <button
                      onClick={onSignup}
                      className="text-blue-600 hover:text-blue-800 font-semibold"
                    >
                      Sign up
                    </button>
                  </p>
                </div>
                
                <div className="mt-4 text-center">
                  <button
                    onClick={() => alert('Password reset coming soon!')}
                    className="text-gray-600 hover:text-gray-800 text-sm"
                  >
                    Forgot password?
                  </button>
                </div>
              </>
            )}
            
            <div className="mt-6 text-center">
              <button
                onClick={onBack}
                className="text-gray-600 hover:text-gray-800"
              >
                ← Back
              </button>
            </div>
            
            {userType === 'admin' && (
              <div className="mt-4 text-center text-xs text-gray-500">
                Admin access is restricted to authorized personnel only
              </div>
            )}
          </div>
        </div>
      );
    };

    const SignupPage = ({ onSignup, onBack, userType = 'user' }) => {
      const [step, setStep] = React.useState(1);
      const [formData, setFormData] = React.useState({
        name: '',
        email: '',
        password: '',
        confirmPassword: '',
        phone: '',
        postcode: '',
        referralCode: '',
        acceptTerms: false,
        // Expert specific fields
        profession: '',
        hourlyRate: '',
        bio: '',
        certifications: '',
        insurance: '',
        availability: []
      });
      const [loading, setLoading] = React.useState(false);
      
      const handleSubmit = async (e) => {
        e.preventDefault();
        
        if (formData.password !== formData.confirmPassword) {
          alert('Passwords do not match');
          return;
        }
        
        if (!formData.acceptTerms) {
          alert('Please accept the terms and conditions');
          return;
        }
        
        setLoading(true);
        
        try {
          // Check if user already exists
          if (registeredUsers.has(formData.email.toLowerCase())) {
            alert('An account with this email already exists');
            return;
          }
          
          // Apply referral code if provided
          let referralBonus = null;
          if (formData.referralCode) {
            const referralResult = applyReferralCode(formData.referralCode, formData.email);
            if (referralResult.valid) {
              referralBonus = referralResult;
            }
          }
          
          if (userType === 'expert') {
            // Create expert account
            const expertData = {
              name: formData.name,
              email: formData.email.toLowerCase(),
              password: formData.password,
              phone: formData.phone,
              profession: formData.profession,
              postcode: formData.postcode,
              location: `${formData.postcode}, London`,
              bio: formData.bio,
              hourlyRate: parseInt(formData.hourlyRate),
              certifications: formData.certifications,
              insurance: formData.insurance,
              availability: formData.availability,
              specialties: []
            };
            
            const result = await dbOperations.createExpert(expertData);
            
            if (result.success) {
              await sendEmail(formData.email, 'welcome', result.expert);
              alert('Expert account created! Please upload your documents for verification.');
              onSignup({ ...result.expert, type: 'expert' });
            }
          } else {
            // Create user account
            const userData = {
              name: formData.name,
              email: formData.email.toLowerCase(),
              password: formData.password,
              phone: formData.phone,
              postcode: formData.postcode,
              userType: 'user'
            };
            
            const result = await dbOperations.createUser(userData);
            
            if (result.success) {
              // Apply referral bonus
              if (referralBonus) {
                const referrer = registeredUsers.get(referralBonus.referrerId);
                if (referrer) {
                  referrer.totalSpent += referralBonus.bonus;
                  await dbOperations.updateUser(referrer.email, { totalSpent: referrer.totalSpent });
                }
              }
              
              await sendEmail(formData.email, 'welcome', result.user);
              alert(`Welcome to DIYMatch! ${referralBonus ? `You've earned £${referralBonus.bonus} credit!` : ''}`);
              onSignup({ ...result.user, type: 'user' });
            }
          }
        } catch (error) {
          console.error('Signup error:', error);
          alert('Signup failed. Please try again.');
        } finally {
          setLoading(false);
        }
      };
      
      const renderStep1 = () => (
        <div className="space-y-4">
          <h3 className="text-xl font-semibold mb-4">Basic Information</h3>
          
          <div>
            <label className="block text-sm font-medium mb-2">Full Name</label>
            <input
              type="text"
              value={formData.name}
              onChange={(e) => setFormData({...formData, name: e.target.value})}
              className="w-full p-3 border rounded-lg"
              placeholder="John Smith"
              required
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-2">Email</label>
            <input
              type="email"
              value={formData.email}
              onChange={(e) => setFormData({...formData, email: e.target.value})}
              className="w-full p-3 border rounded-lg"
              placeholder="your@email.com"
              required
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-2">Password</label>
            <input
              type="password"
              value={formData.password}
              onChange={(e) => setFormData({...formData, password: e.target.value})}
              className="w-full p-3 border rounded-lg"
              placeholder="Min 8 characters"
              minLength="8"
              required
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-2">Confirm Password</label>
            <input
              type="password"
              value={formData.confirmPassword}
              onChange={(e) => setFormData({...formData, confirmPassword: e.target.value})}
              className="w-full p-3 border rounded-lg"
              placeholder="Repeat password"
              required
            />
          </div>
          
          <button
            type="button"
            onClick={() => setStep(2)}
            disabled={!formData.name || !formData.email || !formData.password || !formData.confirmPassword}
            className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700"
          >
            Next →
          </button>
        </div>
      );
      
      const renderStep2User = () => (
        <div className="space-y-4">
          <h3 className="text-xl font-semibold mb-4">Contact Details</h3>
          
          <div>
            <label className="block text-sm font-medium mb-2">Phone Number</label>
            <input
              type="tel"
              value={formData.phone}
              onChange={(e) => setFormData({...formData, phone: e.target.value})}
              className="w-full p-3 border rounded-lg"
              placeholder="07123456789"
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-2">Postcode</label>
            <input
              type="text"
              value={formData.postcode}
              onChange={(e) => setFormData({...formData, postcode: e.target.value})}
              className="w-full p-3 border rounded-lg"
              placeholder="SW1A 1AA"
              required
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-2">Referral Code (Optional)</label>
            <input
              type="text"
              value={formData.referralCode}
              onChange={(e) => setFormData({...formData, referralCode: e.target.value})}
              className="w-full p-3 border rounded-lg"
              placeholder="Enter code for £5 bonus"
            />
          </div>
          
          <div className="bg-gray-50 p-4 rounded-lg">
            <label className="flex items-start">
              <input
                type="checkbox"
                checked={formData.acceptTerms}
                onChange={(e) => setFormData({...formData, acceptTerms: e.target.checked})}
                className="mt-1 mr-2"
              />
              <span className="text-sm text-gray-700">
                I accept the Terms of Service and Privacy Policy. I understand that 
                DIYMatch will process my data to provide services and send relevant communications.
              </span>
            </label>
          </div>
          
          <div className="flex gap-4">
            <button
              type="button"
              onClick={() => setStep(1)}
              className="flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold"
            >
              ← Back
            </button>
            <button
              type="submit"
              disabled={loading || !formData.acceptTerms}
              className={`flex-1 py-3 rounded-lg font-semibold ${
                loading || !formData.acceptTerms
                  ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
                  : 'bg-blue-600 text-white hover:bg-blue-700'
              }`}
            >
              {loading ? 'Creating Account...' : 'Create Account'}
            </button>
          </div>
        </div>
      );
      
      const renderStep2Expert = () => (
        <div className="space-y-4">
          <h3 className="text-xl font-semibold mb-4">Professional Details</h3>
          
          <div>
            <label className="block text-sm font-medium mb-2">Profession</label>
            <select
              value={formData.profession}
              onChange={(e) => setFormData({...formData, profession: e.target.value})}
              className="w-full p-3 border rounded-lg"
              required
            >
              <option value="">Select profession</option>
              <option value="Plumber">Plumber</option>
              <option value="Electrician">Electrician</option>
              <option value="Handyman">Handyman</option>
              <option value="Carpenter">Carpenter</option>
              <option value="Painter">Painter & Decorator</option>
              <option value="Gas Engineer">Gas Safe Engineer</option>
              <option value="Other">Other</option>
            </select>
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-2">Hourly Rate (£)</label>
            <input
              type="number"
              value={formData.hourlyRate}
              onChange={(e) => setFormData({...formData, hourlyRate: e.target.value})}
              className="w-full p-3 border rounded-lg"
              placeholder="45"
              min="20"
              required
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-2">Bio</label>
            <textarea
              value={formData.bio}
              onChange={(e) => setFormData({...formData, bio: e.target.value})}
              className="w-full p-3 border rounded-lg resize-none"
              rows="3"
              placeholder="Tell customers about your experience and specialties..."
              required
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-2">Availability</label>
            <div className="space-y-2">
              {['Mon-Fri', 'Weekends', 'Emergency 24/7'].map(option => (
                <label key={option} className="flex items-center">
                  <input
                    type="checkbox"
                    checked={formData.availability.includes(option)}
                    onChange={(e) => {
                      if (e.target.checked) {
                        setFormData({...formData, availability: [...formData.availability, option]});
                      } else {
                        setFormData({...formData, availability: formData.availability.filter(a => a !== option)});
                      }
                    }}
                    className="mr-2"
                  />
                  {option}
                </label>
              ))}
            </div>
          </div>
          
          <button
            type="button"
            onClick={() => setStep(3)}
            className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700"
          >
            Next →
          </button>
        </div>
      );
      
      return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
            <div className="text-center mb-8">
              <div className="text-5xl mb-4">{userType === 'expert' ? '👨‍🔧' : '🔧'}</div>
              <h2 className="text-3xl font-bold mb-2">
                {userType === 'expert' ? 'Join as Expert' : 'Create Account'}
              </h2>
              <p className="text-gray-600">
                {userType === 'expert' ? 'Start earning with your skills' : 'Get started with DIYMatch'}
              </p>
            </div>
            
            <ProgressSteps
              steps={userType === 'expert' ? ['Basic Info', 'Professional', 'Contact'] : ['Basic Info', 'Contact']}
              currentStep={step - 1}
            />
            
            <form onSubmit={handleSubmit} className="mt-6">
              {step === 1 && renderStep1()}
              {step === 2 && userType === 'user' && renderStep2User()}
              {step === 2 && userType === 'expert' && renderStep2Expert()}
              {step === 3 && userType === 'expert' && renderStep2User()}
            </form>
            
            <div className="mt-6 text-center">
              <button
                onClick={onBack}
                className="text-gray-600 hover:text-gray-800"
              >
                ← Back to {userType === 'expert' ? 'Expert Login' : 'Login'}
              </button>
            </div>
          </div>
        </div>
      );
    };

    // ============================================================================
    // MAIN APP COMPONENT
    // ============================================================================
    
    const App = () => {
      const [currentView, setCurrentView] = React.useState('welcome');
      const [currentUser, setCurrentUser] = React.useState(null);
      const [isLoading, setIsLoading] = React.useState(true);
      
      React.useEffect(() => {
        // Check for saved session
        const savedSession = localStorage.getItem('diymatch_session');
        if (savedSession) {
          try {
            const session = JSON.parse(savedSession);
            setCurrentUser(session);
            setCurrentView(session.type + '_dashboard');
          } catch (error) {
            console.error('Session restore error:', error);
          }
        }
        
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
        }
        
        // Hide splash screen
        setTimeout(() => {
          const splash = document.getElementById('splash-screen');
          if (splash) {
            splash.style.opacity = '0';
            setTimeout(() => splash.remove(), 300);
          }
          setIsLoading(false);
        }, 2000);
      }, []);
      
      const handleLogin = (user) => {
        setCurrentUser(user);
        localStorage.setItem('diymatch_session', JSON.stringify(user));
        
        switch (user.type) {
          case 'admin':
            setCurrentView('admin_dashboard');
            break;
          case 'expert':
            setCurrentView('expert_dashboard');
            break;
          default:
            setCurrentView('user_dashboard');
        }
      };
      
      const handleLogout = () => {
        setCurrentUser(null);
        localStorage.removeItem('diymatch_session');
        setCurrentView('welcome');
        analytics.track('logout', { userType: currentUser?.type });
      };
      
      if (isLoading) {
        return null;
      }
      
      return (
        <ErrorBoundary>
          <NotificationContext.Provider value={useNotifications()}>
            <AuthContext.Provider value={{ user: currentUser, login: handleLogin, logout: handleLogout }}>
              {currentView === 'welcome' && (
                <WelcomePage
                  onGetStarted={() => setCurrentView('user_login')}
                  onLoginExpert={() => setCurrentView('expert_login')}
                />
              )}
              
              {currentView === 'user_login' && (
                <LoginPage
                  userType="user"
                  onLogin={handleLogin}
                  onSignup={() => setCurrentView('user_signup')}
                  onBack={() => setCurrentView('welcome')}
                />
              )}
              
              {currentView === 'user_signup' && (
                <SignupPage
                  userType="user"
                  onSignup={handleLogin}
                  onBack={() => setCurrentView('user_login')}
                />
              )}
              
              {currentView === 'expert_login' && (
                <LoginPage
                  userType="expert"
                  onLogin={handleLogin}
                  onSignup={() => setCurrentView('expert_signup')}
                  onBack={() => setCurrentView('welcome')}
                />
              )}
              
              {currentView === 'expert_signup' && (
                <SignupPage
                  userType="expert"
                  onSignup={handleLogin}
                  onBack={() => setCurrentView('expert_login')}
                />
              )}
              
              {currentView === 'user_dashboard' && currentUser && (
                <UserDashboard user={currentUser} onLogout={handleLogout} />
              )}
              
              {currentView === 'expert_dashboard' && currentUser && (
                <ExpertDashboard expert={currentUser} onLogout={handleLogout} />
              )}
              
              {currentView === 'admin_dashboard' && currentUser && (
                <AdminDashboard onLogout={handleLogout} />
              )}
              
              {/* Admin Login - Hidden Route */}
              {currentView === 'admin_login' && (
                <LoginPage
                  userType="admin"
                  onLogin={handleLogin}
                  onBack={() => setCurrentView('welcome')}
                />
              )}
            </AuthContext.Provider>
          </NotificationContext.Provider>
        </ErrorBoundary>
      );
    };

    // ============================================================================
    // APP INITIALIZATION
    // ============================================================================
    
    // Add admin login shortcut (triple-click on logo)
    let clickCount = 0;
    let clickTimer = null;
    
    document.addEventListener('click', (e) => {
      if (e.target.textContent === '🔧' || e.target.textContent === 'DIYMatch') {
        clickCount++;
        
        if (clickTimer) clearTimeout(clickTimer);
        
        clickTimer = setTimeout(() => {
          if (clickCount >= 3) {
            const appElement = document.getElementById('root');
            if (appElement && appElement._reactRootContainer) {
              // Navigate to admin login
              window.location.hash = '#admin';
              window.location.reload();
            }
          }
          clickCount = 0;
        }, 500);
      }
    });
    
    // Check for admin route
    if (window.location.hash === '#admin') {
      setTimeout(() => {
        const event = new CustomEvent('navigate', { detail: 'admin_login' });
        window.dispatchEvent(event);
      }, 100);
    }
    
    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
