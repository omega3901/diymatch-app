<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
 <meta name="theme-color" content="#2563eb">
 <meta name="mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="default">
 <meta name="apple-mobile-web-app-title" content="DIYMatch">
 <meta name="application-name" content="DIYMatch">
 <meta name="description" content="AI-powered DIY assistant connecting you with verified experts and providing instant problem analysis">
 <meta name="format-detection" content="telephone=no">
 <meta name="msapplication-tap-highlight" content="no">
 
 <title>DIYMatch - AI-Powered DIY Assistant</title>
 
 <!-- PWA Manifest -->
 <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkRJWU1hdGNoIiwKICAic2hvcnRfbmFtZSI6ICJESVlNYXRjaCIsCiAgInN0YXJ0X3VybCI6ICIvIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiIzI1NjNlYiIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLDxzdmcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyB2aWV3Qm94PScwIDAgMTAwIDEwMCc+PHRleHQgeT0nMC45ZW0nIGZvbnQtc2l6ZT0nOTAnPvCflKc8L3RleHQ+PC9zdmc+IiwKICAgICAgInNpemVzIjogImFueSIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9CiAgXQp9">
 
 <!-- Icons -->
 <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🔧</text></svg>">
 <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🔧</text></svg>">
 
 <!-- Tailwind CSS -->
 <script src="https://cdn.tailwindcss.com"></script>
 
 <style>
   /* Enhanced Mobile Optimizations */
   * {
     -webkit-tap-highlight-color: transparent;
     -webkit-touch-callout: none;
     -webkit-user-select: none;
     user-select: none;
     touch-action: pan-y;
   }
   
   html {
     -webkit-text-size-adjust: 100%;
     -ms-text-size-adjust: 100%;
   }
   
   input, textarea, select {
     -webkit-user-select: text;
     user-select: text;
     touch-action: manipulation;
   }
   
   body {
     margin: 0;
     padding: 0;
     font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', sans-serif;
     -webkit-font-smoothing: antialiased;
     -moz-osx-font-smoothing: grayscale;
     overflow-x: hidden;
     background-color: #ffffff;
     overscroll-behavior: none;
   }
   
   .safe-area-top { 
     padding-top: env(safe-area-inset-top);
     padding-top: constant(safe-area-inset-top);
   }
   
   .safe-area-bottom { 
     padding-bottom: env(safe-area-inset-bottom);
     padding-bottom: constant(safe-area-inset-bottom);
   }
   
   /* Mobile Touch Enhancements */
   .mobile-touch {
     cursor: pointer;
     -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
     transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
     touch-action: manipulation;
     will-change: transform;
   }
   
   .mobile-touch:active {
     transform: scale(0.96);
     opacity: 0.85;
   }
   
   /* Smooth Scrolling */
   .smooth-scroll {
     -webkit-overflow-scrolling: touch;
     overscroll-behavior-y: contain;
   }
   
   /* Loading States */
   .loading-pulse { 
     animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; 
   }
   
   @keyframes pulse { 
     0%, 100% { opacity: 1; } 
     50% { opacity: 0.5; } 
   }
   
   .analysis-progress {
     background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
     background-size: 200% 100%;
     animation: shimmer 2s linear infinite;
   }
   
   @keyframes shimmer {
     0% { background-position: -200% 0; }
     100% { background-position: 200% 0; }
   }
   
   /* Input Fixes for Mobile */
   button { 
     touch-action: manipulation;
     -webkit-appearance: none;
     appearance: none;
   }
   
   input[type="text"], 
   input[type="email"], 
   input[type="password"], 
   input[type="tel"], 
   textarea, 
   select { 
     font-size: 16px !important;
     -webkit-appearance: none;
     appearance: none;
     border-radius: 0;
   }
   
   /* Splash Screen */
   .splash-screen {
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background: linear-gradient(135deg, #2563eb 0%, #8b5cf6 100%);
     display: flex;
     align-items: center;
     justify-content: center;
     z-index: 9999;
     color: white;
   }

   /* Offline Message */
   .offline-message {
     position: fixed;
     top: 0;
     left: 0;
     right: 0;
     background: #ef4444;
     color: white;
     padding: 10px;
     text-align: center;
     z-index: 10000;
     font-size: 14px;
     animation: slideDown 0.3s ease-out;
   }
   
   @keyframes slideDown {
     from { transform: translateY(-100%); }
     to { transform: translateY(0); }
   }

   /* Enhanced UI Elements */
   .glass-effect {
     background: rgba(255, 255, 255, 0.1);
     backdrop-filter: blur(10px);
     -webkit-backdrop-filter: blur(10px);
     border: 1px solid rgba(255, 255, 255, 0.2);
   }

   .gradient-border {
     background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
     padding: 2px;
     border-radius: 12px;
   }

   /* Animations */
   .float-animation {
     animation: float 3s ease-in-out infinite;
   }

   @keyframes float {
     0%, 100% { transform: translateY(0); }
     50% { transform: translateY(-10px); }
   }

   .slide-in {
     animation: slideIn 0.3s ease-out;
   }

   @keyframes slideIn {
     from { transform: translateX(100%); opacity: 0; }
     to { transform: translateX(0); opacity: 1; }
   }

   .fade-in {
     animation: fadeIn 0.5s ease-out;
   }
   
   @keyframes fadeIn {
     from { opacity: 0; transform: translateY(10px); }
     to { opacity: 1; transform: translateY(0); }
   }

   /* Notification Badge */
   .notification-badge {
     position: absolute;
     top: -4px;
     right: -4px;
     background: #ef4444;
     color: white;
     font-size: 10px;
     padding: 2px 6px;
     border-radius: 10px;
     font-weight: bold;
     animation: pulse 2s infinite;
   }

   /* Star Rating */
   .star-rating {
     display: flex;
     gap: 4px;
   }

   .star {
     font-size: 20px;
     color: #d1d5db;
     cursor: pointer;
     transition: all 0.2s;
   }

   .star.filled {
     color: #fbbf24;
     transform: scale(1.1);
   }

   .star:hover {
     color: #fbbf24;
     transform: scale(1.2);
   }

   /* Progress Steps */
   .progress-steps {
     display: flex;
     justify-content: space-between;
     margin-bottom: 2rem;
     position: relative;
   }

   .progress-step {
     flex: 1;
     text-align: center;
     position: relative;
     z-index: 1;
   }

   .progress-step:not(:last-child)::after {
     content: '';
     position: absolute;
     top: 20px;
     left: 50%;
     width: 100%;
     height: 2px;
     background: #e5e7eb;
     z-index: -1;
   }

   .progress-step.completed:not(:last-child)::after {
     background: #3b82f6;
     transition: all 0.3s ease;
   }

   .progress-step-circle {
     width: 40px;
     height: 40px;
     border-radius: 50%;
     background: #e5e7eb;
     margin: 0 auto 8px;
     display: flex;
     align-items: center;
     justify-content: center;
     font-weight: 600;
     transition: all 0.3s ease;
     position: relative;
   }

   .progress-step.completed .progress-step-circle {
     background: #3b82f6;
     color: white;
     transform: scale(1.1);
   }

   .progress-step.active .progress-step-circle {
     background: #3b82f6;
     color: white;
     box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
     animation: pulse 2s infinite;
   }

   /* Voice Recording Animation */
   .recording-animation {
     width: 60px;
     height: 60px;
     border-radius: 50%;
     background: #ef4444;
     position: relative;
     animation: recordPulse 1.5s ease-in-out infinite;
   }

   @keyframes recordPulse {
     0% { transform: scale(1); opacity: 1; }
     50% { transform: scale(1.1); opacity: 0.8; }
     100% { transform: scale(1); opacity: 1; }
   }
   
   .recording-wave {
     position: absolute;
     top: 50%;
     left: 50%;
     transform: translate(-50%, -50%);
     width: 100%;
     height: 100%;
     border-radius: 50%;
     border: 2px solid #ef4444;
     animation: wave 1.5s ease-out infinite;
   }
   
   @keyframes wave {
     0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
     100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
   }

   /* Chat Bubbles */
   .chat-bubble {
     max-width: 70%;
     padding: 12px 16px;
     border-radius: 18px;
     margin-bottom: 8px;
     word-wrap: break-word;
     animation: fadeIn 0.3s ease-out;
   }

   .chat-bubble.user {
     background: #3b82f6;
     color: white;
     align-self: flex-end;
     border-bottom-right-radius: 4px;
   }

   .chat-bubble.expert {
     background: #f3f4f6;
     color: #1f2937;
     align-self: flex-start;
     border-bottom-left-radius: 4px;
   }
   
   .typing-indicator {
     display: flex;
     gap: 4px;
     padding: 8px 12px;
   }
   
   .typing-dot {
     width: 8px;
     height: 8px;
     background: #9ca3af;
     border-radius: 50%;
     animation: typing 1.4s infinite;
   }
   
   .typing-dot:nth-child(2) { animation-delay: 0.2s; }
   .typing-dot:nth-child(3) { animation-delay: 0.4s; }
   
   @keyframes typing {
     0%, 60%, 100% { transform: translateY(0); }
     30% { transform: translateY(-10px); }
   }

   /* Emergency Button */
   .emergency-button {
     background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
     animation: emergencyPulse 2s ease-in-out infinite;
   }

   @keyframes emergencyPulse {
     0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
     50% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
   }

   /* Skeleton Loading */
   .skeleton {
     background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
     background-size: 200% 100%;
     animation: skeleton 1.2s ease-in-out infinite;
   }

   @keyframes skeleton {
     0% { background-position: 200% 0; }
     100% { background-position: -200% 0; }
   }

   /* Bottom Navigation Bar */
   .bottom-nav {
     position: fixed;
     bottom: 0;
     left: 0;
     right: 0;
     background: white;
     border-top: 1px solid #e5e7eb;
     display: flex;
     justify-content: space-around;
     padding: 0.5rem 0;
     z-index: 1000;
     box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
   }

   .bottom-nav-item {
     display: flex;
     flex-direction: column;
     align-items: center;
     padding: 0.5rem 1rem;
     color: #6b7280;
     font-size: 0.75rem;
     transition: all 0.2s;
     cursor: pointer;
     position: relative;
   }

   .bottom-nav-item.active {
     color: #3b82f6;
   }
   
   .bottom-nav-item.active::before {
     content: '';
     position: absolute;
     top: -1px;
     left: 50%;
     transform: translateX(-50%);
     width: 30px;
     height: 3px;
     background: #3b82f6;
     border-radius: 0 0 3px 3px;
   }

   .bottom-nav-icon {
     font-size: 1.5rem;
     margin-bottom: 0.25rem;
     transition: transform 0.2s;
   }
   
   .bottom-nav-item:active .bottom-nav-icon {
     transform: scale(1.2);
   }

   /* File Upload Styles */
   .file-upload-zone {
     border: 2px dashed #d1d5db;
     border-radius: 12px;
     padding: 2rem;
     text-align: center;
     cursor: pointer;
     transition: all 0.3s ease;
     background: #f9fafb;
   }

   .file-upload-zone:hover {
     border-color: #3b82f6;
     background: #eff6ff;
   }

   .file-upload-zone.drag-over {
     border-color: #3b82f6;
     background: #dbeafe;
     transform: scale(1.02);
   }

   /* Admin Dashboard Styles */
   .admin-stat-card {
     background: white;
     border-radius: 12px;
     padding: 1.5rem;
     box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
     transition: all 0.3s ease;
   }
   
   .admin-stat-card:hover {
     transform: translateY(-2px);
     box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
   }

   .admin-stat-value {
     font-size: 2rem;
     font-weight: bold;
     color: #1f2937;
   }

   .admin-stat-label {
     font-size: 0.875rem;
     color: #6b7280;
     margin-top: 0.25rem;
   }
   
   /* Feature Cards */
   .feature-card {
     background: white;
     border-radius: 20px;
     padding: 2rem;
     text-align: center;
     transition: all 0.3s ease;
     cursor: pointer;
     box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
   }
   
   .feature-card:hover {
     transform: translateY(-5px);
     box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
   }
   
   .feature-icon {
     width: 80px;
     height: 80px;
     margin: 0 auto 1rem;
     background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
     border-radius: 20px;
     display: flex;
     align-items: center;
     justify-content: center;
     font-size: 2.5rem;
   }
   
   /* Modal Styles */
   .modal-backdrop {
     position: fixed;
     top: 0;
     left: 0;
     width: 100%;
     height: 100%;
     background: rgba(0, 0, 0, 0.5);
     display: flex;
     align-items: center;
     justify-content: center;
     z-index: 1000;
     backdrop-filter: blur(4px);
     -webkit-backdrop-filter: blur(4px);
     animation: fadeIn 0.3s ease-out;
   }
   
   .modal-content {
     background: white;
     border-radius: 20px;
     padding: 24px;
     max-width: 500px;
     width: 90%;
     max-height: 90vh;
     overflow-y: auto;
     animation: slideUp 0.3s ease-out;
   }
   
   @keyframes slideUp {
     from { transform: translateY(20px); opacity: 0; }
     to { transform: translateY(0); opacity: 1; }
   }
   
   /* Success Animation */
   .success-animation {
     width: 100px;
     height: 100px;
     margin: 0 auto;
     background: #10b981;
     border-radius: 50%;
     display: flex;
     align-items: center;
     justify-content: center;
     animation: successPop 0.5s ease-out;
   }
   
   @keyframes successPop {
     0% { transform: scale(0); opacity: 0; }
     50% { transform: scale(1.2); }
     100% { transform: scale(1); opacity: 1; }
   }
   
   /* AI Suggestion Card */
   .ai-suggestion {
     background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
     border: 1px solid #0284c7;
     border-radius: 12px;
     padding: 16px;
     margin: 12px 0;
     position: relative;
     overflow: hidden;
   }
   
   .ai-suggestion::before {
     content: '✨';
     position: absolute;
     top: 10px;
     right: 10px;
     font-size: 20px;
     animation: twinkle 2s infinite;
   }
   
   @keyframes twinkle {
     0%, 100% { opacity: 1; transform: scale(1); }
     50% { opacity: 0.5; transform: scale(0.8); }
   }
   
   /* Responsive Design */
   @media (max-width: 768px) {
     .modal-content {
       width: calc(100vw - 2rem);
       margin: 1rem;
     }
     
     .feature-card {
       padding: 1.5rem;
     }
     
     .feature-icon {
       width: 60px;
       height: 60px;
       font-size: 2rem;
     }
   }
   
   /* PWA Install Button */
   .install-button {
     position: fixed;
     bottom: 100px;
     right: 20px;
     background: #3b82f6;
     color: white;
     padding: 12px 24px;
     border-radius: 50px;
     box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
     display: none;
     z-index: 999;
     animation: slideIn 0.3s ease-out;
   }
   
   .install-button.show {
     display: block;
   }
   
   /* Prevent overscroll bounce on iOS */
   .ios-scroll-fix {
     position: fixed;
     width: 100%;
     height: 100%;
     overflow: auto;
     -webkit-overflow-scrolling: touch;
   }
 </style>
</head>
<body>
 <div id="offline-message" class="offline-message" style="display: none;">
   No internet connection. Some features may not work.
 </div>

 <div id="root"></div>
 
 <!-- Splash Screen -->
 <div id="splash-screen" class="splash-screen">
   <div class="text-center">
     <div class="text-6xl mb-4 animate-bounce">🔧</div>
     <h1 class="text-3xl font-bold mb-2">DIYMatch</h1>
     <p class="text-lg opacity-80">AI-Powered DIY Assistant</p>
     <div class="mt-8">
       <div class="loading-pulse inline-block w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
     </div>
   </div>
 </div>
 
 <!-- PWA Install Button -->
 <button id="install-button" class="install-button mobile-touch">
   <span class="flex items-center gap-2">
     <span>📲</span>
     <span>Install App</span>
   </span>
 </button>

 <!-- React 18 -->
 <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
 <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
 
 <script>
   'use strict';
   
   // ============================================================================
   // SERVICE WORKER REGISTRATION
   // ============================================================================
   
   if ('serviceWorker' in navigator) {
     window.addEventListener('load', () => {
       // Create inline service worker
       const swCode = `
         const CACHE_NAME = 'diymatch-v1';
         const urlsToCache = [
           '/',
           'https://unpkg.com/react@18/umd/react.production.min.js',
           'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js',
           'https://cdn.tailwindcss.com'
         ];
         
         self.addEventListener('install', event => {
           event.waitUntil(
             caches.open(CACHE_NAME)
               .then(cache => cache.addAll(urlsToCache))
           );
         });
         
         self.addEventListener('fetch', event => {
           event.respondWith(
             caches.match(event.request)
               .then(response => response || fetch(event.request))
           );
         });
       `;
       
       const blob = new Blob([swCode], { type: 'application/javascript' });
       const swUrl = URL.createObjectURL(blob);
       
       navigator.serviceWorker.register(swUrl).then(registration => {
         console.log('ServiceWorker registered:', registration);
       }).catch(error => {
         console.log('ServiceWorker registration failed:', error);
       });
     });
   }
   
   // ============================================================================
   // PWA INSTALL PROMPT
   // ============================================================================
   
   let deferredPrompt;
   const installButton = document.getElementById('install-button');
   
   window.addEventListener('beforeinstallprompt', (e) => {
     e.preventDefault();
     deferredPrompt = e;
     installButton.classList.add('show');
   });
   
   installButton.addEventListener('click', async () => {
     if (deferredPrompt) {
       deferredPrompt.prompt();
       const { outcome } = await deferredPrompt.userChoice;
       if (outcome === 'accepted') {
         console.log('User accepted the install prompt');
       }
       deferredPrompt = null;
       installButton.classList.remove('show');
     }
   });
   
   // ============================================================================
   // CONNECTIVITY & ERROR HANDLING
   // ============================================================================
   
   function checkConnectivity() {
     const offlineMessage = document.getElementById('offline-message');
     if (!navigator.onLine) {
       offlineMessage.style.display = 'block';
     } else {
       offlineMessage.style.display = 'none';
     }
   }

   window.addEventListener('online', checkConnectivity);
   window.addEventListener('offline', checkConnectivity);
   checkConnectivity();

   // Error boundary for React
   class ErrorBoundary extends React.Component {
     constructor(props) {
       super(props);
       this.state = { hasError: false, error: null };
     }

     static getDerivedStateFromError(error) {
       return { hasError: true, error };
     }

     componentDidCatch(error, errorInfo) {
       console.error('Error caught by boundary:', error, errorInfo);
     }

     render() {
       if (this.state.hasError) {
         return React.createElement('div', { className: 'min-h-screen flex items-center justify-center p-4' },
           React.createElement('div', { className: 'text-center' },
             React.createElement('div', { className: 'text-6xl mb-4' }, '😔'),
             React.createElement('h1', { className: 'text-2xl font-bold mb-2' }, 'Something went wrong'),
             React.createElement('p', { className: 'text-gray-600 mb-4' }, 'Please refresh the page to try again'),
             React.createElement('button', {
               onClick: () => window.location.reload(),
               className: 'bg-blue-600 text-white px-6 py-3 rounded-lg mobile-touch'
             }, 'Refresh Page')
           )
         );
       }

       return this.props.children;
     }
   }

   // ============================================================================
   // APP CONFIGURATION
   // ============================================================================
   
   const APP_CONFIG = {
     name: 'DIYMatch',
     version: '2.1.0',
     description: 'AI-Powered DIY Assistant with Expert Network',
     adminEmail: 'yahye21@hotmail.com',
     adminPassword: 'Graphics41_',
     supportEmail: 'support@diymatch.co.uk',
     aiAnalysisPrice: 4.99,
     sameDayMultiplier: 1.5,
     platformCommission: 0.15,
     sameDayCommission: 0.20,
     emergencyHotline: '0800-DIY-HELP',
     maxImageSize: 10 * 1024 * 1024, // 10MB
     maxVideoSize: 100 * 1024 * 1024, // 100MB
     maxFileSize: 50 * 1024 * 1024, // 50MB
     freeAnalysesPerMonth: 1,
     referralBonus: 5.00,
     expertVerificationRequired: true,
     minimumExpertRating: 4.0,
     responseTimeTargets: {
       urgent: '1 hour',
       normal: '4 hours',
       scheduled: '24 hours'
     },
     supportChatEnabled: true,
     aiFeatures: {
       voiceCommands: true,
       arMeasurement: true,
       predictiveMaintenance: true,
       smartScheduling: true,
       priceNegotiation: true,
       qualityAssurance: true
     }
   };

   // ============================================================================
   // DATABASE SERVICE
   // ============================================================================
   
   class DatabaseService {
     constructor() {
       this.cache = new Map();
       this.syncQueue = [];
       this.isOnline = navigator.onLine;
       this.dbName = 'DIYMatchDB';
       this.version = 1;
       this.initIndexedDB();
     }

     async initIndexedDB() {
       if ('indexedDB' in window) {
         try {
           const request = indexedDB.open(this.dbName, this.version);
           
           request.onerror = () => console.error('IndexedDB error');
           
           request.onsuccess = (event) => {
             this.db = event.target.result;
             console.log('IndexedDB initialized');
           };
           
           request.onupgradeneeded = (event) => {
             const db = event.target.result;
             
             // Create object stores
             if (!db.objectStoreNames.contains('users')) {
               db.createObjectStore('users', { keyPath: 'id' });
             }
             if (!db.objectStoreNames.contains('analyses')) {
               db.createObjectStore('analyses', { keyPath: 'id' });
             }
             if (!db.objectStoreNames.contains('experts')) {
               db.createObjectStore('experts', { keyPath: 'id' });
             }
             if (!db.objectStoreNames.contains('bookings')) {
               db.createObjectStore('bookings', { keyPath: 'id' });
             }
           };
         } catch (error) {
           console.error('IndexedDB init error:', error);
         }
       }
     }

     async query(collection, operation, data) {
       try {
         if (!this.isOnline) {
           this.syncQueue.push({ collection, operation, data, timestamp: Date.now() });
           return this.handleOfflineOperation(collection, operation, data);
         }

         const result = this.handleOfflineOperation(collection, operation, data);
         this.updateCache(collection, result);
         return result;
       } catch (error) {
         console.error('Database query error:', error);
         return this.handleOfflineOperation(collection, operation, data);
       }
     }

     handleOfflineOperation(collection, operation, data) {
       const localData = JSON.parse(localStorage.getItem(`diymatch_${collection}`) || '{}');
       
       switch (operation) {
         case 'create':
           const id = `${collection}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
           localData[id] = { ...data, id, _local: true, createdAt: new Date().toISOString() };
           break;
         case 'update':
           if (localData[data.id]) {
             localData[data.id] = { ...localData[data.id], ...data, updatedAt: new Date().toISOString() };
           }
           break;
         case 'delete':
           delete localData[data.id];
           break;
         case 'find':
           return Object.values(localData).filter(item => 
             Object.entries(data).every(([key, value]) => item[key] === value)
           );
       }
       
       localStorage.setItem(`diymatch_${collection}`, JSON.stringify(localData));
       return { success: true, data: localData[data.id] || localData };
     }

     async sync() {
       if (!this.isOnline || this.syncQueue.length === 0) return;
       
       const queue = [...this.syncQueue];
       this.syncQueue = [];
       
       for (const item of queue) {
         try {
           await this.query(item.collection, item.operation, item.data);
         } catch (error) {
           this.syncQueue.push(item);
         }
       }
     }

     updateCache(collection, data) {
       this.cache.set(collection, data);
     }
   }

   const db = new DatabaseService();

   // Sync when coming online
   window.addEventListener('online', () => {
     db.isOnline = true;
     db.sync();
   });

   window.addEventListener('offline', () => {
     db.isOnline = false;
   });

   // ============================================================================
   // ENHANCED STATE MANAGEMENT
   // ============================================================================
   
   const registeredUsers = new Map();
   const expertProfiles = new Map();
   const quoteRequests = new Map();
   const bookings = new Map();
   const aiAnalysisHistory = new Map();
   const userAnalysisPurchases = new Map();
   const userFreeAnalyses = new Map();
   const userMessages = new Map();
   const messageThreads = new Map();
   const expertReviews = new Map();
   const savedProjects = new Map();
   const emergencyRequests = new Map();
   const userNotifications = new Map();
   const referralCodes = new Map();
   const expertPortfolios = new Map();
   const voiceNotes = new Map();
   const arSessions = new Map();
   const expertDocuments = new Map();
   const supportTickets = new Map();
   const systemBackups = new Map();
   const userPreferences = new Map();
   const aiSuggestions = new Map();
   const maintenanceSchedules = new Map();
   const priceNegotiations = new Map();
   
   // Parts stores database
   const partsStores = new Map([
     ['london', [
       {
         id: 'store1',
         name: 'B&Q Wembley',
         address: 'Stadium Retail Park, Wembley, HA9 0EW',
         phone: '020 8902 7200',
         distance: '2.3 miles',
         categories: ['plumbing', 'electrical', 'tools', 'paint', 'building'],
         openHours: 'Mon-Sat: 7am-8pm, Sun: 10am-4pm',
         hasParking: true,
         wheelchairAccess: true,
         inStockItems: 847,
         rating: 4.3,
         priceMatch: true
       },
       {
         id: 'store2',
         name: 'Screwfix Camden',
         address: '45 Camden High St, NW1 7JH',
         phone: '020 7387 4488',
         distance: '4.1 miles',
         categories: ['tools', 'electrical', 'plumbing', 'safety'],
         openHours: 'Mon-Fri: 6am-8pm, Sat: 7am-6pm, Sun: 9am-4pm',
         hasParking: false,
         wheelchairAccess: true,
         inStockItems: 523,
         rating: 4.6,
         priceMatch: true
       },
       {
         id: 'store3',
         name: 'Wickes Tottenham',
         address: 'Broad Lane, N15 4QD',
         phone: '020 8808 3366',
         distance: '5.2 miles',
         categories: ['building', 'plumbing', 'paint', 'tools'],
         openHours: 'Mon-Sat: 7am-7pm, Sun: 10am-4pm',
         hasParking: true,
         wheelchairAccess: true,
         inStockItems: 692,
         rating: 4.1,
         priceMatch: false
       }
     ]]
   ]);

   // Enhanced demo expert profiles
   const demoExperts = [
     {
       id: 'expert1',
       name: 'John Smith',
       email: 'john@example.com',
       password: 'password123',
       phone: '07123456789',
       profession: 'Master Plumber',
       postcode: 'NW1',
       location: 'Camden, London',
       bio: 'Professional plumber with 15 years experience. Specialized in emergency repairs, bathroom installations, and eco-friendly solutions. Available 24/7 for emergencies.',
       hourlyRate: 45,
       rating: 4.8,
       reviews: 127,
       completedJobs: 342,
       responseTime: '< 1 hour',
       availability: ['Mon-Fri', 'Weekends', 'Emergency 24/7'],
       certifications: 'City & Guilds Level 3 Plumbing, Water Regulations',
       insurance: 'Public Liability £2M',
       specialties: ['Emergency Repairs', 'Leak Detection', 'Bathroom Installation', 'Eco Solutions'],
       verified: true,
       joinedDate: '2022-03-15',
       languages: ['English', 'Polish'],
       transportMode: 'Van',
       toolsProvided: true,
       guaranteeOffered: '12 months',
       badges: ['Top Rated', 'Quick Response', 'Eco Friendly', '24/7 Available'],
       documents: ['cv_john_smith.pdf', 'cert_plumbing_level3.pdf', 'insurance_2024.pdf'],
       accountStatus: 'verified',
       preferredPayment: ['Cash', 'Bank Transfer', 'Card'],
       minimumCharge: 80,
       emergencyRate: 65,
       averageJobTime: '2.5 hours',
       satisfactionRate: 98
     },
     {
       id: 'expert2',
       name: 'Sarah Johnson',
       email: 'sarah@example.com',
       password: 'password123',
       phone: '07987654321',
       profession: 'Certified Electrician',
       postcode: 'E1',
       location: 'Tower Hamlets, London',
       bio: 'NICEIC approved electrician. Expert in domestic installations, testing, smart home systems, and EV charger installations. Committed to safety and innovation.',
       hourlyRate: 55,
       rating: 4.9,
       reviews: 89,
       completedJobs: 256,
       responseTime: '< 2 hours',
       availability: ['Mon-Sat', 'Emergency weekends'],
       certifications: 'NICEIC Approved, 18th Edition, EV Charging Installation',
       insurance: 'Professional Indemnity £5M',
       specialties: ['Smart Home', 'EV Chargers', 'Safety Inspections', 'LED Upgrades'],
       verified: true,
       joinedDate: '2021-11-08',
       languages: ['English', 'French'],
       transportMode: 'Van',
       toolsProvided: true,
       guaranteeOffered: '18 months',
       badges: ['5 Star Expert', 'Smart Home Pro', 'Safety First', 'EV Specialist'],
       documents: ['cv_sarah_johnson.pdf', 'niceic_cert.pdf', 'ev_training.pdf'],
       accountStatus: 'verified',
       preferredPayment: ['Bank Transfer', 'Card'],
       minimumCharge: 100,
       emergencyRate: 80,
       averageJobTime: '3 hours',
       satisfactionRate: 99
     },
     {
       id: 'expert3',
       name: 'Mike Wilson',
       email: 'mike@example.com',
       password: 'password123',
       phone: '07456789123',
       profession: 'Handyman & Carpenter',
       postcode: 'SW1',
       location: 'Westminster, London',
       bio: 'Versatile handyman with carpentry expertise. No job too small! Specializing in furniture assembly, shelving, repairs, and general maintenance.',
       hourlyRate: 35,
       rating: 4.7,
       reviews: 203,
       completedJobs: 567,
       responseTime: '< 3 hours',
       availability: ['Mon-Sat'],
       certifications: 'City & Guilds Carpentry Level 2',
       insurance: 'Public Liability £1M',
       specialties: ['Furniture Assembly', 'Shelving', 'General Repairs', 'Painting'],
       verified: true,
       joinedDate: '2020-06-22',
       languages: ['English'],
       transportMode: 'Van',
       toolsProvided: true,
       guaranteeOffered: '6 months',
       badges: ['Popular Choice', 'Great Value', 'Reliable'],
       documents: ['cv_mike_wilson.pdf', 'carpentry_cert.pdf'],
       accountStatus: 'verified',
       preferredPayment: ['Cash', 'Bank Transfer'],
       minimumCharge: 60,
       emergencyRate: 50,
       averageJobTime: '2 hours',
       satisfactionRate: 96
     }
   ];

   // Initialize demo data
   demoExperts.forEach(expert => {
     expertProfiles.set(expert.id, expert);
     registeredUsers.set(expert.email.toLowerCase(), {
       ...expert,
       type: 'expert',
       password: expert.password
     });
     
     expertDocuments.set(expert.id, {
       cv: null,
       certifications: [],
       insurance: null,
       uploadedAt: new Date().toISOString()
     });
     
     expertReviews.set(expert.id, [
       {
         id: `review_${expert.id}_1`,
         userName: 'Alice M.',
         rating: 5,
         date: '2024-01-15',
         comment: 'Excellent work! Very professional and efficient. Would definitely recommend.',
         jobType: 'Emergency Repair',
         verified: true,
         helpful: 23,
         images: []
       },
       {
         id: `review_${expert.id}_2`,
         userName: 'David K.',
         rating: 4,
         date: '2024-01-20',
         comment: 'Good service, arrived on time and fixed the issue quickly. Fair pricing.',
         jobType: 'Installation',
         verified: true,
         helpful: 15,
         images: []
       },
       {
         id: `review_${expert.id}_3`,
         userName: 'Emma T.',
         rating: 5,
         date: '2024-02-05',
         comment: 'Amazing experience! Very knowledgeable and went above and beyond.',
         jobType: 'Maintenance',
         verified: true,
         helpful: 31,
         images: []
       }
     ]);
     
     expertPortfolios.set(expert.id, [
       {
         id: `portfolio_${expert.id}_1`,
         title: 'Bathroom Renovation',
         description: 'Complete bathroom makeover with modern fixtures',
         images: ['https://via.placeholder.com/300x200?text=Before', 'https://via.placeholder.com/300x200?text=After'],
         date: '2023-12-01',
         duration: '3 days',
         cost: '£2,500'
       },
       {
         id: `portfolio_${expert.id}_2`,
         title: 'Kitchen Installation',
         description: 'Full kitchen refit including plumbing and electrical work',
         images: ['https://via.placeholder.com/300x200?text=Kitchen+Before', 'https://via.placeholder.com/300x200?text=Kitchen+After'],
         date: '2023-11-15',
         duration: '5 days',
         cost: '£4,000'
       }
     ]);
   });

   // ============================================================================
   // PAYMENT SERVICE
   // ============================================================================
   
   class PaymentService {
     constructor() {
       this.paymentMethods = new Map();
       this.transactions = new Map();
     }

     async processPayment(amount, metadata, paymentMethod = 'card') {
       try {
         const transaction = {
           id: `pay_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
           amount,
           metadata,
           paymentMethod,
           status: 'completed',
           timestamp: new Date().toISOString()
         };
         
         this.transactions.set(transaction.id, transaction);
         
         // Store transaction
         await db.query('transactions', 'create', transaction);
         
         return {
           success: true,
           paymentId: transaction.id,
           amount,
           metadata
         };
       } catch (error) {
         console.error('Payment processing error:', error);
         throw error;
       }
     }

     async refund(paymentId, amount, reason) {
       try {
         const refund = {
           id: `refund_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
           originalPaymentId: paymentId,
           amount,
           reason,
           status: 'completed',
           timestamp: new Date().toISOString()
         };
         
         await db.query('refunds', 'create', refund);
         
         return {
           success: true,
           refundId: refund.id,
           amount,
           reason
         };
       } catch (error) {
         console.error('Refund error:', error);
         throw error;
       }
     }

     async addPaymentMethod(userId, method) {
       const methods = this.paymentMethods.get(userId) || [];
       methods.push(method);
       this.paymentMethods.set(userId, methods);
       return { success: true };
     }
   }

   const paymentService = new PaymentService();

   // ============================================================================
   // ENHANCED AI ANALYSIS SERVICE
   // ============================================================================
   
   class AIAnalysisService {
     constructor() {
       this.analysisCache = new Map();
       this.modelLoaded = false;
     }

     async analyzeImage(imageData, description) {
       try {
         // Enhanced AI analysis with multiple factors
         const analysis = await this.performAnalysis(description, imageData);
         
         // Cache the analysis
         this.analysisCache.set(description, analysis);
         
         return analysis;
       } catch (error) {
         console.error('AI analysis error:', error);
         return this.fallbackAnalysis(description);
       }
     }

     async performAnalysis(description, imageData) {
       const keywords = description.toLowerCase();
       
       // Enhanced pattern matching with confidence scoring
       const patterns = {
         electrical: {
           keywords: ['electric', 'socket', 'wire', 'switch', 'fuse', 'circuit', 'power', 'outlet', 'spark', 'breaker', 'voltage', 'amp', 'watt'],
           severity: 'Critical',
           baseConfidence: 85
         },
         plumbing: {
           keywords: ['leak', 'water', 'pipe', 'tap', 'drain', 'toilet', 'shower', 'sink', 'drip', 'flood', 'pressure', 'valve', 'faucet'],
           severity: 'High',
           baseConfidence: 80
         },
         structural: {
           keywords: ['wall', 'crack', 'ceiling', 'floor', 'foundation', 'damp', 'mold', 'mould', 'subsidence', 'roof', 'beam', 'joist'],
           severity: 'High',
           baseConfidence: 75
         },
         heating: {
           keywords: ['boiler', 'radiator', 'heating', 'cold', 'thermostat', 'gas', 'central heating', 'hot water', 'furnace'],
           severity: 'Critical',
           baseConfidence: 82
         },
         appliance: {
           keywords: ['washing machine', 'dishwasher', 'fridge', 'freezer', 'oven', 'microwave', 'dryer', 'cooker'],
           severity: 'Medium',
           baseConfidence: 78
         },
         pest: {
           keywords: ['mouse', 'rat', 'insect', 'wasp', 'bee', 'ant', 'cockroach', 'pest', 'infestation', 'termite'],
           severity: 'Medium',
           baseConfidence: 70
         }
       };

       // Find best matching pattern
       let bestMatch = null;
       let maxScore = 0;
       let matchedKeywords = [];
       
       for (const [type, config] of Object.entries(patterns)) {
         let score = 0;
         let typeMatchedKeywords = [];
         
         config.keywords.forEach(keyword => {
           if (keywords.includes(keyword)) {
             score += 1;
             typeMatchedKeywords.push(keyword);
             if (keywords.split(' ').includes(keyword)) {
               score += 0.5;
             }
           }
         });
         
         if (score > maxScore) {
           maxScore = score;
           bestMatch = { type, config };
           matchedKeywords = typeMatchedKeywords;
         }
       }

       const confidence = bestMatch 
         ? Math.min(95, bestMatch.config.baseConfidence + (maxScore * 2))
         : 60;

       return this.generateDetailedAnalysis(bestMatch, keywords, confidence, matchedKeywords);
     }

     generateDetailedAnalysis(match, keywords, confidence, matchedKeywords) {
       const isEmergency = keywords.includes('urgent') || keywords.includes('emergency') || keywords.includes('dangerous');
       
       const analysis = {
         problemDetected: match ? this.getProblemName(match.type) : 'General Maintenance Issue',
         confidence: confidence + '%',
         severity: isEmergency ? 'Critical' : (match ? match.config.severity : 'Medium'),
         matchedKeywords,
         description: this.generateDescription(match, isEmergency, confidence),
         isDIYFriendly: this.assessDIYSafety(match, isEmergency),
         estimatedCost: this.estimateCost(match, isEmergency),
         timeToFix: this.estimateTime(match),
         recommendedExpertType: this.getExpertType(match),
         safetyWarnings: this.generateSafetyWarnings(match, isEmergency),
         recommendedParts: this.generatePartsRecommendations(match),
         stepByStepGuide: this.generateStepGuide(match),
         preventiveTips: this.generatePreventiveTips(match),
         urgencyLevel: this.assessUrgency(match, isEmergency),
         toolsRequired: this.generateToolsList(match),
         skillLevel: this.assessSkillLevel(match),
         weatherConsiderations: this.getWeatherConsiderations(match),
         timestamp: new Date().toISOString(),
         
         // New AI features
         aiSuggestions: this.generateAISuggestions(match, keywords),
         alternativeSolutions: this.generateAlternatives(match),
         costSavingTips: this.generateCostSavingTips(match),
         sustainabilityScore: this.calculateSustainabilityScore(match),
         smartHomeIntegration: this.checkSmartHomeCompatibility(match),
         maintenanceSchedule: this.generateMaintenanceSchedule(match),
         warrantyCheck: this.checkWarrantyImplications(match),
         insuranceConsiderations: this.getInsuranceInfo(match)
       };

       return analysis;
     }

     getProblemName(type) {
       const names = {
         electrical: 'Electrical Issue',
         plumbing: 'Plumbing Issue',
         structural: 'Structural/Damp Issue',
         heating: 'Heating/Gas Issue',
         appliance: 'Appliance Malfunction',
         pest: 'Pest Control Issue'
       };
       return names[type] || 'General Maintenance';
     }

     generateDescription(match, isEmergency, confidence) {
       if (!match) {
         return 'General maintenance issue detected. Further inspection recommended to identify specific problem.';
       }

       const urgencyText = isEmergency 
         ? 'This appears to be an urgent issue requiring immediate attention. ' 
         : '';

       const confidenceText = confidence > 85 
         ? 'High confidence analysis indicates ' 
         : confidence > 70 
         ? 'Analysis suggests ' 
         : 'Preliminary analysis indicates ';

       return `${urgencyText}${confidenceText}this is a ${this.getProblemName(match.type).toLowerCase()}. Professional assessment recommended for accurate diagnosis and safe resolution.`;
     }

     assessDIYSafety(match, isEmergency) {
       if (isEmergency) return false;
       if (!match) return true;
       
       const nonDIYTypes = ['electrical', 'heating', 'structural'];
       return !nonDIYTypes.includes(match.type);
     }

     estimateCost(match, isEmergency) {
       const baseCosts = {
         electrical: { min: 100, max: 300 },
         plumbing: { min: 80, max: 200 },
         structural: { min: 150, max: 500 },
         heating: { min: 150, max: 400 },
         appliance: { min: 60, max: 180 },
         pest: { min: 80, max: 250 }
       };

       const costs = match ? baseCosts[match.type] : { min: 50, max: 150 };
       const multiplier = isEmergency ? 1.5 : 1;

       return `£${Math.round(costs.min * multiplier)}-£${Math.round(costs.max * multiplier)}`;
     }

     estimateTime(match) {
       const times = {
         electrical: '2-4 hours',
         plumbing: '1-3 hours',
         structural: '4-8 hours',
         heating: '2-5 hours',
         appliance: '1-2 hours',
         pest: '2-4 hours'
       };

       return match ? times[match.type] : '1-2 hours';
     }

     getExpertType(match) {
       const experts = {
         electrical: 'Electrician',
         plumbing: 'Plumber',
         structural: 'Building Surveyor',
         heating: 'Gas Safe Engineer',
         appliance: 'Appliance Technician',
         pest: 'Pest Control Specialist'
       };

       return match ? experts[match.type] : 'Handyman';
     }

     generateSafetyWarnings(match, isEmergency) {
       const baseWarnings = [];

       if (isEmergency) {
         baseWarnings.push('⚠️ IMMEDIATE ACTION REQUIRED');
         baseWarnings.push('🚨 Ensure safety of all occupants');
       }

       if (!match) {
         return [...baseWarnings, '⚡ Exercise general caution', '🧤 Use appropriate safety equipment'];
       }

       const specificWarnings = {
         electrical: [
           '⚡ Turn off power at circuit breaker',
           '⚠️ Never work on live circuits',
           '🧤 Use insulated tools only',
           '☠️ Risk of electrocution - call professional'
         ],
         plumbing: [
           '💧 Turn off water supply',
           '🪣 Have buckets and towels ready',
           '⚠️ Check for electrical hazards near water',
           '🧤 Wear protective gloves'
         ],
         structural: [
           '🏠 Check structural stability',
           '⚠️ Evacuate if severe damage',
           '📸 Document damage for insurance',
           '🚫 Do not attempt major repairs'
         ],
         heating: [
           '🔥 Turn off gas supply if smell gas',
           '🪟 Ventilate area immediately',
           '🚭 No naked flames',
           '📞 Call Gas Emergency: 0800 111 999'
         ],
         appliance: [
           '🔌 Unplug from power source',
           '⚠️ Check warranty before repairs',
           '📖 Consult user manual',
           '🧊 Allow to cool if hot'
         ],
         pest: [
           '🧤 Wear protective equipment',
           '🚫 Avoid direct contact',
           '🧹 Maintain cleanliness',
           '🏥 Seek medical attention if bitten'
         ]
       };

       return [...baseWarnings, ...(specificWarnings[match.type] || [])];
     }

     generatePartsRecommendations(match) {
       if (!match) {
         return [
           { name: 'Basic Tool Kit', price: '£24.99', priority: 'Essential', availability: 'In Stock' }
         ];
       }

       const partsDatabase = {
         electrical: [
           { name: 'Voltage Tester', price: '£19.99', priority: 'Essential', availability: 'In Stock' },
           { name: 'Wire Nuts Assortment', price: '£8.99', priority: 'Essential', availability: 'In Stock' },
           { name: 'Electrical Tape', price: '£3.49', priority: 'Essential', availability: 'In Stock' },
           { name: 'Circuit Breaker Finder', price: '£34.99', priority: 'Recommended', availability: 'Order' },
           { name: 'Insulated Screwdriver Set', price: '£24.99', priority: 'Essential', availability: 'In Stock' }
         ],
         plumbing: [
           { name: 'Pipe Repair Kit', price: '£12.99', priority: 'Essential', availability: 'In Stock' },
           { name: 'PTFE Tape', price: '£2.49', priority: 'Essential', availability: 'In Stock' },
           { name: 'Adjustable Wrench Set', price: '£15.99', priority: 'Essential', availability: 'In Stock' },
           { name: 'Plumber\'s Putty', price: '£4.99', priority: 'Recommended', availability: 'In Stock' },
           { name: 'Pipe Cutter', price: '£19.99', priority: 'Optional', availability: 'Order' }
         ],
         structural: [
           { name: 'Damp Seal Paint 5L', price: '£24.99', priority: 'Essential', availability: 'In Stock' },
           { name: 'Crack Repair Compound', price: '£8.99', priority: 'Essential', availability: 'In Stock' },
           { name: 'Digital Moisture Meter', price: '£29.99', priority: 'Recommended', availability: 'Order' },
           { name: 'Anti-Mould Treatment', price: '£12.99', priority: 'Essential', availability: 'In Stock' },
           { name: 'Dehumidifier', price: '£149.99', priority: 'Recommended', availability: 'In Stock' }
         ],
         heating: [
           { name: 'Carbon Monoxide Detector', price: '£19.99', priority: 'Essential', availability: 'In Stock' },
           { name: 'Radiator Bleed Key', price: '£2.99', priority: 'Essential', availability: 'In Stock' },
           { name: 'Pipe Insulation', price: '£9.99', priority: 'Recommended', availability: 'In Stock' },
           { name: 'Smart Thermostat', price: '£179.99', priority: 'Optional', availability: 'Order' }
         ],
         appliance: [
           { name: 'Appliance Cleaner', price: '£6.99', priority: 'Essential', availability: 'In Stock' },
           { name: 'Replacement Filters', price: '£14.99', priority: 'Essential', availability: 'Order' },
           { name: 'Multi-meter', price: '£19.99', priority: 'Recommended', availability: 'In Stock' }
         ],
         pest: [
           { name: 'Pest Control Spray', price: '£9.99', priority: 'Essential', availability: 'In Stock' },
           { name: 'Traps Set', price: '£15.99', priority: 'Essential', availability: 'In Stock' },
           { name: 'Sealant Foam', price: '£7.99', priority: 'Recommended', availability: 'In Stock' }
         ]
       };

       return partsDatabase[match.type] || [];
     }

     generateStepGuide(match) {
       if (!match || !this.assessDIYSafety(match, false)) {
         return ['Professional expertise']

const guides = {
      plumbing: [
        '1. 🚰 Turn off water supply at stopcock',
        '2. 📸 Document the issue with photos',
        '3. 🪣 Place buckets under work area',
        '4. 🔍 Identify leak source',
        '5. 🧹 Clean and dry area',
        '6. 🔧 Apply temporary fix if safe',
        '7. 📞 Call expert if beyond basic repair'
      ],
      appliance: [
        '1. 🔌 Disconnect from power',
        '2. 📖 Check user manual',
        '3. 🔍 Inspect for obvious issues',
        '4. 🧹 Clean filters/vents',
        '5. 🔄 Reset if applicable',
        '6. 🧪 Test functionality',
        '7. 📞 Contact manufacturer if under warranty'
      ],
      pest: [
        '1. 🔍 Identify pest type',
        '2. 🧹 Remove food sources',
        '3. 🚪 Seal entry points',
        '4. 🪤 Set appropriate traps',
        '5. 🧼 Deep clean affected areas',
        '6. 📊 Monitor activity',
        '7. 📞 Call specialist if persistent'
      ]
    };

    return guides[match.type] || ['Professional assessment recommended'];
  }

  generatePreventiveTips(match) {
    if (!match) {
      return [
        '📅 Schedule regular maintenance checks',
        '📝 Keep maintenance log',
        '🔧 Learn basic DIY skills',
        '💰 Budget for repairs'
      ];
    }

    const tips = {
      electrical: [
        '⚡ Test RCD monthly',
        '🔌 Check outlets for warmth',
        '💡 Replace old wiring every 25 years',
        '📊 Monitor energy usage',
        '🏠 Annual electrical inspection'
      ],
      plumbing: [
        '💧 Check for drips monthly',
        '🚿 Clean showerheads quarterly',
        '🌡️ Monitor water pressure',
        '❄️ Insulate pipes before winter',
        '🔧 Service boiler annually'
      ],
      structural: [
        '🏠 Clear gutters twice yearly',
        '👀 Inspect roof after storms',
        '💨 Ensure good ventilation',
        '📊 Monitor humidity levels',
        '🔍 Check for cracks seasonally'
      ],
      heating: [
        '🔥 Annual boiler service',
        '🌡️ Bleed radiators seasonally',
        '🚨 Test CO detectors monthly',
        '📅 Replace filters regularly',
        '📊 Track gas usage'
      ],
      appliance: [
        '🧹 Regular cleaning schedule',
        '📖 Follow maintenance guide',
        '🔄 Don\'t overload',
        '⚡ Check power cords',
        '📅 Professional service annually'
      ],
      pest: [
        '🧹 Maintain cleanliness',
        '🚪 Seal gaps and cracks',
        '🗑️ Proper waste management',
        '🌿 Trim vegetation',
        '🔍 Regular inspections'
      ]
    };

    return tips[match.type] || [];
  }

  assessUrgency(match, isEmergency) {
    if (isEmergency) return 'Immediate';
    
    if (!match) return 'Low';
    
    const urgencyLevels = {
      electrical: 'High',
      plumbing: 'Medium-High',
      structural: 'Medium',
      heating: 'High',
      appliance: 'Low-Medium',
      pest: 'Low-Medium'
    };

    return urgencyLevels[match.type] || 'Medium';
  }

  generateToolsList(match) {
    if (!match) {
      return [
        { name: 'Screwdriver Set', essential: true },
        { name: 'Hammer', essential: true },
        { name: 'Pliers', essential: true }
      ];
    }

    const tools = {
      plumbing: [
        { name: 'Adjustable Wrench', essential: true },
        { name: 'Pipe Cutter', essential: false },
        { name: 'Plunger', essential: true },
        { name: 'PTFE Tape', essential: true }
      ],
      electrical: [
        { name: 'Voltage Tester', essential: true },
        { name: 'Insulated Screwdrivers', essential: true },
        { name: 'Wire Strippers', essential: true }
      ],
      structural: [
        { name: 'Spirit Level', essential: true },
        { name: 'Measuring Tape', essential: true },
        { name: 'Trowel', essential: false }
      ]
    };

    return tools[match.type] || [];
  }

  assessSkillLevel(match) {
    if (!match) return 'Beginner';
    
    const levels = {
      electrical: 'Professional Only',
      plumbing: 'Intermediate-Advanced',
      structural: 'Professional Only',
      heating: 'Professional Only',
      appliance: 'Beginner-Intermediate',
      pest: 'Beginner-Intermediate'
    };

    return levels[match.type] || 'Intermediate';
  }

  getWeatherConsiderations(match) {
    if (!match) return 'Check weather before outdoor work';
    
    const considerations = {
      plumbing: 'Freezing temperatures can worsen pipe issues',
      structural: 'Avoid repairs during rain/storms',
      heating: 'Cold weather increases urgency',
      electrical: 'Never work in wet conditions'
    };

    return considerations[match.type] || 'Weather may affect repair timing';
  }

  generateAISuggestions(match, keywords) {
    const suggestions = [];

    if (match && match.type === 'plumbing' && keywords.includes('leak')) {
      suggestions.push({
        type: 'immediate',
        action: 'Place bucket under leak and turn off water supply',
        confidence: 95
      });
    }

    if (keywords.includes('noise') || keywords.includes('sound')) {
      suggestions.push({
        type: 'diagnostic',
        action: 'Record the sound for expert diagnosis',
        confidence: 85
      });
    }

    suggestions.push({
      type: 'preventive',
      action: 'Schedule regular maintenance to prevent future issues',
      confidence: 90
    });

    return suggestions;
  }

  generateAlternatives(match) {
    if (!match) return [];

    const alternatives = {
      plumbing: [
        'Temporary pipe repair tape for quick fix',
        'Call emergency plumber for severe leaks',
        'DIY repair kit from local store'
      ],
      electrical: [
        'Use battery-powered alternatives temporarily',
        'Check if covered by home warranty',
        'Emergency electrician callout'
      ],
      heating: [
        'Portable heaters as temporary solution',
        'Check boiler pressure yourself',
        'Emergency gas engineer'
      ]
    };

    return alternatives[match.type] || ['Consult multiple experts for quotes'];
  }

  generateCostSavingTips(match) {
    const tips = [
      'Get multiple quotes from experts',
      'Check if covered by insurance',
      'Buy parts yourself if expert allows',
      'Consider off-peak timing for non-urgent repairs'
    ];

    if (match && match.type === 'appliance') {
      tips.push('Check warranty before paying for repairs');
      tips.push('Compare repair vs replacement costs');
    }

    return tips;
  }

  calculateSustainabilityScore(match) {
    let score = 70; // Base score

    if (match) {
      if (match.type === 'heating') score += 10; // Energy efficiency impact
      if (match.type === 'plumbing') score += 15; // Water conservation
      if (match.type === 'electrical') score += 5; // Potential for energy saving
    }

    return {
      score: Math.min(100, score),
      tips: [
        'Choose eco-friendly materials',
        'Consider energy-efficient upgrades',
        'Properly dispose of old materials'
      ]
    };
  }

  checkSmartHomeCompatibility(match) {
    if (!match) return { compatible: false, suggestions: [] };

    const compatibility = {
      electrical: {
        compatible: true,
        suggestions: ['Smart switches', 'Smart outlets', 'Energy monitoring']
      },
      heating: {
        compatible: true,
        suggestions: ['Smart thermostat', 'Smart TRVs', 'Zone control']
      },
      plumbing: {
        compatible: true,
        suggestions: ['Leak detectors', 'Smart water shut-off', 'Usage monitors']
      },
      appliance: {
        compatible: true,
        suggestions: ['Smart plugs', 'Energy monitoring', 'Remote control']
      }
    };

    return compatibility[match.type] || { compatible: false, suggestions: [] };
  }

  generateMaintenanceSchedule(match) {
    if (!match) {
      return {
        immediate: ['Address current issue'],
        monthly: ['Visual inspection'],
        annually: ['Professional check']
      };
    }

    const schedules = {
      plumbing: {
        immediate: ['Fix current issue'],
        monthly: ['Check for leaks', 'Test water pressure'],
        quarterly: ['Clean aerators', 'Check under sinks'],
        annually: ['Service boiler', 'Inspect all pipes']
      },
      electrical: {
        immediate: ['Address safety issues'],
        monthly: ['Test RCD', 'Check outlets'],
        quarterly: ['Inspect visible wiring'],
        annually: ['Professional inspection']
      },
      heating: {
        immediate: ['Ensure safe operation'],
        monthly: ['Check pressure', 'Test controls'],
        seasonally: ['Bleed radiators', 'Check filters'],
        annually: ['Full service', 'Safety check']
      }
    };

    return schedules[match.type] || {};
  }

  checkWarrantyImplications(match) {
    return {
      warning: 'DIY repairs may void warranties',
      advice: 'Check warranty terms before attempting repairs',
      covered: match && match.type === 'appliance' ? 'Possibly' : 'Unlikely'
    };
  }

  getInsuranceInfo(match) {
    const info = {
      electrical: 'May be covered if caused by power surge',
      plumbing: 'Water damage often covered, pipes may not be',
      structural: 'Check building insurance policy',
      heating: 'Boiler cover may apply',
      appliance: 'Check home warranty or appliance insurance',
      pest: 'Rarely covered by standard policies'
    };

    return {
      likelihood: match ? info[match.type] : 'Check your policy',
      action: 'Document everything with photos for claims'
    };
  }

  fallbackAnalysis(description) {
    return {
      problemDetected: 'General Maintenance Issue',
      confidence: '60%',
      severity: 'Medium',
      description: 'Unable to perform detailed analysis. Please ensure good lighting and clear description.',
      isDIYFriendly: false,
      estimatedCost: '£50-£200',
      timeToFix: '1-4 hours',
      recommendedExpertType: 'General Handyman',
      safetyWarnings: ['Use appropriate safety equipment', 'Consult professional if unsure'],
      recommendedParts: [],
      timestamp: new Date().toISOString()
    };
  }
}

const aiService = new AIAnalysisService();

// ============================================================================
// EMAIL SERVICE
// ============================================================================

class EmailService {
  constructor() {
    this.templates = {
      welcome: (user) => ({
        subject: 'Welcome to DIYMatch! 🔧',
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h2 style="color: #2563eb;">Welcome ${user.name}!</h2>
            <p>Thank you for joining DIYMatch, your AI-powered DIY assistant.</p>
            <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
              <h3>What you can do now:</h3>
              <ul>
                <li>🤖 Get your first AI analysis FREE this month</li>
                <li>👨‍🔧 Connect with verified local experts</li>
                <li>🛠️ Find parts at nearby stores</li>
                <li>💰 Share your referral code: <strong>${user.referralCode}</strong></li>
              </ul>
            </div>
            <p>Need help? Reply to this email or call ${APP_CONFIG.emergencyHotline}</p>
          </div>
        `,
        text: `Welcome ${user.name}! Thank you for joining DIYMatch.`
      }),
      
      bookingConfirmation: (booking, user, expert) => ({
        subject: `Booking Confirmed - ${expert.name} on ${new Date(booking.date).toLocaleDateString()}`,
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h2 style="color: #2563eb;">Booking Confirmation</h2>
            <div style="border: 2px solid #e5e7eb; padding: 20px; border-radius: 8px;">
              <h3>📅 Appointment Details</h3>
              <p><strong>Expert:</strong> ${expert.name} (${expert.profession})</p>
              <p><strong>Date:</strong> ${new Date(booking.date).toLocaleDateString()}</p>
              <p><strong>Time:</strong> ${booking.time}</p>
              <p><strong>Location:</strong> ${booking.location || user.postcode}</p>
              <p><strong>Estimated Duration:</strong> ${booking.estimatedDuration}</p>
              <p><strong>Total Cost:</strong> £${booking.totalCost}</p>
            </div>
            <p style="margin-top: 20px;">The expert will contact you before arrival.</p>
          </div>
        `,
        text: `Booking confirmed with ${expert.name} on ${new Date(booking.date).toLocaleDateString()}`
      }),
      
      analysisComplete: (analysis, user) => ({
        subject: `Your DIY Analysis is Ready! - ${analysis.problemDetected}`,
        html: `
          <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <h2 style="color: #2563eb;">AI Analysis Complete</h2>
            <div style="background: #f3f4f6; padding: 20px; border-radius: 8px;">
              <h3>Problem Detected: ${analysis.problemDetected}</h3>
              <p><strong>Severity:</strong> ${analysis.severity}</p>
              <p><strong>Estimated Cost:</strong> ${analysis.estimatedCost}</p>
              <p><strong>DIY Friendly:</strong> ${analysis.isDIYFriendly ? 'Yes' : 'No - Professional Required'}</p>
            </div>
            <p style="margin-top: 20px;">
              <a href="#" style="background: #2563eb; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px;">
                View Full Analysis
              </a>
            </p>
          </div>
        `,
        text: `AI Analysis complete: ${analysis.problemDetected}`
      })
    };
  }

  async send(to, template, data) {
    try {
      const emailContent = typeof template === 'string' 
        ? this.templates[template](data)
        : template;
      
      console.log('Email sent:', { to, ...emailContent });
      
      // Store email record
      await db.query('emails', 'create', {
        to,
        ...emailContent,
        sentAt: new Date().toISOString()
      });
      
      return { success: true };
    } catch (error) {
      console.error('Email service error:', error);
      return { success: false, error: error.message };
    }
  }

  async sendBulk(recipients, template, data) {
    const results = await Promise.all(
      recipients.map(to => this.send(to, template, data))
    );
    return results;
  }
}

const emailService = new EmailService();

// ============================================================================
// NOTIFICATION SERVICE
// ============================================================================

class NotificationService {
  constructor() {
    this.permission = 'default';
    this.checkPermission();
  }

  async checkPermission() {
    if ('Notification' in window) {
      this.permission = Notification.permission;
      if (this.permission === 'default') {
        this.permission = await Notification.requestPermission();
      }
    }
  }

  async send(title, options = {}) {
    if (this.permission === 'granted') {
      const notification = new Notification(title, {
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">🔧</text></svg>',
        badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="0.9em" font-size="90">🔧</text></svg>',
        ...options
      });

      notification.onclick = () => {
        window.focus();
        notification.close();
      };

      return notification;
    }
  }

  async sendPush(userId, notification) {
    if (!userNotifications.has(userId)) {
      userNotifications.set(userId, []);
    }
    
    const notificationData = {
      id: `notif_${Date.now()}`,
      ...notification,
      timestamp: new Date().toISOString(),
      read: false
    };
    
    userNotifications.get(userId).push(notificationData);
    
    // Show browser notification if user is logged in
    const currentUser = getCurrentUser();
    if (currentUser && currentUser.id === userId) {
      await this.send(notification.title, {
        body: notification.body,
        tag: notificationData.id
      });
    }
    
    return notificationData;
  }
}

const notificationService = new NotificationService();

// ============================================================================
// ANALYTICS SERVICE
// ============================================================================

class AnalyticsService {
  constructor() {
    this.events = [];
    this.sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    this.userId = null;
  }

  setUser(userId) {
    this.userId = userId;
  }

  track(eventName, parameters = {}) {
    const event = {
      name: eventName,
      parameters,
      timestamp: new Date().toISOString(),
      sessionId: this.sessionId,
      userId: this.userId
    };
    
    this.events.push(event);
    console.log('Analytics event:', event);
    
    // Store in IndexedDB
    db.query('analytics', 'create', event);
  }

  trackPageView(pageName) {
    this.track('page_view', { page_name: pageName });
  }

  trackUserAction(action, category, label, value) {
    this.track(action, {
      event_category: category,
      event_label: label,
      value: value
    });
  }

  trackError(error, fatal = false) {
    this.track('exception', {
      description: error.message || error,
      fatal: fatal
    });
  }

  trackConversion(type, value) {
    this.track('conversion', {
      conversion_type: type,
      value: value,
      currency: 'GBP'
    });
  }

  getAnalytics() {
    const sessions = this.events.reduce((acc, event) => {
      if (!acc[event.sessionId]) {
        acc[event.sessionId] = [];
      }
      acc[event.sessionId].push(event);
      return acc;
    }, {});

    return {
      totalEvents: this.events.length,
      uniqueSessions: Object.keys(sessions).length,
      eventTypes: [...new Set(this.events.map(e => e.name))],
      sessions
    };
  }
}

const analytics = new AnalyticsService();

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

let currentUser = null;

const getCurrentUser = () => currentUser;
const setCurrentUser = (user) => {
  currentUser = user;
  if (user) {
    analytics.setUser(user.id);
  }
};

const triggerHaptic = (type = 'light') => {
  if ('vibrate' in navigator) {
    const patterns = {
      light: 50,
      medium: 100,
      heavy: 200,
      success: [50, 100, 50],
      error: [100, 50, 100],
      warning: [200, 100, 200],
      double: [50, 50, 50],
      long: 500
    };
    navigator.vibrate(patterns[type] || 50);
  }
};

const takePhoto = () => {
  return new Promise((resolve) => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment';
    
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (file) {
        if (file.size > APP_CONFIG.maxImageSize) {
          alert(`Image must be less than ${APP_CONFIG.maxImageSize / 1024 / 1024}MB`);
          return;
        }
        
        const reader = new FileReader();
        reader.onload = (event) => resolve({ 
          type: 'image', 
          data: event.target.result, 
          file,
          metadata: {
            size: file.size,
            type: file.type,
            lastModified: file.lastModified
          }
        });
        reader.readAsDataURL(file);
      }
    };
    
    input.click();
  });
};

const takeVideo = () => {
  return new Promise((resolve) => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'video/*';
    input.capture = 'environment';
    
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (file && file.size <= APP_CONFIG.maxVideoSize) {
        const reader = new FileReader();
        reader.onload = (event) => resolve({ 
          type: 'video', 
          data: event.target.result, 
          file,
          metadata: {
            size: file.size,
            type: file.type,
            lastModified: file.lastModified
          }
        });
        reader.readAsDataURL(file);
      } else if (file) {
        alert(`Video must be less than ${APP_CONFIG.maxVideoSize / 1024 / 1024}MB`);
      }
    };
    
    input.click();
  });
};

const recordVoiceNote = () => {
  return new Promise(async (resolve) => {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert('Voice recording not supported on this device');
      resolve(null);
      return;
    }

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const mediaRecorder = new MediaRecorder(stream);
      const chunks = [];
      
      mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
      
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const reader = new FileReader();
        
        reader.onload = (event) => {
          resolve({
            type: 'voice',
            data: event.target.result,
            duration: chunks.length,
            timestamp: new Date().toISOString()
          });
        };
        
        reader.readAsDataURL(blob);
        stream.getTracks().forEach(track => track.stop());
      };
      
      // Start recording
      mediaRecorder.start();
      
      // Stop after 30 seconds max
      setTimeout(() => {
        if (mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
        }
      }, 30000);
      
      // Add UI for stopping recording
      const stopButton = confirm('Recording... Click OK to stop');
      if (stopButton || true) {
        mediaRecorder.stop();
      }
    } catch (error) {
      console.error('Voice recording error:', error);
      alert('Failed to access microphone');
      resolve(null);
    }
  });
};

const getUserLocation = async () => {
  return new Promise((resolve) => {
    if ('geolocation' in navigator) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          resolve({
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy,
            timestamp: position.timestamp
          });
        },
        (error) => {
          console.error('Location error:', error);
          resolve({ error: error.message });
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    } else {
      resolve({ error: 'Geolocation not supported' });
    }
  });
};

const formatCurrency = (amount) => {
  return new Intl.NumberFormat('en-GB', {
    style: 'currency',
    currency: 'GBP'
  }).format(amount);
};

const formatDate = (date) => {
  return new Intl.DateTimeFormat('en-GB', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  }).format(new Date(date));
};

const generateReferralCode = (userId) => {
  const code = `DIY${userId.substring(5, 9).toUpperCase()}${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
  referralCodes.set(code, {
    userId,
    uses: 0,
    earnings: 0,
    created: new Date().toISOString()
  });
  return code;
};

const checkFreeAnalysisAvailable = (userEmail) => {
  const currentMonth = new Date().toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
  const userRecord = userFreeAnalyses.get(userEmail);
  
  if (!userRecord || userRecord.month !== currentMonth) {
    return true;
  }
  
  return userRecord.used < APP_CONFIG.freeAnalysesPerMonth;
};

const useFreeAnalysis = (userEmail) => {
  const currentMonth = new Date().toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
  const userRecord = userFreeAnalyses.get(userEmail) || { month: currentMonth, used: 0 };
  
  if (userRecord.month !== currentMonth) {
    userRecord.month = currentMonth;
    userRecord.used = 0;
  }
  
  userRecord.used++;
  userRecord.lastUsed = new Date().toISOString();
  userFreeAnalyses.set(userEmail, userRecord);
  
  analytics.track('free_analysis_used', { userEmail, month: currentMonth });
};

// ============================================================================
// DATABASE OPERATIONS
// ============================================================================

const dbOperations = {
  async createUser(userData) {
    try {
      const user = {
        id: `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        ...userData,
        createdAt: new Date().toISOString(),
        analysisCount: 0,
        totalSpent: 0,
        referralCode: generateReferralCode(`user_${Date.now()}`),
        settings: {
          notifications: true,
          newsletter: false,
          theme: 'light',
          language: 'en'
        },
        savedExperts: [],
        savedProjects: [],
        achievements: []
      };
      
      registeredUsers.set(userData.email.toLowerCase(), user);
      await db.query('users', 'create', user);
      
      // Send welcome email
      await emailService.send(userData.email, 'welcome', user);
      
      analytics.track('user_created', { userType: userData.userType });
      return { success: true, user };
    } catch (error) {
      console.error('Create user error:', error);
      throw error;
    }
  },

  async createExpert(expertData) {
    try {
      const expert = {
        id: `expert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        ...expertData,
        createdAt: new Date().toISOString(),
        verified: false,
        rating: 0,
        reviews: 0,
        completedJobs: 0,
        badges: [],
        accountStatus: 'pending_verification',
        earnings: 0,
        responseRate: 100,
        cancelRate: 0
      };
      
      expertProfiles.set(expert.id, expert);
      registeredUsers.set(expert.email.toLowerCase(), {
        ...expert,
        type: 'expert'
      });
      
      await db.query('experts', 'create', expert);
      
      analytics.track('expert_created', { profession: expertData.profession });
      return { success: true, expert };
    } catch (error) {
      console.error('Create expert error:', error);
      throw error;
    }
  },

  async saveAnalysis(analysisData) {
    try {
      const analysis = {
        id: `analysis_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        ...analysisData,
        timestamp: new Date().toISOString()
      };
      
      if (!aiAnalysisHistory.has(analysisData.userEmail)) {
        aiAnalysisHistory.set(analysisData.userEmail, []);
      }
      aiAnalysisHistory.get(analysisData.userEmail).unshift(analysis);
      
      await db.query('analyses', 'create', analysis);
      
      // Update user's analysis count
      const user = registeredUsers.get(analysisData.userEmail);
      if (user) {
        user.analysisCount++;
        registeredUsers.set(analysisData.userEmail, user);
      }
      
      // Send analysis complete email
      await emailService.send(analysisData.userEmail, 'analysisComplete', { analysis, user });
      
      analytics.track('analysis_completed', { 
        problemType: analysisData.problemDetected, 
        severity: analysisData.severity 
      });
      
      return { success: true, analysis };
    } catch (error) {
      console.error('Save analysis error:', error);
      throw error;
    }
  },

  async createBooking(bookingData) {
    try {
      const booking = {
        id: `booking_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        ...bookingData,
        status: 'confirmed',
        createdAt: new Date().toISOString(),
        updates: [],
        chatEnabled: true
      };
      
      if (!bookings.has(bookingData.userEmail)) {
        bookings.set(bookingData.userEmail, []);
      }
      bookings.get(bookingData.userEmail).push(booking);
      
      await db.query('bookings', 'create', booking);
      
      // Send confirmation emails
      const user = registeredUsers.get(bookingData.userEmail);
      const expert = expertProfiles.get(bookingData.expertId);
      
      if (user && expert) {
        await emailService.send(user.email, 'bookingConfirmation', { booking, user, expert });
        await emailService.send(expert.email, 'bookingConfirmation', { booking, user, expert });
      }
      
      // Send push notifications
      await notificationService.sendPush(bookingData.userEmail, {
        title: 'Booking Confirmed!',
        body: `Your appointment with ${expert.name} is confirmed`
      });
      
      await notificationService.sendPush(expert.id, {
        title: 'New Booking!',
        body: `You have a new booking with ${user.name}`
      });
      
      analytics.trackConversion('booking', bookingData.totalCost);
      
      return { success: true, booking };
    } catch (error) {
      console.error('Create booking error:', error);
      throw error;
    }
  },

  async createEmergencyRequest(requestData) {
    try {
      const emergency = {
        id: `emergency_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        ...requestData,
        timestamp: new Date().toISOString(),
        status: 'active',
        respondedExperts: [],
        location: await getUserLocation()
      };
      
      emergencyRequests.set(emergency.id, emergency);
      await db.query('emergencies', 'create', emergency);
      
      // Alert available experts
      const availableExperts = Array.from(expertProfiles.values()).filter(expert => {
        const matchesCategory = expert.specialties.some(s => 
          s.toLowerCase().includes(requestData.category.toLowerCase())
        );
        const isAvailable = expert.availability.includes('Emergency 24/7');
        const isVerified = expert.verified;
        return matchesCategory && isAvailable && isVerified;
      });
      
      // Send notifications to all matching experts
      for (const expert of availableExperts) {
        await notificationService.sendPush(expert.id, {
          title: '🚨 EMERGENCY REQUEST',
          body: requestData.description,
          requiresInteraction: true,
          tag: 'emergency',
          data: emergency
        });
      }
      
      analytics.track('emergency_created', { 
        category: requestData.category, 
        notifiedExperts: availableExperts.length 
      });
      
      return { success: true, emergency, notifiedExperts: availableExperts.length };
    } catch (error) {
      console.error('Create emergency error:', error);
      throw error;
    }
  },

  async createQuoteRequest(quoteData) {
    try {
      const quote = {
        id: `quote_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        ...quoteData,
        status: 'pending',
        createdAt: new Date().toISOString(),
        responses: []
      };
      
      if (!quoteRequests.has(quoteData.userEmail)) {
        quoteRequests.set(quoteData.userEmail, []);
      }
      quoteRequests.get(quoteData.userEmail).push(quote);
      
      await db.query('quotes', 'create', quote);
      
      // Notify relevant experts
      const relevantExperts = Array.from(expertProfiles.values()).filter(expert => 
        expert.profession.toLowerCase().includes(quoteData.category.toLowerCase()) &&
        expert.accountStatus === 'verified'
      );
      
      for (const expert of relevantExperts) {
        await notificationService.sendPush(expert.id, {
          title: 'New Quote Request',
          body: `${quoteData.urgency === 'urgent' ? '🚨 URGENT: ' : ''}${quoteData.description.substring(0, 50)}...`,
          data: quote
        });
      }
      
      analytics.track('quote_requested', { 
        category: quoteData.category, 
        urgency: quoteData.urgency 
      });
      
      return { success: true, quote };
    } catch (error) {
      console.error('Create quote error:', error);
      throw error;
    }
  },

  async createReview(reviewData) {
    try {
      const review = {
        id: `review_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        ...reviewData,
        timestamp: new Date().toISOString(),
        verified: true,
        helpful: 0
      };
      
      if (!expertReviews.has(reviewData.expertId)) {
        expertReviews.set(reviewData.expertId, []);
      }
      expertReviews.get(reviewData.expertId).push(review);
      
      await db.query('reviews', 'create', review);
      
      // Update expert's rating
      const expert = expertProfiles.get(reviewData.expertId);
      if (expert) {
        const allReviews = expertReviews.get(reviewData.expertId);
        const totalRating = allReviews.reduce((sum, r) => sum + r.rating, 0);
        expert.rating = parseFloat((totalRating / allReviews.length).toFixed(1));
        expert.reviews = allReviews.length;
        
        // Award badges
        if (expert.rating >= 4.9 && expert.reviews >= 50) {
          if (!expert.badges.includes('Top Rated')) {
            expert.badges.push('Top Rated');
          }
        }
        
        expertProfiles.set(reviewData.expertId, expert);
      }
      
      analytics.track('review_created', { 
        expertId: reviewData.expertId, 
        rating: reviewData.rating 
      });
      
      return { success: true, review };
    } catch (error) {
      console.error('Create review error:', error);
      throw error;
    }
  }
};

// ============================================================================
// REACT COMPONENTS
// ============================================================================

const { useState, useEffect, useContext, createContext, useRef, useCallback, useMemo } = React;

// Contexts
const AuthContext = createContext();
const ThemeContext = createContext();
const NotificationContext = createContext();

// Custom Hooks
const useAuth = () => useContext(AuthContext);
const useTheme = () => useContext(ThemeContext);
const useNotifications = () => useContext(NotificationContext);

const useLocalStorage = (key, initialValue) => {
  const [storedValue, setStoredValue] = useState(() => {
    try {
      const item = window.localStorage.getItem(key);
      return item ? JSON.parse(item) : initialValue;
    } catch (error) {
      console.error('LocalStorage error:', error);
      return initialValue;
    }
  });

  const setValue = useCallback((value) => {
    try {
      setStoredValue(value);
      window.localStorage.setItem(key, JSON.stringify(value));
    } catch (error) {
      console.error('LocalStorage error:', error);
    }
  }, [key]);

  return [storedValue, setValue];
};

const useDebounce = (value, delay) => {
  const [debouncedValue, setDebouncedValue] = useState(value);

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedValue(value);
    }, delay);

    return () => clearTimeout(handler);
  }, [value, delay]);

  return debouncedValue;
};

// ============================================================================
// SHARED COMPONENTS
// ============================================================================

const LoadingSpinner = ({ size = 'medium', color = 'blue' }) => {
  const sizeClasses = {
    small: 'w-4 h-4',
    medium: 'w-8 h-8',
    large: 'w-12 h-12'
  };
  
  return React.createElement('div', {
    className: `${sizeClasses[size]} border-4 border-${color}-600 border-t-transparent rounded-full animate-spin`
  });
};

const EmptyState = ({ icon, title, description, action }) => {
  return React.createElement('div', { className: 'text-center py-12 fade-in' },
    React.createElement('div', { className: 'text-6xl mb-4 opacity-50' }, icon),
    React.createElement('h3', { className: 'text-xl font-semibold mb-2' }, title),
    React.createElement('p', { className: 'text-gray-600 mb-4' }, description),
    action
  );
};

const ProgressSteps = ({ steps, currentStep }) => {
  return React.createElement('div', { className: 'progress-steps mb-6' },
    steps.map((step, index) =>
      React.createElement('div', {
        key: index,
        className: `progress-step ${
          index < currentStep ? 'completed' : 
          index === currentStep ? 'active' : ''
        }`
      },
        React.createElement('div', { className: 'progress-step-circle' },
          index < currentStep ? '✓' : index + 1
        ),
        React.createElement('div', { className: 'text-xs mt-1' }, step)
      )
    )
  );
};

const StarRating = ({ rating, onRate, readonly = false, size = 'medium' }) => {
  const [hover, setHover] = useState(0);
  
  const sizes = {
    small: 'text-sm',
    medium: 'text-xl',
    large: 'text-2xl'
  };
  
  return React.createElement('div', { className: 'star-rating' },
    [1, 2, 3, 4, 5].map((star) =>
      React.createElement('span', {
        key: star,
        className: `star ${star <= (hover || rating) ? 'filled' : ''} ${sizes[size]}`,
        onClick: () => {
          if (!readonly && onRate) {
            onRate(star);
            triggerHaptic('light');
          }
        },
        onMouseEnter: () => !readonly && setHover(star),
        onMouseLeave: () => !readonly && setHover(0),
        style: { cursor: readonly ? 'default' : 'pointer' }
      }, '★')
    )
  );
};

const Modal = ({ isOpen, onClose, title, children, size = 'medium' }) => {
  useEffect(() => {
    if (isOpen) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
    
    return () => {
      document.body.style.overflow = '';
    };
  }, [isOpen]);
  
  if (!isOpen) return null;
  
  const sizes = {
    small: 'max-w-sm',
    medium: 'max-w-md',
    large: 'max-w-2xl',
    full: 'max-w-4xl'
  };
  
  return React.createElement('div', {
    className: 'modal-backdrop',
    onClick: (e) => {
      if (e.target.className.includes('modal-backdrop')) {
        onClose();
        triggerHaptic('light');
      }
    }
  },
    React.createElement('div', { className: `modal-content ${sizes[size]}` },
      React.createElement('div', { className: 'flex justify-between items-center mb-4' },
        React.createElement('h2', { className: 'text-xl font-semibold' }, title),
        React.createElement('button', {
          onClick: () => {
            onClose();
            triggerHaptic('light');
          },
          className: 'text-gray-500 hover:text-gray-700 text-2xl mobile-touch'
        }, '×')
      ),
      children
    )
  );
};

const SuccessAnimation = ({ message }) => {
  return React.createElement('div', { className: 'text-center' },
    React.createElement('div', { className: 'success-animation mb-4' },
      React.createElement('div', { className: 'text-white text-5xl' }, '✓')
    ),
    React.createElement('h3', { className: 'text-xl font-semibold' }, message)
  );
};

const AISuggestionCard = ({ suggestion, onAccept, onReject }) => {
  return React.createElement('div', { className: 'ai-suggestion' },
    React.createElement('div', { className: 'flex justify-between items-start mb-2' },
      React.createElement('h4', { className: 'font-semibold' }, 'AI Suggestion'),
      React.createElement('span', { className: 'text-sm text-gray-600' }, 
        `${suggestion.confidence}% confidence`
      )
    ),
    React.createElement('p', { className: 'text-sm mb-3' }, suggestion.action),
    React.createElement('div', { className: 'flex gap-2' },
      React.createElement('button', {
        onClick: () => {
          onAccept();
          triggerHaptic('success');
        },
        className: 'px-3 py-1 bg-blue-600 text-white rounded-lg text-sm mobile-touch'
      }, 'Accept'),
      React.createElement('button', {
        onClick: () => {
          onReject();
          triggerHaptic('light');
        },
        className: 'px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-sm mobile-touch'
      }, 'Dismiss')
    )
  );
};

const FileUploadZone = ({ onUpload, accept, multiple = false, maxSize }) => {
  const [isDragging, setIsDragging] = useState(false);
  const fileInputRef = useRef(null);
  
  const handleDrop = useCallback((e) => {
    e.preventDefault();
    setIsDragging(false);
    
    const files = Array.from(e.dataTransfer.files);
    handleFiles(files);
  }, []);
  
  const handleDragOver = useCallback((e) => {
    e.preventDefault();
    setIsDragging(true);
  }, []);
  
  const handleDragLeave = useCallback(() => {
    setIsDragging(false);
  }, []);
  
  const handleFiles = (files) => {
    const validFiles = files.filter(file => {
      if (maxSize && file.size > maxSize) {
        alert(`File ${file.name} is too large`);
        return false;
      }
      return true;
    });
    
    if (!multiple && validFiles.length > 1) {
      onUpload([validFiles[0]]);
    } else {
      onUpload(validFiles);
    }
  };
  
  return React.createElement('div', {
    className: `file-upload-zone ${isDragging ? 'drag-over' : ''}`,
    onDrop: handleDrop,
    onDragOver: handleDragOver,
    onDragLeave: handleDragLeave,
    onClick: () => fileInputRef.current?.click()
  },
    React.createElement('input', {
      ref: fileInputRef,
      type: 'file',
      accept: accept,
      multiple: multiple,
      style: { display: 'none' },
      onChange: (e) => handleFiles(Array.from(e.target.files))
    }),
    React.createElement('div', { className: 'text-4xl mb-2' }, '📁'),
    React.createElement('p', { className: 'font-semibold mb-1' }, 
      isDragging ? 'Drop files here' : 'Drop files or click to upload'
    ),
    React.createElement('p', { className: 'text-sm text-gray-500' },
      accept ? `Accepted: ${accept}` : 'All file types accepted'
    )
  );
};

// ============================================================================
// MAIN APP PAGES
// ============================================================================

const WelcomePage = ({ onGetStarted, onLoginExpert }) => {
  const [showVideo, setShowVideo] = useState(false);
  
  useEffect(() => {
    analytics.trackPageView('welcome');
  }, []);
  
  return React.createElement('div', { 
    className: 'min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 smooth-scroll' 
  },
    React.createElement('div', { className: 'safe-area-top' },
      React.createElement('div', { className: 'container mx-auto px-4 py-8' },
        // Hero Section
        React.createElement('div', { className: 'text-center mb-12 fade-in' },
          React.createElement('div', { className: 'text-6xl mb-4 float-animation' }, '🔧'),
          React.createElement('h1', { className: 'text-5xl font-bold mb-4' }, 'DIYMatch'),
          React.createElement('p', { className: 'text-xl text-gray-600 max-w-2xl mx-auto' }, 
            'AI-powered DIY assistant that instantly analyzes your home problems and connects you with verified local experts'
          )
        ),

        // Main Card
        React.createElement('div', { 
          className: 'bg-white rounded-2xl shadow-xl p-8 max-w-4xl mx-auto mb-8 fade-in' 
        },
          React.createElement('h2', { className: 'text-3xl font-bold text-center mb-8' }, 
            'Fix It Right, Every Time'
          ),
          
          // Features Grid
          React.createElement('div', { className: 'grid md:grid-cols-3 gap-8 mb-8' },
            React.createElement('div', { className: 'feature-card' },
              React.createElement('div', { className: 'feature-icon' }, '📸'),
              React.createElement('h3', { className: 'text-xl font-semibold mb-2' }, 'AI Analysis'),
              React.createElement('p', { className: 'text-gray-600' }, 
                'Snap a photo and get instant expert analysis with cost estimates'
              )
            ),
            React.createElement('div', { className: 'feature-card' },
              React.createElement('div', { className: 'feature-icon' }, '👨‍🔧'),
              React.createElement('h3', { className: 'text-xl font-semibold mb-2' }, 'Expert Network'),
              React.createElement('p', { className: 'text-gray-600' }, 
                'Connect with verified, insured professionals in your area'
              )
            ),
            React.createElement('div', { className: 'feature-card' },
              React.createElement('div', { className: 'feature-icon' }, '🛡️'),
              React.createElement('h3', { className: 'text-xl font-semibold mb-2' }, 'Safety First'),
              React.createElement('p', { className: 'text-gray-600' }, 
                'Know when DIY is safe or when you need a professional'
              )
            )
          ),

          // CTA Buttons
          React.createElement('div', { 
            className: 'flex flex-col sm:flex-row gap-4 justify-center' 
          },
            React.createElement('button', {
              onClick: () => {
                onGetStarted();
                triggerHaptic('medium');
              },
              className: 'mobile-touch bg-blue-600 text-white px-8 py-4 rounded-full text-lg font-semibold hover:bg-blue-700 transition-all transform hover:scale-105 shadow-lg'
            }, 
              React.createElement('span', { className: 'flex items-center justify-center gap-2' },
                React.createElement('span', null, '🚀'),
                'Get Started Free'
              )
            ),
            React.createElement('button', {
              onClick: () => {
                onLoginExpert();
                triggerHaptic('medium');
              },
              className: 'mobile-touch bg-green-600 text-white px-8 py-4 rounded-full text-lg font-semibold hover:bg-green-700 transition-all transform hover:scale-105 shadow-lg'
            },
              React.createElement('span', { className: 'flex items-center justify-center gap-2' },
                React.createElement('span', null, '👨‍🔧'),
                'Join as Expert'
              )
            )
          )
        ),

        // Free Analysis Banner
        React.createElement('div', { 
          className: 'bg-gradient-to-r from-yellow-400 to-orange-500 rounded-2xl p-6 max-w-4xl mx-auto mb-8 text-white shadow-lg' 
        },
          React.createElement('h3', { 
            className: 'text-2xl font-bold mb-2 flex items-center justify-center gap-2' 
          },
            React.createElement('span', { className: 'text-3xl' }, '🎉'),
            'First AI Analysis FREE Every Month!'
          ),
          React.createElement('p', { className: 'text-center text-lg' },
            'New users get their first problem analysis completely free. Additional analyses only £4.99.'
          )
        ),

        // Trust Indicators
        React.createElement('div', { className: 'text-center mb-8' },
          React.createElement('div', { className: 'flex justify-center gap-8 mb-4' },
            React.createElement('div', null,
              React.createElement('div', { className: 'text-3xl font-bold text-blue-600' }, '10K+'),
              React.createElement('div', { className: 'text-gray-600' }, 'Active Users')
            ),
            React.createElement('div', null,
              React.createElement('div', { className: 'text-3xl font-bold text-green-600' }, '500+'),
              React.createElement('div', { className: 'text-gray-600' }, 'Verified Experts')
            ),
            React.createElement('div', null,
              React.createElement('div', { className: 'text-3xl font-bold text-purple-600' }, '4.8★'),
              React.createElement('div', { className: 'text-gray-600' }, 'App Rating')
            )
          )
        ),

        // How It Works
        React.createElement('div', { 
          className: 'bg-gray-50 rounded-2xl p-8 max-w-4xl mx-auto mb-8' 
        },
          React.createElement('h3', { className: 'text-2xl font-bold text-center mb-8' }, 
            'How DIYMatch Works'
          ),
          React.createElement('div', { className: 'grid md:grid-cols-4 gap-6' },
            React.createElement('div', { className: 'text-center' },
              React.createElement('div', { 
                className: 'w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl' 
              }, '📸'),
              React.createElement('h4', { className: 'font-semibold mb-1' }, '1. Capture'),
              React.createElement('p', { className: 'text-sm text-gray-600' }, 
                'Take a photo or video of your problem'
              )
            ),
            React.createElement('div', { className: 'text-center' },
              React.createElement('div', { 
                className: 'w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl' 
              }, '🤖'),
              React.createElement('h4', { className: 'font-semibold mb-1' }, '2. Analyze'),
              React.createElement('p', { className: 'text-sm text-gray-600' }, 
                'AI identifies the issue instantly'
              )
            ),
            React.createElement('div', { className: 'text-center' },
              React.createElement('div', { 
                className: 'w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl' 
              }, '💡'),
              React.createElement('h4', { className: 'font-semibold mb-1' }, '3. Solutions'),
              React.createElement('p', { className: 'text-sm text-gray-600' }, 
                'Get DIY guides or expert quotes'
              )
            ),
            React.createElement('div', { className: 'text-center' },
              React.createElement('div', { 
                className: 'w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3 text-2xl' 
              }, '✅'),
              React.createElement('h4', { className: 'font-semibold mb-1' }, '4. Fix'),
              React.createElement('p', { className: 'text-sm text-gray-600' }, 
                'Complete repairs safely and efficiently'
              )
            )
          )
        ),

        // Video Demo Button
        React.createElement('div', { className: 'text-center mb-8' },
          React.createElement('button', {
            onClick: () => {
              setShowVideo(true);
              triggerHaptic('light');
            },
            className: 'mobile-touch bg-gray-800 text-white px-6 py-3 rounded-full hover:bg-gray-700 transition-all'
          },
            React.createElement('span', { className: 'flex items-center gap-2' },
              React.createElement('span', null, '▶️'),
              'Watch Demo Video'
            )
          )
        ),

        // Contact Section
        React.createElement('div', { 
          className: 'bg-blue-50 rounded-2xl p-6 max-w-4xl mx-auto text-center' 
        },
          React.createElement('h3', { 
            className: 'text-xl font-semibold mb-3 flex items-center justify-center gap-2' 
          },
            React.createElement('span', null, '📞'),
            'Need Help?'
          ),
          React.createElement('p', { className: 'text-gray-700 mb-4' },
            'Our support team is here to help you get started'
          ),
          React.createElement('div', { className: 'flex flex-col sm:flex-row gap-4 justify-center' },
            React.createElement('a', {
              href: `mailto:${APP_CONFIG.supportEmail}`,
              className: 'mobile-touch bg-white px-6 py-3 rounded-lg hover:shadow-md transition-all'
            },
              React.createElement('span', { className: 'flex items-center gap-2' },
                React.createElement('span', null, '✉️'),
                'Email Support'
              )
            ),
            React.createElement('a', {
              href: `tel:${APP_CONFIG.emergencyHotline}`,
              className: 'mobile-touch bg-white px-6 py-3 rounded-lg hover:shadow-md transition-all'
            },
              React.createElement('span', { className: 'flex items-center gap-2' },
                React.createElement('span', null, '📱'),
                'Call Us'
              )
            )
          )
        )
      )
    ),

    // Video Modal
    showVideo && React.createElement(Modal, {
      isOpen: showVideo,
      onClose: () => setShowVideo(false),
      title: 'DIYMatch Demo',
      size: 'large'
    },
      React.createElement('div', { className: 'aspect-video bg-gray-200 rounded-lg flex items-center justify-center' },
        React.createElement('div', { className: 'text-center' },
          React.createElement('div', { className: 'text-6xl mb-4' }, '🎥'),
          React.createElement('p', { className: 'text-gray-600' }, 'Demo video coming soon!')
        )
      )
    )
  );
};

// ============================================================================
// USER DASHBOARD
// ============================================================================

const UserDashboard = ({ user, onLogout }) => {
  const [activeTab, setActiveTab] = useState('home');
  const [analysisHistory, setAnalysisHistory] = useState([]);
  const [notifications, setNotifications] = useState([]);
  const [savedExperts, setSavedExperts] = useState([]);
  const [showSupportChat, setShowSupportChat] = useState(false);
  
  useEffect(() => {
    // Load user data
    const userAnalyses = aiAnalysisHistory.get(user.email) || [];
    setAnalysisHistory(userAnalyses);
    
    const userNotifs = userNotifications.get(user.email) || [];
    setNotifications(userNotifs);
    
    setSavedExperts(user.savedExperts || []);
    
    analytics.trackPageView('user_dashboard');
    setCurrentUser(user);
  }, [user]);
  
  const handleTabChange = (tab) => {
    setActiveTab(tab);
    triggerHaptic('light');
    analytics.track('tab_changed', { tab });
  };
  
  const renderHomeTab = () => {
    const recentAnalysis = analysisHistory[0];
    const freeAvailable = checkFreeAnalysisAvailable(user.email);
    
    return React.createElement('div', { className: 'space-y-6 fade-in' },
      // Welcome Card
      React.createElement('div', { 
        className: 'bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl p-6 text-white shadow-lg' 
      },
        React.createElement('h2', { className: 'text-2xl font-bold mb-2' }, 
          `Welcome back, ${user.name}!`
        ),
        React.createElement('p', { className: 'mb-4 opacity-90' }, 
          'What can we help you fix today?'

// Quick Actions
      React.createElement('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4' },
        React.createElement('button', {
          onClick: () => handleTabChange('analyze'),
          className: 'mobile-touch bg-blue-600 text-white p-6 rounded-xl hover:bg-blue-700 transition-all transform hover:scale-105 shadow-lg'
        },
          React.createElement('div', { className: 'text-3xl mb-2' }, '📸'),
          React.createElement('div', { className: 'font-semibold' }, 'New Analysis'),
          React.createElement('div', { className: 'text-xs opacity-80 mt-1' },
            freeAvailable ? '✨ FREE this month!' : `£${APP_CONFIG.aiAnalysisPrice}`
          )
        ),
        
        React.createElement('button', {
          onClick: () => handleTabChange('experts'),
          className: 'mobile-touch bg-green-600 text-white p-6 rounded-xl hover:bg-green-700 transition-all transform hover:scale-105 shadow-lg'
        },
          React.createElement('div', { className: 'text-3xl mb-2' }, '👨‍🔧'),
          React.createElement('div', { className: 'font-semibold' }, 'Find Experts'),
          React.createElement('div', { className: 'text-xs opacity-80 mt-1' }, 'Verified pros')
        ),
        
        React.createElement('button', {
          onClick: () => handleTabChange('emergency'),
          className: 'mobile-touch emergency-button text-white p-6 rounded-xl hover:opacity-90 transition-all transform hover:scale-105 shadow-lg'
        },
          React.createElement('div', { className: 'text-3xl mb-2' }, '🚨'),
          React.createElement('div', { className: 'font-semibold' }, 'Emergency'),
          React.createElement('div', { className: 'text-xs opacity-80 mt-1' }, '24/7 help')
        ),
        
        React.createElement('button', {
          onClick: () => handleTabChange('parts'),
          className: 'mobile-touch bg-purple-600 text-white p-6 rounded-xl hover:bg-purple-700 transition-all transform hover:scale-105 shadow-lg'
        },
          React.createElement('div', { className: 'text-3xl mb-2' }, '🛠️'),
          React.createElement('div', { className: 'font-semibold' }, 'Find Parts'),
          React.createElement('div', { className: 'text-xs opacity-80 mt-1' }, 'Near you')
        )
      ),
      
      // Recent Analysis
      recentAnalysis && React.createElement('div', { className: 'bg-white rounded-xl shadow-lg p-6' },
        React.createElement('h3', { className: 'text-xl font-semibold mb-4 flex items-center gap-2' },
          React.createElement('span', null, '📊'),
          'Recent Analysis'
        ),
        React.createElement('div', {
          className: 'bg-gray-50 rounded-lg p-4 cursor-pointer hover:bg-gray-100 transition-all',
          onClick: () => handleTabChange('history')
        },
          React.createElement('div', { className: 'flex justify-between items-start mb-2' },
            React.createElement('h4', { className: 'font-semibold' }, recentAnalysis.problemDetected),
            React.createElement('span', {
              className: `px-3 py-1 rounded-full text-sm ${
                recentAnalysis.severity === 'Critical' ? 'bg-red-100 text-red-800' :
                recentAnalysis.severity === 'High' ? 'bg-orange-100 text-orange-800' :
                'bg-yellow-100 text-yellow-800'
              }`
            }, recentAnalysis.severity)
          ),
          React.createElement('p', { className: 'text-sm text-gray-600 mb-2' }, 
            recentAnalysis.description.substring(0, 100) + '...'
          ),
          React.createElement('div', { className: 'flex justify-between text-sm' },
            React.createElement('span', { className: 'text-gray-500' },
              new Date(recentAnalysis.timestamp).toLocaleDateString()
            ),
            React.createElement('span', { className: 'text-blue-600 font-medium' }, 
              'View Details →'
            )
          )
        )
      ),
      
      // AI Suggestions
      React.createElement('div', { className: 'bg-gradient-to-r from-cyan-50 to-blue-50 rounded-xl p-6' },
        React.createElement('h3', { className: 'text-xl font-semibold mb-4 flex items-center gap-2' },
          React.createElement('span', null, '✨'),
          'AI Recommendations'
        ),
        React.createElement('div', { className: 'space-y-3' },
          React.createElement(AISuggestionCard, {
            suggestion: {
              type: 'preventive',
              action: 'Schedule annual boiler service before winter',
              confidence: 92
            },
            onAccept: () => {
              handleTabChange('experts');
              analytics.track('ai_suggestion_accepted', { type: 'preventive' });
            },
            onReject: () => analytics.track('ai_suggestion_rejected', { type: 'preventive' })
          }),
          React.createElement('div', { 
            className: 'bg-white rounded-lg p-4 border border-blue-200' 
          },
            React.createElement('p', { className: 'text-sm' },
              '💡 Based on your location, we recommend checking gutters before the rainy season.'
            )
          )
        )
      ),
      
      // Saved Experts
      savedExperts.length > 0 && React.createElement('div', { 
        className: 'bg-white rounded-xl shadow-lg p-6' 
      },
        React.createElement('h3', { className: 'text-xl font-semibold mb-4 flex items-center gap-2' },
          React.createElement('span', null, '⭐'),
          'Your Saved Experts'
        ),
        React.createElement('div', { className: 'grid gap-3' },
          savedExperts.slice(0, 3).map(expertId => {
            const expert = expertProfiles.get(expertId);
            if (!expert) return null;
            
            return React.createElement('div', {
              key: expertId,
              className: 'flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-all cursor-pointer',
              onClick: () => handleTabChange('experts')
            },
              React.createElement('div', { className: 'flex items-center gap-3' },
                React.createElement('div', { 
                  className: 'w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-xl' 
                }, '👨‍🔧'),
                React.createElement('div', null,
                  React.createElement('div', { className: 'font-medium' }, expert.name),
                  React.createElement('div', { className: 'text-sm text-gray-600' }, expert.profession)
                )
              ),
              React.createElement('div', { className: 'text-right' },
                React.createElement(StarRating, { rating: expert.rating, readonly: true, size: 'small' }),
                React.createElement('div', { className: 'text-xs text-gray-500' }, 
                  `£${expert.hourlyRate}/hr`
                )
              )
            );
          })
        )
      )
    );
  };
  
  const renderAnalyzeTab = () => React.createElement(AIAnalysisPage, { 
    user,
    onComplete: (analysis) => {
      const updatedHistory = [analysis, ...analysisHistory];
      setAnalysisHistory(updatedHistory);
      aiAnalysisHistory.set(user.email, updatedHistory);
    }
  });
  
  const renderExpertsTab = () => React.createElement(ExpertSearchPage, { 
    user,
    savedExperts,
    onToggleSave: (expertId) => {
      const newSaved = savedExperts.includes(expertId)
        ? savedExperts.filter(id => id !== expertId)
        : [...savedExperts, expertId];
      setSavedExperts(newSaved);
      user.savedExperts = newSaved;
      registeredUsers.set(user.email, user);
    }
  });
  
  const renderEmergencyTab = () => React.createElement(EmergencyHelpPage, { user });
  
  const renderPartsTab = () => React.createElement(PartsFinderPage, { user });
  
  const renderHistoryTab = () => React.createElement(AnalysisHistoryPage, { 
    history: analysisHistory,
    onViewDetails: (analysis) => {
      // Could implement detailed view modal
      console.log('View details:', analysis);
    }
  });
  
  const renderProfileTab = () => React.createElement(UserProfilePage, { 
    user,
    onUpdate: (updates) => {
      Object.assign(user, updates);
      registeredUsers.set(user.email, user);
      setCurrentUser(user);
    }
  });
  
  return React.createElement('div', { className: 'min-h-screen bg-gray-50' },
    // Header
    React.createElement('div', { className: 'safe-area-top bg-white shadow-sm sticky top-0 z-50' },
      React.createElement('div', { className: 'container mx-auto px-4 py-4' },
        React.createElement('div', { className: 'flex justify-between items-center' },
          React.createElement('h1', { 
            className: 'text-2xl font-bold flex items-center cursor-pointer',
            onClick: () => handleTabChange('home')
          },
            React.createElement('span', { className: 'text-3xl mr-2' }, '🔧'),
            ' DIYMatch'
          ),
          React.createElement('div', { className: 'flex items-center gap-4' },
            React.createElement('div', { className: 'relative' },
              React.createElement('button', { 
                className: 'text-2xl mobile-touch',
                onClick: () => {
                  const unread = notifications.filter(n => !n.read);
                  if (unread.length > 0) {
                    // Mark all as read
                    notifications.forEach(n => n.read = true);
                    setNotifications([...notifications]);
                    userNotifications.set(user.email, notifications);
                  }
                  // Show notifications modal
                  alert(`You have ${notifications.length} notifications`);
                }
              }, '🔔'),
              notifications.filter(n => !n.read).length > 0 &&
              React.createElement('span', { className: 'notification-badge' },
                notifications.filter(n => !n.read).length
              )
            ),
            React.createElement('button', {
              onClick: () => {
                if (confirm('Are you sure you want to logout?')) {
                  onLogout();
                  triggerHaptic('medium');
                }
              },
              className: 'text-gray-600 hover:text-gray-800 mobile-touch'
            }, 'Logout')
          )
        )
      )
    ),
    
    // Main Content
    React.createElement('div', { 
      className: 'container mx-auto px-4 py-6 pb-20 smooth-scroll',
      style: { minHeight: 'calc(100vh - 120px)' }
    },
      activeTab === 'home' && renderHomeTab(),
      activeTab === 'analyze' && renderAnalyzeTab(),
      activeTab === 'experts' && renderExpertsTab(),
      activeTab === 'emergency' && renderEmergencyTab(),
      activeTab === 'parts' && renderPartsTab(),
      activeTab === 'history' && renderHistoryTab(),
      activeTab === 'profile' && renderProfileTab()
    ),
    
    // Bottom Navigation
    React.createElement('div', { className: 'bottom-nav safe-area-bottom' },
      React.createElement('button', {
        onClick: () => handleTabChange('home'),
        className: `bottom-nav-item ${activeTab === 'home' ? 'active' : ''}`
      },
        React.createElement('div', { className: 'bottom-nav-icon' }, '🏠'),
        React.createElement('span', null, 'Home')
      ),
      React.createElement('button', {
        onClick: () => handleTabChange('analyze'),
        className: `bottom-nav-item ${activeTab === 'analyze' ? 'active' : ''}`
      },
        React.createElement('div', { className: 'bottom-nav-icon' }, '📸'),
        React.createElement('span', null, 'Analyze')
      ),
      React.createElement('button', {
        onClick: () => handleTabChange('experts'),
        className: `bottom-nav-item ${activeTab === 'experts' ? 'active' : ''}`
      },
        React.createElement('div', { className: 'bottom-nav-icon' }, '👨‍🔧'),
        React.createElement('span', null, 'Experts')
      ),
      React.createElement('button', {
        onClick: () => handleTabChange('history'),
        className: `bottom-nav-item ${activeTab === 'history' ? 'active' : ''}`
      },
        React.createElement('div', { className: 'bottom-nav-icon' }, '📋'),
        React.createElement('span', null, 'History')
      ),
      React.createElement('button', {
        onClick: () => handleTabChange('profile'),
        className: `bottom-nav-item ${activeTab === 'profile' ? 'active' : ''}`
      },
        React.createElement('div', { className: 'bottom-nav-icon' }, '👤'),
        React.createElement('span', null, 'Profile')
      )
    ),
    
    // Support Chat Button
    React.createElement('button', {
      onClick: () => {
        setShowSupportChat(true);
        triggerHaptic('medium');
      },
      className: 'fixed bottom-24 right-6 bg-blue-600 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center mobile-touch hover:bg-blue-700 transition-all z-40'
    },
      React.createElement('span', { className: 'text-2xl' }, '💬')
    ),
    
    // Support Chat Modal
    showSupportChat && React.createElement(SupportChatModal, {
      user,
      onClose: () => setShowSupportChat(false)
    })
  );
};

// ============================================================================
// AI ANALYSIS PAGE
// ============================================================================

const AIAnalysisPage = ({ user, onComplete }) => {
  const [step, setStep] = useState(1);
  const [media, setMedia] = useState(null);
  const [description, setDescription] = useState('');
  const [category, setCategory] = useState('');
  const [urgency, setUrgency] = useState('normal');
  const [analyzing, setAnalyzing] = useState(false);
  const [progress, setProgress] = useState(0);
  const [progressMessage, setProgressMessage] = useState('');
  const [analysis, setAnalysis] = useState(null);
  const [showARMode, setShowARMode] = useState(false);
  
  const handleMediaCapture = async (type) => {
    try {
      let capturedMedia;
      
      switch (type) {
        case 'photo':
          capturedMedia = await takePhoto();
          break;
        case 'video':
          capturedMedia = await takeVideo();
          break;
        case 'voice':
          capturedMedia = await recordVoiceNote();
          break;
        case 'ar':
          if (APP_CONFIG.aiFeatures.arMeasurement) {
            setShowARMode(true);
            return;
          }
          break;
      }
      
      if (capturedMedia) {
        setMedia(capturedMedia);
        setStep(2);
        triggerHaptic('success');
        analytics.track('media_captured', { type });
      }
    } catch (error) {
      console.error('Media capture error:', error);
      alert('Failed to capture media. Please try again.');
    }
  };
  
  const performAIAnalysis = async (media, description, progressCallback) => {
    const stages = [
      { progress: 10, message: 'Initializing AI analysis...' },
      { progress: 25, message: 'Processing image data...' },
      { progress: 40, message: 'Identifying problem type...' },
      { progress: 55, message: 'Analyzing severity...' },
      { progress: 70, message: 'Calculating cost estimates...' },
      { progress: 85, message: 'Generating recommendations...' },
      { progress: 95, message: 'Finalizing report...' }
    ];
    
    for (const stage of stages) {
      progressCallback(stage.progress, stage.message);
      await new Promise(resolve => setTimeout(resolve, 800));
    }
    
    const analysisResult = await aiService.analyzeImage(media, description);
    
    progressCallback(100, 'Analysis complete!');
    
    return analysisResult;
  };
  
  const handleAnalysis = async () => {
    if (!media || !description.trim()) {
      alert('Please provide both media and description');
      return;
    }
    
    setAnalyzing(true);
    setStep(3);
    
    try {
      const analysisResult = await performAIAnalysis(
        media,
        `${category} - ${urgency}: ${description}`,
        (prog, msg) => {
          setProgress(prog);
          setProgressMessage(msg);
        }
      );
      
      const isFree = checkFreeAnalysisAvailable(user.email);
      
      if (!isFree) {
        const paymentResult = await paymentService.processPayment(
          APP_CONFIG.aiAnalysisPrice,
          { 
            type: 'ai_analysis', 
            userId: user.id,
            analysisId: analysisResult.id 
          }
        );
        
        if (!paymentResult.success) {
          throw new Error('Payment failed');
        }
        
        // Update user's total spent
        user.totalSpent = (user.totalSpent || 0) + APP_CONFIG.aiAnalysisPrice;
        registeredUsers.set(user.email, user);
      } else {
        useFreeAnalysis(user.email);
      }
      
      const savedAnalysis = {
        ...analysisResult,
        userEmail: user.email,
        media: media,
        description: description,
        category: category,
        urgency: urgency
      };
      
      const dbResult = await dbOperations.saveAnalysis(savedAnalysis);
      
      setAnalysis(dbResult.analysis);
      setStep(4);
      triggerHaptic('success');
      
      if (onComplete) {
        onComplete(dbResult.analysis);
      }
      
      // Check for emergency situations
      if (analysisResult.severity === 'Critical' || urgency === 'emergency') {
        await notificationService.sendPush(user.email, {
          title: '⚠️ Critical Issue Detected',
          body: 'Immediate action recommended. View expert options now.',
          requiresInteraction: true
        });
      }
    } catch (error) {
      console.error('Analysis error:', error);
      alert('Analysis failed. Please try again.');
      setStep(2);
    } finally {
      setAnalyzing(false);
    }
  };
  
  const renderStep1 = () => React.createElement('div', { className: 'space-y-6 fade-in' },
    React.createElement('h2', { className: 'text-2xl font-bold text-center' }, 
      'How would you like to show us the problem?'
    ),
    
    React.createElement('div', { className: 'grid grid-cols-1 gap-4' },
      React.createElement('button', {
        onClick: () => handleMediaCapture('photo'),
        className: 'mobile-touch bg-blue-600 text-white p-6 rounded-xl hover:bg-blue-700 transition-all flex items-center justify-between group'
      },
        React.createElement('div', { className: 'flex items-center' },
          React.createElement('div', { className: 'text-3xl mr-4 group-hover:scale-110 transition-transform' }, '📸'),
          React.createElement('div', { className: 'text-left' },
            React.createElement('div', { className: 'font-semibold' }, 'Take Photo'),
            React.createElement('div', { className: 'text-sm opacity-80' }, 'Best for most issues')
          )
        ),
        React.createElement('div', { className: 'text-2xl opacity-50 group-hover:opacity-100 transition-opacity' }, '→')
      ),
      
      React.createElement('button', {
        onClick: () => handleMediaCapture('video'),
        className: 'mobile-touch bg-purple-600 text-white p-6 rounded-xl hover:bg-purple-700 transition-all flex items-center justify-between group'
      },
        React.createElement('div', { className: 'flex items-center' },
          React.createElement('div', { className: 'text-3xl mr-4 group-hover:scale-110 transition-transform' }, '🎥'),
          React.createElement('div', { className: 'text-left' },
            React.createElement('div', { className: 'font-semibold' }, 'Record Video'),
            React.createElement('div', { className: 'text-sm opacity-80' }, 'For sounds or complex issues')
          )
        ),
        React.createElement('div', { className: 'text-2xl opacity-50 group-hover:opacity-100 transition-opacity' }, '→')
      ),
      
      React.createElement('button', {
        onClick: () => handleMediaCapture('voice'),
        className: 'mobile-touch bg-green-600 text-white p-6 rounded-xl hover:bg-green-700 transition-all flex items-center justify-between group'
      },
        React.createElement('div', { className: 'flex items-center' },
          React.createElement('div', { className: 'text-3xl mr-4 group-hover:scale-110 transition-transform' }, '🎤'),
          React.createElement('div', { className: 'text-left' },
            React.createElement('div', { className: 'font-semibold' }, 'Voice Note'),
            React.createElement('div', { className: 'text-sm opacity-80' }, 'Describe the problem verbally')
          )
        ),
        React.createElement('div', { className: 'text-2xl opacity-50 group-hover:opacity-100 transition-opacity' }, '→')
      ),
      
      APP_CONFIG.aiFeatures.arMeasurement && React.createElement('button', {
        onClick: () => handleMediaCapture('ar'),
        className: 'mobile-touch bg-orange-600 text-white p-6 rounded-xl hover:bg-orange-700 transition-all flex items-center justify-between group'
      },
        React.createElement('div', { className: 'flex items-center' },
          React.createElement('div', { className: 'text-3xl mr-4 group-hover:scale-110 transition-transform' }, '📐'),
          React.createElement('div', { className: 'text-left' },
            React.createElement('div', { className: 'font-semibold' }, 'AR Measure'),
            React.createElement('div', { className: 'text-sm opacity-80' }, 'Measure dimensions in AR')
          )
        ),
        React.createElement('div', { 
          className: 'bg-orange-100 text-orange-800 text-xs px-2 py-1 rounded' 
        }, 'BETA')
      )
    ),
    
    React.createElement('div', { className: 'text-center mt-6' },
      React.createElement('p', { className: 'text-gray-600' }, 
        checkFreeAnalysisAvailable(user.email) 
          ? '✨ Your first analysis this month is FREE!' 
          : `Analysis cost: £${APP_CONFIG.aiAnalysisPrice}`
      )
    )
  );
  
  const renderStep2 = () => React.createElement('div', { className: 'space-y-6 fade-in' },
    React.createElement('h2', { className: 'text-2xl font-bold text-center' }, 
      'Tell us more about the problem'
    ),
    
    media && React.createElement('div', { className: 'bg-gray-100 rounded-lg p-4' },
      media.type === 'image' && React.createElement('img', {
        src: media.data,
        alt: 'Problem',
        className: 'w-full rounded-lg shadow-md'
      }),
      media.type === 'video' && React.createElement('video', {
        src: media.data,
        controls: true,
        className: 'w-full rounded-lg shadow-md'
      }),
      media.type === 'voice' && React.createElement('div', { className: 'text-center py-8' },
        React.createElement('div', { className: 'recording-animation mx-auto mb-4' },
          React.createElement('div', { className: 'recording-wave' })
        ),
        React.createElement('p', { className: 'font-medium' }, `Voice note recorded (${media.duration}s)`),
        React.createElement('audio', {
          src: media.data,
          controls: true,
          className: 'mt-4 mx-auto'
        })
      ),
      React.createElement('button', {
        onClick: () => {
          setMedia(null);
          setStep(1);
          triggerHaptic('light');
        },
        className: 'mt-3 text-sm text-blue-600 hover:text-blue-800'
      }, 'Retake')
    ),
    
    React.createElement('div', null,
      React.createElement('label', { className: 'block text-sm font-medium mb-2' },
        'Problem Category'
      ),
      React.createElement('select', {
        value: category,
        onChange: (e) => setCategory(e.target.value),
        className: 'w-full p-3 border rounded-lg'
      },
        React.createElement('option', { value: '' }, 'Select category...'),
        React.createElement('option', { value: 'plumbing' }, '💧 Plumbing'),
        React.createElement('option', { value: 'electrical' }, '⚡ Electrical'),
        React.createElement('option', { value: 'heating' }, '🔥 Heating/Gas'),
        React.createElement('option', { value: 'structural' }, '🏠 Structural'),
        React.createElement('option', { value: 'appliance' }, '🔧 Appliance'),
        React.createElement('option', { value: 'other' }, '❓ Other')
      )
    ),
    
    React.createElement('div', null,
      React.createElement('label', { className: 'block text-sm font-medium mb-2' },
        'Urgency Level'
      ),
      React.createElement('div', { className: 'grid grid-cols-3 gap-3' },
        ['normal', 'urgent', 'emergency'].map(level =>
          React.createElement('button', {
            key: level,
            onClick: () => {
              setUrgency(level);
              triggerHaptic('light');
            },
            className: `p-3 rounded-lg border-2 transition-all ${
              urgency === level 
                ? level === 'emergency' 
                  ? 'border-red-500 bg-red-50' 
                  : level === 'urgent'
                  ? 'border-orange-500 bg-orange-50'
                  : 'border-blue-500 bg-blue-50'
                : 'border-gray-300'
            }`
          },
            React.createElement('div', { 
              className: `font-medium ${
                level === 'emergency' ? 'text-red-700' :
                level === 'urgent' ? 'text-orange-700' :
                'text-gray-700'
              }` 
            }, 
              level === 'emergency' ? '🚨 Emergency' :
              level === 'urgent' ? '⚠️ Urgent' :
              '✓ Normal'
            )
          )
        )
      )
    ),
    
    React.createElement('div', null,
      React.createElement('label', { className: 'block text-sm font-medium mb-2' },
        'Describe the problem in detail:'
      ),
      React.createElement('textarea', {
        value: description,
        onChange: (e) => setDescription(e.target.value),
        className: 'w-full p-3 border rounded-lg resize-none',
        rows: 4,
        placeholder: 'E.g., Leaking pipe under kitchen sink, started yesterday after heavy rain. Water pooling on floor...'
      })
    ),
    
    React.createElement('div', { className: 'bg-yellow-50 border border-yellow-200 p-4 rounded-lg' },
      React.createElement('p', { className: 'text-sm' },
        React.createElement('strong', null, '💡 Pro Tips: '),
        'Include when it started, any unusual sounds/smells, what you\'ve tried, and if it\'s getting worse.'
      )
    ),
    
    React.createElement('div', { className: 'flex gap-4' },
      React.createElement('button', {
        onClick: () => {
          setStep(1);
          triggerHaptic('light');
        },
        className: 'flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold mobile-touch'
      }, '← Back'),
      React.createElement('button', {
        onClick: handleAnalysis,
        disabled: !description.trim() || !category,
        className: `flex-1 py-3 rounded-lg font-semibold mobile-touch ${
          description.trim() && category
            ? 'bg-blue-600 text-white hover:bg-blue-700'
            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
        }`
      }, 'Analyze →')
    )
  );
  
  const renderStep3 = () => React.createElement('div', { className: 'space-y-6 text-center fade-in' },
    React.createElement('h2', { className: 'text-2xl font-bold' }, 'AI Analysis in Progress'),
    
    React.createElement('div', { className: 'relative w-32 h-32 mx-auto' },
      React.createElement('div', {
        className: 'absolute inset-0 bg-blue-200 rounded-full animate-ping'
      }),
      React.createElement('div', {
        className: 'relative bg-gradient-to-r from-blue-600 to-purple-600 rounded-full w-32 h-32 flex items-center justify-center text-white text-5xl float-animation'
      }, '🤖')
    ),
    
    React.createElement('div', { className: 'space-y-2' },
      React.createElement('div', { className: 'text-lg font-medium' }, progressMessage),
      React.createElement('div', { className: 'w-full bg-gray-200 rounded-full h-3 overflow-hidden' },
        React.createElement('div', {
          className: 'analysis-progress h-full transition-all duration-300',
          style: { width: `${progress}%` }
        })
      ),
      React.createElement('div', { className: 'text-sm text-gray-600' }, `${progress}% Complete`)
    ),
    
    React.createElement('div', { className: 'bg-blue-50 rounded-lg p-4 max-w-md mx-auto' },
      React.createElement('p', { className: 'text-sm text-blue-800' },
        'Our AI is using advanced pattern recognition and machine learning to analyze your problem...'
      )
    )
  );
  
  const renderStep4 = () => {
    if (!analysis) return null;
    
    return React.createElement('div', { className: 'space-y-6 fade-in' },
      React.createElement(SuccessAnimation, { message: 'Analysis Complete!' }),
      
      React.createElement('div', { className: 'bg-white rounded-lg shadow-lg p-6 space-y-4' },
        // Problem Header
        React.createElement('div', { className: 'flex justify-between items-start' },
          React.createElement('div', null,
            React.createElement('h3', { className: 'text-xl font-semibold' }, analysis.problemDetected),
            React.createElement('p', { className: 'text-gray-600 flex items-center gap-1' }, 
              React.createElement('span', null, '🎯'),
              `Confidence: ${analysis.confidence}`
            )
          ),
          React.createElement('div', {
            className: `px-3 py-1 rounded-full text-sm font-medium ${
              analysis.severity === 'Critical' ? 'bg-red-100 text-red-800' :
              analysis.severity === 'High' ? 'bg-orange-100 text-orange-800' :
              'bg-yellow-100 text-yellow-800'
            }`
          }, `${analysis.severity} Severity`)
        ),
        
        React.createElement('p', { className: 'text-gray-700' }, analysis.description),
        
        // Key Metrics
        React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
          React.createElement('div', { className: 'bg-gray-50 p-4 rounded-lg' },
            React.createElement('div', { className: 'text-sm text-gray-600' }, 'Estimated Cost'),
            React.createElement('div', { className: 'font-semibold text-lg' }, analysis.estimatedCost),
            analysis.costSavingTips && React.createElement('div', { className: 'text-xs text-green-600 mt-1' },
              '💰 Savings available'
            )
          ),
          React.createElement('div', { className: 'bg-gray-50 p-4 rounded-lg' },
            React.createElement('div', { className: 'text-sm text-gray-600' }, 'Time to Fix'),
            React.createElement('div', { className: 'font-semibold text-lg' }, analysis.timeToFix),
            React.createElement('div', { className: 'text-xs text-gray-500 mt-1' }, 
              `Urgency: ${analysis.urgencyLevel}`
            )
          )
        ),
        
        // Safety Warnings
        analysis.safetyWarnings && analysis.safetyWarnings.length > 0 &&
        React.createElement('div', { className: 'bg-red-50 border border-red-200 p-4 rounded-lg' },
          React.createElement('h4', { className: 'font-semibold text-red-800 mb-2' }, 
            '⚠️ Safety Warnings'
          ),
          React.createElement('ul', { className: 'space-y-1' },
            analysis.safetyWarnings.map((warning, index) =>
              React.createElement('li', { 
                key: index, 
                className: 'text-sm text-red-700' 
              }, warning)
            )
          )
        ),
        
        // DIY vs Professional
        analysis.isDIYFriendly
          ? React.createElement('div', { className: 'bg-green-50 border border-green-200 p-4 rounded-lg' },
              React.createElement('h4', { className: 'font-semibold text-green-800 mb-2 flex items-center gap-2' },
                React.createElement('span', null, '✅'),
                'DIY Friendly!'
              ),
              React.createElement('p', { className: 'text-sm text-green-700 mb-2' },
                'This issue can be safely handled as a DIY project with proper precautions.'
              ),
              React.createElement('p', { className: 'text-sm' },
                React.createElement('span', { className: 'font-medium' }, 'Skill Level: '),
                analysis.skillLevel
              )
            )
          : React.createElement('div', { className: 'bg-orange-50 border border-orange-200 p-4 rounded-lg' },
              React.createElement('h4', { className: 'font-semibold text-orange-800 mb-2 flex items-center gap-2' },
                React.createElement('span', null, '👨‍🔧'),
                'Professional Required'
              ),
              React.createElement('p', { className: 'text-sm text-orange-700' },
                `This issue requires professional expertise. We recommend hiring a verified ${analysis.recommendedExpertType}.`
              )
            ),
        
        // Tools & Parts
        analysis.isDIYFriendly && React.createElement('div', { className: 'space-y-3' },
          analysis.toolsRequired && analysis.toolsRequired.length > 0 &&
          React.createElement('div', null,
            React.createElement('h4', { className: 'font-medium mb-2' }, '🔧 Tools Needed'),
            React.createElement('div', { className: 'flex flex-wrap gap-2' },
              analysis.toolsRequired.map((tool, index) =>
                React.createElement('span', {
                  key: index,
                  className: `px-3 py-1 rounded-full text-sm ${
                    tool.essential 
                      ? 'bg-blue-100 text-blue-800' 
                      : 'bg-gray-100 text-gray-700'
                  }`
                }, tool.name)
              )
            )
          ),
          
          analysis.recommendedParts && analysis.recommendedParts.length > 0 &&
          React.createElement('div', null,
            React.createElement('h4', { className: 'font-medium mb-2' }, '🛠️ Parts & Materials'),
            React.createElement('div', { className: 'space-y-2' },
              analysis.recommendedParts.slice(0, 3).map((part, index) =>
                React.createElement('div', {
                  key: index,
                  className: 'flex justify-between items-center p-2 bg-gray-50 rounded'
                },
                  React.createElement('div', null,
                    React.createElement('div', { className: 'font-medium text-sm' }, part.name),
                    React.createElement('div', { className: 'text-xs text-gray-600' }, 
                      part.priority + ' • ' + part.availability
                    )
                  ),
                  React.createElement('div', { className: 'font-semibold text-blue-600' }, 
                    part.price
                  )
                )
              )
            )
          )
        ),
        
        // AI Suggestions
        analysis.aiSuggestions && analysis.aiSuggestions.length > 0 &&
        React.createElement('div', { className: 'space-y-3' },
          React.createElement('h4', { className: 'font-medium mb-2 flex items-center gap-2' },
            React.createElement('span', null, '✨'),
            'AI Recommendations'
          ),
          analysis.aiSuggestions.map((suggestion, index) =>
            React.createElement(AISuggestionCard, {
              key: index,
              suggestion: suggestion,
              onAccept: () => {
                if (suggestion.type === 'immediate') {
                  alert(`Action noted: ${suggestion.action}`);
                }
                analytics.track('ai_suggestion_accepted', { 
                  type: suggestion.type,
                  analysisId: analysis.id 
                });
              },
              onReject: () => analytics.track('ai_suggestion_rejected', { 
                type: suggestion.type 
              })
            })
          )
        ),
        
        // Smart Home Integration
        analysis.smartHomeIntegration && analysis.smartHomeIntegration.compatible &&
        React.createElement('div', { className: 'bg-blue-50 border border-blue-200 p-4 rounded-lg' },
          React.createElement('h4', { className: 'font-medium text-blue-800 mb-2' }, 
            '🏡 Smart Home Compatible'
          ),
          React.createElement('p', { className: 'text-sm text-blue-700 mb-2' },
            'This repair is compatible with smart home upgrades:'
          ),
          React.createElement('ul', { className: 'space-y-1' },
            analysis.smartHomeIntegration.suggestions.map((item, index) =>
              React.createElement('li', { key: index, className: 'text-sm' }, `• ${item}`)
            )
          )
        ),
        
        // Action Buttons
        React.createElement('div', { className: 'flex flex-col gap-3 pt-4' },
          analysis.isDIYFriendly && React.createElement('button', {
            onClick: () => {
              // Show DIY guide
              alert('DIY Guide feature coming soon!');
              analytics.track('view_diy_guide', { analysisId: analysis.id });
            },
            className: 'w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 mobile-touch flex items-center justify-center gap-2'
          }, 
            React.createElement('span', null, '📖'),
            'View Step-by-Step Guide'
          ),
          
          React.createElement('button', {
            onClick: () => {
              // Navigate to expert search with pre-filled category
              analytics.track('find_expert_from_analysis', { 
                analysisId: analysis.id,
                expertType: analysis.recommendedExpertType 
              });
              alert(`Finding ${analysis.recommendedExpertType}s...`);
            },
            className: 'w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 mobile-touch flex items-center justify-center gap-2'
          }, 
            React.createElement('span', null, '👨‍🔧'),
            `Find ${analysis.recommendedExpertType}`,
            analysis.urgencyLevel === 'Immediate' && React.createElement('span', {
              className: 'bg-red-500 text-white text-xs px-2 py-1 rounded-full ml-2'
            }, 'URGENT')
          ),
          
          React.createElement('button', {
            onClick: () => {
              // Show parts finder
              analytics.track('find_parts_from_analysis', { analysisId: analysis.id });
              alert('Parts finder coming soon!');
            },
            className: 'w-full bg-purple-600 text-white py-3 rounded-lg font-semibold hover:bg-purple-700 mobile-touch flex items-center justify-center gap-2'
          }, 
            React.createElement('span', null, '🛒'),
            'Find Parts & Tools Nearby'
          ),
          
          React.createElement('button', {
            onClick: () => {
              // Share analysis
              if (navigator.share) {
                navigator.share({
                  title: 'DIYMatch Analysis',
                  text: `${analysis.problemDetected} - ${analysis.description}`,
                  url: window.location.href
                }).catch(console.error);
              } else {
                alert('Share feature not available on this device');
              }
            },
            className: 'w-full bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 mobile-touch flex items-center justify-center gap-2'
          }, 
            React.createElement('span', null, '📤'),
            'Share Analysis'
          )
        )
      ),
      
      // Start New Analysis
      React.createElement('div', { className: 'text-center' },
        React.createElement('button', {
          onClick: () => {
            setStep(1);
            setMedia(null);
            setDescription('');
            setCategory('');
            setUrgency('normal');
            setAnalysis(null);
            triggerHaptic('light');
          },
          className: 'text-blue-600 hover:text-blue-800 font-medium'
        }, 'Start New Analysis →')
      )
    );
  };
  
  return React.createElement('div', { className: 'max-w-2xl mx-auto' },
    React.createElement(ProgressSteps, {
      steps: ['Capture', 'Describe', 'Analyze', 'Results'],
      currentStep: step - 1
    }),
    
    step === 1 && renderStep1(),
    step === 2 && renderStep2(),
    step === 3 && renderStep3(),
    step === 4 && renderStep4(),
    
    // AR Mode Modal
    showARMode && React.createElement(Modal, {
      isOpen: showARMode,
      onClose: () => setShowARMode(false),
      title: 'AR Measurement Mode',
      size: 'large'
    },
      React.createElement('div', { className: 'text-center py-12' },
        React.createElement('div', { className: 'text-6xl mb-4' }, '📐'),
        React.createElement('p', { className: 'text-gray-600' }, 
          'AR measurement feature coming soon! This will allow you to measure dimensions directly in your camera view.'
        )
      )
    )
  );
};

// ============================================================================
// EXPERT SEARCH PAGE
// ============================================================================

const ExpertSearchPage = ({ user, savedExperts = [], onToggleSave }) => {
  const [experts, setExperts] = useState([]);
  const [filteredExperts, setFilteredExperts] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [filterCategory, setFilterCategory] = useState('');
  const [filterRating, setFilterRating] = useState(0);
  const [sortBy, setSortBy] = useState('rating');
  const [showFilters, setShowFilters] = useState(false);
  const [selectedExpert, setSelectedExpert] = useState(null);
  const [showBookingModal, setShowBookingModal] = useState(false);
  
  useEffect(() => {
    const allExperts = Array.from(expertProfiles.values());
    setExperts(allExperts);
    setFilteredExperts(allExperts);
    analytics.trackPageView('expert_search');
  }, []);
  
  useEffect(() => {
    let filtered = experts.filter(expert => {
      const matchesSearch = expert.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                          expert.profession.toLowerCase().includes(searchTerm.toLowerCase()) ||
                          expert.bio.toLowerCase().includes(searchTerm.toLowerCase());
      const matchesCategory = !filterCategory || 
                            expert.profession.toLowerCase().includes(filterCategory.toLowerCase());
      const matchesRating = expert.rating >= filterRating;
      
      return matchesSearch && matchesCategory && matchesRating;
    });
    
    // Sort experts
    filtered.sort((a, b) => {
      switch (sortBy) {
        case 'rating':
          return b.rating - a.rating;
        case 'price':
          return a.hourlyRate - b.hourlyRate;
        case 'distance':
          return 0; // Would use actual distance calculation
        case 'reviews':
          return b.reviews - a.reviews;
        default:
          return 0;
      }
    });
    
    setFilteredExperts(filtered);
  }, [experts, searchTerm, filterCategory, filterRating, sortBy]);
  
  const handleBookExpert = (expert) => {
    setSelectedExpert(expert);
    setShowBookingModal(true);
    triggerHaptic('medium');
  };
  
  return React.createElement('div', { className: 'space-y-6' },
    // Search Header
    React.createElement('div', { className: 'bg-white rounded-lg shadow-md p-4 sticky top-0 z-30' },
      React.createElement('div', { className: 'flex gap-3 mb-3' },
        React.createElement('input', {
          type: 'text',
          placeholder: 'Search experts...',
          value: searchTerm,
          onChange: (e) => setSearchTerm(e.target.value),
          className: 'flex-1 p-3 border rounded-lg'
        }),
        React.createElement('button', {
          onClick: () => {
            setShowFilters(!showFilters);
            triggerHaptic('light');
          },
          className: `px-4 py-3 bg-gray-100 rounded-lg hover:bg-gray-200 mobile-touch ${
            showFilters ? 'bg-blue-100' : ''
          }`
        }, '⚙️')
      ),
      
      // Filters
      showFilters && React.createElement('div', { 
        className: 'grid grid-cols-1 md:grid-cols-3 gap-3 pt-3 border-t' 
      },
        React.createElement('select', {
          value: filterCategory,
          onChange: (e) => setFilterCategory(e.target.value),
          className: 'p-2 border rounded-lg'
        },
          React.createElement('option', { value: '' }, 'All Categories'),
          React.createElement('option', { value: 'plumber' }, 'Plumbers'),
          React.createElement('option', { value: 'electrician' }, 'Electricians'),
          React.createElement('option', { value: 'handyman' }, 'Handymen'),
          React.createElement('option', { value: 'carpenter' }, 'Carpenters')
        ),
        
        React.createElement('select', {
          value: filterRating,
          onChange: (e) => setFilterRating(parseFloat(e.target.value)),
          className: 'p-2 border rounded-lg'
        },
          React.createElement('option', { value: '0' }, 'Any Rating'),
          React.createElement('option', { value: '4' }, '4+ Stars'),
          React.createElement('option', { value: '4.5' }, '4.5+ Stars'),
          React.createElement('option', { value: '4.8' }, '4.8+ Stars')
        ),
        
        React.createElement('select', {
          value: sortBy,
          onChange: (e) => setSortBy(e.target.value),
          className: 'p-2 border rounded-lg'
        },
          React.createElement('option', { value: 'rating' }, 'Sort by Rating'),
          React.createElement('option', { value: 'price' }, 'Sort by Price'),
          React.createElement('option', { value: 'reviews' }, 'Sort by Reviews'),
          React.createElement('option', { value: 'distance' }, 'Sort by Distance')
        )
      )
    ),
    
    // Results Count
    React.createElement('div', { className: 'text-gray-600' },
      `Found ${filteredExperts.length} experts near you`
    ),
    
    // Expert List
    filteredExperts.length === 0
      ? React.createElement(EmptyState, {
          icon: '🔍',
          title: 'No experts found',
          description: 'Try adjusting your search or filters',
          action: React.createElement('button', {
            onClick: () => {
              setSearchTerm('');
              setFilterCategory('');
              setFilterRating(0);
            },
            className: 'bg-blue-600 text-white px-6 py-2 rounded-lg mobile-touch'
          }, 'Clear Filters')
        })
      : React.createElement('div', { className: 'space-y-4' },
          filteredExperts.map(expert =>
            React.createElement('div', {
              key: expert.id,
              className: 'bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow'
            },
              // Expert Header
              React.createElement('div', { className: 'flex justify-between items-start mb-4' },
                React.createElement('div', { className: 'flex gap-4' },
                  React.createElement('div', { 
                    className: 'w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center text-2xl' 
                  }, '👨‍🔧'),
                  React.createElement('div', null,
                    React.createElement('h3', { className: 'text-lg font-semibold' }, expert.name),
                    React.createElement('p', { className: 'text-gray-600' }, expert.profession),
                    React.createElement('p', { className: 'text-sm text-gray-500' }, 
                      `📍 ${expert.location} • ${expert.responseTime}`
                    )
                  )
                ),
                React.createElement('div', { className: 'text-right' },
                  React.createElement('button', {
                    onClick: () => {
                      onToggleSave(expert.id);
                      triggerHaptic('light');
                    },
                    className: 'text-2xl mobile-touch mb-2'
                  }, savedExperts.includes(expert.id) ? '⭐' : '☆'),
                  React.createElement(StarRating, { 
                    rating: parseFloat(expert.rating), 
                    readonly: true,
                    size: 'small'
                  }),
                  React.createElement('p', { className: 'text-xs text-gray-600' }, 
                    `(${expert.reviews} reviews)`
                  )
                )
              ),
              
              // Bio
              React.createElement('p', { className: 'text-gray-700 mb-4' }, expert.bio),
              
              // Badges
              expert.badges && expert.badges.length > 0 &&
              React.createElement('div', { className: 'flex flex-wrap gap-2 mb-4' },
                expert.badges.map((badge, index) =>
                  React.createElement('span', {
                    key: index,
                    className: 'px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium'
                  }, badge)
                )
              ),
              
              // Info Grid
              React.createElement('div', { 
                className: 'grid grid-cols-2 md:grid-cols-4 gap-3 mb-4 text-sm' 
              },
                React.createElement('div', { className: 'bg-gray-50 p-2 rounded' },
                  React.createElement('div', { className: 'text-gray-600' }, 'Rate'),
                  React.createElement('div', { className: 'font-semibold' }, 
                    `£${expert.hourlyRate}/hr`
                  )
                ),
                React.createElement('div', { className: 'bg-gray-50 p-2 rounded' },
                  React.createElement('div', { className: 'text-gray-600' }, 'Jobs'),
                  React.createElement('div', { className: 'font-semibold' }, 
                    expert.completedJobs
                  )
                ),
                React.createElement('div', { className: 'bg-gray-50 p-2 rounded' },
                  React.createElement('div', { className: 'text-gray-600' }, 'Guarantee'),
                  React.createElement('div', { className: 'font-semibold' }, 
                    expert.guaranteeOffered
                  )
                ),
                React.createElement('div', { className: 'bg-gray-50 p-2 rounded' },
                  React.createElement('div', { className: 'text-gray-600' }, 'Min Charge'),
                  React.createElement('div', { className: 'font-semibold' }, 
                    `£${expert.minimumCharge}`
                  )
                )
              ),
              
              // Specialties
              React.createElement('div', { className: 'mb-4' },
                React.createElement('p', { className: 'text-sm font-medium mb-2' }, 
                  'Specialties:'
                ),
                React.createElement('div', { className: 'flex flex-wrap gap-2' },
                  expert.specialties.map((specialty, index) =>
                    React.createElement('span', {
                      key: index,
                      className: 'px-2 py-1 bg-green-100 text-green-800 rounded text-xs'
                    }, specialty)
                  )
                )
              ),
              
              // Actions
              React.createElement('div', { className: 'flex gap-3' },
                React.createElement('button', {
                  onClick: () => {
                    // View profile
                    setSelectedExpert(expert);
                    analytics.track('view_expert_profile', { expertId: expert.id });
                  },
                  className: 'flex-1 bg-gray-200 text-gray-800 py-2 rounded-lg font-semibold hover:bg-gray-300 mobile-touch'
                }, 'View Profile'),
                React.createElement('button', {
                  onClick: () => {
                    // Contact expert
                    alert(`Contacting ${expert.name}...`);
                    analytics.track('contact_expert', { expertId: expert.id });
                  },
                  className: 'flex-1 bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 mobile-touch'
                }, 'Contact'),
                React.createElement('button', {
                  onClick: () => handleBookExpert(expert),
                  className: 'flex-1 bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 mobile-touch'
                }, 'Book Now')
              )
            )
          )
        ),
    
    // Booking Modal
    showBookingModal && selectedExpert && React.createElement(BookingModal, {
      expert: selectedExpert,
      user: user,
      onClose: () => {
        setShowBookingModal(false);
        setSelectedExpert(null);
      },
      onConfirm: async (bookingData) => {
        const result = await dbOperations.createBooking(bookingData);
        if (result.success) {
          alert('Booking confirmed! Check your email for details.');
          setShowBookingModal(false);
          analytics.trackConversion('booking', bookingData.totalCost);
        }
      }
    })
  );
};

// ============================================================================
// BOOKING MODAL
// ============================================================================

const BookingModal = ({ expert, user, onClose, onConfirm }) => {
  const [date, setDate] = useState('');
  const [time, setTime] = useState('');
  const [duration, setDuration] = useState('2');
  const [description, setDescription] = useState('');
  const [urgency, setUrgency] = useState('normal');
  const [photos, setPhotos] = useState([]);
  
  const calculateCost = () => {
    const hours = parseFloat(duration);
    const baseRate = urgency === 'emergency' ? expert.emergencyRate : expert.hourlyRate;
    const multiplier = urgency === 'same-day' ? APP_CONFIG.sameDayMultiplier : 1;
    return Math.max(expert.minimumCharge, hours * baseRate * multiplier);
  };
  
  const handleSubmit = async (e) => {
    e.preventDefault();
    
    const bookingData = {
      expertId: expert.id,
      userEmail: user.email,
      date,
      time,
      duration: `${duration} hours`,
      estimatedDuration: duration,
      description,
      urgency,
      photos,
      totalCost: calculateCost(),
      status: 'pending',
      location: user.postcode
    };
    
    onConfirm(bookingData);
  };
  
  return React.createElement(Modal, {
    isOpen: true,
    onClose: onClose,
    title: `Book ${expert.name}`,
    size: 'large'
  },
    React.createElement('form', { onSubmit: handleSubmit, className: 'space-y-4' },
      // Expert Summary
      React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4 mb-4' },
        React.createElement('div', { className: 'flex items-center gap-3' },
          React.createElement('div', { 
            className: 'w-12 h-12 bg-blue-100 rounded-full

// Date & Time
      React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
        React.createElement('div', null,
          React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 
            'Date'
          ),
          React.createElement('input', {
            type: 'date',
            value: date,
            onChange: (e) => setDate(e.target.value),
            min: new Date().toISOString().split('T')[0],
            className: 'w-full p-3 border rounded-lg',
            required: true
          })
        ),
        React.createElement('div', null,
          React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 
            'Time'
          ),
          React.createElement('select', {
            value: time,
            onChange: (e) => setTime(e.target.value),
            className: 'w-full p-3 border rounded-lg',
            required: true
          },
            React.createElement('option', { value: '' }, 'Select time...'),
            ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'].map(t =>
              React.createElement('option', { key: t, value: t }, t)
            )
          )
        )
      ),
      
      // Duration & Urgency
      React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
        React.createElement('div', null,
          React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 
            'Estimated Duration'
          ),
          React.createElement('select', {
            value: duration,
            onChange: (e) => setDuration(e.target.value),
            className: 'w-full p-3 border rounded-lg'
          },
            React.createElement('option', { value: '1' }, '1 hour'),
            React.createElement('option', { value: '2' }, '2 hours'),
            React.createElement('option', { value: '3' }, '3 hours'),
            React.createElement('option', { value: '4' }, '4 hours'),
            React.createElement('option', { value: '8' }, 'Full day')
          )
        ),
        React.createElement('div', null,
          React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 
            'Urgency'
          ),
          React.createElement('select', {
            value: urgency,
            onChange: (e) => setUrgency(e.target.value),
            className: 'w-full p-3 border rounded-lg'
          },
            React.createElement('option', { value: 'normal' }, 'Normal'),
            React.createElement('option', { value: 'same-day' }, 'Same Day (+50%)'),
            React.createElement('option', { value: 'emergency' }, 
              `Emergency (£${expert.emergencyRate}/hr)`
            )
          )
        )
      ),
      
      // Description
      React.createElement('div', null,
        React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 
          'Describe the problem'
        ),
        React.createElement('textarea', {
          value: description,
          onChange: (e) => setDescription(e.target.value),
          className: 'w-full p-3 border rounded-lg resize-none',
          rows: 4,
          placeholder: 'Please describe the issue in detail...',
          required: true
        })
      ),
      
      // Photo Upload
      React.createElement('div', null,
        React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 
          'Add Photos (Optional)'
        ),
        React.createElement(FileUploadZone, {
          onUpload: (files) => {
            const newPhotos = files.map(file => ({
              file,
              preview: URL.createObjectURL(file)
            }));
            setPhotos([...photos, ...newPhotos]);
          },
          accept: 'image/*',
          multiple: true,
          maxSize: APP_CONFIG.maxImageSize
        }),
        photos.length > 0 && React.createElement('div', { 
          className: 'flex gap-2 mt-2 flex-wrap' 
        },
          photos.map((photo, index) =>
            React.createElement('div', {
              key: index,
              className: 'relative'
            },
              React.createElement('img', {
                src: photo.preview,
                alt: `Photo ${index + 1}`,
                className: 'w-20 h-20 object-cover rounded'
              }),
              React.createElement('button', {
                type: 'button',
                onClick: () => {
                  setPhotos(photos.filter((_, i) => i !== index));
                  URL.revokeObjectURL(photo.preview);
                },
                className: 'absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs'
              }, '×')
            )
          )
        )
      ),
      
      // Cost Summary
      React.createElement('div', { 
        className: 'bg-blue-50 border border-blue-200 rounded-lg p-4' 
      },
        React.createElement('h4', { className: 'font-semibold mb-2' }, 'Cost Estimate'),
        React.createElement('div', { className: 'space-y-1 text-sm' },
          React.createElement('div', { className: 'flex justify-between' },
            React.createElement('span', null, 'Base Rate:'),
            React.createElement('span', null, `£${expert.hourlyRate}/hr`)
          ),
          urgency !== 'normal' && React.createElement('div', { 
            className: 'flex justify-between text-orange-600' 
          },
            React.createElement('span', null, 
              urgency === 'same-day' ? 'Same Day Surcharge:' : 'Emergency Rate:'
            ),
            React.createElement('span', null, 
              urgency === 'same-day' ? '+50%' : `£${expert.emergencyRate}/hr`
            )
          ),
          React.createElement('div', { className: 'flex justify-between' },
            React.createElement('span', null, 'Duration:'),
            React.createElement('span', null, `${duration} hours`)
          ),
          React.createElement('div', { 
            className: 'flex justify-between pt-2 border-t font-semibold' 
          },
            React.createElement('span', null, 'Total Estimate:'),
            React.createElement('span', { className: 'text-lg' }, 
              formatCurrency(calculateCost())
            )
          )
        ),
        React.createElement('p', { className: 'text-xs text-gray-600 mt-2' }, 
          '* Final cost may vary based on actual time and materials used'
        )
      ),
      
      // Terms
      React.createElement('div', { className: 'bg-gray-50 rounded-lg p-3' },
        React.createElement('label', { className: 'flex items-start text-sm' },
          React.createElement('input', {
            type: 'checkbox',
            required: true,
            className: 'mt-1 mr-2'
          }),
          React.createElement('span', null,
            'I agree to the ',
            React.createElement('a', { 
              href: '#', 
              className: 'text-blue-600 hover:underline' 
            }, 'terms of service'),
            ' and understand the cancellation policy'
          )
        )
      ),
      
      // Action Buttons
      React.createElement('div', { className: 'flex gap-3' },
        React.createElement('button', {
          type: 'button',
          onClick: onClose,
          className: 'flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold mobile-touch'
        }, 'Cancel'),
        React.createElement('button', {
          type: 'submit',
          className: 'flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 mobile-touch'
        }, 'Confirm Booking')
      )
    )
  );
};

// ============================================================================
// EMERGENCY HELP PAGE
// ============================================================================

const EmergencyHelpPage = ({ user }) => {
  const [emergencyType, setEmergencyType] = useState('');
  const [description, setDescription] = useState('');
  const [requestSent, setRequestSent] = useState(false);
  const [notifiedExperts, setNotifiedExperts] = useState(0);
  
  const handleEmergencyRequest = async () => {
    if (!emergencyType || !description.trim()) {
      alert('Please select emergency type and describe the issue');
      return;
    }
    
    const result = await dbOperations.createEmergencyRequest({
      userEmail: user.email,
      category: emergencyType,
      description: description,
      urgency: 'emergency'
    });
    
    if (result.success) {
      setRequestSent(true);
      setNotifiedExperts(result.notifiedExperts);
      triggerHaptic('success');
    }
  };
  
  if (requestSent) {
    return React.createElement('div', { className: 'text-center py-12' },
      React.createElement(SuccessAnimation, { 
        message: 'Emergency Request Sent!' 
      }),
      React.createElement('p', { className: 'text-gray-600 mt-4' },
        `We've notified ${notifiedExperts} available experts in your area.`
      ),
      React.createElement('p', { className: 'text-sm text-gray-500 mt-2' },
        'They will contact you shortly.'
      ),
      React.createElement('button', {
        onClick: () => {
          setRequestSent(false);
          setEmergencyType('');
          setDescription('');
        },
        className: 'mt-6 bg-blue-600 text-white px-6 py-3 rounded-lg mobile-touch'
      }, 'Send Another Request')
    );
  }
  
  return React.createElement('div', { className: 'space-y-6' },
    // Emergency Banner
    React.createElement('div', { 
      className: 'bg-red-600 text-white rounded-lg p-6 text-center emergency-button' 
    },
      React.createElement('h2', { className: 'text-2xl font-bold mb-2' }, 
        '🚨 Emergency Help'
      ),
      React.createElement('p', { className: 'mb-4' }, 
        'For life-threatening emergencies, call 999 immediately'
      ),
      React.createElement('a', {
        href: 'tel:999',
        className: 'inline-block bg-white text-red-600 px-8 py-3 rounded-lg font-semibold text-lg mobile-touch'
      }, '📞 Call 999')
    ),
    
    // Emergency Contacts
    React.createElement('div', { className: 'bg-white rounded-lg shadow-md p-6' },
      React.createElement('h3', { className: 'text-xl font-semibold mb-4' }, 
        'Emergency Services'
      ),
      React.createElement('div', { className: 'space-y-3' },
        React.createElement('a', {
          href: 'tel:0800111999',
          className: 'flex items-center justify-between p-4 bg-orange-50 rounded-lg hover:bg-orange-100 transition-colors mobile-touch'
        },
          React.createElement('div', null,
            React.createElement('div', { className: 'font-semibold flex items-center gap-2' },
              React.createElement('span', null, '🔥'),
              'Gas Emergency'
            ),
            React.createElement('div', { className: 'text-sm text-gray-600' }, 
              'Smell gas? Call immediately'
            )
          ),
          React.createElement('div', { className: 'text-blue-600 font-semibold' }, 
            '0800 111 999'
          )
        ),
        
        React.createElement('a', {
          href: 'tel:105',
          className: 'flex items-center justify-between p-4 bg-yellow-50 rounded-lg hover:bg-yellow-100 transition-colors mobile-touch'
        },
          React.createElement('div', null,
            React.createElement('div', { className: 'font-semibold flex items-center gap-2' },
              React.createElement('span', null, '💡'),
              'Power Cut'
            ),
            React.createElement('div', { className: 'text-sm text-gray-600' }, 
              'Report power outages'
            )
          ),
          React.createElement('div', { className: 'text-blue-600 font-semibold' }, 
            '105'
          )
        ),
        
        React.createElement('div', {
          className: 'flex items-center justify-between p-4 bg-blue-50 rounded-lg'
        },
          React.createElement('div', null,
            React.createElement('div', { className: 'font-semibold flex items-center gap-2' },
              React.createElement('span', null, '💧'),
              'Water Emergency'
            ),
            React.createElement('div', { className: 'text-sm text-gray-600' }, 
              'Check your water supplier'
            )
          ),
          React.createElement('button', {
            onClick: () => alert('Please check your water bill for emergency number'),
            className: 'text-blue-600 font-semibold'
          }, 'Find Number')
        )
      )
    ),
    
    // Request Emergency Expert
    React.createElement('div', { className: 'bg-white rounded-lg shadow-md p-6' },
      React.createElement('h3', { className: 'text-xl font-semibold mb-4' }, 
        'Request Emergency Expert'
      ),
      React.createElement('p', { className: 'text-gray-600 mb-4' },
        'For urgent but non-life-threatening issues, we can alert available experts.'
      ),
      
      React.createElement('div', { className: 'space-y-4' },
        React.createElement('div', null,
          React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 
            'Type of Emergency'
          ),
          React.createElement('select', {
            value: emergencyType,
            onChange: (e) => setEmergencyType(e.target.value),
            className: 'w-full p-3 border rounded-lg'
          },
            React.createElement('option', { value: '' }, 'Select emergency type...'),
            React.createElement('option', { value: 'plumbing' }, '💧 Burst Pipe / Major Leak'),
            React.createElement('option', { value: 'electrical' }, '⚡ Electrical Fault'),
            React.createElement('option', { value: 'heating' }, '🔥 No Heating / Hot Water'),
            React.createElement('option', { value: 'security' }, '🔒 Lock Out / Security'),
            React.createElement('option', { value: 'structural' }, '🏠 Structural Damage')
          )
        ),
        
        React.createElement('div', null,
          React.createElement('label', { className: 'block text-sm font-medium mb-2' }, 
            'Describe the Emergency'
          ),
          React.createElement('textarea', {
            value: description,
            onChange: (e) => setDescription(e.target.value),
            className: 'w-full p-3 border rounded-lg resize-none',
            rows: 4,
            placeholder: 'Please describe the emergency situation...'
          })
        ),
        
        React.createElement('button', {
          onClick: handleEmergencyRequest,
          disabled: !emergencyType || !description.trim(),
          className: `w-full py-3 rounded-lg font-semibold mobile-touch ${
            emergencyType && description.trim()
              ? 'bg-red-600 text-white hover:bg-red-700'
              : 'bg-gray-300 text-gray-500 cursor-not-allowed'
          }`
        }, '🚨 Send Emergency Request')
      )
    ),
    
    // Safety Tips
    React.createElement('div', { className: 'bg-yellow-50 rounded-lg p-6' },
      React.createElement('h3', { className: 'text-xl font-semibold mb-4 flex items-center gap-2' },
        React.createElement('span', null, '⚠️'),
        'Emergency Safety Tips'
      ),
      React.createElement('ul', { className: 'space-y-2 text-sm' },
        React.createElement('li', null, 
          '• If you smell gas: Open windows, don\'t use switches, evacuate and call from outside'
        ),
        React.createElement('li', null, 
          '• For electrical issues: Turn off main power if safe to do so'
        ),
        React.createElement('li', null, 
          '• For water leaks: Know where your stopcock is located'
        ),
        React.createElement('li', null, 
          '• Keep emergency numbers saved in your phone'
        ),
        React.createElement('li', null, 
          '• Have a torch and first aid kit accessible'
        )
      )
    )
  );
};

// ============================================================================
// PARTS FINDER PAGE
// ============================================================================

const PartsFinderPage = ({ user }) => {
  const [stores, setStores] = useState([]);
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedStore, setSelectedStore] = useState(null);
  const [userLocation, setUserLocation] = useState(null);
  
  useEffect(() => {
    // Load stores for user's area
    const localStores = partsStores.get('london') || [];
    setStores(localStores);
    
    // Try to get user location
    getUserLocation().then(location => {
      if (!location.error) {
        setUserLocation(location);
      }
    });
    
    analytics.trackPageView('parts_finder');
  }, []);
  
  const handleDirections = (store) => {
    const destination = encodeURIComponent(store.address);
    let url = `https://maps.google.com/?q=${destination}`;
    
    if (userLocation && userLocation.latitude) {
      const origin = `${userLocation.latitude},${userLocation.longitude}`;
      url = `https://www.google.com/maps/dir/${origin}/${destination}`;
    }
    
    window.open(url, '_blank');
    analytics.track('get_directions', { storeId: store.id });
  };
  
  const handleCall = (store) => {
    window.location.href = `tel:${store.phone}`;
    analytics.track('call_store', { storeId: store.id });
  };
  
  return React.createElement('div', { className: 'space-y-6' },
    // Search Bar
    React.createElement('div', { className: 'bg-white rounded-lg shadow-md p-4' },
      React.createElement('input', {
        type: 'text',
        placeholder: 'Search for parts or stores...',
        value: searchTerm,
        onChange: (e) => setSearchTerm(e.target.value),
        className: 'w-full p-3 border rounded-lg'
      })
    ),
    
    // Location Notice
    React.createElement('div', { className: 'bg-blue-50 rounded-lg p-4' },
      React.createElement('p', { className: 'text-sm text-blue-800' },
        React.createElement('span', { className: 'font-semibold' }, '📍 '),
        userLocation && !userLocation.error
          ? 'Using your current location for accurate distances'
          : 'Enable location for accurate store distances'
      )
    ),
    
    // Store List
    stores.length === 0
      ? React.createElement(EmptyState, {
          icon: '🏪',
          title: 'No stores found',
          description: 'No parts stores found in your area',
          action: null
        })
      : React.createElement('div', { className: 'space-y-4' },
          stores
            .filter(store => 
              !searchTerm || 
              store.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
              store.categories.some(cat => cat.includes(searchTerm.toLowerCase()))
            )
            .map(store =>
              React.createElement('div', {
                key: store.id,
                className: 'bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow'
              },
                // Store Header
                React.createElement('div', { className: 'flex justify-between items-start mb-4' },
                  React.createElement('div', null,
                    React.createElement('h3', { className: 'text-lg font-semibold' }, 
                      store.name
                    ),
                    React.createElement('p', { className: 'text-gray-600' }, 
                      store.address
                    ),
                    React.createElement('p', { className: 'text-sm text-blue-600 font-medium' }, 
                      `📍 ${store.distance}`
                    )
                  ),
                  React.createElement('div', { className: 'text-right' },
                    React.createElement(StarRating, { 
                      rating: store.rating, 
                      readonly: true,
                      size: 'small'
                    }),
                    store.priceMatch && React.createElement('div', {
                      className: 'text-xs bg-green-100 text-green-800 px-2 py-1 rounded mt-1'
                    }, '✓ Price Match')
                  )
                ),
                
                // Store Info
                React.createElement('div', { className: 'grid grid-cols-2 gap-4 mb-4 text-sm' },
                  React.createElement('div', null,
                    React.createElement('span', { className: 'text-gray-600' }, 'Hours: '),
                    React.createElement('span', null, store.openHours)
                  ),
                  React.createElement('div', null,
                    React.createElement('span', { className: 'text-gray-600' }, 'In Stock: '),
                    React.createElement('span', { className: 'font-semibold' }, 
                      `${store.inStockItems} items`
                    )
                  )
                ),
                
                // Categories
                React.createElement('div', { className: 'mb-4' },
                  React.createElement('div', { className: 'flex flex-wrap gap-2' },
                    store.categories.map((category, index) =>
                      React.createElement('span', {
                        key: index,
                        className: 'px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs'
                      }, category)
                    )
                  )
                ),
                
                // Features
                React.createElement('div', { className: 'flex gap-4 mb-4 text-sm' },
                  store.hasParking && React.createElement('div', { 
                    className: 'flex items-center gap-1 text-gray-600' 
                  },
                    React.createElement('span', null, '🚗'),
                    'Free Parking'
                  ),
                  store.wheelchairAccess && React.createElement('div', { 
                    className: 'flex items-center gap-1 text-gray-600' 
                  },
                    React.createElement('span', null, '♿'),
                    'Wheelchair Access'
                  )
                ),
                
                // Action Buttons
                React.createElement('div', { className: 'flex gap-3' },
                  React.createElement('button', {
                    onClick: () => handleCall(store),
                    className: 'flex-1 bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 mobile-touch flex items-center justify-center gap-2'
                  },
                    React.createElement('span', null, '📞'),
                    'Call Store'
                  ),
                  React.createElement('button', {
                    onClick: () => handleDirections(store),
                    className: 'flex-1 bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 mobile-touch flex items-center justify-center gap-2'
                  },
                    React.createElement('span', null, '📍'),
                    'Get Directions'
                  ),
                  React.createElement('button', {
                    onClick: () => {
                      setSelectedStore(store);
                      analytics.track('check_stock', { storeId: store.id });
                    },
                    className: 'flex-1 bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700 mobile-touch flex items-center justify-center gap-2'
                  },
                    React.createElement('span', null, '📦'),
                    'Check Stock'
                  )
                )
              )
            )
        ),
    
    // Stock Check Modal
    selectedStore && React.createElement(Modal, {
      isOpen: !!selectedStore,
      onClose: () => setSelectedStore(null),
      title: `Check Stock at ${selectedStore.name}`,
      size: 'medium'
    },
      React.createElement('div', { className: 'space-y-4' },
        React.createElement('p', { className: 'text-gray-600' },
          'Enter the part or product you\'re looking for:'
        ),
        React.createElement('input', {
          type: 'text',
          placeholder: 'e.g., 15mm copper pipe',
          className: 'w-full p-3 border rounded-lg',
          autoFocus: true
        }),
        React.createElement('div', { className: 'bg-blue-50 rounded-lg p-4' },
          React.createElement('p', { className: 'text-sm' },
            React.createElement('strong', null, 'Tip: '),
            'Call the store directly for real-time stock availability'
          )
        ),
        React.createElement('button', {
          onClick: () => handleCall(selectedStore),
          className: 'w-full bg-green-600 text-white py-3 rounded-lg font-semibold mobile-touch'
        }, '📞 Call Now to Check Stock')
      )
    )
  );
};

// ============================================================================
// ANALYSIS HISTORY PAGE
// ============================================================================

const AnalysisHistoryPage = ({ history, onViewDetails }) => {
  const [filter, setFilter] = useState('all');
  const [sortBy, setSortBy] = useState('date');
  
  const filteredHistory = history.filter(analysis => {
    if (filter === 'all') return true;
    if (filter === 'critical') return analysis.severity === 'Critical';
    if (filter === 'diy') return analysis.isDIYFriendly;
    if (filter === 'professional') return !analysis.isDIYFriendly;
    return true;
  }).sort((a, b) => {
    if (sortBy === 'date') return new Date(b.timestamp) - new Date(a.timestamp);
    if (sortBy === 'severity') {
      const severityOrder = { 'Critical': 3, 'High': 2, 'Medium': 1, 'Low': 0 };
      return severityOrder[b.severity] - severityOrder[a.severity];
    }
    return 0;
  });
  
  return React.createElement('div', { className: 'space-y-6' },
    React.createElement('h2', { className: 'text-2xl font-bold' }, 'Analysis History'),
    
    // Filters
    React.createElement('div', { className: 'bg-white rounded-lg shadow-md p-4' },
      React.createElement('div', { className: 'flex flex-wrap gap-3' },
        React.createElement('select', {
          value: filter,
          onChange: (e) => setFilter(e.target.value),
          className: 'p-2 border rounded-lg'
        },
          React.createElement('option', { value: 'all' }, 'All Analyses'),
          React.createElement('option', { value: 'critical' }, 'Critical Only'),
          React.createElement('option', { value: 'diy' }, 'DIY Friendly'),
          React.createElement('option', { value: 'professional' }, 'Professional Required')
        ),
        React.createElement('select', {
          value: sortBy,
          onChange: (e) => setSortBy(e.target.value),
          className: 'p-2 border rounded-lg'
        },
          React.createElement('option', { value: 'date' }, 'Sort by Date'),
          React.createElement('option', { value: 'severity' }, 'Sort by Severity')
        )
      )
    ),
    
    // History List
    filteredHistory.length === 0
      ? React.createElement(EmptyState, {
          icon: '📋',
          title: filter === 'all' ? 'No analyses yet' : 'No matching analyses',
          description: filter === 'all' 
            ? 'Start by taking a photo of your DIY problem'
            : 'Try adjusting your filters',
          action: filter !== 'all' && React.createElement('button', {
            onClick: () => setFilter('all'),
            className: 'bg-blue-600 text-white px-6 py-2 rounded-lg mobile-touch'
          }, 'Clear Filters')
        })
      : React.createElement('div', { className: 'space-y-4' },
          filteredHistory.map((analysis, index) =>
            React.createElement('div', {
              key: analysis.id || index,
              className: 'bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer',
              onClick: () => onViewDetails(analysis)
            },
              React.createElement('div', { className: 'flex justify-between items-start mb-3' },
                React.createElement('div', null,
                  React.createElement('h3', { className: 'text-lg font-semibold' }, 
                    analysis.problemDetected
                  ),
                  React.createElement('p', { className: 'text-sm text-gray-600' },
                    formatDate(analysis.timestamp)
                  )
                ),
                React.createElement('div', {
                  className: `px-3 py-1 rounded-full text-sm font-medium ${
                    analysis.severity === 'Critical' ? 'bg-red-100 text-red-800' :
                    analysis.severity === 'High' ? 'bg-orange-100 text-orange-800' :
                    'bg-yellow-100 text-yellow-800'
                  }`
                }, analysis.severity)
              ),
              React.createElement('p', { className: 'text-gray-700 mb-3' }, 
                analysis.description.substring(0, 150) + '...'
              ),
              React.createElement('div', { 
                className: 'grid grid-cols-3 gap-4 text-sm' 
              },
                React.createElement('div', null,
                  React.createElement('span', { className: 'text-gray-600' }, 'Cost: '),
                  React.createElement('span', { className: 'font-medium' }, 
                    analysis.estimatedCost
                  )
                ),
                React.createElement('div', null,
                  React.createElement('span', { className: 'text-gray-600' }, 'Time: '),
                  React.createElement('span', { className: 'font-medium' }, 
                    analysis.timeToFix
                  )
                ),
                React.createElement('div', null,
                  React.createElement('span', { className: 'text-gray-600' }, 'Type: '),
                  React.createElement('span', { 
                    className: `font-medium ${
                      analysis.isDIYFriendly ? 'text-green-600' : 'text-orange-600'
                    }` 
                  }, 
                    analysis.isDIYFriendly ? 'DIY' : 'Pro'
                  )
                )
              ),
              React.createElement('div', { 
                className: 'flex items-center justify-end mt-3 text-blue-600 text-sm font-medium' 
              },
                'View Details →'
              )
            )
          )
        )
  );
};

// ============================================================================
// USER PROFILE PAGE
// ============================================================================

const UserProfilePage = ({ user, onUpdate }) => {
  const [editMode, setEditMode] = useState(false);
  const [formData, setFormData] = useState({
    name: user.name || '',
    email: user.email || '',
    phone: user.phone || '',
    postcode: user.postcode || '',
    notifications: user.settings?.notifications ?? true,
    newsletter: user.settings?.newsletter ?? false
  });
  
  const handleSave = () => {
    onUpdate({
      ...user,
      name: formData.name,
      phone: formData.phone,
      postcode: formData.postcode,
      settings: {
        ...user.settings,
        notifications: formData.notifications,
        newsletter: formData.newsletter
      }
    });
    setEditMode(false);
    triggerHaptic('success');
    analytics.track('profile_updated');
  };
  
  return React.createElement('div', { className: 'space-y-6' },
    React.createElement('h2', { className: 'text-2xl font-bold' }, 'My Profile'),
    
    // Profile Card
    React.createElement('div', { className: 'bg-white rounded-lg shadow-md p-6' },
      React.createElement('div', { className: 'flex justify-between items-start mb-6' },
        React.createElement('div', { className: 'flex items-center gap-4' },
          React.createElement('div', { 
            className: 'w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center text-3xl' 
          }, user.name ? user.name[0].toUpperCase() : '👤'),
          React.createElement('div', null,
            React.createElement('h3', { className: 'text-xl font-semibold' }, user.name),
            React.createElement('p', { className: 'text-gray-600' }, user.email)
          )
        ),
        React.createElement('button', {
          onClick: () => {
            setEditMode(!editMode);
            triggerHaptic('light');
          },
          className: 'text-blue-600 hover:text-blue-800 font-medium'
        }, editMode ? 'Cancel' : 'Edit Profile')
      ),
      
      React.createElement('div', { className: 'space-y-4' },
        // Name
        React.createElement('div', null,
          React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 
            'Full Name'
          ),
          editMode
            ? React.createElement('input', {
                type: 'text',
                value: formData.name,
                onChange: (e) => setFormData({...formData, name: e.target.value}),
                className: 'w-full p-2 border rounded-lg'
              })
            : React.createElement('p', { className: 'text-gray-700' }, user.name)
        ),
        
        // Email (read-only)
        React.createElement('div', null,
          React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 
            'Email'
          ),
          React.createElement('p', { className: 'text-gray-700' }, user.email)
        ),
        
        // Phone
        React.createElement('div', null,
          React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 
            'Phone'
          ),
          editMode
            ? React.createElement('input', {
                type: 'tel',
                value: formData.phone,
                onChange: (e) => setFormData({...formData, phone: e.target.value}),
                className: 'w-full p-2 border rounded-lg',
                placeholder: 'Add phone number'
              })
            : React.createElement('p', { className: 'text-gray-700' }, 
                user.phone || 'Not provided'
              )
        ),
        
        // Postcode
        React.createElement('div', null,
          React.createElement('label', { className: 'block text-sm font-medium mb-1' }, 
            'Postcode'
          ),
          editMode
            ? React.createElement('input', {
                type: 'text',
                value: formData.postcode,
                onChange: (e) => setFormData({...formData, postcode: e.target.value}),
                className: 'w-full p-2 border rounded-lg',
                placeholder: 'Add postcode'
              })
            : React.createElement('p', { className: 'text-gray-700' }, 
                user.postcode || 'Not provided'
              )
        ),
        
        editMode && React.createElement('button', {
          onClick: handleSave,
          className: 'w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 mobile-touch'
        }, 'Save Changes')
      )
    ),
    
    // Referral Section
    React.createElement('div', { className: 'bg-gradient-to-r from-green-500 to-blue-600 rounded-lg p-6 text-white' },
      React.createElement('h3', { className: 'text-xl font-semibold mb-3' }, 
        '🎁 Refer Friends & Earn'
      ),
      React.createElement('p', { className: 'mb-4' },
        `Earn £${APP_CONFIG.referralBonus} for each friend who signs up and completes their first analysis!`
      ),
      React.createElement('div', { className: 'bg-white/20 backdrop-blur rounded-lg p-4' },
        React.createElement('p', { className: 'text-sm mb-2' }, 'Your referral code:'),
        React.createElement('div', { className: 'flex items-center gap-3' },
          React.createElement('div', { 
            className: 'font-mono text-xl bg-white/10 px-4 py-2 rounded flex-1' 
          }, user.referralCode),
          React.createElement('button', {
            onClick: () => {
              navigator.clipboard.writeText(user.referralCode);
              alert('Referral code copied!');
              triggerHaptic('success');
            },
            className: 'bg-white/20 px-4 py-2 rounded hover:bg-white/30 mobile-touch'
          }, '📋 Copy')
        )
      ),
      React.createElement('div', { className: 'mt-4 grid grid-cols-2 gap-4' },
        React.createElement('div', { className: 'text-center' },
          React.createElement('div', { className: 'text-2xl font-bold' }, 
            referralCodes.get(user.referralCode)?.uses || 0
          ),
          React.createElement('div', { className: 'text-sm opacity-80' }, 
            'Friends Joined'
          )
        ),
        React.createElement('div', { className: 'text-center' },
          React.createElement('div', { className: 'text-2xl font-bold' }, 
            formatCurrency(referralCodes.get(user.referralCode)?.earnings || 0)
          ),
          React.createElement('div', { className: 'text-sm opacity-80' }, 
            'Total Earned'
          )
        )
      )
    ),
    
    // Settings
    React.createElement('div', { className: 'bg-white rounded-lg shadow-md p-6' },
      React.createElement('h3', { className: 'text-xl font-semibold mb-4' }, 
        '⚙️ Settings'
      ),
      React.createElement('div', { className: 'space-y-4' },
        React.createElement('label', { 
          className: 'flex items-center justify-between cursor-pointer' 
        },
          React.createElement('div', null,
            React.createElement('div', { className: 'font-medium' }, 
              'Push Notifications'
            ),
            React.createElement('div', { className: 'text-sm text-gray-600' }, 
              'Get alerts for bookings and updates'
            )
          ),
          React.createElement('input', {
            type: 'checkbox',
            checked: formData.notifications,
            onChange: (e) => {
              const newValue = e.target.checked;
              setFormData({...formData, notifications: newValue});
              onUpdate({
                ...user,
                settings: { ...user.settings, notifications: newValue }
              });
              triggerHaptic('light');
            },
            className: 'w-12 h-6'
          })
        ),
        
        React.createElement('label', { 
          className: 'flex items-center justify-between cursor-pointer' 
        },
          React.createElement('div', null,
            React.createElement('div', { className: 'font-medium' }, 
              'Newsletter'
            ),
            React.createElement('div', { className: 'text-sm text-gray-600' }, 
              'Receive DIY tips and exclusive offers'
            )
          ),
          React.createElement('input', {
            type: 'checkbox',
            checked: formData.newsletter,
            onChange: (e) => {
              const newValue = e.target.checked;
              setFormData({...formData, newsletter: newValue});
              onUpdate({
                ...user,
                settings: { ...user.settings, newsletter: newValue }
              });
              triggerHaptic('light');
            },
            className: 'w-12 h-6'
          })
        )
      )
    ),
    
    // Account Actions
    React.createElement('div', { className: 'space-y-3' },
      React.createElement('button', {
        onClick: () => {
          if (confirm('Are you sure you want to delete your account? This cannot be undone.')) {
            analytics.track('account_deleted');
            alert('Account deletion requested. You will receive a confirmation email.');
          }
        },
        className: 'w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 mobile-touch'
      }, 'Delete Account'),
      
      React.createElement('button', {
        onClick: () => {
          alert('Privacy policy and terms of service');
        },
        className: 'w-full bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-300 mobile-touch'
      }, 'Privacy & Terms')
    )
  );
};

// ============================================================================
// SUPPORT CHAT MODAL
// ============================================================================

const SupportChatModal = ({ user, onClose }) => {
  const [messages, setMessages] = useState([
    {
      id: 1,
      sender: 'support',
      text: 'Hello! How can I help you today?',
      timestamp: new Date()
    }
  ]);
  const [inputMessage, setInputMessage] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const messagesEndRef = useRef(null);
  
  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };
  
  useEffect(() => {
    scrollToBottom();
  }, [messages]);
  
  const handleSend = () => {
    if (!inputMessage.trim()) return;
    
    const newMessage = {
      id: messages.length + 1,
      sender: 'user',
      text: inputMessage,
      timestamp: new Date()
    };
    
    setMessages([...messages, newMessage]);
    setInputMessage('');
    setIsTyping(true);
    
    // Simulate support response
    setTimeout(() => {
      const responses = [
        'Thanks for your message. Let me help you with that.',
        'I understand your concern. Have you tried checking our help center?',
        'I can definitely assist you with this issue.',
        'Let me look into this for you right away.'
      ];
      
      const supportMessage = {
        id: messages.length + 2,
        sender: 'support',
        text: responses[Math.floor(Math.random() * responses.length)],
        timestamp: new Date()
      };
      
      setMessages(prev => [...prev, supportMessage]);
      setIsTyping(false);
    }, 2000);
    
    analytics.track('support_message_sent');
  };
  
  return React.createElement(Modal, {
    isOpen: true,
    onClose: onClose,
    title: 'Support Chat',
    size: 'medium'
  },
    React.createElement('div', { className: 'flex flex-col h-96' },
      // Chat Messages
      React.createElement('div', { 
        className: 'flex-1 overflow-y-auto p-4 bg-gray-50 rounded-lg smooth-scroll' 
      },
        messages.map(message =>
          React.createElement('div', {
            key: message.id,
            className: `flex ${message.sender === 'user' ? 'justify-end' : 'justify-start'} mb-3`
          },
            React.createElement('div', {
              className: `chat-bubble ${message.sender}`
            },
              React.createElement('p', null, message.text),
              React.createElement('p', { 
                className: 'text-xs opacity-70 mt-1' 
              }, 
                new Date(message.timestamp).toLocaleTimeString([], { 
                  hour: '2-digit', 
                  minute: '2-digit' 
                })
              )
            )
          )
        ),
        isTyping && React.createElement('div', { 
          className: 'flex justify-start mb-3' 
        },
          React.createElement('div', { className: 'chat-bubble expert' },
            React.createElement('div', { className: 'typing-indicator' },
              React.createElement('span', { className: 'typing-dot' }),
              React.createElement('span', { className: 'typing-dot' }),
              React.createElement('span', { className: 'typing-dot' })
            )
          )
        ),
        React.createElement('div', { ref: messagesEndRef })
      ),
      
      // Input Area
      React.createElement('div', { className: 'mt-4 flex gap-2' },
        React.createElement('input', {
          type: 'text',
          value: inputMessage,
          onChange: (e) => setInputMessage(e.target.value),
          onKeyPress: (e) => e.key === 'Enter' && handleSend(),
          placeholder: 'Type your message...',
          className: 'flex-1 p-3 border rounded-lg'
        }),
        React.createElement('button', {
          onClick: handleSend,
          disabled: !inputMessage.trim(),
          className: `px-6 py-3 rounded-lg font-semibold mobile-touch ${
            inputMessage.trim()
              ? 'bg-blue-600 text-white hover:bg-blue-700'
              : 'bg-gray-300 text-gray-500 cursor-not-allowed'
          }`
        }, 'Send')
      )
    )
  );
};

// ============================================================================
// EXPERT DASHBOARD
// ============================================================================

const ExpertDashboard = ({ expert, onLogout }) => {
  const [activeTab, setActiveTab] = useState('overview');
  const [bookings, setBookings] = useState([]);
  const [reviews, setReviews] = useState([]);
  const [earnings, setEarnings] = useState({
    today: 0,
    week: 0,
    month: 0,
    total: expert.earnings || 0
  });
  
  useEffect(() => {
    // Load expert data
    const expertBookings = Array.from(bookings.values())
      .flat()
      .filter(b => b.expertId === expert.id);
    setBookings(expertBookings);
    
    const expertReviews = expertReviews.get(expert.id) || [];
    setReviews(expertReviews);
    
    analytics.trackPageView('expert_dashboard');
    setCurrentUser(expert);
  }, [expert]);
  
  const renderOverviewTab = () => {
    return React.createElement('div', { className: 'space-y-6' },
      // Welcome Card
      React.createElement('div', { 
        className: 'bg-gradient-to-r from-green-500 to-blue-600 rounded-xl p-6 text-white' 
      },
        React.createElement('h2', { className: 'text-2xl font-bold mb-2' }, 
          `Welcome back, ${expert.name}!`
        ),
        React.createElement('p', { className: 'mb-4' }, 
          `${expert.profession} • ${expert.location}`
        ),
        React.createElement('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4' },
          React.createElement('div', { className: 'bg-white/20 backdrop-blur rounded-lg p-3' },
            React.createElement('div', { className: 'text-3xl font-bold' }, 
              `${expert.rating} ⭐`
            ),
            React.createElement('div', { className: 'text-sm opacity-90' }, 
              `${expert.reviews} reviews`
            )
          ),
          React.createElement('div', { className: 'bg-white/20 backdrop-blur rounded-lg p-3' },
            React.createElement('div', { className: 'text-3xl font-bold' }, 
              expert.completedJobs
            ),
            React.createElement('div', { className: 'text-sm opacity-90' }, 
              'Jobs Done'
            )
          ),
          React.createElement('div', { className: 'bg-white/20 backdrop-blur rounded-lg p-3' },
            React.createElement('div', { className: 'text-3xl font-bold' }, 
              `${expert.responseRate}%`
            ),
            React.createElement('div', { className: 'text-sm opacity-90' }, 
              'Response Rate'
            )
          ),
          React.createElement('div', { className: 'bg-white/20 backdrop-blur rounded-lg p-3' },
            React.createElement('div', { className: 'text-3xl font-bold' }, 
              formatCurrency(earnings.total)
            ),
            React.createElement('div', { className: 'text-sm opacity-90' }, 
              'Total Earned'
            )
          )
        )
      ),
      
      // Quick Actions
      React.createElement('div', { className: 'grid grid-cols-2 md:grid-cols-4 gap-4' },
        React.createElement('button', {
          onClick: () => setActiveTab('bookings'),
          className: 'mobile-touch bg-blue-600 text-white p-6 rounded-xl hover:bg-blue-700 transition-all'
        },
          React.createElement('div', { className: 'text-3xl mb-2' }, '📅'),
          React.createElement('div', { className: 'font-semibold' }, 'Bookings'),
          React.createElement('div', { className: 'text-xs opacity-80' }, 
            `${bookings.filter(b => b.status === 'pending').length} pending`
          )
        ),
        
        React.createElement('button', {
          onClick: () => setActiveTab('earnings'),
          className: 'mobile-touch bg-green-600 text-white p-6 rounded-xl hover:bg-green-700 transition-all'
        },
          React.createElement('div', { className: 'text-3xl mb-2' }, '💰'),
          React.createElement('div', { className: 'font-semibold' }, 'Earnings'),
          React.createElement('div', { className: 'text-xs opacity-80' }, 
            `${formatCurrency(earnings.month)} this month`
          )
        ),
        
        React.createElement('button', {
          onClick: () => setActiveTab('availability'),
          className: 'mobile-touch bg-purple-600 text-white p-6 rounded-xl hover:bg-purple-700 transition-all'
        },
          React.createElement('div', { className: 'text-3xl mb-2' }, '🗓️'),
          React.createElement('div', { className: 'font-semibold' }, 'Availability'),
          React.createElement('div', { className: 'text-xs opacity-80' }, 'Manage schedule')
        ),
        
        React.createElement('button', {
          onClick: () => setActiveTab('profile'),
          className: 'mobile-touch bg-orange-600 text-white p-6 rounded-xl hover:bg-orange-700 transition-all'
        },
          React.createElement('div', { className: 'text-3xl mb-2' }, '👤'),
          React.createElement('div', { className: 'font-semibold' }, 'Profile'),
          React.createElement('div', { className: 'text-xs opacity-80' }, 'Edit details')
        )
      ),
      
      // Recent Activity
      React.createElement('div', { className: 'bg-white rounded-lg shadow-md p-6' },
        React.createElement('h3', { className: 'text-xl font-semibold mb-4' }, 
          'Recent Activity'
        ),
        React.createElement('div', { className: 'space-y-3' },
          React.createElement('div', { 
            className: 'flex items-center justify-between p-3 bg-blue-50 rounded-lg' 
          },
            React.createElement('div', { className: 'flex items-center gap-3' },
              React.createElement('div', { className: 'text-2xl' }, '📅'),
              React.createElement('div', null,
                React.createElement('div', { className: 'font-medium' }, 
                  'New booking request'
                ),
                React.createElement('div', { className: 'text-sm text-gray-600' }, 
                  '2 hours ago'
                )
              )
            ),
            React.createElement('button', { 
              className: 'text-blue-600 font-medium' 
            }, 'View')
          ),
          React.createElement('div', { 
            className: 'flex items-center justify-between p-3 bg-green-50 rounded-lg' 
          },
            React.createElement('div', { className: 'flex items-center gap-3' },
              React.createElement('div', { className: 'text-2xl' }, '⭐'),
              React.createElement('div', null,
                React.createElement('div', { className: 'font-medium' }, 
                  'New 5-star review'
                ),
                React.createElement('div', { className: 'text-sm text-gray-600' }, 
                  'Yesterday'
                )
              )
            ),
            React.createElement('button', { 
              className: 'text-green-600 font-medium' 
            }, 'Read')
          )
        )
      )
    );
  };
  
  return React.createElement('div', { className: 'min-h-screen bg-gray-50' },
    // Header
    React.createElement('div', { className: 'safe-area-top bg-white shadow-sm' },
      React.createElement('div', { className: 'container mx-auto px-4 py-4' },
        React.createElement('div', { className: 'flex justify-between items-center' },
          React.createElement('h1', { className: 'text-2xl font-bold flex items-center' },
            React.createElement('span', { className: 'text-3xl mr-2' }, '👨‍🔧'),
            ' Expert Portal'
          ),
          React.createElement('button', {
            onClick: onLogout,
            className: 'text-gray-600 hover:text-gray-800'
          }, 'Logout')
        )
      )
    ),
    
    // Main Content
    React.createElement('div', { className: 'container mx-auto px-4 py-6' },
      activeTab === 'overview' && renderOverviewTab(),
      activeTab === 'bookings' && React.createElement('div', { 
        className: 'text-center py-12' 
      },
        React.createElement('p', { className: 'text-gray-600' }, 
          'Bookings management coming soon!'
        )
      ),
      activeTab === 'earnings' && React.createElement('div', { 
        className: 'text-center py-12' 
      },
        React.createElement('p', { className: 'text-gray-600' }, 
          'Earnings dashboard coming soon!'
        )
      ),
      activeTab === 'availability' && React.createElement('div', { 
        className: 'text-center py-12' 
      },
        React.createElement('p', { className: 'text-gray-600' }, 
          'Availability calendar coming soon!'
        )
      ),
      activeTab === 'profile' && React.createElement('div', { 
        className: 'text-center py-12' 
      },
        React.createElement('p', { className: 'text-gray-600' }, 
          'Profile editing coming soon!'
        )
      )
    )
  );
};

// ============================================================================
// ADMIN DASHBOARD
// ============================================================================

const AdminDashboard = ({ onLogout }) => {
  const [activeTab, setActiveTab] = useState('overview');
  
  const stats = {
    totalUsers: registeredUsers.size,
    totalExperts: expertProfiles.size,
    totalAnalyses: Array.from(aiAnalysisHistory.values()).flat().length,
    totalBookings: Array.from(bookings.values()).flat().length,
    monthlyRevenue: 2847.50,
    activeUsers: Math.floor(registeredUsers.size * 0.7),
    pendingVerifications: 3,
    supportTickets: 12
  };
  
  useEffect(() => {
    analytics.trackPageView('admin_dashboard');
  }, []);
  
  return React.createElement('div', { className: 'min-h-screen bg-gray-100' },
    // Header
    React.createElement('div', { className: 'bg-white shadow-sm' },
      React.createElement('div', { className: 'container mx-auto px-4 py-4' },
        React.createElement('div', { className: 'flex justify-between items-center' },
          React.createElement('h1', { className: 'text-2xl font-bold' }, 
            'Admin Dashboard'
          ),
          React.createElement('button', {
            onClick: onLogout,
            className: 'text-gray-600'
          }, 'Logout')
        )
      )
    ),
    
    // Stats Grid
    React.createElement('div', { className: 'container mx-auto px-4 py-6' },
      React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-4 gap-4 mb-6' },
        React.createElement('div', { className: 'admin-stat-card' },
          React.createElement('div', { className: 'admin-stat-value' }, 
            stats.totalUsers
          ),
          React.createElement('div', { className: 'admin-stat-label' }, 
            'Total Users'
          )
        ),
        React.createElement('div', { className: 'admin-stat-card' },
          React.createElement('div', { className: 'admin-stat-value' }, 
            stats.totalExperts
          ),
          React.createElement('div', { className: 'admin-stat-label' }, 
            'Total Experts'
          )
        ),
        React.createElement('div', { className: 'admin-stat-card' },
          React.createElement('div', { className: 'admin-stat-value' }, 
            stats.totalAnalyses
          ),
          React.createElement('div', { className: 'admin-stat-label' }, 
            'Total Analyses'
          )
        ),
        React.createElement('div', { className: 'admin-stat-card' },
          React.createElement('div', { className: 'admin-stat-value' }, 
            formatCurrency(stats.monthlyRevenue)
          ),
          React.createElement('div', { className: 'admin-stat-label' }, 
            'Monthly Revenue'
          )
        )
      ),
      
      // Tabs
      React.createElement('div', { className: 'bg-white rounded-lg shadow-md' },
        React.createElement('div', { className: 'border-b' },
          React.createElement('div', { className: 'flex' },
            ['Overview', 'Users', 'Experts', 'Analytics', 'Settings'].map(tab =>
              React.createElement('button', {
                key: tab,
                onClick: () => setActiveTab(tab.toLowerCase()),
                className: `px-6 py-3 font-medium ${
                  activeTab === tab.toLowerCase()
                    ? 'border-b-2 border-blue-600 text-blue-600'
                    : 'text-gray-600 hover:text-gray-800'
                }`
              }, tab)
            )
          )
        ),
        
        React.createElement('div', { className: 'p-6' },

activeTab === 'users' && React.createElement('div', null,
            React.createElement('h2', { className: 'text-xl font-semibold mb-4' }, 
              'User Management'
            ),
            React.createElement('p', { className: 'text-gray-600' }, 
              'User management interface coming soon...'
            )
          ),
          
          activeTab === 'experts' && React.createElement('div', null,
            React.createElement('h2', { className: 'text-xl font-semibold mb-4' }, 
              'Expert Management'
            ),
            React.createElement('p', { className: 'text-gray-600' }, 
              'Expert verification and management coming soon...'
            )
          ),
          
          activeTab === 'analytics' && React.createElement('div', null,
            React.createElement('h2', { className: 'text-xl font-semibold mb-4' }, 
              'Analytics Dashboard'
            ),
            React.createElement('p', { className: 'text-gray-600' }, 
              'Detailed analytics coming soon...'
            )
          ),
          
          activeTab === 'settings' && React.createElement('div', null,
            React.createElement('h2', { className: 'text-xl font-semibold mb-4' }, 
              'System Settings'
            ),
            React.createElement('p', { className: 'text-gray-600' }, 
              'System configuration coming soon...'
            )
          )
        )
      )
    )
  );
};

// ============================================================================
// AUTHENTICATION PAGES
// ============================================================================

const LoginPage = ({ onLogin, onSignup, onBack, userType = 'user' }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const [showPassword, setShowPassword] = useState(false);
  const [rememberMe, setRememberMe] = useState(false);
  
  const handleLogin = async (e) => {
    e.preventDefault();
    setLoading(true);
    
    try {
      // Admin login
      if (userType === 'admin' && email === APP_CONFIG.adminEmail && password === APP_CONFIG.adminPassword) {
        analytics.track('admin_login', { email });
        onLogin({ type: 'admin', email });
        return;
      }
      
      // Regular user/expert login
      const user = registeredUsers.get(email.toLowerCase());
      if (user && user.password === password) {
        analytics.track('user_login', { userType, email });
        
        if (rememberMe) {
          localStorage.setItem('diymatch_remember', email);
        }
        
        onLogin({ ...user, type: userType });
        return;
      }
      
      alert('Invalid email or password');
      triggerHaptic('error');
    } catch (error) {
      console.error('Login error:', error);
      alert('Login failed. Please try again.');
    } finally {
      setLoading(false);
    }
  };
  
  useEffect(() => {
    const remembered = localStorage.getItem('diymatch_remember');
    if (remembered) {
      setEmail(remembered);
      setRememberMe(true);
    }
  }, []);
  
  return React.createElement('div', { 
    className: 'min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4' 
  },
    React.createElement('div', { 
      className: 'bg-white rounded-2xl shadow-xl p-8 w-full max-w-md fade-in' 
    },
      React.createElement('div', { className: 'text-center mb-8' },
        React.createElement('div', { 
          className: 'text-5xl mb-4 float-animation' 
        },
          userType === 'expert' ? '👨‍🔧' : userType === 'admin' ? '⚙️' : '🔧'
        ),
        React.createElement('h2', { className: 'text-3xl font-bold mb-2' },
          userType === 'expert' ? 'Expert Login' : 
          userType === 'admin' ? 'Admin Login' : 
          'Welcome Back'
        ),
        React.createElement('p', { className: 'text-gray-600' }, 
          'Sign in to continue'
        )
      ),
      
      React.createElement('form', { onSubmit: handleLogin, className: 'space-y-4' },
        React.createElement('div', null,
          React.createElement('label', { 
            className: 'block text-sm font-medium mb-2' 
          }, 'Email'),
          React.createElement('input', {
            type: 'email',
            value: email,
            onChange: (e) => setEmail(e.target.value),
            className: 'w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent',
            placeholder: 'your@email.com',
            required: true,
            autoComplete: 'email'
          })
        ),
        
        React.createElement('div', null,
          React.createElement('label', { 
            className: 'block text-sm font-medium mb-2' 
          }, 'Password'),
          React.createElement('div', { className: 'relative' },
            React.createElement('input', {
              type: showPassword ? 'text' : 'password',
              value: password,
              onChange: (e) => setPassword(e.target.value),
              className: 'w-full p-3 border rounded-lg pr-10 focus:ring-2 focus:ring-blue-500 focus:border-transparent',
              placeholder: '••••••••',
              required: true,
              autoComplete: 'current-password'
            }),
            React.createElement('button', {
              type: 'button',
              onClick: () => setShowPassword(!showPassword),
              className: 'absolute right-3 top-3 text-gray-500 hover:text-gray-700'
            }, showPassword ? '🙈' : '👁️')
          )
        ),
        
        React.createElement('div', { 
          className: 'flex items-center justify-between' 
        },
          React.createElement('label', { 
            className: 'flex items-center cursor-pointer' 
          },
            React.createElement('input', {
              type: 'checkbox',
              checked: rememberMe,
              onChange: (e) => setRememberMe(e.target.checked),
              className: 'mr-2'
            }),
            React.createElement('span', { className: 'text-sm text-gray-600' }, 
              'Remember me'
            )
          ),
          React.createElement('button', {
            type: 'button',
            onClick: () => alert('Password reset coming soon!'),
            className: 'text-sm text-blue-600 hover:text-blue-800'
          }, 'Forgot password?')
        ),
        
        React.createElement('button', {
          type: 'submit',
          disabled: loading,
          className: `w-full py-3 rounded-lg font-semibold transition-all mobile-touch ${
            loading
              ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
              : 'bg-blue-600 text-white hover:bg-blue-700 transform hover:scale-105'
          }`
        }, loading ? React.createElement(LoadingSpinner, { 
          size: 'small', 
          color: 'white' 
        }) : 'Sign In')
      ),
      
      userType === 'user' && React.createElement('div', { 
        className: 'mt-6 text-center' 
      },
        React.createElement('p', { className: 'text-gray-600' },
          "Don't have an account? ",
          React.createElement('button', {
            onClick: onSignup,
            className: 'text-blue-600 hover:text-blue-800 font-semibold'
          }, 'Sign up')
        )
      ),
      
      React.createElement('div', { className: 'mt-6 text-center' },
        React.createElement('button', {
          onClick: onBack,
          className: 'text-gray-600 hover:text-gray-800'
        }, '← Back')
      ),
      
      userType === 'user' && React.createElement('div', { 
        className: 'mt-6 pt-6 border-t' 
      },
        React.createElement('p', { 
          className: 'text-center text-sm text-gray-600 mb-3' 
        }, 'Or continue with'),
        React.createElement('div', { className: 'grid grid-cols-2 gap-3' },
          React.createElement('button', {
            type: 'button',
            onClick: () => alert('Google login coming soon!'),
            className: 'bg-white border border-gray-300 py-2 rounded-lg hover:bg-gray-50 mobile-touch flex items-center justify-center gap-2'
          },
            React.createElement('span', null, '🔍'),
            'Google'
          ),
          React.createElement('button', {
            type: 'button',
            onClick: () => alert('Apple login coming soon!'),
            className: 'bg-black text-white py-2 rounded-lg hover:bg-gray-800 mobile-touch flex items-center justify-center gap-2'
          },
            React.createElement('span', null, '🍎'),
            'Apple'
          )
        )
      )
    )
  );
};

const SignupPage = ({ onSignup, onBack, userType = 'user' }) => {
  const [step, setStep] = useState(1);
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    password: '',
    confirmPassword: '',
    phone: '',
    postcode: '',
    acceptTerms: false,
    acceptMarketing: false,
    referralCode: ''
  });
  const [loading, setLoading] = useState(false);
  const [showPassword, setShowPassword] = useState(false);
  const [passwordStrength, setPasswordStrength] = useState(0);
  
  useEffect(() => {
    // Check password strength
    const password = formData.password;
    let strength = 0;
    if (password.length >= 8) strength++;
    if (/[A-Z]/.test(password)) strength++;
    if (/[a-z]/.test(password)) strength++;
    if (/[0-9]/.test(password)) strength++;
    if (/[^A-Za-z0-9]/.test(password)) strength++;
    setPasswordStrength(strength);
  }, [formData.password]);
  
  const handleSubmit = async (e) => {
    e.preventDefault();
    
    if (formData.password !== formData.confirmPassword) {
      alert('Passwords do not match');
      triggerHaptic('error');
      return;
    }
    
    if (!formData.acceptTerms) {
      alert('Please accept the terms and conditions');
      triggerHaptic('error');
      return;
    }
    
    if (passwordStrength < 3) {
      alert('Please use a stronger password');
      triggerHaptic('error');
      return;
    }
    
    setLoading(true);
    
    try {
      if (registeredUsers.has(formData.email.toLowerCase())) {
        alert('An account with this email already exists');
        return;
      }
      
      const userData = {
        name: formData.name,
        email: formData.email.toLowerCase(),
        password: formData.password,
        phone: formData.phone,
        postcode: formData.postcode,
        userType: userType,
        acceptMarketing: formData.acceptMarketing,
        referredBy: formData.referralCode
      };
      
      const result = await dbOperations.createUser(userData);
      
      if (result.success) {
        // Process referral if code provided
        if (formData.referralCode) {
          const referralData = referralCodes.get(formData.referralCode);
          if (referralData) {
            referralData.uses++;
            referralCodes.set(formData.referralCode, referralData);
          }
        }
        
        alert('Account created successfully!');
        triggerHaptic('success');
        onSignup({ ...result.user, type: 'user' });
      }
    } catch (error) {
      console.error('Signup error:', error);
      alert('Signup failed. Please try again.');
    } finally {
      setLoading(false);
    }
  };
  
  const renderStep1 = () => React.createElement('div', { className: 'space-y-4' },
    React.createElement('div', null,
      React.createElement('label', { 
        className: 'block text-sm font-medium mb-2' 
      }, 'Full Name'),
      React.createElement('input', {
        type: 'text',
        value: formData.name,
        onChange: (e) => setFormData({...formData, name: e.target.value}),
        className: 'w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500',
        placeholder: 'John Smith',
        required: true,
        autoFocus: true
      })
    ),
    
    React.createElement('div', null,
      React.createElement('label', { 
        className: 'block text-sm font-medium mb-2' 
      }, 'Email'),
      React.createElement('input', {
        type: 'email',
        value: formData.email,
        onChange: (e) => setFormData({...formData, email: e.target.value}),
        className: 'w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500',
        placeholder: 'john@example.com',
        required: true
      })
    ),
    
    React.createElement('div', null,
      React.createElement('label', { 
        className: 'block text-sm font-medium mb-2' 
      }, 'Phone (Optional)'),
      React.createElement('input', {
        type: 'tel',
        value: formData.phone,
        onChange: (e) => setFormData({...formData, phone: e.target.value}),
        className: 'w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500',
        placeholder: '07123456789'
      })
    ),
    
    React.createElement('button', {
      onClick: () => {
        if (formData.name && formData.email) {
          setStep(2);
          triggerHaptic('light');
        } else {
          alert('Please fill in required fields');
        }
      },
      className: 'w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 mobile-touch'
    }, 'Continue →')
  );
  
  const renderStep2 = () => React.createElement('div', { className: 'space-y-4' },
    React.createElement('div', null,
      React.createElement('label', { 
        className: 'block text-sm font-medium mb-2' 
      }, 'Password'),
      React.createElement('div', { className: 'relative' },
        React.createElement('input', {
          type: showPassword ? 'text' : 'password',
          value: formData.password,
          onChange: (e) => setFormData({...formData, password: e.target.value}),
          className: 'w-full p-3 border rounded-lg pr-10 focus:ring-2 focus:ring-blue-500',
          placeholder: 'Min 8 characters',
          required: true,
          minLength: 8
        }),
        React.createElement('button', {
          type: 'button',
          onClick: () => setShowPassword(!showPassword),
          className: 'absolute right-3 top-3 text-gray-500 hover:text-gray-700'
        }, showPassword ? '🙈' : '👁️')
      ),
      React.createElement('div', { className: 'mt-2' },
        React.createElement('div', { className: 'flex gap-1' },
          [1, 2, 3, 4, 5].map(level =>
            React.createElement('div', {
              key: level,
              className: `h-2 flex-1 rounded ${
                level <= passwordStrength 
                  ? passwordStrength <= 2 ? 'bg-red-500' :
                    passwordStrength <= 3 ? 'bg-yellow-500' :
                    'bg-green-500'
                  : 'bg-gray-200'
              }`
            })
          )
        ),
        React.createElement('p', { 
          className: `text-xs mt-1 ${
            passwordStrength <= 2 ? 'text-red-600' :
            passwordStrength <= 3 ? 'text-yellow-600' :
            'text-green-600'
          }` 
        }, 
          passwordStrength <= 2 ? 'Weak password' :
          passwordStrength <= 3 ? 'Good password' :
          'Strong password'
        )
      )
    ),
    
    React.createElement('div', null,
      React.createElement('label', { 
        className: 'block text-sm font-medium mb-2' 
      }, 'Confirm Password'),
      React.createElement('input', {
        type: 'password',
        value: formData.confirmPassword,
        onChange: (e) => setFormData({...formData, confirmPassword: e.target.value}),
        className: 'w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500',
        placeholder: 'Repeat password',
        required: true
      })
    ),
    
    React.createElement('div', null,
      React.createElement('label', { 
        className: 'block text-sm font-medium mb-2' 
      }, 'Postcode'),
      React.createElement('input', {
        type: 'text',
        value: formData.postcode,
        onChange: (e) => setFormData({...formData, postcode: e.target.value}),
        className: 'w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500',
        placeholder: 'SW1A 1AA',
        required: true
      })
    ),
    
    React.createElement('div', null,
      React.createElement('label', { 
        className: 'block text-sm font-medium mb-2' 
      }, 'Referral Code (Optional)'),
      React.createElement('input', {
        type: 'text',
        value: formData.referralCode,
        onChange: (e) => setFormData({...formData, referralCode: e.target.value.toUpperCase()}),
        className: 'w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500',
        placeholder: 'Enter code'
      }),
      React.createElement('p', { className: 'text-xs text-gray-600 mt-1' },
        `Both you and your friend get £${APP_CONFIG.referralBonus} credit!`
      )
    ),
    
    React.createElement('div', { className: 'flex gap-3' },
      React.createElement('button', {
        onClick: () => {
          setStep(1);
          triggerHaptic('light');
        },
        className: 'flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold mobile-touch'
      }, '← Back'),
      React.createElement('button', {
        onClick: () => {
          if (formData.password && formData.confirmPassword && formData.postcode) {
            setStep(3);
            triggerHaptic('light');
          } else {
            alert('Please fill in all fields');
          }
        },
        className: 'flex-1 bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 mobile-touch'
      }, 'Continue →')
    )
  );
  
  const renderStep3 = () => React.createElement('form', { 
    onSubmit: handleSubmit, 
    className: 'space-y-4' 
  },
    React.createElement('div', { 
      className: 'bg-gray-50 rounded-lg p-4 space-y-3' 
    },
      React.createElement('label', { 
        className: 'flex items-start cursor-pointer' 
      },
        React.createElement('input', {
          type: 'checkbox',
          checked: formData.acceptTerms,
          onChange: (e) => setFormData({...formData, acceptTerms: e.target.checked}),
          className: 'mt-1 mr-3',
          required: true
        }),
        React.createElement('span', { className: 'text-sm text-gray-700' },
          'I accept the ',
          React.createElement('a', { 
            href: '#', 
            className: 'text-blue-600 hover:underline' 
          }, 'Terms of Service'),
          ' and ',
          React.createElement('a', { 
            href: '#', 
            className: 'text-blue-600 hover:underline' 
          }, 'Privacy Policy')
        )
      ),
      
      React.createElement('label', { 
        className: 'flex items-start cursor-pointer' 
      },
        React.createElement('input', {
          type: 'checkbox',
          checked: formData.acceptMarketing,
          onChange: (e) => setFormData({...formData, acceptMarketing: e.target.checked}),
          className: 'mt-1 mr-3'
        }),
        React.createElement('span', { className: 'text-sm text-gray-700' },
          'Send me helpful DIY tips and exclusive offers'
        )
      )
    ),
    
    React.createElement('div', { 
      className: 'bg-blue-50 rounded-lg p-4' 
    },
      React.createElement('h4', { 
        className: 'font-semibold text-blue-800 mb-2' 
      }, '🎉 Welcome Offer'),
      React.createElement('p', { className: 'text-sm text-blue-700' },
        'Your first AI analysis is FREE! Additional analyses only £4.99.'
      )
    ),
    
    React.createElement('div', { className: 'flex gap-3' },
      React.createElement('button', {
        type: 'button',
        onClick: () => {
          setStep(2);
          triggerHaptic('light');
        },
        className: 'flex-1 bg-gray-200 text-gray-800 py-3 rounded-lg font-semibold mobile-touch'
      }, '← Back'),
      React.createElement('button', {
        type: 'submit',
        disabled: loading || !formData.acceptTerms,
        className: `flex-1 py-3 rounded-lg font-semibold mobile-touch ${
          loading || !formData.acceptTerms
            ? 'bg-gray-300 text-gray-500 cursor-not-allowed'
            : 'bg-green-600 text-white hover:bg-green-700'
        }`
      }, loading ? React.createElement(LoadingSpinner, { 
        size: 'small', 
        color: 'white' 
      }) : 'Create Account')
    )
  );
  
  return React.createElement('div', { 
    className: 'min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4' 
  },
    React.createElement('div', { 
      className: 'bg-white rounded-2xl shadow-xl p-8 w-full max-w-md fade-in' 
    },
      React.createElement('div', { className: 'text-center mb-8' },
        React.createElement('div', { 
          className: 'text-5xl mb-4 float-animation' 
        }, '🔧'),
        React.createElement('h2', { className: 'text-3xl font-bold mb-2' }, 
          'Create Account'
        ),
        React.createElement('p', { className: 'text-gray-600' }, 
          'Join DIYMatch today'
        )
      ),
      
      React.createElement(ProgressSteps, {
        steps: ['Details', 'Security', 'Confirm'],
        currentStep: step - 1
      }),
      
      step === 1 && renderStep1(),
      step === 2 && renderStep2(),
      step === 3 && renderStep3(),
      
      React.createElement('div', { className: 'mt-6 text-center' },
        React.createElement('button', {
          onClick: onBack,
          className: 'text-gray-600 hover:text-gray-800'
        }, '← Back to Login')
      )
    )
  );
};

// ============================================================================
// MAIN APP COMPONENT
// ============================================================================

const App = () => {
  const [currentView, setCurrentView] = useState('welcome');
  const [currentUser, setCurrentUser] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [theme, setTheme] = useState('light');
  
  useEffect(() => {
    // Initialize app
    const initApp = async () => {
      try {
        // Check for saved session
        const savedSession = localStorage.getItem('diymatch_session');
        if (savedSession) {
          const session = JSON.parse(savedSession);
          const user = registeredUsers.get(session.email);
          if (user) {
            handleLogin(user);
          }
        }
        
        // Hide splash screen
        setTimeout(() => {
          const splash = document.getElementById('splash-screen');
          if (splash) {
            splash.style.opacity = '0';
            setTimeout(() => splash.remove(), 300);
          }
          setIsLoading(false);
        }, 2000);
        
        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
        }
        
        analytics.track('app_started');
      } catch (error) {
        console.error('App initialization error:', error);
        setIsLoading(false);
      }
    };
    
    initApp();
  }, []);
  
  const handleLogin = (user) => {
    setCurrentUser(user);
    localStorage.setItem('diymatch_session', JSON.stringify({ 
      email: user.email, 
      type: user.type 
    }));
    
    switch (user.type) {
      case 'admin':
        setCurrentView('admin_dashboard');
        break;
      case 'expert':
        setCurrentView('expert_dashboard');
        break;
      default:
        setCurrentView('user_dashboard');
    }
    
    analytics.track('user_logged_in', { userType: user.type });
  };
  
  const handleLogout = () => {
    setCurrentUser(null);
    setCurrentView('welcome');
    localStorage.removeItem('diymatch_session');
    analytics.track('user_logged_out', { userType: currentUser?.type });
    triggerHaptic('medium');
  };
  
  if (isLoading) {
    return null;
  }
  
  return React.createElement(ErrorBoundary, null,
    React.createElement(ThemeContext.Provider, { value: { theme, setTheme } },
      React.createElement(NotificationContext.Provider, { 
        value: notificationService 
      },
        React.createElement(AuthContext.Provider, { 
          value: { 
            user: currentUser, 
            login: handleLogin, 
            logout: handleLogout 
          }
        },
          currentView === 'welcome' && React.createElement(WelcomePage, {
            onGetStarted: () => setCurrentView('user_login'),
            onLoginExpert: () => setCurrentView('expert_login')
          }),
          
          currentView === 'user_login' && React.createElement(LoginPage, {
            userType: 'user',
            onLogin: handleLogin,
            onSignup: () => setCurrentView('user_signup'),
            onBack: () => setCurrentView('welcome')
          }),
          
          currentView === 'user_signup' && React.createElement(SignupPage, {
            userType: 'user',
            onSignup: handleLogin,
            onBack: () => setCurrentView('user_login')
          }),
          
          currentView === 'expert_login' && React.createElement(LoginPage, {
            userType: 'expert',
            onLogin: handleLogin,
            onSignup: () => setCurrentView('expert_signup'),
            onBack: () => setCurrentView('welcome')
          }),
          
          currentView === 'expert_signup' && React.createElement(SignupPage, {
            userType: 'expert',
            onSignup: handleLogin,
            onBack: () => setCurrentView('expert_login')
          }),
          
          currentView === 'user_dashboard' && currentUser && 
            React.createElement(UserDashboard, { 
              user: currentUser, 
              onLogout: handleLogout 
            }),
          
          currentView === 'expert_dashboard' && currentUser && 
            React.createElement(ExpertDashboard, { 
              expert: currentUser, 
              onLogout: handleLogout 
            }),
          
          currentView === 'admin_dashboard' && currentUser && 
            React.createElement(AdminDashboard, { 
              onLogout: handleLogout 
            }),
          
          currentView === 'admin_login' && React.createElement(LoginPage, {
            userType: 'admin',
            onLogin: handleLogin,
            onBack: () => setCurrentView('welcome')
          })
        )
      )
    )
  );
};

// ============================================================================
// APP INITIALIZATION
// ============================================================================

// Add admin login shortcut (triple-click on logo)
let clickCount = 0;
let clickTimer = null;

document.addEventListener('click', (e) => {
  if (e.target.textContent === '🔧' || 
      (e.target.textContent && e.target.textContent.includes('DIYMatch'))) {
    clickCount++;
    
    if (clickTimer) clearTimeout(clickTimer);
    
    clickTimer = setTimeout(() => {
      if (clickCount >= 3) {
        // Navigate to admin login
        const event = new CustomEvent('navigate', { detail: 'admin_login' });
        window.dispatchEvent(event);
        triggerHaptic('success');
      }
      clickCount = 0;
    }, 500);
  }
});

// Listen for navigation events
window.addEventListener('navigate', (e) => {
  const app = document.getElementById('root')._reactRootContainer;
  if (app) {
    // Force re-render with admin login view
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  }
});

// Render the app
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(App));

// Register global error handler
window.addEventListener('error', (event) => {
  console.error('Global error:', event.error);
  analytics.trackError(event.error, true);
});

window.addEventListener('unhandledrejection', (event) => {
  console.error('Unhandled promise rejection:', event.reason);
  analytics.trackError(event.reason, true);
});
