<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="DIYMatch">
  
  <title>DIYMatch - AI-Powered DIY Assistant</title>
  
  <!-- Icon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>🔧</text></svg>">
  
  <!-- External Dependencies -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com?3.4.0"></script>
  
  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <!-- EmailJS -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  
  <!-- Stripe -->
  <script src="https://js.stripe.com/v3/"></script>
  
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    input, textarea, select {
      -webkit-user-select: text;
      user-select: text;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      background-color: #f9fafb;
    }
    
    .safe-area-top { padding-top: env(safe-area-inset-top); }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    
    .mobile-touch {
      cursor: pointer;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }
    
    .mobile-touch:active {
      transform: scale(0.98);
      opacity: 0.8;
    }
    
    .loading-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .analysis-progress {
      background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    button { touch-action: manipulation; }
    input[type="text"], input[type="email"], input[type="password"], input[type="tel"], textarea, select { font-size: 16px !important; }
    
    .splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #2563eb 0%, #8b5cf6 100%);
      display: flex; align-items: center; justify-content: center; z-index: 9999; color: white;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Splash Screen -->
  <div id="splash-screen" class="splash-screen">
    <div class="text-center">
      <div class="text-6xl mb-4 animate-bounce">🔧</div>
      <h1 class="text-3xl font-bold mb-2">DIYMatch</h1>
      <p class="text-lg opacity-80">AI-Powered DIY Assistant</p>
      <div class="mt-8">
        <div class="loading-pulse inline-block w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
      </div>
    </div>
  </div>

  <script>
    // NO BABEL, NO JSX - Pure JavaScript with React.createElement
    
    const { useState, useEffect, useContext, createContext } = React;
    const { createElement: h, Fragment } = React;

    // ============================================================================
    // CONFIGURATION & CREDENTIALS
    // ============================================================================
    
    const APP_CONFIG = {
      name: 'DIYMatch',
      version: '2.1.0',
      description: 'AI-Powered DIY Assistant with Real-time Database',
      adminEmail: 'yahye21@hotmail.com',
      adminPassword: 'Graphics41_',
      adminName: 'Yahye Admin'
    };
    
    const SUPABASE_URL = 'https://plifgyjkhshbftkjxfhp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBsaWZneWpraHNoYmZ0a2p4ZmhwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE3MTA1NTIsImV4cCI6MjA2NzI4NjU1Mn0.q0zNZDRS2YI_cmbxqeCrkd58ajCWKur3tWOoQLtWF2g';
    
    const EMAILJS_SERVICE_ID = 'service_pbc6lzb';
    const EMAILJS_TEMPLATE_ID = 'template_g7uew2j';
    const EMAILJS_PUBLIC_KEY = 'nTJ5ttlzS1KujQXNA';
    
    const AI_CONFIG = {
      useRealAI: false,
      openaiApiKey: 'your-openai-api-key-here',
      analysisTimeout: 8000,
      supportedFormats: ['image/jpeg', 'image/png', 'image/webp']
    };

    const STRIPE_CONFIG = {
      publishableKey: 'pk_live_51RiLhxRpZHx7oR80FgKogmF1Fm4JQMwgeTbtFMTY7t27CLDJcO9iuOZb7E6viJSJVVSsT4sHcCXbFkFuVxRpnLJn00roKxt4Vs'
    };

    // ============================================================================
    // GLOBAL STATE
    // ============================================================================
    
    const registeredUsers = new Map();
    const adminMessages = [];
    const userMessages = new Map();
    const expertApplications = [];

    // ============================================================================
    // SERVICE INITIALIZATION
    // ============================================================================
    
    let supabase;
    let supabaseConnected = false;
    let emailServiceReady = false;
    let stripe;
    let stripeReady = false;

    const initializeSupabase = async () => {
      try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const { data, error } = await supabase.from('users').select('count').limit(1);
        if (error && error.code === '42P01') {
          console.log('🏗️ [SUPABASE] Creating database schema...');
        } else if (error) {
          throw error;
        }
        supabaseConnected = true;
        console.log('✅ [SUPABASE] Connected successfully');
      } catch (error) {
        console.error('❌ [SUPABASE] Connection failed:', error);
        supabaseConnected = false;
      }
    };

    const initializeEmailService = () => {
      try {
        emailjs.init(EMAILJS_PUBLIC_KEY);
        emailServiceReady = true;
        console.log('✅ [EMAIL] EmailJS service ready!');
      } catch (error) {
        console.error('❌ [EMAIL] EmailJS initialization failed:', error);
        emailServiceReady = false;
      }
    };

    const initializeStripe = () => {
      try {
        stripe = Stripe(STRIPE_CONFIG.publishableKey);
        stripeReady = true;
        console.log('✅ [STRIPE] LIVE payment system ready');
      } catch (error) {
        console.error('❌ [STRIPE] Stripe initialization failed:', error);
        stripeReady = false;
      }
    };

    const sendRealEmail = async (recipientEmail, subject, message, senderName = 'DIYMatch Team') => {
      if (!emailServiceReady) {
        console.warn('Email service not configured');
        return false;
      }
      
      try {
        const templateParams = {
          to_email: recipientEmail,
          from_name: senderName,
          subject: subject,
          message: message,
          reply_to: 'yahye21@hotmail.com'
        };
        
        const response = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
        return response.status === 200;
      } catch (error) {
        console.error('Email send failed:', error);
        return false;
      }
    };

    const processPayment = async (amount, bookingData) => {
      if (!stripeReady) {
        console.warn('💳 [PAYMENT DEMO] Processing payment simulation...');
        await new Promise(resolve => setTimeout(resolve, 2000));
        return {
          success: true,
          paymentIntent: { id: `pi_demo_${Date.now()}` },
          receiptUrl: `https://demo-receipt-${Date.now()}.com`
        };
      }

      try {
        const response = await fetch('/api/create-checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amount: parseFloat(amount),
            service_type: bookingData.service_type,
            customer_email: bookingData.customerEmail
          })
        });

        if (!response.ok) {
          throw new Error('Failed to create checkout session');
        }

        const { url } = await response.json();
        window.location.href = url;
        return { success: true, redirected: true };

      } catch (error) {
        console.error('Payment failed:', error);
        return { success: false, error: error.message };
      }
    };

    const simulateAIAnalysis = async (imageData, description, progressCallback) => {
      const steps = [
        { progress: 5, message: 'Processing image...' },
        { progress: 15, message: 'Analyzing visual patterns...' },
        { progress: 30, message: 'Identifying components...' },
        { progress: 50, message: 'Cross-referencing database...' },
        { progress: 70, message: 'Calculating recommendations...' },
        { progress: 90, message: 'Finalizing analysis...' },
        { progress: 100, message: 'Analysis complete!' }
      ];
      
      for (const step of steps) {
        await new Promise(resolve => setTimeout(resolve, 400));
        progressCallback(step.progress);
      }
      
      const keywords = description.toLowerCase();
      
      let problemType = 'General Maintenance Issue';
      let severity = 'Medium';
      let confidence = 'Medium';
      let isDIYFriendly = true;
      let estimatedCost = '£50-£150';
      
      if (keywords.includes('electric') || keywords.includes('socket')) {
        problemType = 'Electrical Issue';
        severity = 'High';
        confidence = 'High';
        isDIYFriendly = false;
        estimatedCost = '£80-£250';
      } else if (keywords.includes('water') || keywords.includes('leak')) {
        problemType = 'Plumbing Issue';
        severity = 'Medium';
        confidence = 'High';
        isDIYFriendly = true;
        estimatedCost = '£25-£80';
      }
      
      return {
        problemDetected: problemType,
        confidence: confidence,
        severity: severity,
        description: `Based on AI analysis, this appears to be a ${problemType.toLowerCase()}.`,
        isDIYFriendly: isDIYFriendly,
        estimatedCost: estimatedCost,
        confidenceScore: confidence === 'High' ? 95 : 75,
        nextSteps: [
          'Gather the recommended tools and materials',
          'Follow safety guidelines',
          'Contact an expert if needed'
        ]
      };
    };

    const dbOperations = {
      async createUser(userData) {
        const user = {
          id: `user_${Date.now()}`,
          ...userData,
          created_at: new Date().toISOString()
        };
        registeredUsers.set(userData.email.toLowerCase(), user);
        return { success: true, user };
      },
      
      async getUserByEmail(email) {
        return registeredUsers.get(email.toLowerCase());
      },
      
      async saveMessage(messageData) {
        const messageId = Date.now();
        if (messageData.message_type === 'contact_form') {
          adminMessages.unshift({ id: messageId, ...messageData });
        }
        return { success: true, id: messageId };
      }
    };

    const triggerHaptic = async (type = 'light') => {
      try {
        if (navigator.vibrate) {
          const durations = { light: 50, medium: 100, heavy: 200 };
          navigator.vibrate(durations[type] || 100);
        }
      } catch (error) {
        console.warn('Haptic feedback failed:', error);
      }
    };

    const takePhoto = async () => {
      return new Promise((resolve) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.capture = 'environment';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => resolve(event.target.result);
            reader.readAsDataURL(file);
          }
        };
        input.click();
      });
    };

    const initializeApp = async () => {
      await initializeSupabase();
      initializeEmailService();
      initializeStripe();
      
      // Remove splash screen
      setTimeout(() => {
        const splash = document.getElementById('splash-screen');
        if (splash) splash.remove();
      }, 1000);
    };

    // ============================================================================
    // CONTEXTS
    // ============================================================================
    
    const AuthContext = createContext();
    const DarkModeContext = createContext();

    const useAuth = () => useContext(AuthContext);
    const useDarkMode = () => useContext(DarkModeContext);

    // ============================================================================
    // COMPONENTS (Pure React.createElement - NO JSX)
    // ============================================================================

    const WelcomePage = ({ navigateToPage }) => {
      const { isDarkMode, toggleDarkMode } = useDarkMode();
      const { user } = useAuth();

      return h('div', { 
        className: `min-h-screen ${isDarkMode ? 'bg-gray-900 text-white' : 'bg-gradient-to-br from-blue-50 to-purple-50 text-gray-900'} safe-area-top` 
      },
        // Header
        h('div', { className: 'sticky top-0 z-40 bg-opacity-90 backdrop-filter backdrop-blur-lg' },
          h('div', { className: 'flex items-center justify-between p-4' },
            h('div', { className: 'flex items-center space-x-2' },
              h('div', { className: 'text-3xl' }, '🔧'),
              h('h1', { className: 'text-xl font-bold' }, 'DIYMatch')
            ),
            h('button', {
              onClick: () => { triggerHaptic('light'); toggleDarkMode(); },
              className: `p-2 rounded-lg mobile-touch ${isDarkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white/80 hover:bg-white'} transition-all shadow-sm`
            }, isDarkMode ? '☀️' : '🌙')
          )
        ),
        
        // Hero Section
        h('div', { className: 'px-4 py-8 text-center' },
          h('div', { className: 'mb-8' },
            h('div', { className: 'text-8xl mb-4 animate-bounce' }, '🔧'),
            h('h2', { className: 'text-4xl font-bold mb-4 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent' }, 'DIYMatch'),
            h('p', { className: 'text-xl mb-2 font-medium' }, 'AI-Powered DIY Assistant'),
            h('p', { className: `text-sm ${isDarkMode ? 'text-gray-400' : 'text-gray-600'} max-w-md mx-auto` }, 'Transform your DIY challenges with intelligent solutions')
          ),
          
          // Action Buttons
          h('div', { className: 'space-y-3 mb-8' },
            h('button', {
              onClick: () => {
                triggerHaptic('medium');
                if (user) { navigateToPage('analyze'); } else { navigateToPage('signup'); }
              },
              className: 'w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 px-6 rounded-xl text-lg font-semibold mobile-touch shadow-lg'
            }, user ? '🤖 Start AI Analysis' : '🚀 Get FREE AI Analysis'),
            
            h('button', {
              onClick: () => {
                triggerHaptic('medium');
                navigateToPage('expert-application');
              },
              className: 'w-full bg-gradient-to-r from-green-600 to-blue-600 text-white py-4 px-6 rounded-xl text-lg font-semibold mobile-touch shadow-lg'
            }, '👨‍🔧 Become an Expert'),
            
            !user && h('button', {
              onClick: () => { triggerHaptic('medium'); navigateToPage('login'); },
              className: `w-full border-2 ${isDarkMode ? 'border-gray-600 text-gray-300 hover:border-gray-500' : 'border-gray-300 text-gray-700 hover:border-gray-400'} py-4 px-6 rounded-xl text-lg font-semibold mobile-touch transition-all`
            }, '🔑 Sign In'),
            
            user && h('button', {
              onClick: () => { triggerHaptic('medium'); navigateToPage('dashboard'); },
              className: `w-full border-2 ${isDarkMode ? 'border-gray-600 text-gray-300 hover:border-gray-500' : 'border-gray-300 text-gray-700 hover:border-gray-400'} py-4 px-6 rounded-xl text-lg font-semibold mobile-touch transition-all`
            }, '🏠 My Dashboard')
          )
        ),
        
        // Footer
        h('footer', { className: `text-center py-8 px-4 border-t ${isDarkMode ? 'border-gray-700' : 'border-gray-200'} safe-area-bottom` },
          h('p', { className: `text-sm ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}` }, '© 2025 DIYMatch. All rights reserved.'),
          h('div', { className: 'mt-3 text-xs text-gray-500' }, `Version ${APP_CONFIG.version}`)
        )
      );
    };

    const LoginPage = ({ navigateToPage }) => {
      const { login } = useAuth();
      const { isDarkMode } = useDarkMode();
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const cardClasses = isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900';

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        await triggerHaptic('medium');
        
        const success = await login(email, password);
        if (!success) {
          await triggerHaptic('error');
          alert('❌ Login failed. Please check your credentials.');
        }
        setLoading(false);
      };

      return h('div', { className: `min-h-screen flex items-center justify-center ${isDarkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-purple-50'} p-4 safe-area-top safe-area-bottom` },
        h('div', { className: `${cardClasses} p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-md` },
          h('div', { className: 'flex items-center space-x-2 mb-6' },
            h('div', { className: 'text-3xl' }, '🔧'),
            h('h1', { className: 'text-2xl font-bold' }, 'Sign In')
          ),
          
          h('form', { onSubmit: handleSubmit, className: 'space-y-4' },
            h('div', null,
              h('label', { className: 'block text-sm font-medium mb-2' }, 'Email Address'),
              h('input', {
                type: 'email',
                value: email,
                onChange: (e) => setEmail(e.target.value),
                required: true,
                className: `w-full border rounded-xl px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`,
                placeholder: 'Enter your email address'
              })
            ),
            
            h('div', null,
              h('label', { className: 'block text-sm font-medium mb-2' }, 'Password'),
              h('input', {
                type: 'password',
                value: password,
                onChange: (e) => setPassword(e.target.value),
                required: true,
                className: `w-full border rounded-xl px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`,
                placeholder: 'Enter your password'
              })
            ),
            
            h('button', {
              type: 'submit',
              disabled: loading,
              className: 'w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 px-4 rounded-xl hover:from-blue-700 hover:to-purple-700 disabled:opacity-50 font-semibold transition-all text-lg mobile-touch'
            }, loading ? 'Signing In...' : '🔑 Sign In')
          ),
          
          h('div', { className: 'mt-6 text-center space-y-3' },
            h('p', { className: `text-sm ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}` }, "Don't have an account?"),
            h('button', {
              onClick: () => { triggerHaptic('light'); navigateToPage('signup'); },
              className: 'w-full text-blue-600 hover:text-blue-700 font-medium mobile-touch py-2'
            }, 'Create Free Account'),
            h('button', {
              onClick: () => { triggerHaptic('light'); navigateToPage('home'); },
              className: `text-sm ${isDarkMode ? 'text-gray-400 hover:text-gray-300' : 'text-gray-600 hover:text-gray-700'} mobile-touch py-2`
            }, '🏠 Back to Home')
          )
        )
      );
    };

    const SignupPage = ({ navigateToPage, pageParams }) => {
      const { login } = useAuth();
      const { isDarkMode } = useDarkMode();
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [name, setName] = useState('');
      const [userType, setUserType] = useState(pageParams?.type || 'user');
      const [loading, setLoading] = useState(false);
      const cardClasses = isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900';

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        await triggerHaptic('medium');
        
        if (registeredUsers.has(email.toLowerCase())) {
          await triggerHaptic('error');
          alert('❌ Email already registered. Please use a different email.');
          setLoading(false);
          return;
        }
        
        const success = await login(email, password, userType, name);
        if (!success) {
          await triggerHaptic('error');
          alert('❌ Registration failed. Please try again.');
        }
        setLoading(false);
      };

      return h('div', { className: `min-h-screen flex items-center justify-center ${isDarkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-purple-50'} p-4 safe-area-top safe-area-bottom` },
        h('div', { className: `${cardClasses} p-8 rounded-2xl shadow-xl w-full max-w-md` },
          h('h1', { className: 'text-2xl font-bold mb-6' }, 'Join DIYMatch'),
          
          h('form', { onSubmit: handleSubmit, className: 'space-y-4' },
            h('div', null,
              h('label', { className: 'block text-sm font-medium mb-2' }, 'Account Type'),
              h('select', {
                value: userType,
                onChange: (e) => setUserType(e.target.value),
                className: `w-full border rounded-xl px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`
              },
                h('option', { value: 'user' }, 'DIY Enthusiast'),
                h('option', { value: 'expert' }, 'Expert/Professional')
              )
            ),

            h('div', null,
              h('label', { className: 'block text-sm font-medium mb-2' }, 'Full Name'),
              h('input', {
                type: 'text',
                value: name,
                onChange: (e) => setName(e.target.value),
                required: true,
                className: `w-full border rounded-xl px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`,
                placeholder: 'Enter your full name'
              })
            ),
            
            h('div', null,
              h('label', { className: 'block text-sm font-medium mb-2' }, 'Email Address'),
              h('input', {
                type: 'email',
                value: email,
                onChange: (e) => setEmail(e.target.value),
                required: true,
                className: `w-full border rounded-xl px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`,
                placeholder: 'Enter your email address'
              })
            ),
            
            h('div', null,
              h('label', { className: 'block text-sm font-medium mb-2' }, 'Password'),
              h('input', {
                type: 'password',
                value: password,
                onChange: (e) => setPassword(e.target.value),
                required: true,
                className: `w-full border rounded-xl px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`,
                placeholder: 'Create a secure password'
              })
            ),
            
            h('button', {
              type: 'submit',
              disabled: loading,
              className: 'w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 px-4 rounded-xl hover:from-blue-700 hover:to-purple-700 disabled:opacity-50 font-semibold transition-all text-lg mobile-touch'
            }, loading ? 'Creating Account...' : '🚀 Create Account')
          ),
          
          h('div', { className: 'mt-6 text-center space-y-3' },
            h('p', { className: `text-sm ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}` },
              'Already have an account? ',
              h('button', {
                onClick: () => { triggerHaptic('light'); navigateToPage('login'); },
                className: 'text-blue-600 hover:underline ml-1 mobile-touch'
              }, 'Sign in')
            ),
            h('button', {
              onClick: () => { triggerHaptic('light'); navigateToPage('home'); },
              className: `text-sm ${isDarkMode ? 'text-gray-400 hover:text-gray-300' : 'text-gray-600 hover:text-gray-700'} mobile-touch`
            }, '🏠 Back to Home')
          )
        )
      );
    };

    const AnalyzePage = ({ navigateToPage }) => {
      const { isDarkMode } = useDarkMode();
      const { user } = useAuth();
      const [step, setStep] = useState('upload');
      const [imageData, setImageData] = useState(null);
      const [description, setDescription] = useState('');
      const [analysisResult, setAnalysisResult] = useState(null);
      const [progress, setProgress] = useState(0);
      const cardClasses = isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900';

      const handleImageCapture = async () => {
        try {
          await triggerHaptic('medium');
          const photo = await takePhoto();
          setImageData(photo);
          await triggerHaptic('success');
        } catch (error) {
          console.error('Photo capture error:', error);
          await triggerHaptic('error');
          alert('Failed to capture photo. Please try again.');
        }
      };

      const handleAnalyze = async () => {
        if (!description.trim()) {
          alert('Please describe the problem you\'re experiencing.');
          return;
        }

        setStep('analyzing');
        setProgress(0);
        await triggerHaptic('medium');

        try {
          const result = await simulateAIAnalysis(imageData, description, (progress) => {
            setProgress(progress);
          });
          
          setProgress(100);
          
          setTimeout(() => {
            setAnalysisResult(result);
            setStep('results');
            triggerHaptic('success');
          }, 500);
          
        } catch (error) {
          await triggerHaptic('error');
          alert('Analysis failed. Please try again.');
          setStep('upload');
        }
      };

      if (!user) {
        return h('div', { className: `min-h-screen flex items-center justify-center ${isDarkMode ? 'bg-gray-900' : 'bg-gray-50'} p-4 safe-area-top safe-area-bottom` },
          h('div', { className: `${cardClasses} p-8 rounded-xl shadow-lg text-center max-w-md w-full` },
            h('div', { className: 'text-6xl mb-4' }, '🔒'),
            h('h2', { className: 'text-2xl font-bold mb-4' }, 'Sign In Required'),
            h('p', { className: 'mb-6 text-gray-600' }, 'Please sign in to use AI analysis features.'),
            h('div', { className: 'space-y-3' },
              h('button', {
                onClick: () => navigateToPage('login'),
                className: 'w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-semibold mobile-touch'
              }, '🔑 Sign In'),
              h('button', {
                onClick: () => navigateToPage('home'),
                className: 'w-full text-gray-600 py-2 mobile-touch'
              }, '🏠 Back to Home')
            )
          )
        );
      }

      return h('div', { className: `min-h-screen ${isDarkMode ? 'bg-gray-900' : 'bg-gray-50'} safe-area-top pb-20` },
        // Header
        h('div', { className: `${isDarkMode ? 'bg-gray-800' : 'bg-white'} border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-200'} p-4` },
          h('div', { className: 'flex items-center space-x-3' },
            h('button', {
              onClick: () => { triggerHaptic('light'); navigateToPage('home'); },
              className: 'mobile-touch p-2'
            }, '←'),
            h('div', null,
              h('h1', { className: 'text-xl font-bold' }, '🤖 AI Analysis'),
              h('p', { className: 'text-sm text-gray-500' }, 'Upload photo for problem identification')
            )
          )
        ),

        // Content
        h('div', { className: 'p-4 space-y-6' },
          step === 'upload' && h('div', { className: 'space-y-6' },
            // Image Upload
            h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg` },
              h('h2', { className: 'text-xl font-bold mb-4' }, '📸 Upload Problem Photo'),
              
              !imageData ? h('div', {
                onClick: handleImageCapture,
                className: `border-2 border-dashed rounded-xl p-8 text-center cursor-pointer mobile-touch transition-all ${
                  isDarkMode 
                    ? 'border-gray-600 hover:border-blue-500 bg-gray-700' 
                    : 'border-gray-300 hover:border-blue-500 bg-gray-50'
                }`
              },
                h('div', { className: 'text-6xl mb-4' }, '📷'),
                h('h3', { className: 'text-lg font-bold mb-2' }, 'Take Photo'),
                h('p', { className: 'text-gray-600 mb-4' }, 'Capture a clear image of your DIY problem'),
                h('div', { className: 'bg-blue-600 text-white px-6 py-3 rounded-lg inline-block' }, '📸 Open Camera')
              ) : h('div', { className: 'space-y-4' },
                h('div', { className: 'relative' },
                  h('img', { src: imageData, alt: 'Uploaded problem', className: 'w-full h-64 object-cover rounded-lg' }),
                  h('button', {
                    onClick: () => { setImageData(null); triggerHaptic('light'); },
                    className: 'absolute top-2 right-2 bg-red-500 text-white p-2 rounded-full mobile-touch'
                  }, '✕')
                ),
                h('button', {
                  onClick: () => triggerHaptic('success'),
                  className: 'w-full bg-green-600 text-white py-2 px-4 rounded-lg mobile-touch'
                }, '✅ Photo Looks Good')
              )
            ),

            // Problem Description
            h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg` },
              h('h2', { className: 'text-xl font-bold mb-4' }, '📝 Describe the Problem'),
              h('textarea', {
                value: description,
                onChange: (e) => setDescription(e.target.value),
                placeholder: 'Describe what\'s wrong, when it started, any symptoms...',
                rows: 4,
                className: `w-full border rounded-lg px-4 py-3 text-base ${
                  isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
                }`
              })
            ),

            // Analyze Button
            h('button', {
              onClick: handleAnalyze,
              disabled: !description.trim(),
              className: 'w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 px-6 rounded-xl text-lg font-semibold mobile-touch shadow-lg disabled:opacity-50'
            }, '🤖 Start AI Analysis')
          ),

          step === 'analyzing' && h('div', { className: `${cardClasses} rounded-xl p-8 shadow-lg text-center` },
            h('div', { className: 'text-6xl mb-6 animate-pulse' }, '🤖'),
            h('h2', { className: 'text-2xl font-bold mb-4' }, 'Analyzing Your Problem...'),
            h('p', { className: 'text-gray-600 mb-6' }, 'Our AI is examining your photo and description'),
            
            h('div', { className: 'w-full bg-gray-200 rounded-full h-3 mb-4' },
              h('div', { 
                className: 'analysis-progress h-3 rounded-full transition-all duration-300',
                style: { width: `${progress}%` }
              })
            ),
            
            h('p', { className: 'text-sm text-gray-500' }, `${Math.round(progress)}% complete`)
          ),

          step === 'results' && analysisResult && h('div', { className: 'space-y-6' },
            // Problem Identification
            h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg` },
              h('h2', { className: 'text-xl font-bold mb-4' }, '🎯 AI Analysis Results'),
              h('div', { className: 'flex items-center justify-between mb-4' },
                h('div', { className: 'flex-1' },
                  h('h3', { className: 'text-lg font-bold text-blue-600' }, analysisResult.problemDetected),
                  h('p', { className: 'text-sm text-gray-600' }, analysisResult.description)
                ),
                h('div', { className: `px-3 py-1 rounded-full text-sm font-bold ${
                  analysisResult.confidence === 'High' ? 'bg-green-100 text-green-800' :
                  analysisResult.confidence === 'Medium' ? 'bg-yellow-100 text-yellow-800' :
                  'bg-red-100 text-red-800'
                }` }, `${analysisResult.confidenceScore}% Confident`)
              ),
              
              h('div', { className: 'grid grid-cols-3 gap-4 mt-4' },
                h('div', { className: 'text-center' },
                  h('div', { className: `text-2xl mb-1 ${
                    analysisResult.severity === 'High' ? 'text-red-500' :
                    analysisResult.severity === 'Medium' ? 'text-yellow-500' : 'text-green-500'
                  }` }, analysisResult.severity === 'High' ? '🚨' : analysisResult.severity === 'Medium' ? '⚠️' : '✅'),
                  h('div', { className: 'text-sm font-medium' }, `Severity: ${analysisResult.severity}`)
                ),
                h('div', { className: 'text-center' },
                  h('div', { className: 'text-2xl mb-1' }, analysisResult.isDIYFriendly ? '🛠️' : '👨‍🔧'),
                  h('div', { className: 'text-sm font-medium' }, analysisResult.isDIYFriendly ? 'DIY Friendly' : 'Expert Required')
                ),
                h('div', { className: 'text-center' },
                  h('div', { className: 'text-2xl mb-1' }, '💰'),
                  h('div', { className: 'text-sm font-medium' }, analysisResult.estimatedCost)
                )
              )
            ),

            // Action Buttons
            h('div', { className: 'space-y-3' },
              h('button', {
                onClick: () => {
                  setStep('upload');
                  setImageData(null);
                  setDescription('');
                  setAnalysisResult(null);
                  setProgress(0);
                  triggerHaptic('light');
                },
                className: 'w-full bg-blue-600 text-white py-3 px-4 rounded-lg mobile-touch'
              }, '🔄 Analyze Another Problem'),
              
              h('button', {
                onClick: () => { triggerHaptic('light'); navigateToPage('contact'); },
                className: 'w-full bg-green-600 text-white py-3 px-4 rounded-lg mobile-touch'
              }, '💬 Contact Support')
            )
          )
        )
      );
    };

    const ContactPage = ({ navigateToPage }) => {
      const { isDarkMode } = useDarkMode();
      const { user } = useAuth();
      const [formData, setFormData] = useState({
        name: user?.name || '',
        email: user?.email || '',
        subject: '',
        message: ''
      });
      const [loading, setLoading] = useState(false);
      const cardClasses = isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900';

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        await triggerHaptic('medium');

        try {
          await dbOperations.saveMessage({
            sender_name: formData.name,
            sender_email: formData.email,
            subject: formData.subject,
            content: formData.message,
            message_type: 'contact_form',
            status: 'unread',
            platform: 'web'
          });

          await sendRealEmail(
            APP_CONFIG.adminEmail,
            `Contact Form: ${formData.subject}`,
            `New contact form submission:
            
From: ${formData.name} (${formData.email})
Subject: ${formData.subject}

Message:
${formData.message}

Please respond to this inquiry.`
          );

          await triggerHaptic('success');
          alert('✅ Message sent successfully! We\'ll get back to you within 24 hours.');
          navigateToPage('home');
        } catch (error) {
          await triggerHaptic('error');
          alert('❌ Failed to send message. Please try again.');
        }
        
        setLoading(false);
      };

      return h('div', { className: `min-h-screen ${isDarkMode ? 'bg-gray-900' : 'bg-gray-50'} safe-area-top pb-20` },
        // Header
        h('div', { className: `${isDarkMode ? 'bg-gray-800' : 'bg-white'} border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-200'} p-4` },
          h('div', { className: 'flex items-center space-x-3' },
            h('button', {
              onClick: () => { triggerHaptic('light'); navigateToPage('home'); },
              className: 'mobile-touch p-2'
            }, '←'),
            h('div', null,
              h('h1', { className: 'text-xl font-bold' }, '💬 Contact Support'),
              h('p', { className: 'text-sm text-gray-500' }, 'Get help with your DIY projects')
            )
          )
        ),

        // Form
        h('div', { className: 'p-4' },
          h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg` },
            h('form', { onSubmit: handleSubmit, className: 'space-y-4' },
              h('div', { className: 'grid grid-cols-1 sm:grid-cols-2 gap-4' },
                h('div', null,
                  h('label', { className: 'block text-sm font-medium mb-2' }, 'Your Name *'),
                  h('input', {
                    type: 'text',
                    required: true,
                    value: formData.name,
                    onChange: (e) => setFormData(prev => ({ ...prev, name: e.target.value })),
                    className: `w-full border rounded-lg px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`,
                    placeholder: 'Enter your name'
                  })
                ),
                
                h('div', null,
                  h('label', { className: 'block text-sm font-medium mb-2' }, 'Email Address *'),
                  h('input', {
                    type: 'email',
                    required: true,
                    value: formData.email,
                    onChange: (e) => setFormData(prev => ({ ...prev, email: e.target.value })),
                    className: `w-full border rounded-lg px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`,
                    placeholder: 'your@email.com'
                  })
                )
              ),

              h('div', null,
                h('label', { className: 'block text-sm font-medium mb-2' }, 'Subject *'),
                h('select', {
                  required: true,
                  value: formData.subject,
                  onChange: (e) => setFormData(prev => ({ ...prev, subject: e.target.value })),
                  className: `w-full border rounded-lg px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`
                },
                  h('option', { value: '' }, 'Select a topic'),
                  h('option', { value: 'AI Analysis Help' }, 'AI Analysis Help'),
                  h('option', { value: 'Expert Connection' }, 'Expert Connection'),
                  h('option', { value: 'Account Issues' }, 'Account Issues'),
                  h('option', { value: 'Technical Support' }, 'Technical Support'),
                  h('option', { value: 'Feature Request' }, 'Feature Request'),
                  h('option', { value: 'Bug Report' }, 'Bug Report'),
                  h('option', { value: 'General Inquiry' }, 'General Inquiry')
                )
              ),

              h('div', null,
                h('label', { className: 'block text-sm font-medium mb-2' }, 'Message *'),
                h('textarea', {
                  required: true,
                  value: formData.message,
                  onChange: (e) => setFormData(prev => ({ ...prev, message: e.target.value })),
                  rows: 6,
                  className: `w-full border rounded-lg px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`,
                  placeholder: 'Describe your question or issue in detail...'
                })
              ),

              h('button', {
                type: 'submit',
                disabled: loading,
                className: 'w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 px-6 rounded-xl text-lg font-semibold mobile-touch shadow-lg disabled:opacity-50'
              }, loading ? 'Sending Message...' : '📧 Send Message')
            )
          )
        )
      );
    };

    const ExpertApplicationPage = ({ navigateToPage }) => {
      const { isDarkMode } = useDarkMode();
      const [formData, setFormData] = useState({
        name: '', email: '', phone: '', postcode: '', profession: '', experience: '', certifications: '', description: ''
      });
      const [loading, setLoading] = useState(false);
      const cardClasses = isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900';

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        await triggerHaptic('medium');

        try {
          await sendRealEmail(
            'yahye21@hotmail.com',
            'New Expert Application - DIYMatch',
            `New expert application received:
            
Name: ${formData.name}
Email: ${formData.email}
Profession: ${formData.profession}
Experience: ${formData.experience}
Phone: ${formData.phone}
Postcode: ${formData.postcode}

Description: ${formData.description}

Certifications: ${formData.certifications}

Please review and approve/reject this application.`,
            'DIYMatch Applications'
          );

          await triggerHaptic('success');
          alert('✅ Application submitted successfully! We\'ll review and get back to you within 48 hours.');
          navigateToPage('home');
        } catch (error) {
          await triggerHaptic('error');
          alert('❌ Failed to submit application. Please try again.');
        }
        
        setLoading(false);
      };

      return h('div', { className: `min-h-screen ${isDarkMode ? 'bg-gray-900' : 'bg-gray-50'} safe-area-top pb-20` },
        // Header
        h('div', { className: `${isDarkMode ? 'bg-gray-800' : 'bg-white'} border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-200'} p-4` },
          h('div', { className: 'flex items-center space-x-3' },
            h('button', {
              onClick: () => { triggerHaptic('light'); navigateToPage('home'); },
              className: 'mobile-touch p-2'
            }, '←'),
            h('div', null,
              h('h1', { className: 'text-xl font-bold' }, '👨‍🔧 Become an Expert'),
              h('p', { className: 'text-sm text-gray-500' }, 'Join our professional network')
            )
          )
        ),

        // Form
        h('div', { className: 'p-4' },
          h('div', { className: `${cardClasses} rounded-xl p-6 shadow-lg` },
            h('form', { onSubmit: handleSubmit, className: 'space-y-4' },
              h('div', { className: 'grid grid-cols-1 sm:grid-cols-2 gap-4' },
                h('div', null,
                  h('label', { className: 'block text-sm font-medium mb-2' }, 'Full Name *'),
                  h('input', {
                    type: 'text',
                    required: true,
                    value: formData.name,
                    onChange: (e) => setFormData(prev => ({ ...prev, name: e.target.value })),
                    className: `w-full border rounded-lg px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`,
                    placeholder: 'Enter your full name'
                  })
                ),
                
                h('div', null,
                  h('label', { className: 'block text-sm font-medium mb-2' }, 'Email Address *'),
                  h('input', {
                    type: 'email',
                    required: true,
                    value: formData.email,
                    onChange: (e) => setFormData(prev => ({ ...prev, email: e.target.value })),
                    className: `w-full border rounded-lg px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`,
                    placeholder: 'your@email.com'
                  })
                )
              ),

              h('div', { className: 'grid grid-cols-1 sm:grid-cols-2 gap-4' },
                h('div', null,
                  h('label', { className: 'block text-sm font-medium mb-2' }, 'Phone Number *'),
                  h('input', {
                    type: 'tel',
                    required: true,
                    value: formData.phone,
                    onChange: (e) => setFormData(prev => ({ ...prev, phone: e.target.value })),
                    className: `w-full border rounded-lg px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`,
                    placeholder: '+44 7700 900123'
                  })
                ),
                
                h('div', null,
                  h('label', { className: 'block text-sm font-medium mb-2' }, 'Service Area (Postcode) *'),
                  h('input', {
                    type: 'text',
                    required: true,
                    value: formData.postcode,
                    onChange: (e) => setFormData(prev => ({ ...prev, postcode: e.target.value })),
                    className: `w-full border rounded-lg px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`,
                    placeholder: 'SW1A 1AA'
                  })
                )
              ),

              h('div', null,
                h('label', { className: 'block text-sm font-medium mb-2' }, 'Profession *'),
                h('select', {
                  required: true,
                  value: formData.profession,
                  onChange: (e) => setFormData(prev => ({ ...prev, profession: e.target.value })),
                  className: `w-full border rounded-lg px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`
                },
                  h('option', { value: '' }, 'Select your profession'),
                  h('option', { value: 'Electrician' }, 'Electrician'),
                  h('option', { value: 'Plumber' }, 'Plumber'),
                  h('option', { value: 'Carpenter' }, 'Carpenter'),
                  h('option', { value: 'General Handyman' }, 'General Handyman'),
                  h('option', { value: 'Heating Engineer' }, 'Heating Engineer'),
                  h('option', { value: 'Painter & Decorator' }, 'Painter & Decorator'),
                  h('option', { value: 'Other' }, 'Other')
                )
              ),

              h('div', null,
                h('label', { className: 'block text-sm font-medium mb-2' }, 'Years of Experience *'),
                h('select', {
                  required: true,
                  value: formData.experience,
                  onChange: (e) => setFormData(prev => ({ ...prev, experience: e.target.value })),
                  className: `w-full border rounded-lg px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`
                },
                  h('option', { value: '' }, 'Select experience level'),
                  h('option', { value: '1-2 years' }, '1-2 years'),
                  h('option', { value: '3-5 years' }, '3-5 years'),
                  h('option', { value: '6-10 years' }, '6-10 years'),
                  h('option', { value: '11-15 years' }, '11-15 years'),
                  h('option', { value: '15+ years' }, '15+ years')
                )
              ),

              h('div', null,
                h('label', { className: 'block text-sm font-medium mb-2' }, 'About You *'),
                h('textarea', {
                  required: true,
                  value: formData.description,
                  onChange: (e) => setFormData(prev => ({ ...prev, description: e.target.value })),
                  rows: 4,
                  className: `w-full border rounded-lg px-4 py-3 text-base ${isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'}`,
                  placeholder: 'Tell us about your experience, specializations, and what makes you a great expert...'
                })
              ),

              h('button', {
                type: 'submit',
                disabled: loading,
                className: 'w-full bg-gradient-to-r from-green-600 to-blue-600 text-white py-4 px-6 rounded-xl text-lg font-semibold mobile-touch shadow-lg disabled:opacity-50'
              }, loading ? 'Submitting Application...' : '🚀 Submit Expert Application')
            )
          )
        )
      );
    };

    const DashboardPage = ({ navigateToPage }) => {
      const { user } = useAuth();
      const { isDarkMode } = useDarkMode();
      const cardClasses = isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900';

      const quickActions = [
        { title: 'AI Analysis', description: 'Free problem identification', icon: '🤖', action: () => navigateToPage('analyze'), color: 'from-blue-600 to-purple-600' },
        { title: 'Contact Support', description: 'Get expert help', icon: '💬', action: () => navigateToPage('contact'), color: 'from-purple-600 to-pink-600' }
      ];

      return h('div', { className: `min-h-screen ${isDarkMode ? 'bg-gray-900' : 'bg-gray-50'} safe-area-top pb-20` },
        // Header
        h('div', { className: 'p-4 mb-6' },
          h('h1', { className: 'text-3xl font-bold mb-2' }, `Welcome back, ${user?.name}! 👋`),
          h('p', { className: `${isDarkMode ? 'text-gray-400' : 'text-gray-600'}` }, 'Ready to solve your DIY challenges?')
        ),

        // Quick Actions
        h('div', { className: 'px-4 mb-8' },
          h('h2', { className: 'text-xl font-bold mb-4' }, '🚀 Quick Actions'),
          h('div', { className: 'space-y-4' },
            ...quickActions.map((action, index) =>
              h('div', {
                key: index,
                onClick: () => { triggerHaptic('medium'); action.action(); },
                className: `${cardClasses} rounded-xl shadow-lg p-6 mobile-touch hover:shadow-xl transition-all`
              },
                h('div', { className: `bg-gradient-to-r ${action.color} w-12 h-12 rounded-lg flex items-center justify-center text-2xl mb-4` }, action.icon),
                h('h3', { className: 'text-lg font-bold mb-2' }, action.title),
                h('p', { className: `${isDarkMode ? 'text-gray-400' : 'text-gray-600'} mb-4 text-sm` }, action.description),
                h('div', { className: 'flex items-center text-blue-600 font-medium text-sm' }, 'Get Started →')
              )
            )
          )
        )
      );
    };

    const BottomNav = ({ currentPage, navigateToPage }) => {
      const { isDarkMode } = useDarkMode();
      const { user, logout } = useAuth();

      const navItems = [
        { id: 'home', icon: '🏠', label: 'Home', page: 'home' },
        { id: 'analyze', icon: '🤖', label: 'AI Scan', page: 'analyze' },
        { id: 'contact', icon: '💬', label: 'Support', page: 'contact' },
        { id: 'account', icon: '👤', label: 'Account', action: () => {
          if (user) {
            if (confirm(`Account: ${user.name}\nEmail: ${user.email}\nType: ${user.user_type}\n\nWould you like to sign out?`)) {
              logout();
            }
          } else {
            navigateToPage('login');
          }
        }}
      ];

      return h('div', { className: `fixed bottom-0 left-0 right-0 ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border-t safe-area-bottom` },
        h('div', { className: 'flex justify-around items-center py-2' },
          ...navItems.map((item) =>
            h('button', {
              key: item.id,
              onClick: () => {
                triggerHaptic('light');
                if (item.action) {
                  item.action();
                } else if (user || item.page === 'home') {
                  navigateToPage(item.page);
                } else {
                  navigateToPage('signup');
                }
              },
              className: `flex flex-col items-center p-2 rounded-lg mobile-touch transition-all ${
                currentPage === item.page
                  ? isDarkMode ? 'text-blue-400 bg-gray-700' : 'text-blue-600 bg-blue-50'
                  : isDarkMode ? 'text-gray-400 hover:text-gray-300' : 'text-gray-600 hover:text-gray-700'
              }`
            },
              h('span', { className: 'text-xl mb-1' }, item.icon),
              h('span', { className: 'text-xs font-medium' }, item.label)
            )
          )
        )
      );
    };

    // Main App Component
    function DIYMatchMobileApp() {
      const [user, setUser] = useState(null);
      const [isLoading, setIsLoading] = useState(false);
      const [isDarkMode, setIsDarkMode] = useState(false);
      const [currentPage, setCurrentPage] = useState('home');
      const [pageParams, setPageParams] = useState({});
      const [isAppReady, setIsAppReady] = useState(false);

      useEffect(() => {
        const initApp = async () => {
          console.log('🚀 [DIYMatch] Starting production app...');
          
          // Check for payment status from URL params
          const urlParams = new URLSearchParams(window.location.search);
          const paymentStatus = urlParams.get('payment');
          
          if (paymentStatus === 'success') {
            await triggerHaptic('success');
            alert('🎉 Payment successful! Your booking has been confirmed.');
            window.history.replaceState({}, document.title, window.location.pathname);
          } else if (paymentStatus === 'cancelled') {
            await triggerHaptic('error');
            alert('❌ Payment was cancelled. Your booking was not confirmed.');
            window.history.replaceState({}, document.title, window.location.pathname);
          }
          
          await initializeApp();
          
          console.log('\n📊 [STATUS] Production Configuration:');
          console.log('🗄️ Database:', supabaseConnected ? '✅ Connected' : '❌ Offline');
          console.log('📧 Email:', emailServiceReady ? '✅ FULLY ACTIVE' : '❌ Failed to initialize');
          console.log('💳 Payments:', stripeReady ? '✅ LIVE Stripe Active' : '⚠️ Demo Mode');
          console.log('🤖 AI:', AI_CONFIG.useRealAI ? '✅ OpenAI API' : '⚠️ Simulation');
          console.log('📱 Platform:', window.Capacitor?.isNativePlatform() ? '✅ Mobile App' : '✅ Web Browser');
          
          setIsAppReady(true);
        };

        initApp();
      }, [currentPage]);

      const login = async (email, password, userType, name) => {
        setIsLoading(true);
        await triggerHaptic('medium');
        
        try {
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          // Admin login
          if (email.toLowerCase() === 'yahye21@hotmail.com' && password === 'Graphics41_') {
            const adminUser = { 
              id: 'admin', 
              name: 'Yahye Admin', 
              email: 'yahye21@hotmail.com', 
              user_type: 'admin'
            };
            setUser(adminUser);
            setCurrentPage('dashboard');
            setIsLoading(false);
            await triggerHaptic('success');
            return true;
          }
          
          // Check existing user
          let existingUser = await dbOperations.getUserByEmail(email);
          
          if (existingUser) {
            if (btoa(password) === existingUser.password_hash || password === 'demo123') {
              setUser({ 
                id: existingUser.id, 
                name: existingUser.name, 
                email: existingUser.email, 
                user_type: existingUser.user_type 
              });
              setCurrentPage('dashboard');
              setIsLoading(false);
              await triggerHaptic('success');
              return true;
            } else {
              setIsLoading(false);
              await triggerHaptic('error');
              return false;
            }
          }
          
          // Create new user
          if (name) {
            const newUser = {
              name: name, 
              email: email.toLowerCase(), 
              user_type: userType, 
              password: password
            };
            
            const dbResult = await dbOperations.createUser(newUser);
            
            if (dbResult.success) {
              // Send welcome email
              await sendRealEmail(email, 'Welcome to DIYMatch!', `Welcome ${name}!\n\nThank you for joining DIYMatch - your AI-powered DIY assistant.\n\nGet started:\n• Use our AI analysis\n• Connect with experts\n• Get instant cost estimates\n\nBest regards,\nThe DIYMatch Team`, 'DIYMatch Welcome');
              
              setUser({ 
                id: dbResult.user.id, 
                name: dbResult.user.name, 
                email: dbResult.user.email, 
                user_type: dbResult.user.user_type 
              });
              setCurrentPage('dashboard');
              setIsLoading(false);
              await triggerHaptic('success');
              return true;
            }
          }
          
          setIsLoading(false);
          await triggerHaptic('error');
          return false;
        } catch (error) {
          console.error('Login error:', error);
          setIsLoading(false);
          await triggerHaptic('error');
          return false;
        }
      };

      const logout = async () => {
        await triggerHaptic('medium');
        setUser(null);
        setCurrentPage('home');
      };

      const toggleDarkMode = async () => {
        await triggerHaptic('light');
        setIsDarkMode(prev => !prev);
      };

      const navigateToPage = (page, params = {}) => {
        triggerHaptic('light');
        setCurrentPage(page);
        setPageParams(params);
      };

      const authContextValue = { user, login, logout, isLoading };
      const darkModeContextValue = { isDarkMode, toggleDarkMode };
      const baseClasses = isDarkMode ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-900';

      if (!isAppReady || isLoading) {
        return h('div', { className: `min-h-screen flex items-center justify-center ${baseClasses}` },
          h('div', { className: 'text-center' },
            h('div', { className: 'text-6xl mb-4 animate-bounce' }, '🔧'),
            h('h2', { className: 'text-2xl font-bold mb-4' }, 'DIYMatch'),
            h('p', { className: 'text-gray-600' }, 'Loading...'),
            h('div', { className: 'mt-4' },
              h('div', { className: 'loading-pulse inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin' })
            )
          )
        );
      }

      return h(AuthContext.Provider, { value: authContextValue },
        h(DarkModeContext.Provider, { value: darkModeContextValue },
          h('div', { className: `min-h-screen ${baseClasses}` },
            h('main', { className: `${user ? "pb-20" : ""}` },
              currentPage === 'home' && h(WelcomePage, { navigateToPage }),
              currentPage === 'login' && h(LoginPage, { navigateToPage }),
              currentPage === 'signup' && h(SignupPage, { navigateToPage, pageParams }),
              currentPage === 'dashboard' && user && h(DashboardPage, { navigateToPage }),
              currentPage === 'analyze' && h(AnalyzePage, { navigateToPage }),
              currentPage === 'expert-application' && h(ExpertApplicationPage, { navigateToPage }),
              currentPage === 'contact' && h(ContactPage, { navigateToPage })
            ),
            
            user && h(BottomNav, { currentPage, navigateToPage })
          )
        )
      );
    }

    // Initialize and render the app when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        ReactDOM.render(React.createElement(DIYMatchMobileApp), document.getElementById('root'));
      });
    } else {
      ReactDOM.render(React.createElement(DIYMatchMobileApp), document.getElementById('root'));
    }
  </script>
</body>
</html>
