<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#2563eb">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="DIYMatch">
  <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
  
  <title>DIYMatch - AI-Powered DIY Assistant</title>
  
  <!-- Icon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üîß</text></svg>">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/json,{%22name%22:%22DIYMatch%22,%22short_name%22:%22DIYMatch%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22theme_color%22:%22%232563eb%22,%22background_color%22:%22%23ffffff%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%232563eb'/><text x='256' y='320' font-size='280' text-anchor='middle' fill='white'>üîß</text></svg>%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22}]}">
  
  <!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com/3.4.0"></script>
  
  <style>
    * {
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    input, textarea, select {
      -webkit-user-select: text;
      user-select: text;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      -webkit-font-smoothing: antialiased;
      overflow-x: hidden;
      background-color: #f9fafb;
    }
    
    .safe-area-top { padding-top: env(safe-area-inset-top); }
    .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
    
    .mobile-touch {
      cursor: pointer;
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
      transition: all 0.2s ease;
    }
    
    .mobile-touch:active {
      transform: scale(0.98);
      opacity: 0.8;
    }
    
    .loading-pulse { animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .analysis-progress {
      background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #06b6d4 100%);
      background-size: 200% 100%;
      animation: shimmer 2s linear infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    
    button { touch-action: manipulation; }
    input[type="text"], input[type="email"], input[type="password"], input[type="tel"], textarea, select { font-size: 16px !important; }
    
    .splash-screen {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, #2563eb 0%, #8b5cf6 100%);
      display: flex; align-items: center; justify-content: center; z-index: 9999; color: white;
    }

    .offline-message {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #ef4444;
      color: white;
      padding: 10px;
      text-align: center;
      z-index: 10000;
      font-size: 14px;
    }

    .error-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      padding: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="offline-message" class="offline-message" style="display: none;">
    No internet connection. Some features may not work.
  </div>

  <div id="error-screen" class="error-screen" style="display: none;">
    <div>
      <div style="font-size: 60px; margin-bottom: 20px;">‚ö†Ô∏è</div>
      <h2 style="font-size: 24px; margin-bottom: 10px; color: #1f2937;">Loading Error</h2>
      <p style="color: #6b7280; margin-bottom: 20px;">Please check your internet connection and try again.</p>
      <button onclick="location.reload()" style="background: #2563eb; color: white; padding: 12px 24px; border-radius: 8px; border: none; font-size: 16px;">
        Retry
      </button>
    </div>
  </div>

  <div id="root"></div>
  
  <!-- Splash Screen -->
  <div id="splash-screen" class="splash-screen">
    <div class="text-center">
      <div class="text-6xl mb-4 animate-bounce">üîß</div>
      <h1 class="text-3xl font-bold mb-2">DIYMatch</h1>
      <p class="text-lg opacity-80">AI-Powered DIY Assistant</p>
      <div class="mt-8">
        <div class="loading-pulse inline-block w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
      </div>
    </div>
  </div>

  <!-- React 18 with Babel Standalone for JSX -->
 <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
  <script type="text/babel">
    // ============================================================================
    // CONNECTIVITY CHECK
    // ============================================================================
    
    function checkConnectivity() {
      const offlineMessage = document.getElementById('offline-message');
      if (!navigator.onLine) {
        offlineMessage.style.display = 'block';
      } else {
        offlineMessage.style.display = 'none';
      }
    }

    window.addEventListener('online', checkConnectivity);
    window.addEventListener('offline', checkConnectivity);
    checkConnectivity();

    // ============================================================================
    // CONFIGURATION
    // ============================================================================
    
    const APP_CONFIG = {
      name: 'DIYMatch',
      version: '1.0.0',
      description: 'AI-Powered DIY Assistant with Expert Network',
      adminEmail: 'yahye21@hotmail.com',
      adminPassword: 'Graphics41_',
      supportEmail: 'support@diymatch.co.uk',
      aiAnalysisPrice: 4.99, // Per issue, not subscription
      sameDayMultiplier: 1.5,
      platformCommission: 0.15,
      sameDayCommission: 0.20
    };

    // ============================================================================
    // GLOBAL STATE (In-Memory Storage)
    // ============================================================================
    
    const registeredUsers = new Map();
    const expertProfiles = new Map();
    const quoteRequests = new Map();
    const bookings = new Map();
    const aiAnalysisHistory = new Map();
    const userAnalysisPurchases = new Map(); // Track payments per issue
    const userFreeAnalyses = new Map(); // Track free monthly analyses
    const userMessages = new Map();
    const messageThreads = new Map();
    
    const partsStores = new Map([
      ['london', [
        {
          name: 'B&Q Wembley',
          address: 'Stadium Retail Park, Wembley, HA9 0EW',
          phone: '020 8902 7200',
          distance: '2.3 miles',
          categories: ['plumbing', 'electrical', 'tools', 'paint', 'building']
        },
        {
          name: 'Screwfix Camden',
          address: '45 Camden High St, NW1 7JH',
          phone: '020 7387 4488',
          distance: '4.1 miles',
          categories: ['tools', 'electrical', 'plumbing', 'safety']
        },
        {
          name: 'Wickes Tottenham',
          address: 'Broad Lane, N15 4QD',
          phone: '020 8808 3366',
          distance: '5.2 miles',
          categories: ['building', 'plumbing', 'paint', 'tools']
        }
      ]]
    ]);

    // ============================================================================
    // UTILITY FUNCTIONS
    // ============================================================================
    
    const triggerHaptic = (type = 'light') => {
      if (navigator.vibrate) {
        const patterns = {
          light: 50,
          medium: 100,
          heavy: 200,
          success: [50, 100, 50],
          error: [100, 50, 100]
        };
        navigator.vibrate(patterns[type] || 50);
      }
    };

    const takePhoto = () => {
      return new Promise((resolve) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.capture = 'environment';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => resolve({ type: 'image', data: event.target.result, file });
            reader.readAsDataURL(file);
          }
        };
        input.click();
      });
    };

    const takeVideo = () => {
      return new Promise((resolve) => {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'video/*';
        input.capture = 'environment';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (file && file.size <= 100 * 1024 * 1024) { // 100MB limit
            const reader = new FileReader();
            reader.onload = (event) => resolve({ type: 'video', data: event.target.result, file });
            reader.readAsDataURL(file);
          } else if (file) {
            alert('Video must be less than 100MB');
          }
        };
        input.click();
      });
    };

    const getUserLocation = async () => {
      return new Promise((resolve) => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              resolve({
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                city: 'London' // Would use reverse geocoding in production
              });
            },
            () => resolve({ city: 'London' }) // Default fallback
          );
        } else {
          resolve({ city: 'London' });
        }
      });
    };

    // Simulated payment processing
    const processPayment = async (amount, metadata) => {
      // In production, this would integrate with Stripe
      console.log('Processing payment:', { amount, metadata });
      
      // Simulate payment delay
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      // For demo, always succeed
      alert(`Payment of ¬£${amount.toFixed(2)} processed successfully`);
      return { success: true, paymentId: `pay_${Date.now()}` };
    };

    // Check if user has free analysis available
    const checkFreeAnalysisAvailable = (userEmail) => {
      const currentMonth = new Date().toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      const userRecord = userFreeAnalyses.get(userEmail);
      
      if (!userRecord || userRecord.month !== currentMonth) {
        return true; // New month or first time
      }
      
      return !userRecord.used; // Haven't used this month's free analysis
    };

    // Use free analysis
    const useFreeAnalysis = (userEmail) => {
      const currentMonth = new Date().toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
      userFreeAnalyses.set(userEmail, {
        month: currentMonth,
        used: true,
        usedDate: new Date().toISOString()
      });
    };

    // Get next free analysis date
    const getNextFreeAnalysisDate = () => {
      const now = new Date();
      const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      return nextMonth.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
    };

    // ============================================================================
    // DATABASE OPERATIONS
    // ============================================================================
    
    const dbOperations = {
      // User operations
      async createUser(userData) {
        const user = {
          id: `user_${Date.now()}`,
          ...userData,
          createdAt: new Date().toISOString(),
          analysisCount: 0
        };
        registeredUsers.set(userData.email.toLowerCase(), user);
        return { success: true, user };
      },

      async getUserByEmail(email) {
        return registeredUsers.get(email.toLowerCase());
      },

      async updateUser(email, updates) {
        const user = registeredUsers.get(email.toLowerCase());
        if (user) {
          Object.assign(user, updates);
          return { success: true, user };
        }
        return { success: false, error: 'User not found' };
      },

      // Quote operations
      async createQuoteRequest(quoteData) {
        const quote = {
          id: `quote_${Date.now()}`,
          ...quoteData,
          status: 'pending',
          createdAt: new Date().toISOString()
        };
        
        if (!quoteRequests.has(quoteData.expertId)) {
          quoteRequests.set(quoteData.expertId, []);
        }
        quoteRequests.get(quoteData.expertId).push(quote);
        
        return { success: true, quote };
      },

      async getQuotesForExpert(expertId) {
        return quoteRequests.get(expertId) || [];
      },

      // Booking operations
      async createBooking(bookingData) {
        const booking = {
          id: `booking_${Date.now()}`,
          ...bookingData,
          status: 'confirmed',
          createdAt: new Date().toISOString()
        };
        
        if (!bookings.has(bookingData.userEmail)) {
          bookings.set(bookingData.userEmail, []);
        }
        bookings.get(bookingData.userEmail).push(booking);
        
        return { success: true, booking };
      },

      // AI Analysis history
      async saveAnalysis(analysisData) {
        const analysis = {
          id: `analysis_${Date.now()}`,
          ...analysisData,
          timestamp: new Date().toISOString()
        };
        
        if (!aiAnalysisHistory.has(analysisData.userEmail)) {
          aiAnalysisHistory.set(analysisData.userEmail, []);
        }
        aiAnalysisHistory.get(analysisData.userEmail).push(analysis);
        
        return { success: true, analysis };
      }
    };

    // ============================================================================
    // EMAIL SERVICE (Simulated)
    // ============================================================================
    
    const sendEmail = async (to, subject, body, fromName = 'DIYMatch', replyTo = APP_CONFIG.supportEmail) => {
      // In production, this would use EmailJS or similar
      console.log('Email sent:', { to, subject, body, fromName, replyTo });
      return true;
    };

    const sendBookingConfirmation = async (booking, user, expert) => {
      const customerEmail = `
Dear ${user.name},

Your booking has been confirmed!

BOOKING DETAILS:
----------------
Expert: ${expert.name}
Service: ${booking.service}
Date: ${new Date(booking.date).toLocaleDateString()}
Time: ${booking.time}
Location: ${booking.location || user.postcode}

COST BREAKDOWN:
--------------
Service Cost: ${booking.basePrice}
${booking.isSameDay ? 'Same-day Surge (+50%): ¬£' + (booking.surgeAmount || '0') : ''}
Platform Fee: ${booking.platformFee}
Total Paid: ${booking.totalCost}

Best regards,
The DIYMatch Team
`;

      await sendEmail(user.email, 'Booking Confirmation - DIYMatch', customerEmail);
      await sendEmail(expert.email, 'New Booking Alert - DIYMatch', `New booking from ${user.name}`);
    };

    // ============================================================================
    // AI ANALYSIS FUNCTIONS
    // ============================================================================
    
    const performAIAnalysis = async (media, description, progressCallback) => {
      if (!navigator.onLine) {
        throw new Error('Internet connection required for AI analysis');
      }

      const steps = [
        { progress: 10, delay: 500, message: 'Analyzing ' + media.type + '...' },
        { progress: 25, delay: 700, message: 'Identifying problem type...' },
        { progress: 40, delay: 600, message: 'Searching knowledge base...' },
        { progress: 60, delay: 800, message: 'Calculating solutions...' },
        { progress: 75, delay: 700, message: 'Finding parts needed...' },
        { progress: 90, delay: 600, message: 'Matching with experts...' },
        { progress: 100, delay: 500, message: 'Generating report...' }
      ];

      for (const step of steps) {
        await new Promise(resolve => setTimeout(resolve, step.delay));
        progressCallback(step.progress, step.message);
      }

      return analyzeWithAI(description.toLowerCase(), media);
    };

    const analyzeWithAI = (keywords, media) => {
      let problemType = 'General Maintenance';
      let severity = 'Medium';
      let confidence = 85;
      let isDIYFriendly = true;
      let estimatedCost = '¬£50-¬£150';
      let recommendedExpert = 'Handyman';
      let riskLevel = 'Low';
      
      const patterns = {
        electrical: {
          keywords: ['electric', 'socket', 'wire', 'switch', 'fuse', 'circuit', 'power', 'outlet', 'spark'],
          problem: 'Electrical Issue',
          severity: 'Critical',
          diy: false,
          expert: 'Electrician',
          cost: '¬£100-¬£300',
          risk: 'High'
        },
        plumbing: {
          keywords: ['leak', 'water', 'pipe', 'tap', 'drain', 'toilet', 'shower', 'sink', 'drip'],
          problem: 'Plumbing Issue',
          severity: 'High',
          diy: true,
          expert: 'Plumber',
          cost: '¬£80-¬£200',
          risk: 'Medium'
        },
        structural: {
          keywords: ['wall', 'crack', 'ceiling', 'floor', 'foundation', 'damp', 'mold'],
          problem: 'Structural/Damp Issue',
          severity: 'High',
          diy: false,
          expert: 'Building Surveyor',
          cost: '¬£150-¬£500',
          risk: 'High'
        },
        heating: {
          keywords: ['boiler', 'radiator', 'heating', 'cold', 'thermostat', 'gas'],
          problem: 'Heating/Gas Issue',
          severity: 'Critical',
          diy: false,
          expert: 'Gas Safe Engineer',
          cost: '¬£150-¬£400',
          risk: 'Critical'
        }
      };

      // Find best match
      for (const [type, config] of Object.entries(patterns)) {
        const matchCount = config.keywords.filter(kw => keywords.includes(kw)).length;
        if (matchCount >= 2) {
          problemType = config.problem;
          severity = config.severity;
          isDIYFriendly = config.diy;
          recommendedExpert = config.expert;
          estimatedCost = config.cost;
          riskLevel = config.risk;
          confidence = Math.min(95, 70 + (matchCount * 5));
          break;
        }
      }

      // Generate parts recommendations based on problem type
      const recommendedParts = generatePartsRecommendations(problemType);

      // Check urgent expert availability
      const availableExperts = checkUrgentExpertAvailability(recommendedExpert);

      return {
        problemDetected: problemType,
        confidence: confidence + '%',
        severity,
        description: `AI analysis indicates this is a ${problemType.toLowerCase()} with ${confidence}% confidence.`,
        isDIYFriendly,
        estimatedCost,
        recommendedExpertType: recommendedExpert,
        safetyWarnings: generateSafetyWarnings(severity),
        recommendedParts,
        stepByStepGuide: isDIYFriendly ? generateSteps(problemType) : ['Professional expertise required'],
        riskLevel,
        mediaType: media.type,
        regulations: getRegulations(problemType),
        availableExperts,
        aiInsights: generateAIInsights(problemType, severity),
        preventiveTips: generatePreventiveTips(problemType)
      };
    };

    const generateSafetyWarnings = (severity) => {
      const warnings = {
        'Critical': [
          'üö® IMMEDIATE DANGER - Take action now',
          '‚ö†Ô∏è Turn off utilities if necessary',
          'üìû Consider emergency services if needed',
          'üö´ Do not attempt DIY repairs'
        ],
        'High': [
          '‚ö†Ô∏è Potential safety hazard',
          'üß§ Use appropriate PPE',
          'üìñ Follow safety procedures',
          'üë®‚Äçüîß Consider professional help'
        ],
        'Medium': [
          '‚ö° Exercise caution',
          'ü•Ω Wear safety equipment',
          'üìã Follow instructions carefully'
        ],
        'Low': [
          '‚úÖ Generally safe for DIY',
          'üß§ Basic safety gear recommended'
        ]
      };
      
      return warnings[severity] || warnings['Medium'];
    };

    const generatePartsRecommendations = (problemType) => {
      const partsMap = {
        'Plumbing Issue': [
          { name: 'Pipe Repair Kit', price: '¬£12.99', category: 'plumbing' },
          { name: 'PTFE Tape', price: '¬£2.49', category: 'plumbing' },
          { name: 'Adjustable Wrench', price: '¬£15.99', category: 'tools' },
          { name: 'Plumber\'s Putty', price: '¬£4.99', category: 'plumbing' }
        ],
        'Electrical Issue': [
          { name: 'Voltage Tester', price: '¬£19.99', category: 'electrical' },
          { name: 'Wire Nuts Assortment', price: '¬£8.99', category: 'electrical' },
          { name: 'Electrical Tape', price: '¬£3.49', category: 'electrical' },
          { name: 'Circuit Breaker Finder', price: '¬£34.99', category: 'electrical' }
        ],
        'Structural/Damp Issue': [
          { name: 'Damp Seal Paint', price: '¬£24.99', category: 'paint' },
          { name: 'Crack Filler', price: '¬£8.99', category: 'building' },
          { name: 'Moisture Meter', price: '¬£19.99', category: 'tools' },
          { name: 'Anti-Mold Spray', price: '¬£12.99', category: 'building' }
        ],
        'General Maintenance': [
          { name: 'Multi-Tool Set', price: '¬£24.99', category: 'tools' },
          { name: 'WD-40', price: '¬£5.99', category: 'tools' },
          { name: 'Duct Tape', price: '¬£4.49', category: 'tools' },
          { name: 'Screwdriver Set', price: '¬£12.99', category: 'tools' }
        ]
      };
      
      return partsMap[problemType] || partsMap['General Maintenance'];
    };

    const generateSteps = (problemType) => {
      const steps = {
        'Plumbing Issue': [
          '1. üö∞ Turn off water supply at stopcock',
          '2. ü™£ Place bucket under work area',
          '3. üîç Identify exact source of issue',
          '4. üîß Disassemble affected components',
          '5. üõ†Ô∏è Replace faulty parts',
          '6. üî® Reassemble and test',
          '7. ‚úÖ Check for leaks after 30 minutes'
        ],
        'General Maintenance': [
          '1. üìã Assess the problem thoroughly',
          '2. üõ†Ô∏è Gather necessary tools',
          '3. ü¶∫ Put on safety equipment',
          '4. üìñ Follow repair guidelines',
          '5. ‚úÖ Test and verify repair'
        ]
      };
      
      return steps[problemType] || steps['General Maintenance'];
    };

    const getRegulations = (problemType) => {
      const regulations = {
        'Electrical Issue': 'Part P Building Regulations - Notifiable work requires certified electrician',
        'Heating/Gas Issue': 'Gas Safe regulations - Only Gas Safe registered engineers',
        'Structural/Damp Issue': 'Building Regulations may apply - Check with local authority',
        'Plumbing Issue': 'Water Regulations (WRAS) - Some work requires approval'
      };
      
      return regulations[problemType] || 'No specific regulations, but follow best practices';
    };

    const checkUrgentExpertAvailability = (expertType) => {
      const experts = Array.from(expertProfiles.values());
      const now = new Date();
      const currentHour = now.getHours();
      
      const availableExperts = experts.filter(expert => {
        const matchesType = expert.profession.toLowerCase().includes(expertType.toLowerCase());
        const isAvailable = currentHour >= 8 && currentHour < 20;
        const respondsQuickly = expert.responseTime && (expert.responseTime.includes('< 1 hour') || expert.responseTime.includes('< 2 hours'));
        
        return matchesType && isAvailable && respondsQuickly;
      });

      return {
        count: availableExperts.length,
        experts: availableExperts.slice(0, 3),
        nextAvailable: availableExperts.length === 0 ? 'Tomorrow 8am' : 'Now'
      };
    };

    const generateAIInsights = (problemType, severity) => {
      return {
        rootCause: `Based on the analysis, the likely root cause is ${
          problemType.includes('Electrical') ? 'electrical component failure or wiring issues' :
          problemType.includes('Plumbing') ? 'seal degradation or pipe corrosion' :
          problemType.includes('Structural') ? 'moisture ingress or settlement' :
          'wear and tear over time'
        }.`,
        riskAssessment: `This issue has a ${severity.toLowerCase()} risk level. ${
          severity === 'Critical' ? 'Immediate action required to prevent danger.' :
          severity === 'High' ? 'Should be addressed within 24-48 hours.' :
          'Can be scheduled for repair within a week.'
        }`,
        costFactors: 'Main cost drivers include parts, labor time, and any required certifications.'
      };
    };

    const generatePreventiveTips = (problemType) => {
      const tips = {
        'Electrical Issue': [
          'Test RCD/circuit breakers monthly',
          'Check for warm outlets or switches',
          'Schedule electrical inspection every 5 years',
          'Replace smoke detector batteries annually'
        ],
        'Plumbing Issue': [
          'Check under sinks monthly for leaks',
          'Clean drain traps regularly',
          'Test water pressure quarterly',
          'Inspect visible pipes for corrosion'
        ],
        'Structural/Damp Issue': [
          'Clear gutters twice yearly',
          'Check for cracks after extreme weather',
          'Ensure good ventilation',
          'Monitor humidity levels'
        ]
      };
      
      return tips[problemType] || [
        'Regular visual inspections',
        'Keep maintenance log',
        'Address issues promptly',
        'Follow manufacturer guidelines'
      ];
    };

    // Calculate AI-powered price estimation
    const calculateAIPrice = (description, isSameDay, expertHourlyRate) => {
      const baseRate = expertHourlyRate || 40;
      const keywords = description.toLowerCase();
      
      let estimatedHours = 2; // Default
      let complexity = 1.0;
      
      // AI logic to estimate job complexity
      if (keywords.includes('emergency') || keywords.includes('urgent')) complexity *= 1.3;
      if (keywords.includes('extensive') || keywords.includes('major')) {
        estimatedHours = 4;
        complexity *= 1.2;
      }
      if (keywords.includes('simple') || keywords.includes('quick')) {
        estimatedHours = 1;
        complexity *= 0.9;
      }
      
      const basePrice = baseRate * estimatedHours * complexity;
      const finalPrice = isSameDay ? basePrice * 1.5 : basePrice;
      
      return {
        estimated: `¬£${finalPrice.toFixed(2)}`,
        hours: estimatedHours,
        confidence: 'Medium'
      };
    };

    // ============================================================================
    // CONTEXTS
    // ============================================================================
    
    const AuthContext = React.createContext();
    const ThemeContext = React.createContext();

    // ============================================================================
    // PAGE COMPONENTS
    // ============================================================================
    
    // Welcome Page
    const WelcomePage = ({ navigateTo }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const { user } = React.useContext(AuthContext);

      return (
        <div className="safe-area-top">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} shadow-sm`}>
            <div className="flex items-center justify-between p-4">
              <div className="flex items-center space-x-2">
                <div className="text-3xl">üîß</div>
                <h1 className="text-xl font-bold">DIYMatch</h1>
              </div>
              <button
                onClick={() => React.useContext(ThemeContext).toggleTheme()}
                className="p-2 rounded-lg mobile-touch"
              >
                {isDarkMode ? '‚òÄÔ∏è' : 'üåô'}
              </button>
            </div>
          </div>

          <div className="px-4 py-8">
            <div className="text-center mb-8">
              <h2 className="text-3xl font-bold mb-4">Professional DIY Solutions</h2>
              <p className="text-gray-600">AI-powered analysis & expert connections</p>
            </div>

            <div className="space-y-4 max-w-md mx-auto">
              <button
                onClick={() => navigateTo(user ? 'analysis' : 'signup')}
                className="w-full bg-blue-600 text-white py-4 rounded-xl font-semibold mobile-touch flex items-center justify-center space-x-2"
              >
                <span>ü§ñ</span>
                <span>AI Analysis - ¬£4.99 Per Issue</span>
                <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded ml-2">1 FREE/month</span>
              </button>

              <button
                onClick={() => navigateTo(user ? 'experts' : 'signup')}
                className="w-full bg-green-600 text-white py-4 rounded-xl font-semibold mobile-touch flex items-center justify-center space-x-2"
              >
                <span>üë®‚Äçüîß</span>
                <span>Find Local Experts</span>
              </button>

              <button
                onClick={() => navigateTo(user ? 'parts' : 'signup')}
                className="w-full bg-purple-600 text-white py-4 rounded-xl font-semibold mobile-touch flex items-center justify-center space-x-2"
              >
                <span>üõ†Ô∏è</span>
                <span>Find Parts & Tools</span>
              </button>

              {!user && (
                <button
                  onClick={() => navigateTo('login')}
                  className="w-full border-2 border-gray-300 py-4 rounded-xl font-semibold mobile-touch"
                >
                  Sign In
                </button>
              )}

              {user && (
                <button
                  onClick={() => navigateTo('dashboard')}
                  className="w-full border-2 border-gray-300 py-4 rounded-xl font-semibold mobile-touch"
                >
                  My Dashboard
                </button>
              )}
            </div>
          </div>

          <div className="px-4 py-8">
            <div className="grid grid-cols-2 gap-4">
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded-xl shadow-sm`}>
                <div className="text-2xl mb-2">üì∏</div>
                <h3 className="font-semibold">Photo/Video Analysis</h3>
                <p className="text-sm text-gray-600">AI identifies problems instantly</p>
              </div>
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded-xl shadow-sm`}>
                <div className="text-2xl mb-2">üí∞</div>
                <h3 className="font-semibold">Pay Per Issue</h3>
                <p className="text-sm text-gray-600">¬£4.99 one-time payment</p>
              </div>
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded-xl shadow-sm`}>
                <div className="text-2xl mb-2">üõ†Ô∏è</div>
                <h3 className="font-semibold">Parts Finder</h3>
                <p className="text-sm text-gray-600">Local stores & supplies</p>
              </div>
              <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} p-4 rounded-xl shadow-sm`}>
                <div className="text-2xl mb-2">üéÅ</div>
                <h3 className="font-semibold">Monthly Free Analysis</h3>
                <p className="text-sm text-gray-600">Get 1 FREE analysis every month!</p>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Login Page
    const LoginPage = ({ navigateTo }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const { login } = React.useContext(AuthContext);
      const [email, setEmail] = React.useState('');
      const [password, setPassword] = React.useState('');

      const handleLogin = async (e) => {
        e.preventDefault();
        
        if (email === APP_CONFIG.adminEmail && password === APP_CONFIG.adminPassword) {
          login({ email, name: 'Admin', role: 'admin' });
          navigateTo('dashboard');
          return;
        }

        const user = registeredUsers.get(email.toLowerCase());
        if (user && user.password === password) {
          login(user);
          navigateTo('dashboard');
        } else {
          alert('Invalid credentials');
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center px-4">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6 w-full max-w-md`}>
            <div className="text-center mb-6">
              <div className="text-4xl mb-2">üîß</div>
              <h2 className="text-2xl font-bold">Welcome Back</h2>
            </div>

            <form onSubmit={handleLogin} className="space-y-4">
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="Email"
                className="w-full p-3 border rounded-lg"
                required
              />

              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="Password"
                className="w-full p-3 border rounded-lg"
                required
              />

              <button
                type="submit"
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold mobile-touch"
              >
                Sign In
              </button>

              <div className="text-center space-y-2">
                <button
                  type="button"
                  onClick={() => navigateTo('signup')}
                  className="text-blue-600 hover:underline"
                >
                  Don't have an account? Sign up
                </button>
                
                <button
                  type="button"
                  onClick={() => navigateTo('welcome')}
                  className="text-gray-600 hover:underline block mx-auto"
                >
                  Back to Home
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // Signup Page
    const SignupPage = ({ navigateTo }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const { login } = React.useContext(AuthContext);
      const [formData, setFormData] = React.useState({
        name: '',
        email: '',
        password: '',
        phone: '',
        postcode: '',
        userType: 'customer'
      });
      const [acceptedTerms, setAcceptedTerms] = React.useState(false);
      const [showTerms, setShowTerms] = React.useState(false);

      const handleSignup = async (e) => {
        e.preventDefault();
        
        if (!acceptedTerms) {
          alert('Please accept the Terms & Conditions to continue');
          return;
        }
        
        const result = await dbOperations.createUser({
          ...formData,
          acceptedTermsAt: new Date().toISOString()
        });

        if (result.success) {
          await sendEmail(
            formData.email,
            'Welcome to DIYMatch!',
            `Hi ${formData.name}, Welcome to DIYMatch! Your account has been created successfully.`
          );
          
          login(result.user);
          navigateTo('dashboard');
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center px-4">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl shadow-lg p-6 w-full max-w-md`}>
            <div className="text-center mb-6">
              <div className="text-4xl mb-2">üîß</div>
              <h2 className="text-2xl font-bold">Create Account</h2>
            </div>

            <form onSubmit={handleSignup} className="space-y-4">
              <div className="grid grid-cols-2 gap-3 mb-4">
                <button
                  type="button"
                  onClick={() => setFormData({...formData, userType: 'customer'})}
                  className={`p-3 rounded-lg border-2 mobile-touch ${
                    formData.userType === 'customer' 
                      ? 'border-blue-600 bg-blue-50' 
                      : 'border-gray-300'
                  }`}
                >
                  <div className="text-2xl mb-1">üè†</div>
                  <div className="font-medium">Customer</div>
                </button>
                <button
                  type="button"
                  onClick={() => setFormData({...formData, userType: 'expert'})}
                  className={`p-3 rounded-lg border-2 mobile-touch ${
                    formData.userType === 'expert' 
                      ? 'border-blue-600 bg-blue-50' 
                      : 'border-gray-300'
                  }`}
                >
                  <div className="text-2xl mb-1">üë®‚Äçüîß</div>
                  <div className="font-medium">Expert</div>
                </button>
              </div>

              <input
                type="text"
                value={formData.name}
                onChange={(e) => setFormData({...formData, name: e.target.value})}
                placeholder="Full Name"
                className="w-full p-3 border rounded-lg"
                required
              />

              <input
                type="email"
                value={formData.email}
                onChange={(e) => setFormData({...formData, email: e.target.value})}
                placeholder="Email"
                className="w-full p-3 border rounded-lg"
                required
              />

              <input
                type="password"
                value={formData.password}
                onChange={(e) => setFormData({...formData, password: e.target.value})}
                placeholder="Password (min 8 characters)"
                className="w-full p-3 border rounded-lg"
                required
                minLength={8}
              />

              <input
                type="tel"
                value={formData.phone}
                onChange={(e) => setFormData({...formData, phone: e.target.value})}
                placeholder="Phone Number"
                className="w-full p-3 border rounded-lg"
                required
              />

              <input
                type="text"
                value={formData.postcode}
                onChange={(e) => setFormData({...formData, postcode: e.target.value})}
                placeholder="Postcode"
                className="w-full p-3 border rounded-lg"
                required
              />

              <div className="border rounded-lg p-4">
                <label className="flex items-start space-x-3">
                  <input
                    type="checkbox"
                    checked={acceptedTerms}
                    onChange={(e) => setAcceptedTerms(e.target.checked)}
                    className="mt-1"
                  />
                  <div className="text-sm">
                    <p>
                      I accept the{' '}
                      <button
                        type="button"
                        onClick={() => setShowTerms(true)}
                        className="text-blue-600 underline"
                      >
                        Terms & Conditions
                      </button>
                      {' '}and{' '}
                      <button
                        type="button"
                        onClick={() => setShowTerms(true)}
                        className="text-blue-600 underline"
                      >
                        Privacy Policy
                      </button>
                    </p>
                  </div>
                </label>
              </div>

              <button
                type="submit"
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold mobile-touch"
              >
                Create Account
              </button>

              <div className="text-center">
                <button
                  type="button"
                  onClick={() => navigateTo('login')}
                  className="text-blue-600 hover:underline"
                >
                  Already have an account? Sign in
                </button>
              </div>
            </form>
          </div>

          {showTerms && (
            <TermsModal
              onClose={() => setShowTerms(false)}
              isDarkMode={isDarkMode}
            />
          )}
        </div>
      );
    };

    // Terms & Conditions Modal
    const TermsModal = ({ onClose, isDarkMode }) => {
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl w-full max-w-2xl max-h-[90vh] overflow-hidden`}>
            <div className="p-4 border-b flex items-center justify-between">
              <h2 className="text-xl font-bold">Terms & Conditions</h2>
              <button
                onClick={onClose}
                className="text-gray-500 text-2xl mobile-touch"
              >
                √ó
              </button>
            </div>
            <div className="p-4 overflow-y-auto max-h-[70vh]">
              <div className="prose prose-sm max-w-none">
                <h3 className="font-bold mb-3">DIYMatch Terms of Service</h3>
                <p className="mb-3">Last updated: {new Date().toLocaleDateString()}</p>
                
                <h4 className="font-bold mt-4 mb-2">1. Acceptance of Terms</h4>
                <p className="mb-3">
                  By accessing or using DIYMatch, you agree to be bound by these Terms. If you disagree with any part, you may not use our services.
                </p>
                
                <h4 className="font-bold mt-4 mb-2">2. Service Description</h4>
                <p className="mb-3">
                  DIYMatch provides AI-powered DIY analysis and connects users with independent tradespeople. We are a platform only and do not employ or endorse any experts.
                </p>
                
                <h4 className="font-bold mt-4 mb-2">3. User Responsibilities</h4>
                <ul className="list-disc pl-5 mb-3">
                  <li>Provide accurate information</li>
                  <li>Maintain account security</li>
                  <li>Verify expert credentials independently</li>
                  <li>Comply with all applicable laws</li>
                  <li>Accept all risks of DIY work</li>
                </ul>
                
                <h4 className="font-bold mt-4 mb-2">4. AI Analysis Service</h4>
                <p className="mb-3">
                  AI analysis is for guidance only, not professional advice. ¬£4.99 per issue with 1 free analysis per month. Results may not be accurate or complete.
                </p>
                
                <h4 className="font-bold mt-4 mb-2">5. Expert Services</h4>
                <p className="mb-3">
                  All experts are independent contractors. DIYMatch is not responsible for their work quality, conduct, or any damages. Users must verify qualifications and insurance.
                </p>
                
                <h4 className="font-bold mt-4 mb-2">6. Fees & Payments</h4>
                <ul className="list-disc pl-5 mb-3">
                  <li>AI Analysis: ¬£4.99 per issue (1 free per month)</li>
                  <li>Platform fee: 15% of booking (20% for same-day)</li>
                  <li>Same-day surge: +50% to customer</li>
                  <li>All payments are non-refundable</li>
                </ul>
                
                <h4 className="font-bold mt-4 mb-2">7. Liability Limitation</h4>
                <p className="mb-3">
                  DIYMatch shall not be liable for any damages arising from use of our services, including but not limited to property damage, personal injury, or financial losses.
                </p>
                
                <h4 className="font-bold mt-4 mb-2">8. Privacy Policy</h4>
                <p className="mb-3">
                  We collect and process personal data as described in our Privacy Policy. By using DIYMatch, you consent to such processing.
                </p>
                
                <h4 className="font-bold mt-4 mb-2">9. Contact</h4>
                <p className="mb-3">
                  Questions about these terms? Contact us at support@diymatch.co.uk
                </p>
              </div>
            </div>
            <div className="p-4 border-t">
              <button
                onClick={onClose}
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold mobile-touch"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Dashboard Page
    const DashboardPage = ({ navigateTo }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const { user, logout } = React.useContext(AuthContext);
      const [activeTab, setActiveTab] = React.useState('home');

      if (!user) {
        navigateTo('welcome');
        return null;
      }

      const userBookings = bookings.get(user.email) || [];
      const userAnalyses = aiAnalysisHistory.get(user.email) || [];

      return (
        <div className="min-h-screen safe-area-top">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} shadow-sm`}>
            <div className="p-4">
              <div className="flex items-center justify-between mb-4">
                <h1 className="text-xl font-bold">Welcome, {user.name}</h1>
                <button
                  onClick={() => {
                    logout();
                    navigateTo('welcome');
                  }}
                  className="text-red-600 mobile-touch"
                >
                  Logout
                </button>
              </div>

              <div className="flex space-x-4">
                <button
                  onClick={() => setActiveTab('home')}
                  className={`px-4 py-2 rounded-lg ${activeTab === 'home' ? 'bg-blue-600 text-white' : 'bg-gray-200'} mobile-touch`}
                >
                  Home
                </button>
                <button
                  onClick={() => setActiveTab('bookings')}
                  className={`px-4 py-2 rounded-lg ${activeTab === 'bookings' ? 'bg-blue-600 text-white' : 'bg-gray-200'} mobile-touch`}
                >
                  Bookings
                </button>
                <button
                  onClick={() => setActiveTab('history')}
                  className={`px-4 py-2 rounded-lg ${activeTab === 'history' ? 'bg-blue-600 text-white' : 'bg-gray-200'} mobile-touch`}
                >
                  History
                </button>
              </div>
            </div>
          </div>

          <div className="p-4">
            {activeTab === 'home' && (
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <button
                    onClick={() => navigateTo('analysis')}
                    className="bg-blue-600 text-white p-6 rounded-xl mobile-touch"
                  >
                    <div className="text-3xl mb-2">ü§ñ</div>
                    <div className="font-semibold">AI Analysis</div>
                    <div className="text-sm opacity-80">¬£4.99/issue</div>
                    {checkFreeAnalysisAvailable(user.email) && (
                      <div className="text-xs bg-green-500 text-white px-2 py-1 rounded mt-1">
                        1 FREE available
                      </div>
                    )}
                  </button>

                  <button
                    onClick={() => navigateTo('experts')}
                    className="bg-green-600 text-white p-6 rounded-xl mobile-touch"
                  >
                    <div className="text-3xl mb-2">üë®‚Äçüîß</div>
                    <div className="font-semibold">Find Experts</div>
                    <div className="text-sm opacity-80">Get quotes</div>
                  </button>

                  <button
                    onClick={() => navigateTo('parts')}
                    className="bg-purple-600 text-white p-6 rounded-xl mobile-touch"
                  >
                    <div className="text-3xl mb-2">üõ†Ô∏è</div>
                    <div className="font-semibold">Parts Finder</div>
                    <div className="text-sm opacity-80">Local stores</div>
                  </button>

                  <button
                    onClick={() => navigateTo('profile')}
                    className="bg-gray-600 text-white p-6 rounded-xl mobile-touch"
                  >
                    <div className="text-3xl mb-2">üë§</div>
                    <div className="font-semibold">Profile</div>
                    <div className="text-sm opacity-80">Settings</div>
                  </button>
                </div>

                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}>
                  <h3 className="font-semibold mb-3">Your Activity</h3>
                  <div className="space-y-2">
                    <div className="flex justify-between">
                      <span>AI Analyses:</span>
                      <span className="font-medium">{userAnalyses.length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span>Bookings:</span>
                      <span className="font-medium">{userBookings.length}</span>
                    </div>
                    <div className="flex justify-between">
                      <span>Member Since:</span>
                      <span className="font-medium">{new Date(user.createdAt).toLocaleDateString()}</span>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {activeTab === 'bookings' && (
              <div className="space-y-4">
                {userBookings.length === 0 ? (
                  <div className="text-center py-8">
                    <div className="text-5xl mb-4">üìÖ</div>
                    <p className="text-gray-600">No bookings yet</p>
                    <button
                      onClick={() => navigateTo('experts')}
                      className="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg mobile-touch"
                    >
                      Find Experts
                    </button>
                  </div>
                ) : (
                  userBookings.map(booking => (
                    <div 
                      key={booking.id} 
                      className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}
                    >
                      <div className="flex justify-between items-start mb-2">
                        <div>
                          <h4 className="font-semibold">{booking.expertName}</h4>
                          <p className="text-sm text-gray-600">{booking.service}</p>
                        </div>
                        <span className={`px-2 py-1 rounded text-xs ${
                          booking.status === 'confirmed' ? 'bg-green-100 text-green-800' :
                          booking.status === 'completed' ? 'bg-blue-100 text-blue-800' :
                          'bg-gray-100 text-gray-800'
                        }`}>
                          {booking.status}
                        </span>
                      </div>
                      <div className="text-sm text-gray-600">
                        <p>Date: {new Date(booking.date).toLocaleDateString()}</p>
                        <p>Time: {booking.time}</p>
                        <p>Cost: {booking.totalCost}</p>
                      </div>
                    </div>
                  ))
                )}
              </div>
            )}

            {activeTab === 'history' && (
              <div className="space-y-4">
                {userAnalyses.length === 0 ? (
                  <div className="text-center py-8">
                    <div className="text-5xl mb-4">üìä</div>
                    <p className="text-gray-600">No analyses yet</p>
                    <button
                      onClick={() => navigateTo('analysis')}
                      className="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg mobile-touch"
                    >
                      Start Analysis
                    </button>
                  </div>
                ) : (
                  userAnalyses.map(analysis => (
                    <div 
                      key={analysis.id} 
                      className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}
                    >
                      <div className="flex items-center space-x-3">
                        <div className="text-2xl">
                          {analysis.severity === 'Critical' ? 'üö®' :
                           analysis.severity === 'High' ? '‚ö†Ô∏è' :
                           analysis.severity === 'Medium' ? '‚ö°' : '‚úÖ'}
                        </div>
                        <div className="flex-1">
                          <h4 className="font-semibold">{analysis.problemDetected}</h4>
                          <p className="text-sm text-gray-600">
                            {new Date(analysis.timestamp).toLocaleDateString()}
                          </p>
                        </div>
                        <span className="text-sm font-medium">{analysis.estimatedCost}</span>
                      </div>
                    </div>
                  ))
                )}
              </div>
            )}
          </div>

          <div className={`fixed bottom-0 left-0 right-0 ${isDarkMode ? 'bg-gray-800' : 'bg-white'} border-t safe-area-bottom`}>
            <div className="flex justify-around py-2">
              <button
                onClick={() => navigateTo('dashboard')}
                className="p-3 mobile-touch"
              >
                <div className="text-center">
                  <div className="text-2xl">üè†</div>
                  <div className="text-xs">Home</div>
                </div>
              </button>
              <button
                onClick={() => navigateTo('analysis')}
                className="p-3 mobile-touch"
              >
                <div className="text-center">
                  <div className="text-2xl">üì∏</div>
                  <div className="text-xs">Analyze</div>
                </div>
              </button>
              <button
                onClick={() => navigateTo('experts')}
                className="p-3 mobile-touch"
              >
                <div className="text-center">
                  <div className="text-2xl">üë®‚Äçüîß</div>
                  <div className="text-xs">Experts</div>
                </div>
              </button>
              <button
                onClick={() => navigateTo('parts')}
                className="p-3 mobile-touch"
              >
                <div className="text-center">
                  <div className="text-2xl">üõ†Ô∏è</div>
                  <div className="text-xs">Parts</div>
                </div>
              </button>
              <button
                onClick={() => navigateTo('profile')}
                className="p-3 mobile-touch"
              >
                <div className="text-center">
                  <div className="text-2xl">üë§</div>
                  <div className="text-xs">Profile</div>
                </div>
              </button>
            </div>
          </div>
        </div>
      );
    };

    // AI Analysis Page with Payment
    const AIAnalysisPage = ({ navigateTo }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const { user } = React.useContext(AuthContext);
      const [step, setStep] = React.useState('waiver');
      const [media, setMedia] = React.useState(null);
      const [description, setDescription] = React.useState('');
      const [progress, setProgress] = React.useState(0);
      const [progressMessage, setProgressMessage] = React.useState('');
      const [analysisResult, setAnalysisResult] = React.useState(null);
      const [acceptedWaiver, setAcceptedWaiver] = React.useState(false);
      const [showPartsModal, setShowPartsModal] = React.useState(false);
      const [selectedParts, setSelectedParts] = React.useState([]);
      const [showAISuggestions, setShowAISuggestions] = React.useState(false);
      const [urgencyLevel, setUrgencyLevel] = React.useState('normal');

      React.useEffect(() => {
        if (!user) {
          alert('Please sign in to use AI Analysis');
          navigateTo('login');
        }
      }, [user]);

      const handleWaiverAccept = () => {
        if (!acceptedWaiver) {
          alert('Please accept the waiver to continue');
          return;
        }
        setStep('capture');
      };

      const handleMediaCapture = async (type) => {
        const mediaData = type === 'video' ? await takeVideo() : await takePhoto();
        if (mediaData) {
          setMedia(mediaData);
          setStep('describe');
          triggerHaptic('success');
        }
      };

      const checkAnalysisPayment = () => {
        // Generate unique issue ID based on description and media
        const issueId = btoa(description + (media?.data || '').substring(0, 100)).substring(0, 20);
        const purchases = userAnalysisPurchases.get(user.email) || [];
        
        if (purchases.includes(issueId)) {
          return { paid: true, issueId };
        }
        return { paid: false, issueId };
      };

      const handleAnalyze = () => {
        if (!navigator.onLine) {
          alert('Internet connection required for AI analysis');
          return;
        }

        // Set urgency level based on keywords
        const urgentKeywords = ['urgent', 'emergency', 'flooding', 'gas', 'smoke', 'fire', 'dangerous'];
        const descLower = description.toLowerCase();
        if (urgentKeywords.some(keyword => descLower.includes(keyword))) {
          setUrgencyLevel('urgent');
        }

        const hasFreeAnalysis = checkFreeAnalysisAvailable(user.email);
        const { paid } = checkAnalysisPayment();
        
        if (hasFreeAnalysis || paid) {
          if (hasFreeAnalysis && !paid) {
            // Use free analysis
            useFreeAnalysis(user.email);
            alert('Using your FREE monthly analysis!');
          }
          startAnalysis();
        } else {
          setStep('payment');
        }
      };

      const handlePayment = async () => {
        const { issueId } = checkAnalysisPayment();
        
        const result = await processPayment(APP_CONFIG.aiAnalysisPrice, {
          description: 'DIYMatch AI Analysis - Per Issue',
          userEmail: user.email,
          issueId: issueId
        });

        if (result.success) {
          const purchases = userAnalysisPurchases.get(user.email) || [];
          purchases.push(issueId);
          userAnalysisPurchases.set(user.email, purchases);
          
          startAnalysis();
        } else {
          alert('Payment failed. Please try again.');
        }
      };

      const startAnalysis = async () => {
        setStep('analyzing');
        
        try {
          const result = await performAIAnalysis(media, description, (progress, message) => {
            setProgress(progress);
            setProgressMessage(message);
          });
          
          result.urgencyLevel = urgencyLevel;
          
          await dbOperations.saveAnalysis({
            ...result,
            userEmail: user.email,
            media: media.type,
            description
          });

          setAnalysisResult(result);
          setStep('results');
          triggerHaptic('success');
        } catch (error) {
          alert('Analysis failed: ' + error.message);
          setStep('describe');
        }
      };

      // AI Suggestion Helper
      const getAISuggestions = () => [
        'Is this an urgent/emergency situation?',
        'Is there active water/electrical hazard?',
        'When did you first notice this issue?',
        'Has this problem occurred before?',
        'Are there any unusual sounds or smells?'
      ];

      if (!user) return null;

      return (
        <div className="min-h-screen safe-area-top pb-20">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} shadow-sm`}>
            <div className="flex items-center p-4">
              <button
                onClick={() => navigateTo('dashboard')}
                className="mr-4 mobile-touch"
              >
                ‚Üê
              </button>
              <h1 className="text-xl font-bold">ü§ñ AI Analysis</h1>
              <div className="ml-auto">
                {user && checkFreeAnalysisAvailable(user.email) ? (
                  <span className="text-sm bg-green-100 text-green-800 px-2 py-1 rounded font-medium">
                    1 FREE available
                  </span>
                ) : (
                  <span className="text-sm bg-blue-100 text-blue-800 px-2 py-1 rounded">
                    ¬£4.99/issue
                  </span>
                )}
              </div>
            </div>
          </div>

          <div className="p-4">
            {step === 'waiver' && (
              <div>
                <div className="text-center mb-6">
                  <div className="text-6xl mb-4">üìã</div>
                  <h2 className="text-2xl font-bold mb-2">Important Agreement</h2>
                  <p className="text-gray-600">Please read and accept before proceeding</p>
                </div>

                <div className="border rounded-lg p-4 mb-4">
                  <h4 className="font-semibold mb-2">Terms & Liability Waiver</h4>
                  <div className="text-sm text-gray-600 space-y-2">
                    <p>‚Ä¢ AI analysis is for guidance only, not professional advice</p>
                    <p className="font-medium text-green-600">‚Ä¢ First analysis each month is FREE!</p>
                    <p>‚Ä¢ Additional analyses: ¬£4.99 per issue</p>
                    <p>‚Ä¢ Results may not be 100% accurate</p>
                    <p>‚Ä¢ Always consult professionals for serious issues</p>
                    <p>‚Ä¢ You accept full responsibility for any DIY work</p>
                    <p>‚Ä¢ DIYMatch is not liable for any damages or injuries</p>
                    <p>‚Ä¢ Internet connection required for analysis</p>
                  </div>
                  <label className="flex items-start space-x-3 mt-4">
                    <input
                      type="checkbox"
                      checked={acceptedWaiver}
                      onChange={(e) => setAcceptedWaiver(e.target.checked)}
                      className="mt-1"
                    />
                    <span className="text-sm font-medium">
                      I have read and accept these terms
                    </span>
                  </label>
                </div>

                <button
                  onClick={handleWaiverAccept}
                  disabled={!acceptedWaiver}
                  className={`w-full py-3 rounded-lg font-semibold mobile-touch ${
                    acceptedWaiver ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-500'
                  }`}
                >
                  Continue to Camera
                </button>
              </div>
            )}

            {step === 'capture' && (
              <div className="text-center">
                <div className="mb-8">
                  <div className="text-6xl mb-4">üì∏</div>
                  <h2 className="text-2xl font-bold mb-2">Capture Your Problem</h2>
                  <p className="text-gray-600">Take a photo or video of the issue</p>
                </div>

                <div className="space-y-3 max-w-sm mx-auto">
                  <button
                    onClick={() => handleMediaCapture('photo')}
                    className="w-full bg-blue-600 text-white px-6 py-4 rounded-xl font-semibold mobile-touch flex items-center justify-center space-x-2"
                  >
                    <span>üì∑</span>
                    <span>Take Photo</span>
                  </button>
                  
                  <button
                    onClick={() => handleMediaCapture('video')}
                    className="w-full bg-purple-600 text-white px-6 py-4 rounded-xl font-semibold mobile-touch flex items-center justify-center space-x-2"
                  >
                    <span>üé•</span>
                    <span>Record Video</span>
                  </button>
                  
                  <p className="text-xs text-gray-500">Max video size: 100MB</p>
                </div>
              </div>
            )}

            {step === 'describe' && (
              <div>
                <div className="mb-4">
                  {media.type === 'image' ? (
                    <img 
                      src={media.data} 
                      className="w-full rounded-xl mb-4"
                      style={{ maxHeight: '300px', objectFit: 'cover' }}
                    />
                  ) : (
                    <video 
                      src={media.data} 
                      controls
                      className="w-full rounded-xl mb-4"
                      style={{ maxHeight: '300px' }}
                    />
                  )}
                  
                  <div className="flex items-center justify-between mb-2">
                    <h3 className="text-lg font-semibold">Describe the problem</h3>
                    <button
                      onClick={() => setShowAISuggestions(!showAISuggestions)}
                      className="text-blue-600 text-sm mobile-touch"
                    >
                      üí° AI Help
                    </button>
                  </div>
                  
                  {showAISuggestions && (
                    <div className="bg-blue-50 rounded-lg p-3 mb-3">
                      <p className="text-sm font-medium mb-2">Answer these to improve accuracy:</p>
                      <ul className="text-sm space-y-1">
                        {getAISuggestions().map((suggestion, idx) => (
                          <li key={idx}>‚Ä¢ {suggestion}</li>
                        ))}
                      </ul>
                    </div>
                  )}
                  
                  <textarea
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    placeholder="What issue are you experiencing? Be as detailed as possible..."
                    className="w-full p-3 border rounded-lg"
                    rows={4}
                  />
                  
                  <p className="text-xs text-gray-500 text-right mt-1">
                    {description.length}/500 characters
                  </p>
                </div>

                <div className="flex space-x-3">
                  <button
                    onClick={() => {
                      setStep('capture');
                      setMedia(null);
                    }}
                    className="flex-1 border border-gray-300 py-3 rounded-lg mobile-touch"
                  >
                    Retake {media.type === 'video' ? 'Video' : 'Photo'}
                  </button>

                  <button
                    onClick={handleAnalyze}
                    disabled={!description || description.length < 10}
                    className={`flex-1 py-3 rounded-lg font-semibold mobile-touch ${
                      description && description.length >= 10 
                        ? 'bg-blue-600 text-white' 
                        : 'bg-gray-300 text-gray-500'
                    }`}
                  >
                    {checkFreeAnalysisAvailable(user.email) ? 'Analyze FREE' : 'Analyze ¬£4.99'}
                  </button>
                </div>
              </div>
            )}

            {step === 'payment' && (
              <div>
                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-6 shadow-sm mb-4`}>
                  <h2 className="text-2xl font-bold mb-4">Payment Required</h2>
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                    <p className="text-sm text-yellow-800">
                      <span className="font-medium">üí° You've used your FREE monthly analysis.</span><br/>
                      Next free analysis available: {getNextFreeAnalysisDate()}
                    </p>
                  </div>
                  <div className="text-center mb-6">
                    <p className="text-3xl font-bold text-green-600">¬£4.99</p>
                    <p className="text-gray-600">One-time payment for this issue</p>
                  </div>

                  <div className="bg-blue-50 rounded-lg p-4 mb-6">
                    <h4 className="font-medium mb-2">This analysis includes:</h4>
                    <ul className="space-y-2 text-sm">
                      <li className="flex items-center">
                        <span className="text-green-500 mr-2">‚úì</span>
                        <span>AI problem identification</span>
                      </li>
                      <li className="flex items-center">
                        <span className="text-green-500 mr-2">‚úì</span>
                        <span>Safety assessment</span>
                      </li>
                      <li className="flex items-center">
                        <span className="text-green-500 mr-2">‚úì</span>
                        <span>Parts recommendations</span>
                      </li>
                      <li className="flex items-center">
                        <span className="text-green-500 mr-2">‚úì</span>
                        <span>Expert matching</span>
                      </li>
                      <li className="flex items-center">
                        <span className="text-green-500 mr-2">‚úì</span>
                        <span>DIY instructions (if safe)</span>
                      </li>
                    </ul>
                  </div>
                </div>

                <button
                  onClick={handlePayment}
                  className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold mobile-touch"
                >
                  Pay ¬£4.99 & Analyze
                </button>
              </div>
            )}

            {step === 'analyzing' && (
              <div className="text-center">
                <div className="mb-8">
                  <div className="text-6xl mb-4 animate-pulse">ü§ñ</div>
                  <h2 className="text-2xl font-bold mb-2">AI Analysis in Progress</h2>
                  <p className="text-gray-600">{progressMessage || 'Processing...'}</p>
                </div>

                <div className="max-w-xs mx-auto">
                  <div className="bg-gray-200 rounded-full h-4 mb-2">
                    <div 
                      className="analysis-progress h-full rounded-full"
                      style={{ width: `${progress}%` }}
                    />
                  </div>
                  <p className="text-sm text-gray-600">{progress}% complete</p>
                </div>
              </div>
            )}

            {step === 'results' && analysisResult && (
              <div className="space-y-4">
                {/* Urgent Expert Availability (if applicable) */}
                {analysisResult.urgencyLevel === 'urgent' && analysisResult.availableExperts && (
                  <div className="bg-red-50 border-2 border-red-300 rounded-xl p-4 text-center">
                    <h3 className="font-bold text-red-800 text-lg mb-2">
                      üö® URGENT ISSUE DETECTED
                    </h3>
                    {analysisResult.availableExperts.count > 0 ? (
                      <div>
                        <p className="text-red-700 font-medium">
                          {analysisResult.availableExperts.count} experts available NOW
                        </p>
                        <button
                          onClick={() => navigateTo('experts')}
                          className="mt-3 bg-red-600 text-white px-6 py-3 rounded-lg font-bold mobile-touch animate-pulse"
                        >
                          Get Immediate Help ‚Üí
                        </button>
                      </div>
                    ) : (
                      <div>
                        <p className="text-red-700">
                          No experts available right now
                        </p>
                        <p className="text-sm text-red-600">
                          Next available: {analysisResult.availableExperts.nextAvailable}
                        </p>
                      </div>
                    )}
                  </div>
                )}

                {/* Problem Summary */}
                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-6 shadow-sm`}>
                  <div className="flex items-start space-x-4">
                    <div className={`text-4xl ${
                      analysisResult.severity === 'Critical' ? 'text-red-500' :
                      analysisResult.severity === 'High' ? 'text-orange-500' :
                      analysisResult.severity === 'Medium' ? 'text-yellow-500' :
                      'text-blue-500'
                    }`}>
                      {analysisResult.severity === 'Critical' ? 'üö®' :
                       analysisResult.severity === 'High' ? '‚ö†Ô∏è' :
                       analysisResult.severity === 'Medium' ? '‚ö°' : '‚úÖ'}
                    </div>
                    <div className="flex-1">
                      <h2 className="text-2xl font-bold mb-2">{analysisResult.problemDetected}</h2>
                      <p className="text-gray-600 mb-3">{analysisResult.description}</p>
                      
                      <div className="flex flex-wrap gap-2 mt-3">
                        <span className={`px-3 py-1 rounded-full text-sm ${
                          analysisResult.isDIYFriendly 
                            ? 'bg-green-100 text-green-800' 
                            : 'bg-red-100 text-red-800'
                        }`}>
                          {analysisResult.isDIYFriendly ? 'üîß DIY Possible' : 'üë®‚Äçüîß Expert Required'}
                        </span>
                        <span className="px-3 py-1 rounded-full text-sm bg-blue-100 text-blue-800">
                          üí∞ {analysisResult.estimatedCost}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* AI Insights */}
                {analysisResult.aiInsights && (
                  <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}>
                    <h3 className="font-bold mb-3">ü§ñ AI Insights</h3>
                    <div className="space-y-2 text-sm">
                      <p><strong>Root Cause:</strong> {analysisResult.aiInsights.rootCause}</p>
                      <p><strong>Risk Assessment:</strong> {analysisResult.aiInsights.riskAssessment}</p>
                      <p><strong>Cost Factors:</strong> {analysisResult.aiInsights.costFactors}</p>
                    </div>
                  </div>
                )}

                {/* Stuck? Get Expert Help Button */}
                <div className="bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-xl p-4 text-center">
                  <h3 className="font-bold text-lg mb-2">üÜò Stuck or Need Help?</h3>
                  <p className="text-sm mb-3">
                    If you're not confident with DIY, get expert help immediately.
                  </p>
                  <button
                    onClick={() => {
                      window.scrollTo(0, 0);
                      navigateTo('experts');
                    }}
                    className="bg-white text-orange-600 px-6 py-3 rounded-lg font-bold mobile-touch"
                  >
                    Find Expert Now ‚Üí
                  </button>
                </div>

                {/* Parts & Tools */}
                <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-6 shadow-sm`}>
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="font-bold text-lg">üõ†Ô∏è Parts & Tools Needed</h3>
                    <button
                      onClick={() => setShowPartsModal(true)}
                      className="text-blue-600 font-medium mobile-touch"
                    >
                      üìç Find Stores
                    </button>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    {analysisResult.recommendedParts?.map((part, idx) => (
                      <div 
                        key={idx} 
                        className="border rounded-lg p-3"
                      >
                        <div className="flex items-start justify-between">
                          <div>
                            <h4 className="font-medium text-sm">{part.name}</h4>
                            <p className="text-lg font-bold text-green-600">{part.price}</p>
                          </div>
                          <input
                            type="checkbox"
                            checked={selectedParts.includes(part.name)}
                            onChange={(e) => {
                              if (e.target.checked) {
                                setSelectedParts([...selectedParts, part.name]);
                              } else {
                                setSelectedParts(selectedParts.filter(p => p !== part.name));
                              }
                            }}
                            className="mt-1"
                          />
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Safety Warnings */}
                {analysisResult.safetyWarnings?.length > 0 && (
                  <div className="bg-red-50 border border-red-200 rounded-xl p-4">
                    <h3 className="font-bold text-red-800 mb-3">‚ö†Ô∏è Safety Warnings</h3>
                    <ul className="space-y-2">
                      {analysisResult.safetyWarnings.map((warning, index) => (
                        <li key={index} className="text-sm text-red-700 flex items-start">
                          <span className="mr-2">‚Ä¢</span>
                          {warning}
                        </li>
                      ))}
                    </ul>
                  </div>
                )}

                {/* Step by Step Guide */}
                {analysisResult.isDIYFriendly && (
                  <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-6 shadow-sm`}>
                    <h3 className="font-bold mb-3">üìã Step-by-Step Guide</h3>
                    <ol className="space-y-2">
                      {analysisResult.stepByStepGuide.map((step, idx) => (
                        <li key={idx} className="text-sm">{step}</li>
                      ))}
                    </ol>
                  </div>
                )}

                {/* Regulations */}
                {analysisResult.regulations && (
                  <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}>
                    <h4 className="font-bold mb-2">üìú Regulations</h4>
                    <p className="text-sm text-gray-600">{analysisResult.regulations}</p>
                  </div>
                )}

                {/* Preventive Tips */}
                {analysisResult.preventiveTips?.length > 0 && (
                  <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}>
                    <h4 className="font-bold mb-3">üí° Prevention Tips</h4>
                    <ul className="space-y-1">
                      {analysisResult.preventiveTips.map((tip, idx) => (
                        <li key={idx} className="text-sm text-gray-600">‚Ä¢ {tip}</li>
                      ))}
                    </ul>
                  </div>
                )}

                {/* Action Buttons */}
                <div className="grid grid-cols-2 gap-3">
                  <button
                    onClick={() => {
                      setStep('waiver');
                      setMedia(null);
                      setDescription('');
                      setAnalysisResult(null);
                      setSelectedParts([]);
                      setAcceptedWaiver(false);
                    }}
                    className="border border-gray-300 py-3 rounded-lg mobile-touch"
                  >
                    New Analysis
                  </button>

                  <button
                    onClick={() => navigateTo('experts')}
                    className="bg-blue-600 text-white py-3 rounded-lg font-semibold mobile-touch"
                  >
                    Find Expert
                  </button>

                  <button
                    onClick={() => alert('Report saved to your account')}
                    className="border border-gray-300 py-3 rounded-lg mobile-touch"
                  >
                    üíæ Save
                  </button>

                  <button
                    onClick={() => alert('Sharing feature coming soon')}
                    className="border border-gray-300 py-3 rounded-lg mobile-touch"
                  >
                    üì§ Share
                  </button>
                </div>
              </div>
            )}
          </div>

          {/* Parts Store Modal */}
          {showPartsModal && (
            <PartsStoreModal
              parts={selectedParts}
              userLocation={user.postcode || 'London'}
              onClose={() => setShowPartsModal(false)}
              isDarkMode={isDarkMode}
            />
          )}
        </div>
      );
    };

    // Parts Finder Page
    const PartsFinderPage = ({ navigateTo }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const { user } = React.useContext(AuthContext);
      const [searchQuery, setSearchQuery] = React.useState('');
      const [selectedCategory, setSelectedCategory] = React.useState('all');
      const [nearbyStores, setNearbyStores] = React.useState([]);
      
      React.useEffect(() => {
        // Get stores for user's location
        const cityStores = partsStores.get('london') || [];
        setNearbyStores(cityStores);
      }, []);

      const categories = [
        { id: 'all', name: 'All', icon: 'üõ†Ô∏è' },
        { id: 'plumbing', name: 'Plumbing', icon: 'üö∞' },
        { id: 'electrical', name: 'Electrical', icon: '‚ö°' },
        { id: 'tools', name: 'Tools', icon: 'üîß' },
        { id: 'paint', name: 'Paint', icon: 'üé®' },
        { id: 'building', name: 'Building', icon: 'üèóÔ∏è' },
        { id: 'safety', name: 'Safety', icon: 'ü¶∫' }
      ];

      const filteredStores = nearbyStores.filter(store => {
        if (selectedCategory === 'all') return true;
        return store.categories.includes(selectedCategory);
      });

      return (
        <div className="min-h-screen safe-area-top pb-20">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} shadow-sm`}>
            <div className="flex items-center p-4">
              <button
                onClick={() => navigateTo('dashboard')}
                className="mr-4 mobile-touch"
              >
                ‚Üê
              </button>
              <h1 className="text-xl font-bold">üõ†Ô∏è Find Parts & Tools</h1>
            </div>
          </div>

          <div className="p-4">
            <div className="relative mb-4">
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="Search for parts or tools..."
                className="w-full p-3 pl-10 border rounded-lg"
              />
              <span className="absolute left-3 top-3.5 text-gray-400">üîç</span>
            </div>

            <div className="mb-4">
              <div className="flex overflow-x-auto space-x-3 pb-2">
                {categories.map(cat => (
                  <button
                    key={cat.id}
                    onClick={() => setSelectedCategory(cat.id)}
                    className={`flex items-center space-x-2 px-4 py-2 rounded-lg whitespace-nowrap mobile-touch ${
                      selectedCategory === cat.id 
                        ? 'bg-blue-600 text-white' 
                        : 'bg-gray-100 text-gray-700'
                    }`}
                  >
                    <span>{cat.icon}</span>
                    <span>{cat.name}</span>
                  </button>
                ))}
              </div>
            </div>

            <div className="space-y-4">
              {filteredStores.length === 0 ? (
                <div className="text-center py-12">
                  <p className="text-gray-500">No stores found for this category</p>
                </div>
              ) : (
                filteredStores.map((store, idx) => (
                  <div 
                    key={idx}
                    className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}
                  >
                    <div className="flex items-start justify-between mb-3">
                      <div>
                        <h3 className="font-semibold text-lg">{store.name}</h3>
                        <p className="text-sm text-gray-600">{store.address}</p>
                      </div>
                      <span className="text-sm font-medium text-blue-600">
                        {store.distance}
                      </span>
                    </div>
                    
                    <div className="flex flex-wrap gap-2 mb-3">
                      {store.categories.map(cat => (
                        <span 
                          key={cat}
                          className="text-xs bg-gray-100 px-2 py-1 rounded"
                        >
                          {cat}
                        </span>
                      ))}
                    </div>
                    
                    <div className="flex justify-between items-center">
                      <div className="flex space-x-3">
                        <button
                          onClick={() => window.open(`tel:${store.phone}`)}
                          className="flex items-center space-x-1 text-blue-600 mobile-touch"
                        >
                          <span>üìû</span>
                          <span className="text-sm">Call</span>
                        </button>
                        <button
                          onClick={() => window.open(`https://maps.google.com/?q=${encodeURIComponent(store.address)}`)}
                          className="flex items-center space-x-1 text-blue-600 mobile-touch"
                        >
                          <span>üó∫Ô∏è</span>
                          <span className="text-sm">Directions</span>
                        </button>
                      </div>
                      <button
                        className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm mobile-touch"
                      >
                        View Stock
                      </button>
                    </div>
                  </div>
                ))
              )}
            </div>

            <div className="fixed bottom-20 left-4 right-4">
              <div className="bg-blue-600 text-white rounded-lg p-3 text-center">
                <p className="text-sm">
                  üí° Tip: Use AI Analysis first to get exact parts recommendations!
                </p>
              </div>
            </div>
          </div>
        </div>
      );
    };

    // Parts Store Modal Component
    const PartsStoreModal = ({ parts, userLocation, onClose, isDarkMode }) => {
      const [selectedStore, setSelectedStore] = React.useState(null);
      
      // Get stores for user's city (simplified for demo)
      const cityStores = partsStores.get('london') || [];
      
      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl w-full max-w-md max-h-[80vh] overflow-y-auto`}>
            <div className="sticky top-0 bg-white border-b p-4">
              <div className="flex items-center justify-between">
                <h2 className="text-xl font-bold">üè™ Find Parts Locally</h2>
                <button
                  onClick={onClose}
                  className="text-gray-500 text-2xl mobile-touch"
                >
                  √ó
                </button>
              </div>
              {parts.length > 0 && (
                <p className="text-sm text-gray-600 mt-1">
                  Finding stores with {parts.length} selected items
                </p>
              )}
            </div>

            <div className="p-4 space-y-4">
              {cityStores.map((store, idx) => (
                <div 
                  key={idx}
                  className={`border rounded-lg p-4 mobile-touch ${
                    selectedStore === idx ? 'border-blue-600 bg-blue-50' : ''
                  }`}
                  onClick={() => setSelectedStore(idx)}
                >
                  <div className="flex items-start justify-between mb-2">
                    <div>
                      <h3 className="font-semibold">{store.name}</h3>
                      <p className="text-sm text-gray-600">{store.address}</p>
                    </div>
                    <span className="text-sm font-medium text-blue-600">
                      {store.distance}
                    </span>
                  </div>
                  
                  <div className="flex items-center justify-between">
                    <div className="flex flex-wrap gap-1">
                      {store.categories.map(cat => (
                        <span 
                          key={cat}
                          className="text-xs bg-gray-100 px-2 py-1 rounded"
                        >
                          {cat}
                        </span>
                      ))}
                    </div>
                    <div className="flex space-x-2">
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          window.open(`tel:${store.phone}`);
                        }}
                        className="text-blue-600 p-2"
                      >
                        üìû
                      </button>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          window.open(`https://maps.google.com/?q=${encodeURIComponent(store.address)}`);
                        }}
                        className="text-blue-600 p-2"
                      >
                        üó∫Ô∏è
                      </button>
                    </div>
                  </div>
                </div>
              ))}

              {parts.length > 0 && (
                <div className="bg-blue-50 rounded-lg p-4 mt-4">
                  <h4 className="font-medium mb-2">üìù Your Shopping List:</h4>
                  <ul className="text-sm space-y-1">
                    {parts.map((part, idx) => (
                      <li key={idx}>‚Ä¢ {part}</li>
                    ))}
                  </ul>
                  <p className="text-xs text-gray-600 mt-2">
                    Call ahead to check availability
                  </p>
                </div>
              )}
            </div>

            <div className="p-4 border-t">
              <button
                onClick={onClose}
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold mobile-touch"
              >
                Done
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Experts Page
    const ExpertsPage = ({ navigateTo }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const { user } = React.useContext(AuthContext);
      const [filter, setFilter] = React.useState('all');
      const [selectedExpert, setSelectedExpert] = React.useState(null);

      const filteredExperts = Array.from(expertProfiles.values()).filter(expert => {
        if (filter === 'all') return true;
        return expert.profession.toLowerCase().includes(filter.toLowerCase());
      });

      return (
        <div className="min-h-screen safe-area-top pb-20">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} shadow-sm`}>
            <div className="p-4">
              <div className="flex items-center mb-4">
                <button
                  onClick={() => navigateTo('dashboard')}
                  className="mr-4 mobile-touch"
                >
                  ‚Üê
                </button>
                <h1 className="text-xl font-bold">Find Experts</h1>
              </div>

              <div className="flex space-x-2 overflow-x-auto">
                {['all', 'plumber', 'electrician', 'handyman', 'gas safe engineer', 'building surveyor'].map(category => (
                  <button
                    key={category}
                    onClick={() => setFilter(category)}
                    className={`px-4 py-2 rounded-lg whitespace-nowrap mobile-touch ${
                      filter === category ? 'bg-blue-600 text-white' : 'bg-gray-200'
                    }`}
                  >
                    {category.charAt(0).toUpperCase() + category.slice(1)}
                  </button>
                ))}
              </div>
            </div>
          </div>

          <div className="p-4 space-y-4">
            {filteredExperts.length === 0 ? (
              <div className="text-center py-12">
                <div className="text-6xl mb-4">üë®‚Äçüîß</div>
                <h3 className="text-xl font-semibold mb-2">No Experts Yet</h3>
                <p className="text-gray-600 mb-4">Experts will appear here once they sign up</p>
                <p className="text-sm text-gray-500">
                  Are you an expert? Sign up to be listed here!
                </p>
              </div>
            ) : (
              filteredExperts.map(expert => (
                <div
                  key={expert.id}
                  onClick={() => {
                    setSelectedExpert(expert);
                    navigateTo('expert-detail');
                  }}
                  className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm mobile-touch`}
                >
                  <div className="flex items-start justify-between mb-3">
                    <div>
                      <h3 className="font-semibold text-lg">{expert.name}</h3>
                      <p className="text-gray-600">{expert.profession}</p>
                      <div className="flex items-center mt-1">
                        <span className="text-yellow-500 mr-1">‚≠ê</span>
                        <span className="font-medium mr-2">{expert.rating}</span>
                        <span className="text-sm text-gray-500">({expert.reviews} reviews)</span>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className="text-xl font-bold text-green-600">¬£{expert.hourlyRate}/hr</p>
                      <p className="text-sm text-gray-500">{expert.responseTime}</p>
                    </div>
                  </div>
                  
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-4 text-sm text-gray-600">
                      <span>üìç {expert.location}</span>
                      <span>‚úÖ {expert.completedJobs} jobs</span>
                    </div>
                    <button className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium">
                      View Profile
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>

          {/* Store selectedExpert in window for access by detail page */}
          {selectedExpert && (() => {
            window.selectedExpert = selectedExpert;
            return null;
          })()}
        </div>
      );
    };

    // Expert Detail Page
    const ExpertDetailPage = ({ navigateTo }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const { user } = React.useContext(AuthContext);
      const expert = window.selectedExpert;
      const [showQuoteModal, setShowQuoteModal] = React.useState(false);

      if (!expert) {
        navigateTo('experts');
        return null;
      }

      return (
        <div className="min-h-screen safe-area-top pb-20">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} shadow-sm`}>
            <div className="flex items-center p-4">
              <button
                onClick={() => navigateTo('experts')}
                className="mr-4 mobile-touch"
              >
                ‚Üê
              </button>
              <h1 className="text-xl font-bold">{expert.name}</h1>
            </div>
          </div>

          <div className="p-4 space-y-4">
            {/* Profile Card */}
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-6 shadow-sm`}>
              <div className="flex items-start justify-between mb-4">
                <div>
                  <h2 className="text-2xl font-bold mb-1">{expert.name}</h2>
                  <p className="text-lg text-gray-600 mb-2">{expert.profession}</p>
                  <div className="flex items-center">
                    <span className="text-yellow-500 mr-1">‚≠ê</span>
                    <span className="font-medium text-lg mr-2">{expert.rating}</span>
                    <span className="text-gray-500">({expert.reviews} reviews)</span>
                  </div>
                </div>
                <div className="text-center">
                  <p className="text-3xl font-bold text-green-600">¬£{expert.hourlyRate}</p>
                  <p className="text-sm text-gray-600">per hour</p>
                </div>
              </div>
              
              <p className="text-gray-600 mb-4">{expert.bio}</p>
              
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <p className="font-medium mb-1">üìç Location</p>
                  <p className="text-gray-600">{expert.location} ({expert.postcode})</p>
                </div>
                <div>
                  <p className="font-medium mb-1">‚è±Ô∏è Response Time</p>
                  <p className="text-gray-600">{expert.responseTime}</p>
                </div>
                <div>
                  <p className="font-medium mb-1">‚úÖ Completed Jobs</p>
                  <p className="text-gray-600">{expert.completedJobs}</p>
                </div>
                <div>
                  <p className="font-medium mb-1">üìÖ Availability</p>
                  <p className="text-gray-600">{expert.availability.join(', ')}</p>
                </div>
              </div>
            </div>

            {/* Certifications & Insurance */}
            <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-6 shadow-sm`}>
              <h3 className="font-bold mb-4">üìú Qualifications</h3>
              <div className="space-y-3">
                <div>
                  <p className="font-medium mb-1">Certifications</p>
                  <p className="text-sm text-gray-600">{expert.certifications}</p>
                </div>
                <div>
                  <p className="font-medium mb-1">Insurance</p>
                  <p className="text-sm text-gray-600">{expert.insurance}</p>
                </div>
              </div>
            </div>

            {/* Action Buttons */}
            <div className="grid grid-cols-2 gap-3">
              <button
                onClick={() => setShowQuoteModal(true)}
                className="bg-blue-600 text-white py-4 rounded-xl font-semibold mobile-touch"
              >
                üí¨ Request Quote
              </button>
              
              <button
                onClick={() => window.open(`tel:${expert.phone}`)}
                className="border border-blue-600 text-blue-600 py-4 rounded-xl font-semibold mobile-touch"
              >
                üìû Call Expert
              </button>
            </div>
          </div>

          {/* Quote Request Modal */}
          {showQuoteModal && (
            <QuoteRequestModal
              expert={expert}
              user={user}
              onClose={() => setShowQuoteModal(false)}
              onSubmit={async (quoteData) => {
                await dbOperations.createQuoteRequest(quoteData);
                alert('Quote request sent! The expert will respond within 24 hours.');
                setShowQuoteModal(false);
                navigateTo('dashboard');
              }}
            />
          )}
        </div>
      );
    };

    // Quote Request Modal
    const QuoteRequestModal = ({ expert, user, onClose, onSubmit }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const [formData, setFormData] = React.useState({
        selectedDate: '',
        selectedTime: '',
        preferredTime: 'morning',
        description: '',
        images: [],
        urgency: 'normal'
      });
      const [showCalendar, setShowCalendar] = React.useState(false);

      const today = new Date();
      const isSameDay = formData.selectedDate === today.toISOString().split('T')[0];

      // Generate time slots
      const generateTimeSlots = () => {
        const slots = [];
        const startHour = 8;
        const endHour = 18;
        
        for (let hour = startHour; hour < endHour; hour++) {
          slots.push(`${hour}:00`);
          slots.push(`${hour}:30`);
        }
        
        return slots;
      };

      const handleImageUpload = async () => {
        const image = await takePhoto();
        if (image) {
          setFormData({
            ...formData,
            images: [...formData.images, image.data]
          });
        }
      };

      const handleSubmit = () => {
        if (!formData.selectedDate || !formData.selectedTime || !formData.description) {
          alert('Please fill in all required fields');
          return;
        }

        const quoteData = {
          expertId: expert.id,
          expertName: expert.name,
          userEmail: user.email,
          userName: user.name,
          ...formData,
          isSameDay,
          surgeMultiplier: isSameDay ? APP_CONFIG.sameDayMultiplier : 1.0,
          aiPriceEstimate: calculateAIPrice(formData.description, isSameDay, expert.hourlyRate)
        };

        onSubmit(quoteData);
      };

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto`}>
            {/* Header */}
            <div className="sticky top-0 bg-white border-b p-4">
              <div className="flex items-center justify-between">
                <h2 className="text-xl font-bold">Request Quote</h2>
                <button
                  onClick={onClose}
                  className="text-gray-500 text-2xl mobile-touch"
                >
                  √ó
                </button>
              </div>
              <p className="text-sm text-gray-600 mt-1">From {expert.name}</p>
            </div>

            {/* Form */}
            <div className="p-4 space-y-4">
              {/* Date Selection */}
              <div>
                <label className="block text-sm font-medium mb-2">
                  Select Date & Time *
                </label>
                <button
                  onClick={() => setShowCalendar(!showCalendar)}
                  className="w-full p-3 border rounded-lg text-left flex items-center justify-between"
                >
                  <span>
                    {formData.selectedDate ? 
                      `${new Date(formData.selectedDate).toLocaleDateString()} at ${formData.selectedTime}` : 
                      'Choose date and time'
                    }
                  </span>
                  <span>üìÖ</span>
                </button>
                
                {/* Calendar View */}
                {showCalendar && (
                  <div className="mt-2 border rounded-lg p-4">
                    <CalendarComponent
                      selectedDate={formData.selectedDate}
                      onDateSelect={(date) => setFormData({...formData, selectedDate: date})}
                      expertAvailability={expert.availability}
                    />
                    
                    {/* Time Slots */}
                    {formData.selectedDate && (
                      <div className="mt-4">
                        <h4 className="font-medium mb-2">Available Times</h4>
                        <div className="grid grid-cols-4 gap-2">
                          {generateTimeSlots().map(time => (
                            <button
                              key={time}
                              onClick={() => {
                                setFormData({...formData, selectedTime: time});
                                setShowCalendar(false);
                              }}
                              className={`p-2 rounded border mobile-touch ${
                                formData.selectedTime === time 
                                  ? 'bg-blue-600 text-white' 
                                  : 'hover:bg-gray-100'
                              }`}
                            >
                              {time}
                            </button>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}
                
                {isSameDay && (
                  <div className="mt-2 bg-orange-50 border border-orange-200 rounded-lg p-3">
                    <p className="text-sm text-orange-800 font-medium">
                      ‚ö° Same-day booking: +50% surge pricing applies
                    </p>
                    <p className="text-xs text-orange-700 mt-1">
                      Platform commission increases to 20% for urgent bookings
                    </p>
                  </div>
                )}
              </div>

              {/* Problem Description */}
              <div>
                <label className="block text-sm font-medium mb-2">
                  Describe the issue in detail *
                </label>
                <textarea
                  value={formData.description}
                  onChange={(e) => setFormData({...formData, description: e.target.value})}
                  placeholder="Please provide as much detail as possible..."
                  rows={4}
                  className="w-full p-3 border rounded-lg"
                />
                
                {/* AI Price Estimate */}
                {formData.description.length > 20 && (
                  <div className="mt-2 bg-blue-50 rounded-lg p-3">
                    <p className="text-sm font-medium text-blue-800">
                      ü§ñ AI Price Estimate
                    </p>
                    <p className="text-lg font-bold text-blue-900">
                      {calculateAIPrice(formData.description, isSameDay, expert.hourlyRate).estimated}
                    </p>
                    <p className="text-xs text-blue-700">
                      Based on {calculateAIPrice(formData.description, isSameDay, expert.hourlyRate).hours} hours of work
                    </p>
                  </div>
                )}
              </div>

              {/* Image Upload */}
              <div>
                <label className="block text-sm font-medium mb-2">
                  Add photos (recommended)
                </label>
                <button
                  onClick={handleImageUpload}
                  className="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg text-blue-600 mobile-touch"
                >
                  <span>üì∏ Add Photo</span>
                </button>
                {formData.images.length > 0 && (
                  <div className="grid grid-cols-3 gap-2 mt-2">
                    {formData.images.map((img, idx) => (
                      <div key={idx} className="relative">
                        <img 
                          src={img} 
                          className="w-full h-24 object-cover rounded"
                        />
                        <button
                          onClick={() => setFormData({
                            ...formData,
                            images: formData.images.filter((_, i) => i !== idx)
                          })}
                          className="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 text-sm"
                        >
                          √ó
                        </button>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Submit Button */}
              <button
                onClick={handleSubmit}
                className="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold mobile-touch"
              >
                Submit Quote Request
              </button>
            </div>
          </div>
        </div>
      );
    };

    // Calendar Component
    const CalendarComponent = ({ selectedDate, onDateSelect, expertAvailability }) => {
      const today = new Date();
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      
      const getDaysInMonth = (date) => {
        return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
      };
      
      const getFirstDayOfMonth = (date) => {
        return new Date(date.getFullYear(), date.getMonth(), 1).getDay();
      };
      
      const days = [];
      const daysInMonth = getDaysInMonth(today);
      const firstDay = getFirstDayOfMonth(today);
      
      // Add empty cells for days before month starts
      for (let i = 0; i < firstDay; i++) {
        days.push(null);
      }
      
      // Add days of month
      for (let i = 1; i <= daysInMonth; i++) {
        days.push(i);
      }
      
      return (
        <div>
          <div className="text-center font-semibold mb-3">
            {today.toLocaleString('default', { month: 'long' })} {currentYear}
          </div>
          <div className="grid grid-cols-7 gap-1 text-center text-sm">
            {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(day => (
              <div key={day} className="font-medium text-gray-600">{day}</div>
            ))}
            {days.map((day, idx) => (
              <button
                key={idx}
                onClick={() => day && day >= today.getDate() && 
                  onDateSelect(`${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`)}
                disabled={!day || day < today.getDate()}
                className={`p-2 rounded mobile-touch ${
                  !day ? 'invisible' : 
                  day < today.getDate() ? 'text-gray-300' :
                  selectedDate === `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}` 
                    ? 'bg-blue-600 text-white' 
                    : 'hover:bg-gray-100'
                }`}
              >
                {day || ''}
              </button>
            ))}
          </div>
        </div>
      );
    };

    // Bookings Page
    const BookingsPage = ({ navigateTo }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const { user } = React.useContext(AuthContext);
      const userBookings = bookings.get(user.email) || [];
      const [selectedBooking, setSelectedBooking] = React.useState(null);
      const [showMessages, setShowMessages] = React.useState(false);

      return (
        <div className="min-h-screen safe-area-top pb-20">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} shadow-sm`}>
            <div className="flex items-center p-4">
              <button
                onClick={() => navigateTo('dashboard')}
                className="mr-4 mobile-touch"
              >
                ‚Üê
              </button>
              <h1 className="text-xl font-bold">My Bookings</h1>
            </div>
          </div>

          <div className="p-4">
            {userBookings.length === 0 ? (
              <div className="text-center py-12">
                <div className="text-6xl mb-4">üìÖ</div>
                <p className="text-gray-600 mb-4">No bookings yet</p>
                <button
                  onClick={() => navigateTo('experts')}
                  className="bg-blue-600 text-white px-6 py-3 rounded-lg mobile-touch"
                >
                  Find Experts
                </button>
              </div>
            ) : (
              <div className="space-y-4">
                {userBookings.map(booking => (
                  <div 
                    key={booking.id}
                    className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-xl p-4 shadow-sm`}
                  >
                    <div className="flex justify-between items-start mb-3">
                      <div>
                        <h3 className="font-semibold text-lg">{booking.expertName}</h3>
                        <p className="text-gray-600">{booking.service}</p>
                      </div>
                      <span className={`px-3 py-1 rounded-full text-sm ${
                        booking.status === 'confirmed' ? 'bg-green-100 text-green-800' :
                        booking.status === 'completed' ? 'bg-blue-100 text-blue-800' :
                        'bg-gray-100 text-gray-800'
                      }`}>
                        {booking.status}
                      </span>
                    </div>
                    <div className="space-y-1 text-sm text-gray-600 mb-3">
                      <p>üìÖ {new Date(booking.date).toLocaleDateString()}</p>
                      <p>‚è∞ {booking.time}</p>
                      <p>üí∞ {booking.totalCost}</p>
                      {booking.isSameDay && (
                        <p className="text-orange-600 font-medium">
                          ‚ö° Same-day service (+50%)
                        </p>
                      )}
                    </div>
                    <button
                      onClick={() => {
                        setSelectedBooking(booking);
                        setShowMessages(true);
                      }}
                      className="w-full bg-blue-600 text-white py-2 rounded-lg font-medium mobile-touch flex items-center justify-center space-x-2"
                    >
                      <span>üí¨</span>
                      <span>Message Expert</span>
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Messaging Modal */}
          {showMessages && selectedBooking && (
            <MessagingModal
              booking={selectedBooking}
              user={user}
              onClose={() => {
                setShowMessages(false);
                setSelectedBooking(null);
              }}
            />
          )}
        </div>
      );
    };

    // Messaging Modal Component
    const MessagingModal = ({ booking, user, onClose }) => {
      const { isDarkMode } = React.useContext(ThemeContext);
      const [messages, setMessages] = React.useState([]);
      const [newMessage, setNewMessage] = React.useState('');
      const [loading, setLoading] = React.useState(true);

      React.useEffect(() => {
        // Load messages for this booking
        const bookingMessages = messageThreads.get(booking.id) || [];
        setMessages(bookingMessages);
        setLoading(false);
      }, [booking.id]);
