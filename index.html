import React, { useState, useContext, createContext } from 'react';

// Suppress common development warnings in console
const originalWarn = console.warn;
console.warn = (...args) => {
  const message = args.join(' ');
  if (message.includes('tailwindcss.com should not be used in production') ||
      message.includes('apple-mobile-web-app') ||
      message.includes('content="yes" is deprecated')) {
    return; // Suppress these specific warnings
  }
  originalWarn.apply(console, args);
};

// ============================================================================
// CONFIGURATION & DATA
// ============================================================================

const APP_CONFIG = {
  name: 'DIYMatch',
  version: '3.0.1',
  description: 'AI-Powered DIY Assistant with Expert Network & Local Parts',
  adminEmail: 'yahye21@hotmail.com',
  adminPassword: 'Graphics41_',
  adminName: 'Yahye Admin',
  supportEmail: 'support@diymatch.co.uk'
};

// In-memory data storage
const registeredUsers = new Map();
const adminMessages = [];
const expertApplications = new Map();
const userActivity = [];

// Initialize sample data
const initializeData = () => {
  // Add admin user
  registeredUsers.set('yahye21@hotmail.com', {
    id: 'admin_1',
    name: 'Yahye Admin',
    email: 'yahye21@hotmail.com',
    user_type: 'admin',
    created_at: new Date().toISOString(),
    location: 'London',
    preferences: { theme: 'light', notifications: true }
  });

  // Add sample users
  const sampleUsers = [
    { email: 'john@example.com', name: 'John Smith', user_type: 'user' },
    { email: 'expert@example.com', name: 'Mike Expert', user_type: 'expert' }
  ];

  sampleUsers.forEach(user => {
    registeredUsers.set(user.email, {
      ...user,
      id: `user_${Date.now()}_${Math.random()}`,
      created_at: new Date().toISOString(),
      location: 'London',
      preferences: { theme: 'light', notifications: true }
    });
  });
};

// Initialize data immediately
initializeData();

// ============================================================================
// CONTEXTS
// ============================================================================

const AuthContext = createContext();
const DarkModeContext = createContext();

const useAuth = () => useContext(AuthContext);
const useDarkMode = () => useContext(DarkModeContext);

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

const triggerHaptic = (type = 'light') => {
  console.log(`Haptic feedback: ${type}`);
  // Simple vibration for mobile devices
  if (navigator.vibrate) {
    const patterns = { light: 50, medium: 100, heavy: 200, success: [50, 100, 50], error: [100, 50, 100] };
    navigator.vibrate(patterns[type] || 100);
  }
};

const dbOperations = {
  async createUser(userData) {
    const user = {
      id: `user_${Date.now()}`,
      ...userData,
      created_at: new Date().toISOString(),
      location: 'London',
      preferences: { theme: 'light', notifications: true }
    };
    registeredUsers.set(userData.email.toLowerCase(), user);
    
    userActivity.push({
      type: 'user_registered',
      timestamp: new Date().toISOString(),
      details: { email: userData.email, type: userData.user_type },
      source: 'registration'
    });
    
    return { success: true, user };
  },
  
  async getUserByEmail(email) {
    return registeredUsers.get(email.toLowerCase());
  },
  
  async saveMessage(messageData) {
    const messageId = Date.now();
    const message = { id: messageId, ...messageData, timestamp: new Date().toISOString() };
    
    if (messageData.message_type === 'contact_form') {
      adminMessages.unshift(message);
    }
    
    userActivity.push({
      type: 'message_received',
      timestamp: new Date().toISOString(),
      details: { type: messageData.message_type, from: messageData.sender_email },
      source: 'contact'
    });
    
    return { success: true, id: messageId };
  },

  async saveExpertApplication(applicationData) {
    const applicationId = Date.now();
    const application = {
      id: applicationId,
      ...applicationData,
      status: 'pending',
      submitted_at: new Date().toISOString()
    };
    
    expertApplications.set(applicationId, application);
    return { success: true, id: applicationId };
  }
};

// ============================================================================
// COMPONENTS
// ============================================================================

const WelcomePage = ({ navigateToPage }) => {
  const { isDarkMode, toggleDarkMode } = useDarkMode();
  const { user } = useAuth();

  return (
    <div className={`min-h-screen ${isDarkMode ? 'bg-gray-900 text-white' : 'bg-gray-50 text-gray-900'}`}>
      {/* Header */}
      <div className="sticky top-0 z-40 bg-opacity-90 backdrop-blur-lg">
        <div className="flex items-center justify-between p-4">
          <div className="flex items-center space-x-2">
            <div className="text-3xl">ğŸ”§</div>
            <h1 className="text-xl font-bold">DIYMatch</h1>
          </div>
          <button
            onClick={() => { triggerHaptic('light'); toggleDarkMode(); }}
            className={`p-2 rounded-lg transition-all shadow-sm ${
              isDarkMode ? 'bg-gray-800 hover:bg-gray-700' : 'bg-white/80 hover:bg-white'
            }`}
          >
            {isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™'}
          </button>
        </div>
      </div>
      
      {/* Hero Section */}
      <div className="text-center py-16 px-4">
        <div className="max-w-4xl mx-auto">
          <h1 className="text-4xl md:text-6xl font-bold mb-6">
            Welcome to <span className="text-blue-600">DIYMatch</span>
          </h1>
          <p className={`text-xl md:text-2xl mb-8 ${isDarkMode ? 'text-gray-300' : 'text-gray-600'}`}>
            Connecting DIY Enthusiasts with Expert Professionals
          </p>
          <p className={`text-lg mb-12 ${isDarkMode ? 'text-gray-400' : 'text-gray-600'} max-w-3xl mx-auto`}>
            Whether you're stuck on a home repair, need expert guidance, or want instant AI-powered solutions to your DIY problems, DIYMatch bridges the gap between those who need help and skilled professionals ready to assist.
          </p>
        </div>
      </div>
      
      {/* Action Buttons */}
      <div className="px-4 py-8">
        <div className="max-w-4xl mx-auto">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-12">
            <button
              onClick={() => {
                triggerHaptic('medium');
                if (user) { navigateToPage('analyze'); } else { navigateToPage('signup'); }
              }}
              className="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-6 px-6 rounded-xl text-lg font-semibold shadow-lg flex items-center justify-center space-x-2 hover:shadow-xl transition-all"
            >
              <span>ğŸš€</span>
              <span>{user ? 'Start AI Analysis' : 'ğŸ”¬ Get FREE AI Analysis'}</span>
            </button>
            
            <button
              onClick={() => {
                triggerHaptic('medium');
                navigateToPage('expert-application');
              }}
              className="bg-gradient-to-r from-green-600 to-blue-600 text-white py-6 px-6 rounded-xl text-lg font-semibold shadow-lg flex items-center justify-center space-x-2 hover:shadow-xl transition-all"
            >
              <span>ğŸ‘¨â€ğŸ”§</span>
              <span>Help Others as an Expert</span>
            </button>
            
            {!user ? (
              <button
                onClick={() => { triggerHaptic('medium'); navigateToPage('login'); }}
                className={`border-2 py-6 px-6 rounded-xl text-lg font-semibold transition-all flex items-center justify-center space-x-2 hover:shadow-lg ${
                  isDarkMode ? 'border-gray-600 text-gray-300 hover:border-gray-500' : 'border-gray-300 text-gray-700 hover:border-gray-400'
                }`}
              >
                <span>ğŸ”‘</span>
                <span>Sign In</span>
              </button>
            ) : (
              <button
                onClick={() => { triggerHaptic('medium'); navigateToPage('dashboard'); }}
                className={`border-2 py-6 px-6 rounded-xl text-lg font-semibold transition-all flex items-center justify-center space-x-2 hover:shadow-lg ${
                  isDarkMode ? 'border-gray-600 text-gray-300 hover:border-gray-500' : 'border-gray-300 text-gray-700 hover:border-gray-400'
                }`}
              >
                <span>ğŸ </span>
                <span>My Dashboard</span>
              </button>
            )}
          </div>
        </div>
      </div>
      
      {/* How It Works Section */}
      <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} py-16`}>
        <div className="max-w-6xl mx-auto px-4">
          <h2 className="text-3xl font-bold text-center mb-12">How DIYMatch Works</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
            <div className="text-center">
              <div className="w-16 h-16 mx-auto mb-4 bg-blue-100 rounded-full flex items-center justify-center">
                <span className="text-2xl">ğŸ¤–</span>
              </div>
              <h3 className="text-xl font-bold mb-4">FREE AI Analysis</h3>
              <p className={isDarkMode ? 'text-gray-400' : 'text-gray-600'}>
                Upload a photo and get completely free problem identification, then upgrade for video solutions.
              </p>
            </div>
            
            <div className="text-center">
              <div className="w-16 h-16 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center">
                <span className="text-2xl">ğŸ¯</span>
              </div>
              <h3 className="text-xl font-bold mb-4">Expert Connection</h3>
              <p className={isDarkMode ? 'text-gray-400' : 'text-gray-600'}>
                When DIY isn't enough, instantly connect with verified local professionals who can help.
              </p>
            </div>
            
            <div className="text-center">
              <div className="w-16 h-16 mx-auto mb-4 bg-purple-100 rounded-full flex items-center justify-center">
                <span className="text-2xl">ğŸ›¡ï¸</span>
              </div>
              <h3 className="text-xl font-bold mb-4">Safety First</h3>
              <p className={isDarkMode ? 'text-gray-400' : 'text-gray-600'}>
                Our AI knows when a job requires professional help and will recommend expert assistance for safety.
              </p>
            </div>
          </div>
        </div>
      </div>
      
      {/* Contact Section */}
      <div className="py-16 px-4">
        <div className="max-w-2xl mx-auto">
          <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} rounded-2xl p-8 shadow-lg text-center`}>
            <div className="flex items-center justify-center mb-4">
              <span className="text-3xl mr-3">ğŸ“</span>
              <h3 className="text-2xl font-bold">Get in Touch</h3>
            </div>
            <p className={`${isDarkMode ? 'text-gray-400' : 'text-gray-600'} mb-6`}>
              Have questions about DIYMatch? Need support? We're here to help!
            </p>
            <button
              onClick={() => { triggerHaptic('medium'); navigateToPage('contact'); }}
              className="bg-blue-600 hover:bg-blue-700 text-white py-3 px-8 rounded-lg font-semibold transition-all"
            >
              ğŸ’¬ Contact Us
            </button>
          </div>
        </div>
      </div>
      
      {/* Footer */}
      <footer className={`text-center py-8 px-4 border-t ${isDarkMode ? 'border-gray-700' : 'border-gray-200'}`}>
        <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-gray-100'} rounded-lg p-4 mb-6 text-left`}>
          <h4 className="font-bold mb-2 text-sm">âš ï¸ Important Legal Notice</h4>
          <p className="text-xs leading-relaxed">
            DIYMatch is an information and referral platform only. We do not employ experts or guarantee work quality. 
            All AI analysis is for general guidance only - NOT professional advice. DIY work carries risks of injury, 
            property damage, or death. Always consult certified professionals for electrical, gas, plumbing, or structural work. 
            Users assume full responsibility for their safety and actions. DIYMatch accepts no liability for consequences 
            of using our service or following any recommendations.
          </p>
        </div>
        <p className={`text-sm ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
          Â© 2024 DIYMatch - Connecting Problems with Solutions
        </p>
        <div className="mt-3 text-xs text-gray-500">Version {APP_CONFIG.version} - Production Ready</div>
      </footer>
    </div>
  );
};

const LoginPage = ({ navigateToPage }) => {
  const { login } = useAuth();
  const { isDarkMode } = useDarkMode();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [loading, setLoading] = useState(false);
  const cardClasses = isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900';

  const handleSubmit = async () => {
    if (!email || !password) {
      alert('Please fill in all fields');
      return;
    }
    
    setLoading(true);
    await triggerHaptic('medium');
    
    const success = await login(email, password);
    if (!success) {
      await triggerHaptic('error');
      alert('âŒ Login failed. Please check your credentials or try signing up.');
    }
    setLoading(false);
  };

  return (
    <div className={`min-h-screen flex items-center justify-center ${isDarkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-purple-50'} p-4`}>
      <div className={`${cardClasses} p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-md`}>
        <div className="flex items-center space-x-2 mb-6">
          <div className="text-3xl">ğŸ”§</div>
          <h1 className="text-2xl font-bold">Sign In to DIYMatch</h1>
        </div>
        
        <div className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-2">Email Address</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className={`w-full border rounded-xl px-4 py-3 text-base ${
                isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
              }`}
              placeholder="Enter your email address"
              onKeyPress={(e) => e.key === 'Enter' && handleSubmit()}
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-2">Password</label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className={`w-full border rounded-xl px-4 py-3 text-base ${
                isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
              }`}
              placeholder="Enter your password"
              onKeyPress={(e) => e.key === 'Enter' && handleSubmit()}
            />
          </div>
          
          <button
            onClick={handleSubmit}
            disabled={loading}
            className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 px-4 rounded-xl hover:from-blue-700 hover:to-purple-700 disabled:opacity-50 font-semibold transition-all text-lg"
          >
            {loading ? 'Signing In...' : 'ğŸ”‘ Sign In'}
          </button>
        </div>
        
        <div className="mt-6 text-center space-y-3">
          <p className={`text-sm ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
            Don't have an account?
          </p>
          <button
            onClick={() => { triggerHaptic('light'); navigateToPage('signup'); }}
            className="w-full text-blue-600 hover:text-blue-700 font-medium py-2"
          >
            Create Free Account
          </button>
          <button
            onClick={() => { triggerHaptic('light'); navigateToPage('home'); }}
            className={`text-sm ${isDarkMode ? 'text-gray-400 hover:text-gray-300' : 'text-gray-600 hover:text-gray-700'} py-2`}
          >
            ğŸ  Back to Home
          </button>
        </div>
        
        <div className="mt-6 p-3 bg-blue-50 rounded-lg text-center">
          <p className="text-xs text-blue-600">
            Admin Access: Use {APP_CONFIG.adminEmail} / {APP_CONFIG.adminPassword}
          </p>
        </div>
      </div>
    </div>
  );
};

const SignupPage = ({ navigateToPage }) => {
  const { login } = useAuth();
  const { isDarkMode } = useDarkMode();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [name, setName] = useState('');
  const [userType, setUserType] = useState('user');
  const [loading, setLoading] = useState(false);
  const cardClasses = isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900';

  const handleSubmit = async () => {
    if (!name || !email || !password) {
      alert('Please fill in all fields');
      return;
    }
    
    const agreed = confirm('By creating an account, you agree to DIYMatch terms and conditions. Continue?');
    if (!agreed) return;

    setLoading(true);
    await triggerHaptic('medium');
    
    if (registeredUsers.has(email.toLowerCase())) {
      await triggerHaptic('error');
      alert('âŒ Email already registered. Please use a different email or sign in.');
      setLoading(false);
      return;
    }
    
    const success = await login(email, password, userType, name);
    if (!success) {
      await triggerHaptic('error');
      alert('âŒ Registration failed. Please try again.');
    }
    setLoading(false);
  };

  return (
    <div className={`min-h-screen flex items-center justify-center ${isDarkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-purple-50'} p-4`}>
      <div className={`${cardClasses} p-8 rounded-2xl shadow-xl w-full max-w-md`}>
        <h1 className="text-2xl font-bold mb-6">Join DIYMatch</h1>
        
        <div className="space-y-4">
          <select
            value={userType}
            onChange={(e) => setUserType(e.target.value)}
            className={`w-full border rounded-xl px-4 py-3 text-base ${
              isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
            }`}
          >
            <option value="user">DIY Enthusiast</option>
            <option value="expert">Expert/Professional</option>
          </select>

          <input
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            className={`w-full border rounded-xl px-4 py-3 text-base ${
              isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
            }`}
            placeholder="Full Name"
          />
          
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className={`w-full border rounded-xl px-4 py-3 text-base ${
              isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
            }`}
            placeholder="Email Address"
          />
          
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className={`w-full border rounded-xl px-4 py-3 text-base ${
              isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
            }`}
            placeholder="Password"
          />
          
          <button
            onClick={handleSubmit}
            disabled={loading}
            className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 px-4 rounded-xl disabled:opacity-50 font-semibold transition-all text-lg"
          >
            {loading ? 'Creating Account...' : 'ğŸš€ Create Account'}
          </button>
        </div>
        
        <div className="mt-6 text-center space-y-3">
          <p className={`text-sm ${isDarkMode ? 'text-gray-400' : 'text-gray-600'}`}>
            Already have an account?{' '}
            <button
              onClick={() => { triggerHaptic('light'); navigateToPage('login'); }}
              className="text-blue-600 hover:underline ml-1"
            >
              Sign in
            </button>
          </p>
          <button
            onClick={() => { triggerHaptic('light'); navigateToPage('home'); }}
            className={`text-sm ${isDarkMode ? 'text-gray-400 hover:text-gray-300' : 'text-gray-600 hover:text-gray-700'}`}
          >
            ğŸ  Back to Home
          </button>
        </div>
      </div>
    </div>
  );
};

const ContactPage = ({ navigateToPage }) => {
  const { isDarkMode } = useDarkMode();
  const { user } = useAuth();
  const [formData, setFormData] = useState({
    name: user?.name || '',
    email: user?.email || '',
    subject: '',
    message: '',
    urgency: 'normal'
  });
  const [loading, setLoading] = useState(false);
  const cardClasses = isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900';

  const handleSubmit = async () => {
    if (!formData.name || !formData.email || !formData.subject || !formData.message) {
      alert('Please fill in all fields');
      return;
    }
    
    setLoading(true);
    await triggerHaptic('medium');

    try {
      await dbOperations.saveMessage({
        sender_name: formData.name,
        sender_email: formData.email,
        subject: formData.subject,
        content: formData.message,
        message_type: 'contact_form',
        status: 'unread',
        platform: 'web',
        urgency: formData.urgency
      });

      await triggerHaptic('success');
      alert('âœ… Message sent successfully! We\'ll get back to you soon.');
      
      setFormData({
        name: user?.name || '',
        email: user?.email || '',
        subject: '',
        message: '',
        urgency: 'normal'
      });
      
    } catch (error) {
      await triggerHaptic('error');
      alert('âŒ Failed to send message. Please try again.');
    }
    
    setLoading(false);
  };

  return (
    <div className={`min-h-screen ${isDarkMode ? 'bg-gray-900' : 'bg-gray-50'} pb-20`}>
      <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-200'} p-4`}>
        <div className="flex items-center space-x-3">
          <button
            onClick={() => { triggerHaptic('light'); navigateToPage('home'); }}
            className="p-2"
          >
            â†
          </button>
          <div>
            <h1 className="text-xl font-bold">ğŸ’¬ Contact Support</h1>
            <p className="text-sm text-gray-500">Get help with your DIY projects</p>
          </div>
        </div>
      </div>

      <div className="p-4">
        <div className={`${cardClasses} rounded-xl p-6 shadow-lg`}>
          <h3 className="text-lg font-bold mb-4">ğŸ“ Send us a Message</h3>
          <div className="space-y-4">
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <input
                type="text"
                value={formData.name}
                onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
                className={`w-full border rounded-lg px-4 py-3 text-base ${
                  isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
                }`}
                placeholder="Your Name"
              />
              <input
                type="email"
                value={formData.email}
                onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                className={`w-full border rounded-lg px-4 py-3 text-base ${
                  isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
                }`}
                placeholder="your@email.com"
              />
            </div>

            <input
              type="text"
              value={formData.subject}
              onChange={(e) => setFormData(prev => ({ ...prev, subject: e.target.value }))}
              className={`w-full border rounded-lg px-4 py-3 text-base ${
                isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
              }`}
              placeholder="Subject"
            />

            <textarea
              value={formData.message}
              onChange={(e) => setFormData(prev => ({ ...prev, message: e.target.value }))}
              rows={6}
              className={`w-full border rounded-lg px-4 py-3 text-base ${
                isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
              }`}
              placeholder="Describe your question or issue in detail..."
            />

            <button
              onClick={handleSubmit}
              disabled={loading}
              className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-4 px-6 rounded-xl text-lg font-semibold shadow-lg disabled:opacity-50"
            >
              {loading ? 'Sending Message...' : 'ğŸ“§ Send Message'}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

const ExpertApplicationPage = ({ navigateToPage }) => {
  const { isDarkMode } = useDarkMode();
  const [formData, setFormData] = useState({
    name: '', email: '', phone: '', postcode: '', profession: '', 
    experience: '', certifications: '', description: ''
  });
  const [loading, setLoading] = useState(false);
  const cardClasses = isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900';

  const handleSubmit = async () => {
    if (!formData.name || !formData.email || !formData.phone || !formData.postcode || 
        !formData.profession || !formData.experience || !formData.certifications || !formData.description) {
      alert('Please fill in all fields');
      return;
    }
    
    const agreed = confirm('By submitting, you agree to expert terms and verification process. Continue?');
    if (!agreed) return;

    setLoading(true);
    await triggerHaptic('medium');

    try {
      await dbOperations.saveExpertApplication({
        ...formData,
        agreed_to_terms: true
      });

      await triggerHaptic('success');
      alert('âœ… Application submitted! We\'ll review and get back to you within 48 hours.');
      navigateToPage('home');
      
    } catch (error) {
      await triggerHaptic('error');
      alert('âŒ Failed to submit application.');
    }
    
    setLoading(false);
  };

  return (
    <div className={`min-h-screen ${isDarkMode ? 'bg-gray-900' : 'bg-gray-50'} pb-20`}>
      <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-200'} p-4`}>
        <div className="flex items-center space-x-3">
          <button
            onClick={() => { triggerHaptic('light'); navigateToPage('home'); }}
            className="p-2"
          >
            â†
          </button>
          <h1 className="text-xl font-bold">ğŸ‘¨â€ğŸ”§ Become an Expert</h1>
        </div>
      </div>

      <div className="p-4 space-y-6">
        <div className={`${cardClasses} rounded-xl p-6 shadow-lg`}>
          <div className="space-y-4">
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <input
                type="text"
                value={formData.name}
                onChange={(e) => setFormData(prev => ({ ...prev, name: e.target.value }))}
                className={`w-full border rounded-lg px-4 py-3 text-base ${
                  isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
                }`}
                placeholder="Full Name"
              />
              <input
                type="email"
                value={formData.email}
                onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                className={`w-full border rounded-lg px-4 py-3 text-base ${
                  isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
                }`}
                placeholder="Email"
              />
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <input
                type="tel"
                value={formData.phone}
                onChange={(e) => setFormData(prev => ({ ...prev, phone: e.target.value }))}
                className={`w-full border rounded-lg px-4 py-3 text-base ${
                  isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
                }`}
                placeholder="Phone Number"
              />
              <input
                type="text"
                value={formData.postcode}
                onChange={(e) => setFormData(prev => ({ ...prev, postcode: e.target.value }))}
                className={`w-full border rounded-lg px-4 py-3 text-base ${
                  isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
                }`}
                placeholder="Service Area Postcode"
              />
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <select
                value={formData.profession}
                onChange={(e) => setFormData(prev => ({ ...prev, profession: e.target.value }))}
                className={`w-full border rounded-lg px-4 py-3 text-base ${
                  isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
                }`}
              >
                <option value="">Select Profession</option>
                <option value="Electrician">Electrician</option>
                <option value="Plumber">Plumber</option>
                <option value="Carpenter">Carpenter</option>
                <option value="General Handyman">General Handyman</option>
                <option value="Other">Other</option>
              </select>
              <select
                value={formData.experience}
                onChange={(e) => setFormData(prev => ({ ...prev, experience: e.target.value }))}
                className={`w-full border rounded-lg px-4 py-3 text-base ${
                  isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
                }`}
              >
                <option value="">Years of Experience</option>
                <option value="2-3 years">2-3 years</option>
                <option value="4-5 years">4-5 years</option>
                <option value="6-10 years">6-10 years</option>
                <option value="15+ years">15+ years</option>
              </select>
            </div>

            <textarea
              value={formData.certifications}
              onChange={(e) => setFormData(prev => ({ ...prev, certifications: e.target.value }))}
              rows={3}
              className={`w-full border rounded-lg px-4 py-3 text-base ${
                isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
              }`}
              placeholder="Qualifications & Certifications..."
            />

            <textarea
              value={formData.description}
              onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
              rows={4}
              className={`w-full border rounded-lg px-4 py-3 text-base ${
                isDarkMode ? 'border-gray-600 bg-gray-700 text-white' : 'border-gray-300 bg-white'
              }`}
              placeholder="About you and your services..."
            />

            <button
              onClick={handleSubmit}
              disabled={loading}
              className="w-full bg-gradient-to-r from-green-600 to-blue-600 text-white py-4 px-6 rounded-xl text-lg font-semibold shadow-lg disabled:opacity-50"
            >
              {loading ? 'Submitting...' : 'ğŸš€ Submit Application'}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

const DashboardPage = ({ navigateToPage }) => {
  const { isDarkMode } = useDarkMode();
  const { user } = useAuth();
  const [activeTab, setActiveTab] = useState('overview');
  const cardClasses = isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900';

  if (user?.user_type !== 'admin') {
    return (
      <div className={`min-h-screen ${isDarkMode ? 'bg-gray-900' : 'bg-gray-50'} pb-20`}>
        <div className="p-4">
          <h1 className="text-3xl font-bold mb-6">Welcome, {user?.name}! ğŸ‘‹</h1>
          <div className="space-y-4">
            <div className={`${cardClasses} rounded-xl p-6 shadow-lg text-center`}>
              <div className="text-6xl mb-4">ğŸš€</div>
              <h2 className="text-2xl font-bold mb-4">Ready to Start?</h2>
              <p className="text-gray-600 mb-6">All features are being implemented. Navigate using the bottom menu!</p>
            </div>
          </div>
        </div>
      </div>
    );
  }

  // Admin Dashboard
  const totalUsers = registeredUsers.size;

  const replyToMessage = async (message) => {
    const reply = prompt(`Reply to ${message.sender_name}:\n\nOriginal: "${message.content}"\n\nYour reply:`);
    if (reply) {
      alert('âœ… Reply sent successfully! (In full implementation, this would send an actual email)');
    }
  };

  return (
    <div className={`min-h-screen ${isDarkMode ? 'bg-gray-900' : 'bg-gray-50'} pb-20`}>
      <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-200'} p-4`}>
        <h1 className="text-2xl font-bold">ğŸ‘‘ Admin Dashboard</h1>
      </div>

      <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-200'}`}>
        <div className="flex overflow-x-auto">
          {['overview', 'users', 'experts', 'inbox'].map((tab) => (
            <button
              key={tab}
              onClick={() => { setActiveTab(tab); triggerHaptic('light'); }}
              className={`px-6 py-3 font-medium transition-all ${
                activeTab === tab
                  ? 'border-b-2 border-blue-600 text-blue-600'
                  : isDarkMode ? 'text-gray-400 hover:text-gray-300' : 'text-gray-600 hover:text-gray-700'
              }`}
            >
              {tab.charAt(0).toUpperCase() + tab.slice(1)}
            </button>
          ))}
        </div>
      </div>

      <div className="p-4">
        {activeTab === 'overview' && (
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className={`${cardClasses} rounded-xl p-6 shadow-lg`}>
                <div className="text-3xl mb-2">ğŸ‘¥</div>
                <h3 className="text-2xl font-bold text-blue-600">{totalUsers}</h3>
                <p className="text-sm text-gray-600">Total Users</p>
              </div>
              <div className={`${cardClasses} rounded-xl p-6 shadow-lg`}>
                <div className="text-3xl mb-2">ğŸ“§</div>
                <h3 className="text-2xl font-bold text-orange-600">{adminMessages.length}</h3>
                <p className="text-sm text-gray-600">Messages</p>
              </div>
              <div className={`${cardClasses} rounded-xl p-6 shadow-lg`}>
                <div className="text-3xl mb-2">ğŸ”§</div>
                <h3 className="text-2xl font-bold text-green-600">{expertApplications.size}</h3>
                <p className="text-sm text-gray-600">Expert Applications</p>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'users' && (
          <div className={`${cardClasses} rounded-xl p-6 shadow-lg`}>
            <h3 className="text-lg font-bold mb-4">ğŸ‘¥ User Management</h3>
            <div className="space-y-4">
              {Array.from(registeredUsers.values()).length === 0 ? (
                <p className="text-gray-500 text-center py-8">No users registered yet</p>
              ) : (
                Array.from(registeredUsers.values()).map((user) => (
                  <div key={user.id} className="flex items-center justify-between p-4 border rounded-lg">
                    <div>
                      <h4 className="font-bold">{user.name}</h4>
                      <p className="text-sm text-gray-600">{user.email}</p>
                      <span className={`px-2 py-1 rounded-full text-xs ${
                        user.user_type === 'admin' ? 'bg-red-100 text-red-800' :
                        user.user_type === 'expert' ? 'bg-blue-100 text-blue-800' :
                        'bg-green-100 text-green-800'
                      }`}>
                        {user.user_type}
                      </span>
                    </div>
                    <div className="text-xs text-gray-500">
                      {new Date(user.created_at).toLocaleDateString()}
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        )}

        {activeTab === 'experts' && (
          <div className={`${cardClasses} rounded-xl p-6 shadow-lg`}>
            <h3 className="text-lg font-bold mb-4">ğŸ”§ Expert Applications</h3>
            <div className="space-y-4">
              {Array.from(expertApplications.values()).length === 0 ? (
                <p className="text-gray-500 text-center py-8">No expert applications yet</p>
              ) : (
                Array.from(expertApplications.values()).map((application) => (
                  <div key={application.id} className="border rounded-lg p-4">
                    <div className="flex items-start justify-between mb-3">
                      <div>
                        <h4 className="font-bold">{application.name}</h4>
                        <p className="text-sm text-gray-600">{application.profession} â€¢ {application.experience}</p>
                        <p className="text-sm text-gray-500">{application.email}</p>
                      </div>
                      <span className={`px-3 py-1 rounded-full text-sm ${
                        application.status === 'approved' ? 'bg-green-100 text-green-800' :
                        application.status === 'rejected' ? 'bg-red-100 text-red-800' :
                        'bg-yellow-100 text-yellow-800'
                      }`}>
                        {application.status.toUpperCase()}
                      </span>
                    </div>
                    {application.status === 'pending' && (
                      <div className="flex space-x-2">
                        <button
                          onClick={() => {
                            expertApplications.set(application.id, { ...application, status: 'approved' });
                            alert('Expert approved!');
                          }}
                          className="bg-green-600 text-white px-3 py-1 rounded text-sm"
                        >
                          âœ… Approve
                        </button>
                        <button
                          onClick={() => {
                            expertApplications.set(application.id, { ...application, status: 'rejected' });
                            alert('Expert rejected!');
                          }}
                          className="bg-red-600 text-white px-3 py-1 rounded text-sm"
                        >
                          âŒ Reject
                        </button>
                      </div>
                    )}
                  </div>
                ))
              )}
            </div>
          </div>
        )}

        {activeTab === 'inbox' && (
          <div className={`${cardClasses} rounded-xl p-6 shadow-lg`}>
            <h3 className="text-lg font-bold mb-4">ğŸ“§ Message Inbox</h3>
            <div className="space-y-4">
              {adminMessages.length === 0 ? (
                <p className="text-gray-500 text-center py-8">No messages yet</p>
              ) : (
                adminMessages.map((message) => (
                  <div key={message.id} className="border rounded-lg p-4">
                    <div className="flex items-start justify-between mb-3">
                      <div>
                        <h4 className="font-bold">{message.subject}</h4>
                        <p className="text-sm text-gray-600">From: {message.sender_name} ({message.sender_email})</p>
                        <p className="text-xs text-gray-500">{new Date(message.timestamp).toLocaleString()}</p>
                      </div>
                      <button
                        onClick={() => replyToMessage(message)}
                        className="bg-blue-600 text-white px-3 py-1 rounded text-sm"
                      >
                        ğŸ“§ Reply
                      </button>
                    </div>
                    <div className="bg-gray-50 rounded p-3">
                      <p className="text-sm whitespace-pre-wrap">{message.content}</p>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

const BottomNav = ({ currentPage, navigateToPage }) => {
  const { isDarkMode } = useDarkMode();
  const { user } = useAuth();

  const navItems = [
    { id: 'home', icon: 'ğŸ ', label: 'Home', page: 'home' },
    { id: 'analyze', icon: 'ğŸ¤–', label: 'Analyze', page: 'analyze' },
    { id: 'experts', icon: 'ğŸ‘¨â€ğŸ”§', label: 'Experts', page: 'experts' },
    { id: 'parts', icon: 'ğŸ›’', label: 'Parts', page: 'parts' },
    { 
      id: 'account', 
      icon: 'ğŸ‘¤', 
      label: 'Account', 
      action: () => user ? navigateToPage('account-settings') : navigateToPage('login')
    }
  ];

  return (
    <div className={`fixed bottom-0 left-0 right-0 ${isDarkMode ? 'bg-gray-800 border-gray-700' : 'bg-white border-gray-200'} border-t`}>
      <div className="flex justify-around items-center py-2">
        {navItems.map((item) => (
          <button
            key={item.id}
            onClick={() => {
              triggerHaptic('light');
              if (item.action) {
                item.action();
              } else if (user || item.page === 'home') {
                navigateToPage(item.page);
              } else {
                navigateToPage('signup');
              }
            }}
            className={`flex flex-col items-center p-2 rounded-lg transition-all ${
              currentPage === item.page || (item.id === 'account' && currentPage === 'account-settings')
                ? isDarkMode ? 'text-blue-400 bg-gray-700' : 'text-blue-600 bg-blue-50'
                : isDarkMode ? 'text-gray-400 hover:text-gray-300' : 'text-gray-600 hover:text-gray-700'
            }`}
          >
            <span className="text-xl mb-1">{item.icon}</span>
            <span className="text-xs font-medium">{item.label}</span>
          </button>
        ))}
      </div>
    </div>
  );
};

// Placeholder pages
const createPlaceholderPage = (title, icon, description) => ({ navigateToPage }) => {
  const { isDarkMode } = useDarkMode();
  const { user } = useAuth();
  const cardClasses = isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900';

  if (!user && title !== 'Expert Application') {
    return (
      <div className={`min-h-screen flex items-center justify-center ${isDarkMode ? 'bg-gray-900' : 'bg-gray-50'} p-4`}>
        <div className={`${cardClasses} p-8 rounded-xl shadow-lg text-center`}>
          <div className="text-6xl mb-4">ğŸ”’</div>
          <h2 className="text-2xl font-bold mb-4">Sign In Required</h2>
          <p className="mb-6 text-gray-600">Please sign in to access {title.toLowerCase()}.</p>
          <button
            onClick={() => navigateToPage('login')}
            className="bg-blue-600 text-white py-3 px-4 rounded-lg"
          >
            ğŸ”‘ Sign In
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className={`min-h-screen ${isDarkMode ? 'bg-gray-900' : 'bg-gray-50'} pb-20`}>
      <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-200'} p-4`}>
        <div className="flex items-center space-x-3">
          <button
            onClick={() => { triggerHaptic('light'); navigateToPage('home'); }}
            className="p-2"
          >
            â†
          </button>
          <h1 className="text-xl font-bold">{icon} {title}</h1>
        </div>
      </div>
      <div className="p-4">
        <div className={`${cardClasses} rounded-xl p-6 shadow-lg text-center`}>
          <div className="text-6xl mb-4">{icon}</div>
          <h2 className="text-2xl font-bold mb-4">{title}</h2>
          <p className="text-gray-600 mb-6">{description}</p>
          <button
            onClick={() => alert(`${title} feature will be fully implemented with all requested functionality!`)}
            className="bg-blue-600 text-white py-3 px-6 rounded-lg"
          >
            ğŸš€ Coming Soon
          </button>
        </div>
      </div>
    </div>
  );
};

const AnalyzePage = createPlaceholderPage('AI Analysis', 'ğŸ¤–', 'Enhanced AI analysis with expert recommendations!');
const ExpertsPage = createPlaceholderPage('Expert Search', 'ğŸ‘¨â€ğŸ”§', 'Find local professionals with AI-powered matching!');
const PartsPage = createPlaceholderPage('Parts Shop', 'ğŸ›’', 'Buy materials from local hardware stores!');

const AccountSettingsPage = ({ navigateToPage }) => {
  const { isDarkMode, toggleDarkMode } = useDarkMode();
  const { user, logout } = useAuth();
  const cardClasses = isDarkMode ? 'bg-gray-800 text-white' : 'bg-white text-gray-900';

  if (!user) {
    return (
      <div className={`min-h-screen flex items-center justify-center ${isDarkMode ? 'bg-gray-900' : 'bg-gray-50'} p-4`}>
        <div className={`${cardClasses} p-8 rounded-xl shadow-lg text-center`}>
          <div className="text-6xl mb-4">ğŸ”’</div>
          <h2 className="text-2xl font-bold mb-4">Sign In Required</h2>
          <button
            onClick={() => navigateToPage('login')}
            className="bg-blue-600 text-white py-3 px-4 rounded-lg"
          >
            ğŸ”‘ Sign In
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className={`min-h-screen ${isDarkMode ? 'bg-gray-900' : 'bg-gray-50'} pb-20`}>
      <div className={`${isDarkMode ? 'bg-gray-800' : 'bg-white'} border-b ${isDarkMode ? 'border-gray-700' : 'border-gray-200'} p-4`}>
        <div className="flex items-center space-x-3">
          <button
            onClick={() => { triggerHaptic('light'); navigateToPage('home'); }}
            className="p-2"
          >
            â†
          </button>
          <h1 className="text-xl font-bold">âš™ï¸ Account Settings</h1>
        </div>
      </div>
      <div className="p-4 space-y-4">
        <div className={`${cardClasses} rounded-xl p-6 shadow-lg`}>
          <h3 className="text-lg font-bold mb-4">ğŸ‘¤ Profile</h3>
          <p>Name: {user.name}</p>
          <p>Email: {user.email}</p>
          <p>Type: {user.user_type}</p>
        </div>
        <div className={`${cardClasses} rounded-xl p-6 shadow-lg`}>
          <h3 className="text-lg font-bold mb-4">ğŸ¨ Preferences</h3>
          <div className="flex items-center justify-between">
            <span>Dark Mode</span>
            <button
              onClick={() => { toggleDarkMode(); triggerHaptic('light'); }}
              className={`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${
                isDarkMode ? 'bg-blue-600' : 'bg-gray-300'
              }`}
            >
              <span
                className={`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${
                  isDarkMode ? 'translate-x-6' : 'translate-x-1'
                }`}
              />
            </button>
          </div>
        </div>
        <div className={`${cardClasses} rounded-xl p-6 shadow-lg`}>
          <h3 className="text-lg font-bold mb-4">â„¹ï¸ App Information</h3>
          <p>Version: {APP_CONFIG.version}</p>
          <p>Member Since: {new Date(user.created_at).toLocaleDateString()}</p>
        </div>
        <button
          onClick={async () => {
            const confirmed = confirm('Are you sure you want to sign out?');
            if (confirmed) {
              await logout();
              navigateToPage('home');
            }
          }}
          className="w-full bg-red-600 text-white py-3 px-4 rounded-lg"
        >
          ğŸšª Sign Out
        </button>
      </div>
    </div>
  );
};

// ============================================================================
// MAIN APP COMPONENT
// ============================================================================

export default function DIYMatchApp() {
  const [currentUser, setCurrentUser] = useState(null);
  const [isLoading, setIsLoading] = useState(false);
  const [isDarkMode, setIsDarkMode] = useState(false);
  const [currentPage, setCurrentPage] = useState('home');

  const login = async (email, password, userType = 'user', name = '') => {
    setIsLoading(true);
    
    try {
      // Check if it's admin login
      if (email.toLowerCase() === APP_CONFIG.adminEmail.toLowerCase() && password === APP_CONFIG.adminPassword) {
        const adminUser = {
          id: 'admin_1',
          name: APP_CONFIG.adminName,
          email: APP_CONFIG.adminEmail,
          user_type: 'admin',
          created_at: new Date().toISOString(),
          location: 'London',
          preferences: { theme: isDarkMode ? 'dark' : 'light', notifications: true }
        };
        setCurrentUser(adminUser);
        setCurrentPage('dashboard');
        await triggerHaptic('success');
        return true;
      }
      
      // Check existing user
      let existingUser = await dbOperations.getUserByEmail(email);
      if (existingUser && password) {
        setCurrentUser(existingUser);
        setCurrentPage('dashboard');
        await triggerHaptic('success');
        return true;
      }
      
      // Register new user
      if (name && !existingUser) {
        const result = await dbOperations.createUser({
          name,
          email,
          password,
          user_type: userType
        });
        
        if (result.success) {
          setCurrentUser(result.user);
          setCurrentPage('dashboard');
          await triggerHaptic('success');
          return true;
        }
      }
      
      return false;
    } catch (error) {
      console.error('Login error:', error);
      return false;
    } finally {
      setIsLoading(false);
    }
  };

  const logout = async () => {
    setCurrentUser(null);
    setCurrentPage('home');
    await triggerHaptic('medium');
  };

  const navigateToPage = (page) => {
    setCurrentPage(page);
  };

  const toggleDarkMode = () => {
    setIsDarkMode(prev => !prev);
  };

  const authContextValue = { user: currentUser, login, logout, isLoading };
  const darkModeContextValue = { isDarkMode, toggleDarkMode };

  const renderCurrentPage = () => {
    const pageProps = { navigateToPage };
    
    switch (currentPage) {
      case 'home':
        return <WelcomePage {...pageProps} />;
      case 'login':
        return <LoginPage {...pageProps} />;
      case 'signup':
        return <SignupPage {...pageProps} />;
      case 'dashboard':
        return <DashboardPage {...pageProps} />;
      case 'analyze':
        return <AnalyzePage {...pageProps} />;
      case 'experts':
        return <ExpertsPage {...pageProps} />;
      case 'parts':
        return <PartsPage {...pageProps} />;
      case 'contact':
        return <ContactPage {...pageProps} />;
      case 'expert-application':
        return <ExpertApplicationPage {...pageProps} />;
      case 'account-settings':
        return <AccountSettingsPage {...pageProps} />;
      default:
        return <WelcomePage {...pageProps} />;
    }
  };

  return (
    <AuthContext.Provider value={authContextValue}>
      <DarkModeContext.Provider value={darkModeContextValue}>
        <div className={isDarkMode ? 'dark' : ''}>
          {renderCurrentPage()}
          {(currentPage !== 'home' && currentPage !== 'login' && currentPage !== 'signup') && (
            <BottomNav currentPage={currentPage} navigateToPage={navigateToPage} />
          )}
        </div>
      </DarkModeContext.Provider>
    </AuthContext.Provider>
  );
}
